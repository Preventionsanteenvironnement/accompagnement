<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Ma Recherche de Stage â€” Mon Objectif</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<script>
if (location.protocol === 'http:' && !/^(localhost|127\.0\.0\.1)$/.test(location.hostname)) {
  location.replace('https://' + location.host + location.pathname + location.search + location.hash);
}
</script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
*{-webkit-tap-highlight-color:transparent}
button,[role="button"]{touch-action:manipulation}
:root{
  --bg:#faf9f7;--surface:#fff;--border:rgba(0,0,0,.06);
  --text:#1a1a2e;--text2:#64748b;--text3:#94a3b8;
  --primary:#6366f1;--primary-light:#eef2ff;
  --success:#10b981;--success-bg:rgba(16,185,129,.08);
  --danger:#ef4444;--danger-bg:rgba(239,68,68,.08);
  --warn:#f59e0b;--warn-bg:rgba(245,158,11,.08);
  --stage:#f59e0b;--stage-bg:rgba(245,158,11,.06);
  --radius:16px;--radius-sm:12px;
  --shadow:0 2px 8px rgba(0,0,0,.04);--shadow-lg:0 8px 30px rgba(0,0,0,.08);
  --font:'Plus Jakarta Sans',system-ui,sans-serif
}
*,*::before,*::after{box-sizing:border-box}
html{scroll-behavior:smooth;overflow-x:hidden}
body{font-family:var(--font);background:var(--bg);color:var(--text);min-height:100vh;overflow-x:hidden;margin:0}

/* â”€â”€ Header â”€â”€ */
.page-header{background:var(--surface);padding:14px 20px;display:flex;align-items:center;gap:14px;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:50;max-width:100vw}
.back-btn{width:36px;height:36px;border-radius:10px;border:none;background:var(--bg);cursor:pointer;font-size:1rem;display:flex;align-items:center;justify-content:center;flex-shrink:0;color:var(--text)}
.page-title{font-weight:800;font-size:.95rem;flex:1;min-width:0;overflow:hidden;text-overflow:ellipsis;white-space:nowrap}
.page-code{font-size:.75rem;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:1px}
.page-body{max-width:520px;margin:0 auto;padding:16px 16px 100px;overflow-x:hidden;word-wrap:break-word}

/* â”€â”€ Progress Bar â”€â”€ */
.progress-bar{display:flex;align-items:center;justify-content:space-between;padding:20px 8px 24px;position:relative}
.progress-line{position:absolute;top:32px;left:36px;right:36px;height:3px;background:#e8e8ef;border-radius:2px;z-index:0}
.progress-fill{height:100%;background:var(--stage);border-radius:2px;transition:width .4s ease}
.step-dot{width:36px;height:36px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:.8rem;font-weight:800;position:relative;z-index:1;transition:all .3s;cursor:pointer;border:3px solid #e8e8ef;background:var(--surface);color:var(--text3)}
.step-dot.done{border-color:var(--success);background:var(--success);color:#fff}
.step-dot.active{border-color:var(--stage);background:var(--stage);color:#fff;transform:scale(1.15);box-shadow:0 3px 12px rgba(245,158,11,.3)}
.step-dot.future{border-color:#e8e8ef;background:var(--surface);color:var(--text3)}
.step-label{position:absolute;top:40px;left:50%;transform:translateX(-50%);font-size:.6rem;font-weight:700;text-transform:uppercase;letter-spacing:.3px;white-space:nowrap;color:var(--text3)}
.step-dot.active .step-label{color:var(--stage)}
.step-dot.done .step-label{color:var(--success)}

/* â”€â”€ Status Banner â”€â”€ */
.status-banner{text-align:center;padding:12px 16px;border-radius:var(--radius-sm);margin-bottom:16px;font-size:.82rem;font-weight:700}
.status-banner.searching{background:var(--warn-bg);color:var(--warn)}
.status-banner.found{background:var(--success-bg);color:var(--success)}

/* â”€â”€ Step Sections â”€â”€ */
.step-section{display:none;animation:fadeIn .3s ease}
.step-section.active{display:block}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
.step-title{font-size:1rem;font-weight:800;margin-bottom:4px}
.step-sub{font-size:.8rem;color:var(--text2);margin-bottom:16px;line-height:1.5}

/* â”€â”€ Checklist â”€â”€ */
.check-item{display:flex;align-items:flex-start;gap:12px;padding:14px 16px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);margin-bottom:8px;cursor:pointer;transition:all .15s}
.check-item:hover{box-shadow:var(--shadow)}
.check-item.done{opacity:.7}
.check-box{width:24px;height:24px;border-radius:8px;border:2px solid var(--border);display:flex;align-items:center;justify-content:center;flex-shrink:0;font-size:.8rem;transition:all .2s;margin-top:1px}
.check-item.done .check-box{border-color:var(--success);background:var(--success);color:#fff}
.check-label{flex:1}
.check-label .cl-title{font-weight:700;font-size:.85rem}
.check-label .cl-sub{font-size:.75rem;color:var(--text3);margin-top:2px}
.check-detail{display:none;margin-top:8px;padding:10px 12px;background:var(--bg);border-radius:8px;font-size:.78rem;color:var(--text2);line-height:1.6}
.check-item.expanded .check-detail{display:block}
.check-expand{font-size:.7rem;color:var(--primary);font-weight:700;cursor:pointer;margin-top:4px}

/* â”€â”€ Date inputs in checklist â”€â”€ */
.check-dates{display:flex;gap:8px;margin-top:8px}
.check-dates input[type="date"]{flex:1;padding:8px 10px;border:1px solid var(--border);border-radius:8px;font-family:var(--font);font-size:.78rem;font-weight:600}
.check-input{width:100%;padding:8px 10px;border:1px solid var(--border);border-radius:8px;font-family:var(--font);font-size:.8rem;font-weight:600;margin-top:6px}

/* â”€â”€ Entreprise Cards â”€â”€ */
.ent-counter{text-align:center;font-size:.82rem;font-weight:700;color:var(--text2);margin-bottom:12px}
.ent-counter strong{color:var(--stage);font-size:1.1rem}
.ent-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:10px;overflow:hidden;transition:all .15s}
.ent-card:hover{box-shadow:var(--shadow)}
.ent-head{padding:14px 16px;cursor:pointer;display:flex;align-items:center;gap:12px}
.ent-icon{width:36px;height:36px;border-radius:10px;background:var(--stage-bg);display:flex;align-items:center;justify-content:center;font-size:1.1rem;flex-shrink:0}
.ent-info{flex:1;min-width:0}
.ent-name{font-weight:800;font-size:.85rem;white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.ent-meta{font-size:.73rem;color:var(--text3);margin-top:1px}
.ent-status{padding:4px 10px;border-radius:999px;font-size:.68rem;font-weight:800;text-transform:uppercase;letter-spacing:.3px;flex-shrink:0}
.ent-status.a_contacter{background:var(--bg);color:var(--text3)}
.ent-status.contacte{background:rgba(59,130,246,.1);color:#3b82f6}
.ent-status.en_attente{background:var(--warn-bg);color:var(--warn)}
.ent-status.relance{background:rgba(139,92,246,.1);color:#8b5cf6}
.ent-status.accepte{background:var(--success-bg);color:var(--success)}
.ent-status.refuse{background:var(--danger-bg);color:var(--danger)}
.ent-body{display:none;padding:0 16px 16px;border-top:1px solid var(--border)}
.ent-card.open .ent-body{display:block}
.ent-field{margin-top:10px}
.ent-field-label{font-size:.7rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);margin-bottom:4px}
.ent-field-value{font-size:.82rem;font-weight:600}
.ent-field-value a{color:var(--primary);text-decoration:none}
.ent-actions-row{display:flex;gap:6px;margin-top:12px;flex-wrap:wrap}
.ent-btn{padding:8px 14px;border:1px solid var(--border);border-radius:10px;font-family:var(--font);font-weight:700;font-size:.75rem;cursor:pointer;background:var(--surface);color:var(--text2);transition:all .15s}
.ent-btn:hover{background:var(--primary-light);color:var(--primary);border-color:rgba(99,102,241,.2)}
.ent-btn.primary{background:var(--primary);color:#fff;border-color:var(--primary)}
.ent-btn.danger{color:var(--danger);border-color:rgba(239,68,68,.2)}
.ent-btn.danger:hover{background:var(--danger-bg)}

/* â”€â”€ Status select â”€â”€ */
.status-select{width:100%;padding:8px 12px;border:1px solid var(--border);border-radius:8px;font-family:var(--font);font-size:.8rem;font-weight:700;margin-top:4px;background:var(--surface)}

/* â”€â”€ Action timeline â”€â”€ */
.action-timeline{margin-top:10px}
.action-item{display:flex;gap:10px;padding:8px 0;border-bottom:1px solid var(--border);font-size:.78rem}
.action-item:last-child{border-bottom:none}
.action-date{font-weight:700;color:var(--text3);flex-shrink:0;width:50px}
.action-type{font-weight:700;flex-shrink:0}
.action-result{color:var(--text2);flex:1}

/* â”€â”€ Add forms â”€â”€ */
.form-overlay{display:none;position:fixed;inset:0;z-index:100;background:rgba(0,0,0,.3);align-items:flex-end;justify-content:center}
.form-overlay.show{display:flex}
.form-sheet{background:var(--surface);border-radius:var(--radius) var(--radius) 0 0;padding:24px 20px 40px;width:100%;max-width:520px;max-height:85vh;overflow-y:auto;animation:slideUp .3s ease}
@keyframes slideUp{from{transform:translateY(100%)}to{transform:none}}
.form-title{font-weight:800;font-size:1rem;margin-bottom:16px;display:flex;align-items:center;justify-content:space-between}
.form-close{width:32px;height:32px;border-radius:8px;border:none;background:var(--bg);cursor:pointer;font-size:.9rem;display:flex;align-items:center;justify-content:center}
.form-group{margin-bottom:12px}
.form-label{font-size:.75rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);margin-bottom:4px}
.form-input{width:100%;padding:10px 14px;border:1px solid var(--border);border-radius:10px;font-family:var(--font);font-size:.85rem;font-weight:600;outline:none;transition:border-color .2s}
.form-input:focus{border-color:var(--primary)}
.form-select{width:100%;padding:10px 14px;border:1px solid var(--border);border-radius:10px;font-family:var(--font);font-size:.85rem;font-weight:600;background:var(--surface)}
textarea.form-input{resize:vertical;min-height:60px}
.form-submit{width:100%;padding:14px;background:var(--primary);color:#fff;border:none;border-radius:12px;font-family:var(--font);font-weight:800;font-size:.88rem;cursor:pointer;margin-top:8px;transition:all .15s}
.form-submit:hover{box-shadow:0 4px 16px rgba(99,102,241,.3)}
.form-required{color:var(--danger);font-weight:800}

/* â”€â”€ Contact mode chips â”€â”€ */
.contact-chips{display:flex;flex-wrap:wrap;gap:6px;margin-top:4px}
.contact-chip{padding:6px 12px;border:1px solid var(--border);border-radius:8px;font-family:var(--font);font-size:.75rem;font-weight:700;cursor:pointer;background:var(--surface);transition:all .15s}
.contact-chip.active{background:var(--primary-light);color:var(--primary);border-color:rgba(99,102,241,.3)}

/* â”€â”€ Relance cards â”€â”€ */
.relance-card{background:var(--warn-bg);border:1px solid rgba(245,158,11,.15);border-radius:var(--radius-sm);padding:14px 16px;margin-bottom:8px}
.relance-card .rc-name{font-weight:800;font-size:.85rem}
.relance-card .rc-info{font-size:.78rem;color:var(--text2);margin-top:2px}
.relance-card .rc-actions{margin-top:8px;display:flex;gap:6px}

/* â”€â”€ Finalisation â”€â”€ */
.final-card{background:var(--surface);border:2px solid var(--success);border-radius:var(--radius);padding:24px 20px;text-align:center;margin-bottom:16px}
.final-card .fc-emoji{font-size:3rem;margin-bottom:8px}
.final-card .fc-title{font-weight:800;font-size:1.1rem;color:var(--success)}
.final-card .fc-sub{font-size:.82rem;color:var(--text2);margin-top:4px}

/* â”€â”€ Aide accordions â”€â”€ */
.aide-acc{margin-bottom:8px}
.aide-head{width:100%;text-align:left;padding:14px 16px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);font-family:var(--font);font-weight:700;font-size:.85rem;cursor:pointer;display:flex;align-items:center;justify-content:space-between;transition:all .15s}
.aide-head:hover{border-color:var(--primary);box-shadow:var(--shadow)}
.aide-head .arrow{transition:transform .2s;font-size:.75rem;color:var(--text3)}
.aide-head.open .arrow{transform:rotate(90deg)}
.aide-body{display:none;padding:14px 16px;background:var(--surface);border:1px solid var(--border);border-top:none;border-radius:0 0 var(--radius-sm) var(--radius-sm);font-size:.82rem;color:var(--text2);line-height:1.7}
.aide-body.open{display:block}
.aide-body strong{color:var(--text);font-weight:700}
.aide-body .script-box{background:var(--bg);border-radius:8px;padding:12px;margin:8px 0;font-style:italic;border-left:3px solid var(--stage)}

/* â”€â”€ Empty â”€â”€ */
.empty{text-align:center;color:var(--text3);font-size:.82rem;font-style:italic;padding:24px 16px}

/* â”€â”€ Add floating btn â”€â”€ */
.fab{position:fixed;bottom:24px;right:50%;transform:translateX(50%);padding:14px 28px;background:var(--primary);color:#fff;border:none;border-radius:999px;font-family:var(--font);font-weight:800;font-size:.85rem;cursor:pointer;box-shadow:0 4px 20px rgba(99,102,241,.35);z-index:40;transition:all .15s}
.fab:hover{box-shadow:0 6px 28px rgba(99,102,241,.45);transform:translateX(50%) translateY(-2px)}

/* â”€â”€ Footer â”€â”€ */
.ref-footer{font-size:.75rem;color:var(--text3);text-align:center;margin-top:24px;font-style:italic;padding:12px;border-top:1px solid var(--border)}
</style>
</head>
<body>

<header class="page-header">
  <button class="back-btn" onclick="goBack()">â†</button>
  <span class="page-title">ğŸ” Ma Recherche de Stage</span>
  <span class="page-code" id="page-code">â€”</span>
</header>

<div class="page-body">
  <!-- Status Banner -->
  <div id="status-banner" class="status-banner searching">Recherche en cours...</div>

  <!-- Progress Bar -->
  <div class="progress-bar">
    <div class="progress-line"><div class="progress-fill" id="progress-fill" style="width:0%"></div></div>
    <div class="step-dot" data-step="1" onclick="goStep(1)">1<span class="step-label">PrÃ©parer</span></div>
    <div class="step-dot" data-step="2" onclick="goStep(2)">2<span class="step-label">Lister</span></div>
    <div class="step-dot" data-step="3" onclick="goStep(3)">3<span class="step-label">Contacter</span></div>
    <div class="step-dot" data-step="4" onclick="goStep(4)">4<span class="step-label">Suivre</span></div>
    <div class="step-dot" data-step="5" onclick="goStep(5)">5<span class="step-label">Finaliser</span></div>
  </div>

  <!-- â•â•â•â• STEP 1: ME PREPARER â•â•â•â• -->
  <div class="step-section" id="step-1">
    <div class="step-title">â‘  Me prÃ©parer</div>
    <div class="step-sub">Avant de chercher, je prÃ©pare mes outils. Chaque Ã©lÃ©ment est un petit objectif Ã  atteindre.</div>

    <div class="check-item" data-key="cv" onclick="togglePrep(this,'cv')">
      <div class="check-box"></div>
      <div class="check-label">
        <div class="cl-title">RÃ©diger mon CV</div>
        <div class="cl-sub">Quand ? OÃ¹ ? (en classe, Ã  la maison...)</div>
        <div class="check-detail">
          <strong>Conseils CV :</strong><br>
          - 1 page maximum, pas plus<br>
          - Nom, prÃ©nom, age, classe, lycÃ©e<br>
          - Tes expÃ©riences (mÃªme bÃ©nÃ©voles ou stages prÃ©cÃ©dents)<br>
          - Tes qualitÃ©s et compÃ©tences<br>
          - Demande Ã  ton prof de le relire
        </div>
        <div class="check-expand" onclick="event.stopPropagation();this.parentNode.parentNode.classList.toggle('expanded')">Voir les conseils</div>
      </div>
    </div>

    <div class="check-item" data-key="lettre" onclick="togglePrep(this,'lettre')">
      <div class="check-box"></div>
      <div class="check-label">
        <div class="cl-title">PrÃ©parer ma lettre / email type</div>
        <div class="cl-sub">Un modÃ¨le Ã  adapter pour chaque entreprise</div>
        <div class="check-detail">
          <strong>Structure email :</strong><br>
          - Objet : "Demande de stage - [ta classe] - [dates]"<br>
          - Bonjour Madame/Monsieur,<br>
          - Je suis en [classe] au lycÃ©e [nom]...<br>
          - Je recherche un stage de [X semaines] du [date] au [date]...<br>
          - En piÃ¨ce jointe mon CV...<br>
          - Formule de politesse + signature
        </div>
        <div class="check-expand" onclick="event.stopPropagation();this.parentNode.parentNode.classList.toggle('expanded')">Voir le modÃ¨le</div>
      </div>
    </div>

    <div class="check-item" data-key="oral" onclick="togglePrep(this,'oral')">
      <div class="check-box"></div>
      <div class="check-label">
        <div class="cl-title">PrÃ©parer mon oral / entretien</div>
        <div class="cl-sub">Savoir me prÃ©senter et rÃ©pondre aux questions</div>
        <div class="check-detail">
          <strong>Mon pitch :</strong><br>
          <div class="script-box">"Bonjour, je m'appelle [prÃ©nom], je suis en [classe] au lycÃ©e [nom]. Je cherche un stage de [X] semaines Ã  partir du [date]. Je suis motivÃ©(e) et je souhaite dÃ©couvrir votre mÃ©tier."</div>
          <strong>Questions frÃ©quentes :</strong><br>
          - Pourquoi cette entreprise ? â†’ "Parce que votre activitÃ© correspond Ã  ma formation..."<br>
          - Quelles sont tes qualitÃ©s ? â†’ "Je suis ponctuel(le), sÃ©rieux(se)..."<br>
          - Que sais-tu faire ? â†’ "En cours, j'ai appris Ã ..."
        </div>
        <div class="check-expand" onclick="event.stopPropagation();this.parentNode.parentNode.classList.toggle('expanded')">Voir les conseils</div>
      </div>
    </div>

    <div class="check-item" data-key="dates_connues" onclick="togglePrep(this,'dates_connues')">
      <div class="check-box"></div>
      <div class="check-label">
        <div class="cl-title">Saisir mes dates de PFMP</div>
        <div class="cl-sub">Les dates donnÃ©es par le lycÃ©e</div>
        <div class="check-dates">
          <input type="date" id="pfmp-debut" placeholder="DÃ©but" onchange="savePfmpDates()" onclick="event.stopPropagation()">
          <input type="date" id="pfmp-fin" placeholder="Fin" onchange="savePfmpDates()" onclick="event.stopPropagation()">
        </div>
      </div>
    </div>

    <div class="check-item" data-key="secteur" onclick="togglePrep(this,'secteur')">
      <div class="check-box"></div>
      <div class="check-label">
        <div class="cl-title">DÃ©finir mon secteur / mÃ©tier</div>
        <div class="cl-sub">En lien avec ma filiÃ¨re</div>
        <input type="text" class="check-input" id="secteur-input" placeholder="Ex: Commerce, Restauration, BTP..." onchange="saveSecteur()" onclick="event.stopPropagation()">
      </div>
    </div>
  </div>

  <!-- â•â•â•â• STEP 2: MES ENTREPRISES â•â•â•â• -->
  <div class="step-section" id="step-2">
    <div class="step-title">â‘¡ Mes entreprises</div>
    <div class="step-sub">Liste au moins 10 entreprises Ã  contacter. Plus tu en as, plus tu as de chances !</div>
    <div class="ent-counter" id="ent-counter">Chargement...</div>
    <div id="ent-list"></div>
    <button class="fab" id="fab-add" onclick="openAddForm()" style="display:none">+ Nouvelle entreprise</button>
  </div>

  <!-- â•â•â•â• STEP 3: CONTACTER â•â•â•â• -->
  <div class="step-section" id="step-3">
    <div class="step-title">â‘¢ Contacter</div>
    <div class="step-sub">Contacte chaque entreprise de ta liste. Note la date, le mode et le rÃ©sultat.</div>
    <div id="contact-counter" class="ent-counter"></div>
    <div id="contact-list"></div>
  </div>

  <!-- â•â•â•â• STEP 4: SUIVRE â•â•â•â• -->
  <div class="step-section" id="step-4">
    <div class="step-title">â‘£ Suivre et relancer</div>
    <div class="step-sub">Pas de rÃ©ponse aprÃ¨s 1 semaine ? Relance ! C'est normal et Ã§a montre ta motivation.</div>
    <div id="relance-section"></div>
    <div id="reponses-section"></div>
  </div>

  <!-- â•â•â•â• STEP 5: FINALISER â•â•â•â• -->
  <div class="step-section" id="step-5">
    <div class="step-title">â‘¤ Finaliser</div>
    <div class="step-sub">Bravo ! Une entreprise a acceptÃ©. VÃ©rifie que tout est en ordre.</div>
    <div id="final-content"></div>
  </div>

  <!-- AIDE (toujours visible en bas) -->
  <div style="margin-top:28px">
    <div style="font-size:.75rem;font-weight:800;text-transform:uppercase;letter-spacing:.8px;color:var(--text3);margin-bottom:10px">Aide et conseils</div>

    <div class="aide-acc">
      <button class="aide-head" onclick="toggleAide(this)">Comment appeler une entreprise ? <span class="arrow">â–¶</span></button>
      <div class="aide-body">
        <div class="script-box">"Bonjour, je m'appelle [prÃ©nom], je suis Ã©lÃ¨ve en [classe] au lycÃ©e [nom]. Je vous appelle car je cherche un stage de [durÃ©e] Ã  partir du [date]. Est-ce que vous acceptez des stagiaires ?"</div>
        <strong>Conseils :</strong><br>
        - Parle clairement, pas trop vite<br>
        - Souris : Ã§a s'entend au tÃ©lÃ©phone<br>
        - Aie un stylo et papier prÃªt pour noter<br>
        - Si la personne n'est pas disponible, demande quand rappeler<br>
        - Remercie toujours, mÃªme si c'est non
      </div>
    </div>

    <div class="aide-acc">
      <button class="aide-head" onclick="toggleAide(this)">Comment Ã©crire un email / courrier ? <span class="arrow">â–¶</span></button>
      <div class="aide-body">
        <strong>Objet :</strong> Demande de stage - [Classe] - [Dates PFMP]<br><br>
        <div class="script-box">Madame, Monsieur,<br><br>Actuellement Ã©lÃ¨ve en [classe] au lycÃ©e [nom] Ã  [ville], je recherche un stage de [durÃ©e] du [date dÃ©but] au [date fin] dans le cadre de ma formation.<br><br>Votre entreprise m'intÃ©resse car [1 raison concrÃ¨te].<br><br>Je me tiens Ã  votre disposition pour un entretien. Vous trouverez mon CV en piÃ¨ce jointe.<br><br>Je vous prie d'agrÃ©er, Madame, Monsieur, mes salutations distinguÃ©es.<br><br>[PrÃ©nom Nom]<br>[TÃ©lÃ©phone]</div>
      </div>
    </div>

    <div class="aide-acc">
      <button class="aide-head" onclick="toggleAide(this)">Comment se prÃ©senter en personne ? <span class="arrow">â–¶</span></button>
      <div class="aide-body">
        <strong>Avant d'entrer :</strong><br>
        - Tenue correcte (pas de casquette, Ã©couteurs rangÃ©s)<br>
        - Avoir son CV imprime dans une pochette propre<br>
        - Ã‰teindre ou mettre son tÃ©lÃ©phone en silencieux<br><br>
        <strong>En entrant :</strong><br>
        - Saluer, regarder la personne dans les yeux<br>
        - Se prÃ©senter calmement avec son pitch<br>
        - Si le responsable n'est pas lÃ  : demander son nom et quand repasser<br>
        - Laisser son CV mÃªme si on ne peut pas voir quelqu'un
      </div>
    </div>

    <div class="aide-acc">
      <button class="aide-head" onclick="toggleAide(this)">AprÃ¨s le premier contact ? <span class="arrow">â–¶</span></button>
      <div class="aide-body">
        <strong>Si pas de rÃ©ponse :</strong><br>
        - Attends 5 Ã  7 jours puis relance<br>
        - "Bonjour, je me permets de vous recontacter suite Ã  ma demande de stage..."<br>
        - C'est normal de relancer, Ã§a montre ta motivation !<br><br>
        <strong>Si refus :</strong><br>
        - Remercie quand mÃªme poliment<br>
        - Demande s'ils connaissent une autre entreprise qui accepte des stagiaires<br>
        - Ne te dÃ©courage pas : il faut souvent 10+ contacts pour trouver<br><br>
        <strong>Si acceptÃ© :</strong><br>
        - Confirme les dates et les horaires<br>
        - Demande qui sera ton tuteur<br>
        - PrÃ©viens ton lycÃ©e pour la convention
      </div>
    </div>
  </div>

  <div class="ref-footer">monobjectif.fr â€” Ma Recherche de Stage</div>
</div>

<!-- â•â•â•â• FORM: Ajouter entreprise â•â•â•â• -->
<div class="form-overlay" id="form-add-ent">
  <div class="form-sheet">
    <div class="form-title">Ajouter une entreprise <button class="form-close" onclick="closeForm('form-add-ent')">âœ•</button></div>
    <div class="form-group"><div class="form-label">Nom <span class="form-required">*</span></div><input type="text" class="form-input" id="f-nom" placeholder="Nom de l'entreprise"></div>
    <div class="form-group"><div class="form-label">Ville <span class="form-required">*</span></div><input type="text" class="form-input" id="f-ville" placeholder="Ville"></div>
    <div class="form-group"><div class="form-label">Secteur</div>
      <select class="form-select" id="f-secteur">
        <option value="">Choisir...</option>
        <option>Commerce / Vente</option>
        <option>Restauration / HÃ´tellerie</option>
        <option>Artisanat</option>
        <option>BTP / Construction</option>
        <option>Industrie / Production</option>
        <option>Services Ã  la personne</option>
        <option>SantÃ© / Social</option>
        <option>Automobile / MÃ©canique</option>
        <option>Logistique / Transport</option>
        <option>Administration / Bureau</option>
        <option>Informatique / NumÃ©rique</option>
        <option value="__autre">Autre...</option>
      </select>
      <input type="text" class="form-input" id="f-secteur-autre" placeholder="PrÃ©ciser le secteur..." style="display:none;margin-top:6px">
    </div>
    <div class="form-group"><div class="form-label">Personne Ã  contacter</div><input type="text" class="form-input" id="f-contact" placeholder="Nom du responsable (optionnel)"></div>
    <div class="form-group"><div class="form-label">TÃ©lÃ©phone</div><input type="tel" class="form-input" id="f-tel" placeholder="NumÃ©ro de tÃ©lÃ©phone"></div>
    <div class="form-group"><div class="form-label">Email</div><input type="email" class="form-input" id="f-email" placeholder="Adresse email (optionnel)"></div>
    <div class="form-group"><div class="form-label">Notes</div><textarea class="form-input" id="f-notes" placeholder="Informations supplÃ©mentaires..."></textarea></div>
    <button class="form-submit" onclick="saveEntreprise()">Enregistrer</button>
  </div>
</div>

<!-- â•â•â•â• FORM: Ajouter action â•â•â•â• -->
<div class="form-overlay" id="form-add-action">
  <div class="form-sheet">
    <div class="form-title">Ajouter une action <button class="form-close" onclick="closeForm('form-add-action')">âœ•</button></div>
    <input type="hidden" id="fa-ent-id">
    <div class="form-group"><div class="form-label">Type de contact</div>
      <div class="contact-chips" id="fa-type-chips">
        <button class="contact-chip" data-v="appel" onclick="selectChip(this)">ğŸ“ Appel</button>
        <button class="contact-chip" data-v="visite" onclick="selectChip(this)">ğŸš¶ En personne</button>
        <button class="contact-chip" data-v="email" onclick="selectChip(this)">ğŸ“§ Email</button>
        <button class="contact-chip" data-v="courrier" onclick="selectChip(this)">âœ‰ï¸ Courrier</button>
        <button class="contact-chip" data-v="autre" onclick="selectChip(this)">Autre</button>
      </div>
    </div>
    <div class="form-group"><div class="form-label">Date</div><input type="date" class="form-input" id="fa-date"></div>
    <div class="form-group"><div class="form-label">RÃ©sultat / Remarque</div><input type="text" class="form-input" id="fa-resultat" placeholder="Ex: Pas de rÃ©ponse, Envoyer CV, Rappeler..."></div>
    <button class="form-submit" onclick="saveAction()">Enregistrer</button>
  </div>
</div>

<script src="js/data_eleves.js"></script>
<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   INIT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var firebaseConfig={apiKey:"AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0IQcLI",authDomain:"devoirs-pse.firebaseapp.com",databaseURL:"https://devoirs-pse-default-rtdb.europe-west1.firebasedatabase.app",projectId:"devoirs-pse",storageBucket:"devoirs-pse.appspot.com",messagingSenderId:"614730413904",appId:"1:614730413904:web:a5dd478af5de30f6bede55"};
firebase.initializeApp(firebaseConfig);var db=firebase.database();
var SESSION_CODE_KEY='accompagnement_session_code';
function sanitizeCode(v){return String(v||'').toUpperCase().replace(/[^A-Z0-9]/g,'').slice(0,16)}
var userCode=sanitizeCode(sessionStorage.getItem(SESSION_CODE_KEY)||'');
if(!/^[A-Z0-9]{4,16}$/.test(userCode)){window.location.href='index.html';throw new Error('no session')}
function resolveDataCode(lc){if(typeof window.trouverEleve!=='function')return String(lc||'').toUpperCase();var e=window.trouverEleve(lc);return e&&e.userCode?String(e.userCode).toUpperCase():String(lc||'').toUpperCase()}
var dataCode=resolveDataCode(userCode);
document.getElementById('page-code').textContent=userCode;
function escHtml(s){var d=document.createElement('div');d.textContent=s;return d.innerHTML}
function goBack(){window.location.href='index.html'}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STATE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
var stageData={};
var currentStep=1;
var REF=db.ref('accompagnement/eleves/'+dataCode+'/recherche_stage');

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DATA LISTENER
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
db.ref('accompagnement/eleves/'+dataCode).on('value',function(snap){
  var allData=snap.val()||{};
  // Migration
  if(!allData.recherche_stage||!allData.recherche_stage._migrated){
    migrateOldData(allData);return;
  }
  stageData=allData.recherche_stage||{};
  render();
});

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MIGRATION
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function migrateOldData(allData){
  var nd={_migrated:true,etape_courante:1,preparation:{cv:false,lettre:false,oral:false,dates_connues:false,secteur:false},config:{},finalisation:{},entreprises:{}};
  var lieux=allData.stage_lieux||{};
  var statusMap={'contacte':'contacte','relance':'relance','reponse recue':'en_attente','reponse reÃ§ue':'en_attente','stage trouve':'accepte','stage trouvÃ©':'accepte'};
  Object.values(lieux).forEach(function(l){
    var k=db.ref().push().key;
    nd.entreprises[k]={nom:l.nom||'',ville:l.ville||'',secteur:'',contact_nom:'',telephone:'',email:'',statut:statusMap[(l.statut||'').toLowerCase()]||'a_contacter',notes:'',date_premier_contact:'',date_relance:'',created:l.created||new Date().toISOString()};
  });
  var objs=allData.objectifs||{};
  Object.values(objs).forEach(function(o){
    if(o.context!=='Recherche'||!o.demarches)return;
    Object.values(o.demarches).forEach(function(d){
      if(!d.entreprise)return;
      var k=db.ref().push().key;
      nd.entreprises[k]={nom:d.entreprise,ville:d.ville||'',secteur:'',contact_nom:'',telephone:'',email:'',statut:'contacte',notes:'',date_premier_contact:d.date_demarche||'',date_relance:'',created:new Date().toISOString()};
    });
  });
  REF.set(nd);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RENDER
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function render(){
  var step=stageData.etape_courante||1;
  currentStep=step;
  renderProgress();
  renderBanner();
  renderStep1();
  renderStep2();
  renderStep3();
  renderStep4();
  renderStep5();
  goStep(step);
}

function renderProgress(){
  var prep=stageData.preparation||{};
  var ents=stageData.entreprises||{};
  var entArr=Object.values(ents);
  var contacted=entArr.filter(function(e){return e.statut&&e.statut!=='a_contacter'}).length;
  var accepted=entArr.filter(function(e){return e.statut==='accepte'}).length;
  var prepDone=Object.values(prep).filter(function(v){return v===true}).length;
  var prepTotal=5;
  var step=stageData.etape_courante||1;

  var dots=document.querySelectorAll('.step-dot');
  dots.forEach(function(d){
    var s=parseInt(d.dataset.step);
    d.className='step-dot'+(s<step?' done':s===step?' active':' future');
  });
  var pct=Math.max(0,Math.min(100,((step-1)/4)*100));
  document.getElementById('progress-fill').style.width=pct+'%';
}

function renderBanner(){
  var b=document.getElementById('status-banner');
  var conf=stageData.config||{};
  var accepted=Object.values(stageData.entreprises||{}).filter(function(e){return e.statut==='accepte'}).length;
  if(accepted||conf.stage_trouve){
    b.className='status-banner found';
    b.textContent='Stage trouvÃ© !';
  }else{
    var deb=conf.pfmp_debut;
    if(deb){
      var jours=daysLeft(deb);
      b.className='status-banner searching';
      b.textContent=jours>0?'PFMP dans '+jours+' jours â€” Recherche en cours':'Recherche en cours...';
    }else{
      b.className='status-banner searching';
      b.textContent='Recherche en cours...';
    }
  }
}

/* â”€â”€ Step 1: Preparation â”€â”€ */
function renderStep1(){
  var prep=stageData.preparation||{};
  var conf=stageData.config||{};
  var items=document.querySelectorAll('#step-1 .check-item');
  items.forEach(function(it){
    var key=it.dataset.key;
    if(prep[key]){it.classList.add('done')}else{it.classList.remove('done')}
  });
  if(conf.pfmp_debut)document.getElementById('pfmp-debut').value=conf.pfmp_debut;
  if(conf.pfmp_fin)document.getElementById('pfmp-fin').value=conf.pfmp_fin;
  if(conf.secteur_vise)document.getElementById('secteur-input').value=conf.secteur_vise;
}

/* â”€â”€ Step 2: Entreprises â”€â”€ */
function renderStep2(){
  var ents=stageData.entreprises||{};
  var keys=Object.keys(ents);
  var el=document.getElementById('ent-list');
  document.getElementById('ent-counter').innerHTML='<strong>'+keys.length+'</strong> / 10 entreprises';
  if(!keys.length){el.innerHTML='<div class="empty">Aucune entreprise ajoutÃ©e. Clique sur le bouton ci-dessous pour commencer !</div>';return}
  el.innerHTML=keys.map(function(k){return renderEntCard(k,ents[k])}).join('');
}

function renderEntCard(k,e){
  var statusLabels={a_contacter:'Ã€ contacter',contacte:'ContactÃ©',en_attente:'En attente',relance:'RelancÃ©e',accepte:'AcceptÃ©',refuse:'RefusÃ©'};
  var actions=e.actions?Object.values(e.actions).sort(function(a,b){return(b.date||'').localeCompare(a.date||'')}):[];
  var lastAction=actions.length?actions[0]:null;
  var metaParts=[e.secteur,e.ville].filter(Boolean);
  if(lastAction)metaParts.push(lastAction.type+' le '+dateFr(lastAction.date));

  var h='<div class="ent-card" id="ent-'+k+'">';
  h+='<div class="ent-head" onclick="toggleEnt(\''+k+'\')">';
  h+='<div class="ent-icon">ğŸ¢</div>';
  h+='<div class="ent-info"><div class="ent-name">'+escHtml(e.nom||'â€”')+'</div><div class="ent-meta">'+escHtml(metaParts.join(' Â· '))+'</div></div>';
  h+='<span class="ent-status '+escHtml(e.statut||'a_contacter')+'">'+(statusLabels[e.statut]||'Ã€ contacter')+'</span>';
  h+='</div>';
  h+='<div class="ent-body">';
  // Details
  if(e.contact_nom)h+='<div class="ent-field"><div class="ent-field-label">Contact</div><div class="ent-field-value">'+escHtml(e.contact_nom)+'</div></div>';
  if(e.telephone)h+='<div class="ent-field"><div class="ent-field-label">TÃ©lÃ©phone</div><div class="ent-field-value"><a href="tel:'+escHtml(e.telephone)+'">'+escHtml(e.telephone)+'</a></div></div>';
  if(e.email)h+='<div class="ent-field"><div class="ent-field-label">Email</div><div class="ent-field-value"><a href="mailto:'+escHtml(e.email)+'">'+escHtml(e.email)+'</a></div></div>';
  // Status
  h+='<div class="ent-field"><div class="ent-field-label">Statut</div><select class="status-select" onchange="updateEntStatus(\''+k+'\',this.value)">';
  ['a_contacter','contacte','en_attente','relance','accepte','refuse'].forEach(function(s){
    h+='<option value="'+s+'"'+(s===e.statut?' selected':'')+'>'+statusLabels[s]+'</option>';
  });
  h+='</select></div>';
  if(e.notes)h+='<div class="ent-field"><div class="ent-field-label">Notes</div><div class="ent-field-value">'+escHtml(e.notes)+'</div></div>';
  // Actions timeline
  if(actions.length){
    h+='<div class="ent-field"><div class="ent-field-label">Historique</div><div class="action-timeline">';
    actions.forEach(function(a){
      var typeIcons={appel:'ğŸ“',visite:'ğŸš¶',email:'ğŸ“§',courrier:'âœ‰ï¸',relance:'ğŸ”„',autre:'ğŸ“'};
      h+='<div class="action-item"><div class="action-date">'+dateFr(a.date)+'</div><div class="action-type">'+(typeIcons[a.type]||'ğŸ“')+'</div><div class="action-result">'+escHtml(a.resultat||'â€”')+'</div></div>';
    });
    h+='</div></div>';
  }
  // Buttons
  h+='<div class="ent-actions-row">';
  h+='<button class="ent-btn primary" onclick="openActionForm(\''+k+'\')">+ Action</button>';
  if(e.statut!=='accepte')h+='<button class="ent-btn" onclick="planRelance(\''+k+'\')">Planifier relance</button>';
  h+='<button class="ent-btn danger" onclick="deleteEnt(\''+k+'\')">Supprimer</button>';
  h+='</div>';
  h+='</div></div>';
  return h;
}

/* â”€â”€ Step 3: Contacter â”€â”€ */
function renderStep3(){
  var ents=stageData.entreprises||{};
  var keys=Object.keys(ents);
  var aContacter=keys.filter(function(k){return ents[k].statut==='a_contacter'});
  var contacted=keys.filter(function(k){return ents[k].statut&&ents[k].statut!=='a_contacter'});
  var el=document.getElementById('contact-list');
  document.getElementById('contact-counter').innerHTML='<strong>'+contacted.length+'</strong> contactÃ©es / '+keys.length+' au total';

  var h='';
  if(aContacter.length){
    h+='<div style="font-size:.75rem;font-weight:800;text-transform:uppercase;color:var(--warn);margin:12px 0 8px">Ã€ contacter ('+aContacter.length+')</div>';
    aContacter.forEach(function(k){
      var e=ents[k];
      h+='<div class="ent-card"><div class="ent-head">';
      h+='<div class="ent-icon">ğŸ¢</div>';
      h+='<div class="ent-info"><div class="ent-name">'+escHtml(e.nom)+'</div><div class="ent-meta">'+escHtml([e.ville,e.telephone].filter(Boolean).join(' Â· '))+'</div></div>';
      h+='<button class="ent-btn primary" style="flex-shrink:0" onclick="event.stopPropagation();openActionForm(\''+k+'\')">Contacte !</button>';
      h+='</div></div>';
    });
  }
  if(contacted.length){
    h+='<div style="font-size:.75rem;font-weight:800;text-transform:uppercase;color:var(--success);margin:12px 0 8px">DÃ©jÃ  contactÃ©es ('+contacted.length+')</div>';
    contacted.forEach(function(k){
      var e=ents[k];var statusLabels={contacte:'ContactÃ©',en_attente:'En attente',relance:'RelancÃ©e',accepte:'AcceptÃ©',refuse:'RefusÃ©'};
      h+='<div class="ent-card"><div class="ent-head" onclick="toggleEnt(\''+k+'\')">';
      h+='<div class="ent-icon">ğŸ¢</div>';
      h+='<div class="ent-info"><div class="ent-name">'+escHtml(e.nom)+'</div><div class="ent-meta">'+escHtml(e.ville||'')+'</div></div>';
      h+='<span class="ent-status '+escHtml(e.statut)+'">'+(statusLabels[e.statut]||e.statut)+'</span>';
      h+='</div></div>';
    });
  }
  if(!keys.length)h='<div class="empty">Ajoute d\'abord des entreprises dans l\'Ã©tape 2</div>';
  el.innerHTML=h;
}

/* â”€â”€ Step 4: Suivre â”€â”€ */
function renderStep4(){
  var ents=stageData.entreprises||{};
  var keys=Object.keys(ents);
  var now=new Date();now.setHours(0,0,0,0);

  // A relancer: contacte ou en_attente depuis > 5 jours, ou date_relance passee
  var toRelance=keys.filter(function(k){
    var e=ents[k];
    if(e.statut==='accepte'||e.statut==='refuse'||e.statut==='a_contacter')return false;
    if(e.date_relance){var dr=new Date(e.date_relance);dr.setHours(0,0,0,0);if(dr<=now)return true}
    if(e.date_premier_contact){var dp=new Date(e.date_premier_contact);dp.setHours(0,0,0,0);var diff=(now-dp)/(1000*60*60*24);if(diff>=5&&e.statut!=='relance')return true}
    return false;
  });

  var accepted=keys.filter(function(k){return ents[k].statut==='accepte'});
  var refused=keys.filter(function(k){return ents[k].statut==='refuse'});
  var enAttente=keys.filter(function(k){return ents[k].statut==='en_attente'||ents[k].statut==='contacte'});

  var h='';
  if(toRelance.length){
    h+='<div style="font-size:.75rem;font-weight:800;text-transform:uppercase;color:var(--warn);margin:8px 0">Ã€ relancer ('+toRelance.length+')</div>';
    toRelance.forEach(function(k){
      var e=ents[k];
      var ago=e.date_premier_contact?daysSince(e.date_premier_contact):null;
      h+='<div class="relance-card"><div class="rc-name">'+escHtml(e.nom)+'</div><div class="rc-info">'+escHtml(e.ville||'')+(ago!==null?' Â· contactÃ©e il y a '+ago+' jours':'')+'</div>';
      h+='<div class="rc-actions"><button class="ent-btn primary" onclick="openActionForm(\''+k+'\')">J\'ai relancÃ©</button><button class="ent-btn" onclick="planRelance(\''+k+'\')">Reporter</button></div></div>';
    });
  }
  if(accepted.length){
    h+='<div style="font-size:.75rem;font-weight:800;text-transform:uppercase;color:var(--success);margin:16px 0 8px">RÃ©ponses positives ('+accepted.length+')</div>';
    accepted.forEach(function(k){
      var e=ents[k];
      h+='<div class="ent-card" style="border-color:var(--success)"><div class="ent-head"><div class="ent-icon" style="background:var(--success-bg)">âœ…</div><div class="ent-info"><div class="ent-name">'+escHtml(e.nom)+'</div><div class="ent-meta">'+escHtml(e.ville||'')+'</div></div></div></div>';
    });
  }
  if(enAttente.length){
    h+='<div style="font-size:.75rem;font-weight:800;text-transform:uppercase;color:var(--text3);margin:16px 0 8px">En attente ('+enAttente.length+')</div>';
    enAttente.forEach(function(k){
      var e=ents[k];
      h+='<div class="ent-card"><div class="ent-head"><div class="ent-icon">â³</div><div class="ent-info"><div class="ent-name">'+escHtml(e.nom)+'</div><div class="ent-meta">'+escHtml(e.ville||'')+'</div></div></div></div>';
    });
  }
  if(refused.length){
    h+='<div style="font-size:.75rem;font-weight:800;text-transform:uppercase;color:var(--danger);margin:16px 0 8px">Refus ('+refused.length+')</div>';
    refused.forEach(function(k){
      var e=ents[k];
      h+='<div class="ent-card" style="opacity:.5"><div class="ent-head"><div class="ent-icon">âŒ</div><div class="ent-info"><div class="ent-name">'+escHtml(e.nom)+'</div></div></div></div>';
    });
  }
  if(!keys.length||(!toRelance.length&&!accepted.length&&!enAttente.length&&!refused.length)){
    h='<div class="empty">Contacte d\'abord des entreprises pour voir ton suivi ici</div>';
  }
  document.getElementById('relance-section').innerHTML=h;
}

/* â”€â”€ Step 5: Finaliser â”€â”€ */
function renderStep5(){
  var ents=stageData.entreprises||{};
  var accepted=Object.keys(ents).filter(function(k){return ents[k].statut==='accepte'});
  var fin=stageData.finalisation||{};
  var conf=stageData.config||{};
  var el=document.getElementById('final-content');

  if(!accepted.length){
    el.innerHTML='<div class="empty" style="padding:40px 20px"><div style="font-size:2.5rem;margin-bottom:12px">ğŸ’ª</div><div style="font-style:normal;font-weight:700;color:var(--text)">Continue tes recherches !</div><div style="margin-top:8px">Aucune entreprise n\'a encore acceptÃ©. C\'est normal, Ã§a prend du temps. Relance et contacte d\'autres entreprises.</div></div>';
    return;
  }
  var entAccepted=ents[accepted[0]];
  var h='<div class="final-card"><div class="fc-emoji">ğŸ‰</div><div class="fc-title">Stage trouvÃ© !</div><div class="fc-sub">'+escHtml(entAccepted.nom)+' â€” '+escHtml(entAccepted.ville||'')+'</div>';
  if(conf.pfmp_debut&&conf.pfmp_fin)h+='<div class="fc-sub">Du '+dateFr(conf.pfmp_debut)+' au '+dateFr(conf.pfmp_fin)+'</div>';
  h+='</div>';

  h+='<div class="check-item'+(fin.convention_envoyee?' done':'')+'" onclick="toggleFinal(\'convention_envoyee\')"><div class="check-box">'+(fin.convention_envoyee?'âœ“':'')+'</div><div class="check-label"><div class="cl-title">Convention envoyÃ©e Ã  l\'entreprise</div></div></div>';
  h+='<div class="check-item'+(fin.convention_signee_entreprise?' done':'')+'" onclick="toggleFinal(\'convention_signee_entreprise\')"><div class="check-box">'+(fin.convention_signee_entreprise?'âœ“':'')+'</div><div class="check-label"><div class="cl-title">Convention signÃ©e par l\'entreprise</div></div></div>';
  h+='<div class="check-item'+(fin.convention_signee_lycee?' done':'')+'" onclick="toggleFinal(\'convention_signee_lycee\')"><div class="check-box">'+(fin.convention_signee_lycee?'âœ“':'')+'</div><div class="check-label"><div class="cl-title">Convention signÃ©e par le lycÃ©e</div></div></div>';
  el.innerHTML=h;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   NAVIGATION
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function goStep(s){
  currentStep=s;
  document.querySelectorAll('.step-section').forEach(function(el){el.classList.remove('active')});
  var target=document.getElementById('step-'+s);
  if(target)target.classList.add('active');
  // Show FAB only on step 2
  var fab=document.getElementById('fab-add');
  if(fab)fab.style.display=(s===2)?'block':'none';
  // Update dots visually (current view, not saved step)
  document.querySelectorAll('.step-dot').forEach(function(d){
    var ds=parseInt(d.dataset.step);
    var saved=stageData.etape_courante||1;
    if(ds<saved)d.className='step-dot done';
    else if(ds===s)d.className='step-dot active';
    else d.className='step-dot future';
  });
}

function autoAdvanceStep(){
  var prep=stageData.preparation||{};
  var ents=Object.values(stageData.entreprises||{});
  var prepDone=[prep.cv,prep.lettre,prep.oral,prep.dates_connues,prep.secteur].filter(Boolean).length;
  var contacted=ents.filter(function(e){return e.statut&&e.statut!=='a_contacter'}).length;
  var accepted=ents.filter(function(e){return e.statut==='accepte'}).length;

  var newStep=1;
  if(prepDone>=3)newStep=2;
  if(ents.length>=3)newStep=Math.max(newStep,2);
  if(contacted>=1)newStep=Math.max(newStep,3);
  if(contacted>=2)newStep=Math.max(newStep,4);
  if(accepted>=1)newStep=5;

  var current=stageData.etape_courante||1;
  if(newStep>current){
    REF.child('etape_courante').set(newStep);
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STEP 1 HANDLERS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function togglePrep(el,key){
  var prep=stageData.preparation||{};
  var newVal=!prep[key];
  REF.child('preparation/'+key).set(newVal);
  autoAdvanceStep();
}

function savePfmpDates(){
  var d=document.getElementById('pfmp-debut').value;
  var f=document.getElementById('pfmp-fin').value;
  if(d)REF.child('config/pfmp_debut').set(d);
  if(f)REF.child('config/pfmp_fin').set(f);
  if(d&&f)REF.child('preparation/dates_connues').set(true);
  autoAdvanceStep();
}

function saveSecteur(){
  var v=document.getElementById('secteur-input').value.trim();
  if(v){
    REF.child('config/secteur_vise').set(v);
    REF.child('preparation/secteur').set(true);
    autoAdvanceStep();
  }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STEP 2 HANDLERS â€” ENTREPRISES
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openAddForm(){
  document.getElementById('form-add-ent').classList.add('show');
  document.getElementById('f-nom').value='';
  document.getElementById('f-ville').value='';
  document.getElementById('f-secteur').value='';
  document.getElementById('f-secteur-autre').style.display='none';
  document.getElementById('f-contact').value='';
  document.getElementById('f-tel').value='';
  document.getElementById('f-email').value='';
  document.getElementById('f-notes').value='';
  setTimeout(function(){document.getElementById('f-nom').focus()},100);
}

function saveEntreprise(){
  var nom=document.getElementById('f-nom').value.trim();
  var ville=document.getElementById('f-ville').value.trim();
  if(!nom){alert('Le nom est obligatoire');return}
  if(!ville){alert('La ville est obligatoire');return}
  var sectSel=document.getElementById('f-secteur');
  var secteur=sectSel.value==='__autre'?document.getElementById('f-secteur-autre').value.trim():sectSel.value;
  REF.child('entreprises').push({
    nom:nom,ville:ville,secteur:secteur||'',
    contact_nom:document.getElementById('f-contact').value.trim(),
    telephone:document.getElementById('f-tel').value.trim(),
    email:document.getElementById('f-email').value.trim(),
    statut:'a_contacter',
    notes:document.getElementById('f-notes').value.trim(),
    date_premier_contact:'',date_relance:'',
    created:new Date().toISOString()
  });
  closeForm('form-add-ent');
  autoAdvanceStep();
}

function toggleEnt(k){
  var card=document.getElementById('ent-'+k);
  if(card)card.classList.toggle('open');
}

function updateEntStatus(k,val){
  REF.child('entreprises/'+k+'/statut').set(val);
  if(val==='contacte'||val==='en_attente'||val==='relance'){
    var e=stageData.entreprises&&stageData.entreprises[k];
    if(e&&!e.date_premier_contact){
      REF.child('entreprises/'+k+'/date_premier_contact').set(new Date().toISOString().split('T')[0]);
    }
  }
  if(val==='accepte'){
    REF.child('config/stage_trouve').set(true);
    REF.child('finalisation/entreprise_id').set(k);
  }
  autoAdvanceStep();
}

function deleteEnt(k){
  if(confirm('Supprimer cette entreprise ?')){
    REF.child('entreprises/'+k).remove();
  }
}

function planRelance(k){
  var dateStr=prompt('Date de relance (JJ/MM) ?');
  if(!dateStr)return;
  // Try to parse JJ/MM or use as-is
  var parts=dateStr.split('/');
  var d;
  if(parts.length===2){
    var yr=new Date().getFullYear();
    d=yr+'-'+(parts[1].length===1?'0':'')+parts[1]+'-'+(parts[0].length===1?'0':'')+parts[0];
  }else{d=dateStr}
  REF.child('entreprises/'+k+'/date_relance').set(d);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   ACTIONS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function openActionForm(k){
  document.getElementById('fa-ent-id').value=k;
  document.getElementById('fa-date').value=new Date().toISOString().split('T')[0];
  document.getElementById('fa-resultat').value='';
  document.querySelectorAll('#fa-type-chips .contact-chip').forEach(function(c){c.classList.remove('active')});
  document.getElementById('form-add-action').classList.add('show');
}

function selectChip(el){
  el.parentNode.querySelectorAll('.contact-chip').forEach(function(c){c.classList.remove('active')});
  el.classList.add('active');
}

function saveAction(){
  var k=document.getElementById('fa-ent-id').value;
  var typeEl=document.querySelector('#fa-type-chips .contact-chip.active');
  var type=typeEl?typeEl.dataset.v:'autre';
  var date=document.getElementById('fa-date').value;
  var resultat=document.getElementById('fa-resultat').value.trim();

  REF.child('entreprises/'+k+'/actions').push({
    type:type,date:date||new Date().toISOString().split('T')[0],
    resultat:resultat,created:new Date().toISOString()
  });
  // Auto-update status if still a_contacter
  var e=stageData.entreprises&&stageData.entreprises[k];
  if(e&&e.statut==='a_contacter'){
    REF.child('entreprises/'+k+'/statut').set('contacte');
    REF.child('entreprises/'+k+'/date_premier_contact').set(date||new Date().toISOString().split('T')[0]);
  }
  closeForm('form-add-action');
  autoAdvanceStep();
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   STEP 5 HANDLERS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function toggleFinal(key){
  var fin=stageData.finalisation||{};
  REF.child('finalisation/'+key).set(!fin[key]);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   UTILITIES
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
function closeForm(id){document.getElementById(id).classList.remove('show')}
function dateFr(d){if(!d)return'â€”';return new Date(d).toLocaleDateString('fr-FR',{day:'numeric',month:'short'})}
function daysLeft(d){if(!d)return null;var t=new Date();t.setHours(0,0,0,0);var x=new Date(d);x.setHours(0,0,0,0);return Math.ceil((x-t)/864e5)}
function daysSince(d){if(!d)return null;var t=new Date();t.setHours(0,0,0,0);var x=new Date(d);x.setHours(0,0,0,0);return Math.floor((t-x)/864e5)}
function toggleAide(btn){btn.classList.toggle('open');var body=btn.nextElementSibling;if(body)body.classList.toggle('open')}

// Secteur "Autre" toggle
document.getElementById('f-secteur').addEventListener('change',function(){
  document.getElementById('f-secteur-autre').style.display=this.value==='__autre'?'block':'none';
});
</script>
</body>
</html>
