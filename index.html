<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Espace Réussite</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="js/firebase-config.js"></script>

    <style>
        :root { 
            --bg-app: #f8fafc; --surface: #ffffff; --text-main: #0f172a; --primary: #4f46e5; --radius: 10px;
            --cog-color: #3b82f6; --emo-color: #ec4899; --soc-color: #8b5cf6; --neu-color: #64748b;
        }
        body { background-color: var(--bg-app); color: var(--text-main); font-family: 'Outfit', sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        .app-header { background: var(--surface); padding: 1rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e2e8f0; z-index: 20; }
        .student-id { font-weight: 700; color: var(--text-main); font-size: 0.9rem; letter-spacing: 0.5px; text-transform: uppercase; }
        .btn-header { background: none; border: 1px solid #cbd5e1; color: var(--neu-color); padding: 4px 10px; border-radius: 6px; font-size: 0.75rem; font-weight: 600; text-decoration: none; }

        .app-content { flex: 1; overflow-y: auto; padding: 1rem; padding-bottom: 100px; display: none; }
        .app-content.active { display: block; }

        .mood-box { background: white; padding: 15px; border-radius: var(--radius); border: 1px solid #e2e8f0; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        
        .kpi-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 1.5rem; }
        .kpi-item { background: white; border-radius: var(--radius); padding: 10px 5px; text-align: center; border: 1px solid #e2e8f0; cursor: pointer; }
        .chart-mini { position: relative; height: 50px; width: 50px; margin: 0 auto 5px auto; }
        .kpi-title { font-weight: 700; font-size: 0.7rem; text-transform: uppercase; color: var(--neu-color); }

        .obj-card { background: white; border-radius: var(--radius); padding: 12px; margin-bottom: 8px; border: 1px solid #e2e8f0; border-left-width: 4px; display: flex; align-items: center; cursor: pointer; }
        .obj-card.cog { border-left-color: var(--cog-color); }
        .obj-card.emo { border-left-color: var(--emo-color); }
        .obj-card.soc { border-left-color: var(--soc-color); }
        .obj-card.neu { border-left-color: var(--neu-color); }
        
        .obj-content { flex: 1; margin-left: 10px; }
        .obj-title { font-weight: 600; font-size: 0.9rem; line-height: 1.2; margin-bottom: 4px; }
        .obj-meta { font-size: 0.75rem; color: #64748b; display: flex; gap: 8px; align-items: center; }
        .obj-badge { background: #f1f5f9; padding: 2px 6px; border-radius: 6px; font-weight: 700; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .obj-time { font-weight: 600; margin-left: auto; }
        .obj-time.urgent { color: #dc2626; }

        .btn-main { display: block; width: 100%; background: white; border: 1px solid #e2e8f0; padding: 12px; margin-bottom: 10px; border-radius: var(--radius); text-align: left; font-weight: 600; color: var(--primary); }
        .btn-add { background: var(--primary); color: white; text-align: center; border: none; }

        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid #e2e8f0; display: flex; justify-content: space-around; padding: 12px 0; z-index: 30; }
        .nav-btn { background: none; border: none; color: #94a3b8; font-size: 0.75rem; font-weight: 600; }
        .nav-btn.active { color: var(--primary); }

        .overlay-full { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f8fafc; z-index: 100; display: none; flex-direction: column; overflow-y: auto; }
        .overlay-header { padding: 1rem; background: white; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; }
        .step-content { padding: 1.1rem; flex: 1; }
        
        .list-btn { width: 100%; text-align: left; padding: 12px; margin-bottom: 8px; background: white; border: 1px solid #e2e8f0; border-radius: var(--radius); font-weight: 600; color: var(--text-main); }
        .list-btn:active, .list-btn.selected { background: #e0e7ff; border-color: var(--primary); color: var(--primary); font-weight: 800; }

        .form-label { font-size: 0.75rem; font-weight: 800; color: var(--neu-color); text-transform: uppercase; margin-bottom: 7px; display: block; }
        .form-control, .form-select, textarea.form-control { border-radius: 10px; border: 1px solid #cbd5e1; padding: 12px; width: 100%; margin-bottom: 15px; font-size: 0.95rem; }
        textarea.form-control { min-height: 90px; resize: none; }

        .hidden { display: none !important; }
        #qrcode-container { display: flex; justify-content: center; margin: 20px 0; padding: 10px; background: white; border-radius: 12px; }

        .breath-circle {
            width: 220px;
            height: 220px;
            border-radius: 999px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            border: 3px solid #e2e8f0;
            background: white;
            margin: 0 auto;
            transition: transform 5s linear;
        }
        .breath-circle.inhale { transform: scale(1.15); }
        .breath-circle.exhale { transform: scale(0.95); }

        /* WIZARD PREMIUM */
        .wiz-topbar { display:flex; justify-content:space-between; align-items:center; gap:10px; margin-bottom:14px; }
        .wiz-back { border:1px solid #cbd5e1; background:white; color:#334155; padding:8px 10px; border-radius:10px; font-weight:800; font-size:.85rem; }
        .wiz-pill { flex:1; background:white; border:1px solid #e2e8f0; border-radius:999px; padding:10px 12px; display:flex; justify-content:space-between; align-items:center; }
        .wiz-pill .k { font-size:.72rem; font-weight:900; color:#64748b; text-transform:uppercase; letter-spacing:.6px; }
        .wiz-pill .v { font-size:.9rem; font-weight:900; color:#0f172a; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; max-width:55%; text-align:right; }
        .wiz-section-title { font-weight:900; font-size:.78rem; color:#475569; text-transform:uppercase; letter-spacing:.7px; margin:14px 0 8px 0; display:flex; align-items:center; gap:8px; }
        .dot { width:10px; height:10px; border-radius:999px; display:inline-block; }
        .dot.cog { background: var(--cog-color); }
        .dot.emo { background: var(--emo-color); }
        .dot.soc { background: var(--soc-color); }
        .dot.neu { background: var(--neu-color); }

        .cps-grid { display:grid; grid-template-columns: repeat(2, 1fr); gap:10px; }
        .cps-tile { background:white; border:1px solid #e2e8f0; border-radius:14px; padding:12px; text-align:left; box-shadow: 0 1px 0 rgba(15,23,42,.03); transition: transform .06s ease; }
        .cps-tile:active { transform: scale(.99); }
        .cps-type { font-size:.70rem; font-weight:900; text-transform:uppercase; letter-spacing:.6px; color:#64748b; margin-bottom:6px; display:flex; align-items:center; gap:8px; }
        .cps-label { font-size:.92rem; font-weight:900; color:#0f172a; line-height:1.18; }
        .cps-sub { font-size:.78rem; color:#64748b; margin-top:6px; line-height:1.2; }
        .cps-tile.cog { border-left:5px solid var(--cog-color); }
        .cps-tile.emo { border-left:5px solid var(--emo-color); }
        .cps-tile.soc { border-left:5px solid var(--soc-color); }
        .cps-tile.neu { border-left:5px solid var(--neu-color); }

        .goal-chip { width:100%; background:white; border:1px solid #e2e8f0; border-radius:14px; padding:12px; text-align:left; margin-bottom:10px; }
        .goal-chip .h { font-weight:900; color:#0f172a; font-size:.92rem; }
        .goal-chip .m { margin-top:5px; color:#64748b; font-size:.78rem; line-height:1.2; }
        .goal-chip.cog { border-left:5px solid var(--cog-color); }
        .goal-chip.emo { border-left:5px solid var(--emo-color); }
        .goal-chip.soc { border-left:5px solid var(--soc-color); }
        .goal-chip.neu { border-left:5px solid var(--neu-color); }

        .big-type-row { display:grid; grid-template-columns: repeat(2, 1fr); gap:10px; }
        .big-type { background:white; border:1px solid #e2e8f0; border-radius:16px; padding:16px; font-weight:900; text-align:left; }
        .big-type.cog { border-left:6px solid var(--cog-color); }
        .big-type.emo { border-left:6px solid var(--emo-color); }
        .big-type.soc { border-left:6px solid var(--soc-color); }
        .big-type.neu { border-left:6px solid var(--neu-color); }
        .big-type small { display:block; margin-top:6px; color:#64748b; font-weight:700; }

    </style>
</head>
<body>

<div id="loader" style="position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; display:flex; align-items:center; justify-content:center;">
    <div class="spinner-border text-primary" role="status"></div>
</div>

<header class="app-header">
    <div class="student-id"><span id="display-code">--</span></div>
    <button class="btn-header" onclick="startBreathing()">Respiration</button>
</header>

<main class="app-content active" id="view-dashboard">
    <div class="mood-box" id="mood-box" style="display:none;">
        <div>
            <div style="font-size:0.75rem; color:#64748b; font-weight:600;">HUMEUR DU JOUR</div>
            <div style="font-weight:700; color:#4f46e5;" id="mood-display">--</div>
        </div>
        <button class="btn-header" onclick="openMoodModal()">Changer</button>
    </div>

    <div class="kpi-grid">
        <div class="kpi-item" onclick="openCircleDetail('COG')"><div class="chart-mini"><canvas id="chartCog"></canvas></div><div class="kpi-title">Cognitif</div></div>
        <div class="kpi-item" onclick="openCircleDetail('EMO')"><div class="chart-mini"><canvas id="chartEmo"></canvas></div><div class="kpi-title">Émotionnel</div></div>
        <div class="kpi-item" onclick="openCircleDetail('SOC')"><div class="chart-mini"><canvas id="chartSoc"></canvas></div><div class="kpi-title">Social</div></div>
    </div>

    <button class="btn-main btn-add" onclick="startGoalWizard()">+ Ajouter un objectif</button>
    <button class="btn-main" onclick="openRecoModal()">Ajouter une reconnaissance</button>
    <button class="btn-main" onclick="openAttestation()">Ma Synthèse CPS</button>

    <h6 style="font-weight:700; margin-top:20px; margin-bottom:10px; font-size:0.85rem; color:#334155;">OBJECTIFS À ATTEINDRE</h6>
    <div id="goals-list"></div>

    <div style="margin-top:20px; border-top:1px solid #e2e8f0; padding-top:10px;">
        <div onclick="toggleHistory()" style="cursor:pointer; font-size:0.8rem; font-weight:600; color:#64748b;">
            Voir les objectifs atteints ▼
        </div>
        <div id="history-list" style="display:none; margin-top:10px;"></div>
    </div>
</main>

<div class="bottom-nav">
    <button class="nav-btn active" onclick="switchView('dashboard')">ACCUEIL</button>
    <button class="nav-btn" onclick="openAttestation()">BILAN</button>
</div>

<div id="wizard-overlay" class="overlay-full">
    <div class="overlay-header">
        <h5 style="margin:0; font-weight:800;">Nouvel Objectif</h5>
        <button class="btn-header" onclick="closeWizard()">Fermer</button>
    </div>
    <div class="step-content" id="wizard-content"></div>
</div>

<div id="detail-overlay" class="overlay-full">
    <div class="overlay-header">
        <h5 style="margin:0; font-weight:800;">Détail Objectif</h5>
        <button class="btn-header" onclick="closeDetail()">Fermer</button>
    </div>
    <div class="step-content">
        <div class="mb-3">
            <span id="det-badge" class="obj-badge">CADRE</span>
        </div>
        
        <label class="form-label">Objectif</label>
        <input type="text" id="det-title" class="form-control" disabled style="background:#f1f5f9; font-weight:800;">
        <small class="text-muted d-block mb-3" id="det-help">Texte issu du référentiel (non modifiable).</small>

        <label class="form-label">Pour quand ?</label>
        <input type="date" id="det-date" class="form-control">

        <label class="form-label">Matière / Lieu</label>
        <input type="text" id="det-context" class="form-control">

        <button class="btn-main btn-add" onclick="saveDetail()">Enregistrer les modifications</button>

        <hr style="margin: 20px 0; border-color:#e2e8f0;">

        <button class="btn-main" style="border-color:#4f46e5; color:#4f46e5;" onclick="showQRForGoal()">Faire valider par un prof</button>
        <div id="qr-feedback" style="text-align:center; font-size:0.75rem; color:#64748b; margin-top:5px;"></div>
        
        <button class="btn-header w-100 mt-3" style="color:#dc2626; border-color:#fca5a5;" onclick="deleteGoal()">Supprimer</button>
    </div>
</div>

<div id="reco-overlay" class="overlay-full">
    <div class="overlay-header">
        <h5 style="margin:0; font-weight:800;">Reconnaissance</h5>
        <button class="btn-header" onclick="closeReco()">Fermer</button>
    </div>
    <div class="step-content" style="text-align:center;">
        <h6 class="form-label mb-4" style="text-align:center;">QUEL TYPE DE RÉUSSITE ?</h6>
        <button class="btn-main" style="border-left:5px solid var(--cog-color);" onclick="generateRecoQR('COG')">Cognitif</button>
        <button class="btn-main" style="border-left:5px solid var(--emo-color);" onclick="generateRecoQR('EMO')">Émotionnel</button>
        <button class="btn-main" style="border-left:5px solid var(--soc-color);" onclick="generateRecoQR('SOC')">Social</button>
        <button class="btn-main" style="border-left:5px solid var(--neu-color);" onclick="generateRecoQR('AUTRE')">Autre</button>
    </div>
</div>

<div id="qr-overlay" class="overlay-full" style="justify-content:center; align-items:center;">
    <div style="text-align:center; padding:20px;">
        <h4 style="font-weight:900; margin-bottom:20px;">Faire valider</h4>
        <div id="qrcode-container"></div>
        <p class="text-muted small mt-3">Présente ce code à l'adulte.</p>
        <button class="btn-header" onclick="document.getElementById('qr-overlay').style.display='none'">Fermer</button>
    </div>
</div>

<div id="mood-overlay" class="overlay-full">
    <div class="overlay-header"><h5 style="margin:0; font-weight:800;">Météo du jour</h5></div>
    <div class="step-content" id="mood-content"></div>
</div>

<div id="circle-overlay" class="overlay-full">
    <div class="overlay-header"><h5 id="circle-title" style="margin:0; font-weight:800;">--</h5><button class="btn-header" onclick="closeCircle()">Fermer</button></div>
    <div class="step-content" id="circle-content"></div>
</div>

<div id="attestation-overlay" class="overlay-full">
    <div class="overlay-header no-print"><h5 style="margin:0; font-weight:800;">Synthèse</h5><button class="btn-header" onclick="document.getElementById('attestation-overlay').style.display='none'">Fermer</button></div>
    <div class="step-content" id="attestation-content">
        <h3 class="fw-bold mb-4 text-center">Profil de Compétences</h3>
        <div class="card p-3 mb-3" style="border-left:5px solid var(--cog-color)"><h5 style="color:var(--cog-color); margin:0 0 10px 0; font-weight:900;">Cognitif</h5><p id="syn-cog" class="small m-0 text-muted">...</p></div>
        <div class="card p-3 mb-3" style="border-left:5px solid var(--emo-color)"><h5 style="color:var(--emo-color); margin:0 0 10px 0; font-weight:900;">Émotionnel</h5><p id="syn-emo" class="small m-0 text-muted">...</p></div>
        <div class="card p-3 mb-3" style="border-left:5px solid var(--soc-color)"><h5 style="color:var(--soc-color); margin:0 0 10px 0; font-weight:900;">Social</h5><p id="syn-soc" class="small m-0 text-muted">...</p></div>
        <button class="btn-main no-print mt-4" onclick="window.print()">Imprimer</button>
    </div>
</div>

<div id="breath-overlay" class="overlay-full" style="justify-content:center;">
    <div class="text-center" style="padding:24px;">
        <div id="breath-circle" class="breath-circle">Prêt</div>
        <button class="btn-header mt-4" onclick="stopBreathing()">Fermer</button>
    </div>
</div>

<script>
    if (typeof firebaseConfig !== 'undefined') firebase.initializeApp(firebaseConfig);
    let userCode = new URLSearchParams(window.location.search).get("id");

    window.addEventListener('load', () => {
        setTimeout(() => {
            document.getElementById('loader').style.display = 'none';
            if(!userCode) {
                userCode = "KA47";
                document.getElementById('display-code').innerText = "KA47 (TEST)";
            }
            loadData();
        }, 2000);
    });

    let userData = {};
    let draft = {};
    let currentEditId = null;
    let charts = {};
    let breathInterval = null;

    const MATIERES = ["Français","Maths","Anglais","Espagnol","Hist-Géo","Eco-Droit","Ens. Pro","PSE","Arts","EPS","Autre"];
    const EMOTIONS = {
        "Joie": ["Satisfait","Fier","Enthousiaste"], "Tristesse": ["Déçu","Découragé"], "Colère": ["Agacé","Frustré"],
        "Peur": ["Inquiet","Stressé"], "Dégoût": ["Gêné"], "Surprise": ["Étonné"]
    };

    /* BIBLIOTHÈQUE CPS (VERSION 1) 
       Tu l’enrichiras ensuite avec ton PDF : ici on met déjà une base solide et premium.
       Structure : par cadre -> liste CPS (id, type, label, sub, goals[])
    */
    const CPS_LIB = {
        "Scolaire": [
            { id:"SC_COG_CONS", type:"COG", label:"Comprendre une consigne", sub:"Je clarifie avant d’agir", goals:[
                "Reformuler la consigne avec mes mots",
                "Repérer les verbes d’action dans la consigne",
                "Demander une précision si je bloque",
                "Surligner les informations utiles"
            ]},
            { id:"SC_COG_FOCUS", type:"COG", label:"Me concentrer", sub:"Je garde mon attention", goals:[
                "Me mettre en mode sans distractions 10 minutes",
                "Faire une chose à la fois",
                "Me remettre au travail après une interruption",
                "Finir une tâche commencée"
            ]},
            { id:"SC_COG_ORGA", type:"COG", label:"M’organiser", sub:"Matériel et méthode", goals:[
                "Préparer mon matériel avant de commencer",
                "Planifier mon travail en 3 étapes",
                "Noter les devoirs / échéances du jour",
                "Vérifier mon travail avant de rendre"
            ]},
            { id:"SC_COG_AUTON", type:"COG", label:"Gagner en autonomie", sub:"Je gère sans dépendre", goals:[
                "Chercher une solution avant de demander",
                "Utiliser une fiche / un modèle",
                "Relire mon cours pour trouver l’info",
                "Faire une auto-vérification simple"
            ]},

            { id:"SC_EMO_STRESS", type:"EMO", label:"Réguler mon stress", sub:"Je redescends vite", goals:[
                "Faire 3 respirations avant de répondre",
                "Me calmer avant une évaluation",
                "Utiliser une phrase rassurante (je peux y arriver)",
                "Demander une pause courte si besoin"
            ]},
            { id:"SC_EMO_CONF", type:"EMO", label:"Prendre confiance", sub:"Je me valorise", goals:[
                "Noter 1 réussite du jour",
                "Oser tenter même si je ne suis pas sûr",
                "Accepter une erreur sans me dévaloriser",
                "Me féliciter après un effort"
            ]},
            { id:"SC_EMO_COL", type:"EMO", label:"Gérer la frustration", sub:"Je reste stable", goals:[
                "Ne pas abandonner au premier blocage",
                "Dire ce que je ressens sans exploser",
                "Revenir au calme en 2 minutes",
                "Accepter une correction sans me braquer"
            ]},

            { id:"SC_SOC_ECOUTE", type:"SOC", label:"Écouter sans couper", sub:"Je respecte la parole", goals:[
                "Laisser parler jusqu’au bout",
                "Regarder la personne qui parle",
                "Reformuler ce que j’ai compris",
                "Poser une question après écoute"
            ]},
            { id:"SC_SOC_ORAL", type:"SOC", label:"Participer à l’oral", sub:"Je prends ma place", goals:[
                "Lever la main 1 fois aujourd’hui",
                "Parler clairement en une phrase",
                "Oser poser une question",
                "Exprimer mon avis avec respect"
            ]},
            { id:"SC_SOC_GRP", type:"SOC", label:"Travailler en groupe", sub:"Je coopère", goals:[
                "Me répartir une tâche et la tenir",
                "Aider sans faire à la place",
                "Encourager un camarade",
                "Garder un ton calme en équipe"
            ]}
        ],

        "PFMP": [
            { id:"PF_COG_PROC", type:"COG", label:"Appliquer une procédure", sub:"Je respecte les étapes", goals:[
                "Lire la consigne pro avant d’agir",
                "Suivre l’ordre des étapes",
                "Vérifier le résultat à la fin",
                "Demander validation au bon moment"
            ]},
            { id:"PF_COG_TEMPS", type:"COG", label:"Gérer mon temps", sub:"Je tiens le rythme", goals:[
                "Commencer dès qu’on me confie une tâche",
                "Finir dans le temps donné",
                "Prévenir si je suis en retard",
                "Prioriser l’essentiel"
            ]},
            { id:"PF_COG_SECUR", type:"COG", label:"Respecter la sécurité", sub:"Je travaille sans risque", goals:[
                "Porter les EPI sans qu’on me le rappelle",
                "Ranger l’espace de travail",
                "Signaler un danger à un adulte",
                "Appliquer une consigne de sécurité"
            ]},

            { id:"PF_EMO_STRESS", type:"EMO", label:"Gérer la pression", sub:"Je reste pro", goals:[
                "Rester calme si on me reprend",
                "Respirer avant de répondre",
                "Demander une précision sans peur",
                "Continuer malgré une erreur"
            ]},
            { id:"PF_EMO_MOTIV", type:"EMO", label:"Rester motivé", sub:"Je tiens l’effort", goals:[
                "Faire la tâche jusqu’au bout",
                "Accepter une tâche répétitive",
                "Me fixer un mini-objectif dans la journée",
                "Faire preuve d’initiative simple"
            ]},

            { id:"PF_SOC_POLI", type:"SOC", label:"Communiquer poliment", sub:"Formules pro", goals:[
                "Saluer en arrivant et en partant",
                "Dire merci / s’il vous plaît",
                "Parler avec un ton adapté",
                "Demander de l’aide correctement"
            ]},
            { id:"PF_SOC_HIER", type:"SOC", label:"Respecter la hiérarchie", sub:"Je m’adresse bien", goals:[
                "Identifier la bonne personne à qui parler",
                "Prévenir mon tuteur avant une action",
                "Accepter une consigne sans discuter",
                "Faire un retour clair en fin de tâche"
            ]}
        ],

        "Recherche": [
            { id:"RE_COG_PLAN", type:"COG", label:"Planifier mes démarches", sub:"Je m’organise", goals:[
                "Faire une liste de 5 entreprises",
                "Prévoir 2 actions par jour",
                "Noter les réponses reçues",
                "Préparer un message type"
            ]},
            { id:"RE_COG_CV", type:"COG", label:"Améliorer mon CV", sub:"Je rends pro", goals:[
                "Corriger les fautes",
                "Ajouter une expérience / compétence",
                "Adapter le CV à un métier",
                "Mettre en page proprement"
            ]},
            { id:"RE_EMO_OSER", type:"EMO", label:"Oser contacter", sub:"Je dépasse la peur", goals:[
                "Appeler 1 entreprise aujourd’hui",
                "Envoyer 2 candidatures",
                "Relancer poliment après 3 jours",
                "Me récompenser après l’effort"
            ]},
            { id:"RE_EMO_PERS", type:"EMO", label:"Persévérer", sub:"Je ne lâche pas", goals:[
                "Faire 1 action même si j’ai peur",
                "Continuer après un refus",
                "Garder un rythme régulier",
                "Demander un avis pour progresser"
            ]},
            { id:"RE_SOC_ENT", type:"SOC", label:"Se présenter", sub:"Message clair", goals:[
                "Dire qui je suis en 10 secondes",
                "Expliquer ce que je cherche",
                "Poser une question pro",
                "Remercier et conclure"
            ]},
            { id:"RE_SOC_MAIL", type:"SOC", label:"Écrire un message pro", sub:"Mail / SMS", goals:[
                "Écrire un mail court et poli",
                "Mettre un objet clair",
                "Joindre le bon fichier",
                "Relire avant d’envoyer"
            ]}
        ],

        "Autre": []
    };

    function loadData() {
        if(!userCode) return;
        document.getElementById('display-code').innerText = userCode;
        firebase.database().ref(`accompagnement/eleves/${userCode}`).on('value', (snap) => {
            userData = snap.val() || { objectifs: {}, meteo: {} };
            renderDashboard();
            checkMood();
            renderAttestation();
        });
    }

    function renderDashboard() {
        const list = document.getElementById('goals-list'); list.innerHTML = '';
        const hist = document.getElementById('history-list'); hist.innerHTML = '';
        const goals = userData.objectifs || {};
        const keys = Object.keys(goals);
        let counts = {COG:0, EMO:0, SOC:0};

        keys.sort((a,b) => {
            const da = new Date(goals[a].date_cible || '2099-01-01');
            const db = new Date(goals[b].date_cible || '2099-01-01');
            return da - db;
        });

        keys.forEach(k => {
            const g = goals[k];

            let rawType = (g.type || 'AUTRE').toUpperCase();
            let typeClass = 'neu';
            if(rawType.includes('COG')) typeClass = 'cog';
            else if(rawType.includes('EMO')) typeClass = 'emo';
            else if(rawType.includes('SOC')) typeClass = 'soc';

            let timeStr = "Date à définir";
            let urgentClass = "";
            if(g.date_cible) {
                const today = new Date(); today.setHours(0,0,0,0);
                const target = new Date(g.date_cible); target.setHours(0,0,0,0);
                const diff = Math.ceil((target - today) / (86400000));
                if(!isNaN(diff)) {
                    if(diff < 0) { timeStr = "Dépassé"; urgentClass = "urgent"; }
                    else if(diff === 0) { timeStr = "Aujourd'hui"; }
                    else { timeStr = `J-${diff}`; }
                }
            }

            if(g.done) {
                if(rawType.includes('COG')) counts.COG++;
                else if(rawType.includes('EMO')) counts.EMO++;
                else if(rawType.includes('SOC')) counts.SOC++;

                hist.innerHTML += `
                <div class="obj-card ${typeClass}" style="opacity:0.6; cursor:default;">
                    <div class="obj-content">
                        <div class="obj-title" style="text-decoration:line-through;">${g.titre || ''}</div>
                        <div class="obj-meta">Validé le ${new Date(g.date_done || Date.now()).toLocaleDateString()}</div>
                    </div>
                </div>`;
            } else {
                list.innerHTML += `
                <div class="obj-card ${typeClass}" onclick="openDetail('${k}')">
                    <div style="display:flex; align-items:center; margin-right:12px;">
                        <input type="checkbox" onclick="event.stopPropagation(); toggleGoal('${k}', true)" style="width:22px;height:22px; cursor:pointer;">
                    </div>
                    <div class="obj-content" style="flex:1;">
                        <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                            <span class="obj-title">${g.titre || ''}</span>
                            <span class="obj-badge">${(g.context || 'Autre')}</span>
                        </div>
                        <div class="obj-meta" style="display:flex; justify-content:space-between; margin-top:6px;">
                            <span>${g.detail || ''}</span>
                            <span class="obj-time ${urgentClass}">${timeStr}</span>
                        </div>
                    </div>
                </div>`;
            }
        });

        if(list.innerHTML === '') list.innerHTML = '<div style="text-align:center; color:#94a3b8; font-style:italic; padding:20px;">Aucun objectif en cours.</div>';

        ['Cog','Emo','Soc'].forEach(t => {
            const id = 'chart' + t;
            const canvas = document.getElementById(id);
            if(!canvas) return;
            if(charts[id]) charts[id].destroy();
            charts[id] = new Chart(canvas, {
                type:'doughnut',
                data:{datasets:[{data:[counts[t.toUpperCase()], 10], backgroundColor:['#4f46e5','#f1f5f9'], borderWidth:0}]},
                options:{cutout:'75%', events:[], plugins:{tooltip:false}}
            });
        });
    }

    function toggleGoal(k, status) {
        if(confirm("As-tu atteint cet objectif ?")) {
            firebase.database().ref(`accompagnement/eleves/${userCode}/objectifs/${k}`).update({done: status, date_done: new Date().toISOString()});
        } else {
            renderDashboard();
        }
    }

    /* WIZARD NOUVELLE LOGIQUE
       1) Cadre
       2) Choix CPS (boutons couleurs)  -> fixe automatiquement type (COG/EMO/SOC/AUTRE)
       3) Choix objectif concret (savoir-faire) selon cadre + CPS (boutons)
       4) Date
       5) Matière/Lieu
       6) Récap
    */
    window.startGoalWizard = function() { 
        draft = {
            context: null,
            type: null,
            cps_id: null,
            cps_label: null,
            titre: null,
            origin: null,
            date: null,
            detail: null
        }; 
        document.getElementById('wizard-overlay').style.display='flex'; 
        wizStep(1); 
    }

    function typeClass(type) {
        const t = (type || 'AUTRE').toUpperCase();
        if(t.includes('COG')) return 'cog';
        if(t.includes('EMO')) return 'emo';
        if(t.includes('SOC')) return 'soc';
        return 'neu';
    }

    function prettyType(type) {
        const t = (type || 'AUTRE').toUpperCase();
        if(t === 'COG') return 'Cognitif';
        if(t === 'EMO') return 'Émotionnel';
        if(t === 'SOC') return 'Social';
        return 'Autre';
    }

    function wizTop(s) {
        const back = s > 1 ? `<button class="wiz-back" onclick="wizStep(${s-1})">Retour</button>` : `<span style="width:74px;"></span>`;
        const vContext = draft.context ? draft.context : "Cadre";
        const vType = draft.type ? prettyType(draft.type) : "CPS";
        return `
            <div class="wiz-topbar">
                ${back}
                <div class="wiz-pill">
                    <span class="k">Cadre</span>
                    <span class="v">${vContext}</span>
                </div>
                <div class="wiz-pill">
                    <span class="k">Type</span>
                    <span class="v">${vType}</span>
                </div>
            </div>
        `;
    }

    function getCpsListForContext(ctx) {
        if(!ctx) return [];
        return CPS_LIB[ctx] || [];
    }

    function getCpsById(ctx, id) {
        const arr = getCpsListForContext(ctx);
        return arr.find(x => x.id === id) || null;
    }

    function cpsSection(title, dotClass, items) {
        if(!items || items.length === 0) return '';
        const tiles = items.map(c => `
            <button class="cps-tile ${typeClass(c.type)}" onclick="selectCPS('${c.id}')">
                <div class="cps-type"><span class="dot ${typeClass(c.type)}"></span>${prettyType(c.type)}</div>
                <div class="cps-label">${c.label}</div>
                <div class="cps-sub">${c.sub || ''}</div>
            </button>
        `).join('');
        return `
            <div class="wiz-section-title"><span class="dot ${dotClass}"></span>${title}</div>
            <div class="cps-grid">${tiles}</div>
        `;
    }

    window.selectCPS = function(cpsId) {
        const cps = getCpsById(draft.context, cpsId);
        if(!cps) return;
        draft.cps_id = cps.id;
        draft.cps_label = cps.label;
        draft.type = cps.type || 'AUTRE';
        draft.origin = 'lib';
        wizStep(3);
    }

    function wizStep(s) {
        const c = document.getElementById('wizard-content'); 
        c.innerHTML = '';

        if(s===1) {
            c.innerHTML = `
                ${wizTop(1)}
                <div style="background:white; border:1px solid #e2e8f0; border-radius:16px; padding:14px; margin-bottom:12px;">
                    <div class="form-label" style="margin:0;">Choisis un cadre</div>
                    <div style="margin-top:8px; font-size:.85rem; color:#64748b; font-weight:700;">Le cadre va adapter la bibliothèque de compétences et d’objectifs.</div>
                </div>
                <button class="list-btn" onclick="draft.context='Scolaire'; wizStep(2)">Scolaire</button>
                <button class="list-btn" onclick="draft.context='PFMP'; wizStep(2)">PFMP / Stage</button>
                <button class="list-btn" onclick="draft.context='Recherche'; wizStep(2)">Recherche de stage</button>
                <button class="list-btn" onclick="draft.context='Autre'; wizStep(2)">Autre (Libre)</button>
            `;
        }

        else if(s===2) {
            // CAS "AUTRE" = l’élève choisit le type puis écrit son objectif (sans prompt)
            if(draft.context === 'Autre') {
                c.innerHTML = `
                    ${wizTop(2)}
                    <div style="background:white; border:1px solid #e2e8f0; border-radius:16px; padding:14px; margin-bottom:12px;">
                        <div class="form-label" style="margin:0;">Choisis un type</div>
                        <div style="margin-top:8px; font-size:.85rem; color:#64748b; font-weight:700;">Ici, tout est libre. Tu écriras ton objectif ensuite.</div>
                    </div>
                    <div class="big-type-row">
                        <button class="big-type cog" onclick="draft.type='COG'; draft.cps_id=null; draft.cps_label=null; draft.origin='free'; wizStep(3)">
                            Cognitif
                            <small>Comprendre, s’organiser, apprendre</small>
                        </button>
                        <button class="big-type emo" onclick="draft.type='EMO'; draft.cps_id=null; draft.cps_label=null; draft.origin='free'; wizStep(3)">
                            Émotionnel
                            <small>Stress, confiance, frustration</small>
                        </button>
                        <button class="big-type soc" onclick="draft.type='SOC'; draft.cps_id=null; draft.cps_label=null; draft.origin='free'; wizStep(3)">
                            Social
                            <small>Communication, écoute, coopération</small>
                        </button>
                        <button class="big-type neu" onclick="draft.type='AUTRE'; draft.cps_id=null; draft.cps_label=null; draft.origin='free'; wizStep(3)">
                            Autre
                            <small>Objectif personnel</small>
                        </button>
                    </div>
                `;
                return;
            }

            // Autres cadres : affichage bibliothèque CPS (boutons couleurs)
            const cpsArr = getCpsListForContext(draft.context);
            const cog = cpsArr.filter(x => (x.type||'').toUpperCase()==='COG');
            const emo = cpsArr.filter(x => (x.type||'').toUpperCase()==='EMO');
            const soc = cpsArr.filter(x => (x.type||'').toUpperCase()==='SOC');

            c.innerHTML = `
                ${wizTop(2)}
                <div style="background:white; border:1px solid #e2e8f0; border-radius:16px; padding:14px; margin-bottom:12px;">
                    <div class="form-label" style="margin:0;">Choisis une compétence</div>
                    <div style="margin-top:8px; font-size:.85rem; color:#64748b; font-weight:700;">Clique sur une CPS : le type se sélectionne automatiquement.</div>
                </div>
                ${cpsSection("Cognitif", "cog", cog)}
                ${cpsSection("Émotionnel", "emo", emo)}
                ${cpsSection("Social", "soc", soc)}
                <div style="height:8px;"></div>
                <button class="list-btn" onclick="draft.type='AUTRE'; draft.cps_id=null; draft.cps_label=null; draft.origin='free'; wizStep(3)">Autre (objectif libre)</button>
            `;
        }

        else if(s===3) {
            // Si libre : on écrit l’objectif directement (sans prompt)
            if(draft.origin === 'free' || !draft.cps_id) {
                c.innerHTML = `
                    ${wizTop(3)}
                    <div style="background:white; border:1px solid #e2e8f0; border-radius:16px; padding:14px; margin-bottom:12px;">
                        <div class="form-label" style="margin:0;">Écris ton objectif</div>
                        <div style="margin-top:8px; font-size:.85rem; color:#64748b; font-weight:700;">Court, concret, réalisable.</div>
                    </div>
                    <label class="form-label">Objectif</label>
                    <textarea id="w-free-goal" class="form-control" placeholder="Ex : Me remettre au calme quand je suis agacé"></textarea>
                    <button class="btn-main btn-add" onclick="setFreeGoalAndContinue()">Continuer</button>
                `;
                return;
            }

            // Bibliothèque : choix des objectifs concrets (savoir-faire) liés à la CPS
            const cps = getCpsById(draft.context, draft.cps_id);
            const goals = (cps && cps.goals) ? cps.goals : [];
            const tClass = typeClass(draft.type);

            let goalButtons = goals.map(g => `
                <button class="goal-chip ${tClass}" onclick="draft.titre=${JSON.stringify(g)}; wizStep(4)">
                    <div class="h">${g}</div>
                    <div class="m">${draft.context} • ${prettyType(draft.type)} • ${cps.label}</div>
                </button>
            `).join('');

            goalButtons += `
                <button class="goal-chip neu" onclick="openCustomGoalFromCps()">
                    <div class="h">Autre (écrire mon objectif)</div>
                    <div class="m">Même CPS, mais objectif personnalisé</div>
                </button>
            `;

            c.innerHTML = `
                ${wizTop(3)}
                <div style="background:white; border:1px solid #e2e8f0; border-radius:16px; padding:14px; margin-bottom:12px;">
                    <div class="form-label" style="margin:0;">Choisis un objectif concret</div>
                    <div style="margin-top:8px; font-size:.85rem; color:#64748b; font-weight:800;">
                        <span style="display:inline-flex; align-items:center; gap:8px;">
                            <span class="dot ${tClass}"></span>${cps.label}
                        </span>
                    </div>
                </div>
                ${goalButtons}
            `;
        }

        else if(s===4) {
            const today = new Date().toISOString().split('T')[0];
            c.innerHTML = `
                ${wizTop(4)}
                <div style="background:white; border:1px solid #e2e8f0; border-radius:16px; padding:14px; margin-bottom:12px;">
                    <div class="form-label" style="margin:0;">Choisis une date</div>
                    <div style="margin-top:8px; font-size:.85rem; color:#64748b; font-weight:700;">Une date proche et réaliste.</div>
                </div>
                <label class="form-label">Pour quand ?</label>
                <input type="date" id="w-date" class="form-control" value="${draft.date || today}">
                <button class="btn-main btn-add" onclick="draft.date=document.getElementById('w-date').value; wizStep(5)">Continuer</button>
            `;
        }

        else if(s===5) {
            let inputHtml = `<input type="text" id="w-det" class="form-control" placeholder="Précise le lieu, la matière, le contexte...">`;
            if(draft.context === 'Scolaire') {
                inputHtml = `<select id="w-det" class="form-select">${MATIERES.map(m=>`<option value="${m}">${m}</option>`).join('')}</select>`;
            }
            c.innerHTML = `
                ${wizTop(5)}
                <div style="background:white; border:1px solid #e2e8f0; border-radius:16px; padding:14px; margin-bottom:12px;">
                    <div class="form-label" style="margin:0;">Matière / Lieu</div>
                    <div style="margin-top:8px; font-size:.85rem; color:#64748b; font-weight:700;">Ça aide à se rappeler quand utiliser l’objectif.</div>
                </div>
                <label class="form-label">Contexte</label>
                ${inputHtml}
                <button class="btn-main btn-add" onclick="draft.detail=document.getElementById('w-det').value; wizStep(6)">Continuer</button>
            `;
        }

        else if(s===6) {
            const tClass = typeClass(draft.type);
            const cpsLine = draft.cps_label ? `<div style="margin-top:6px; color:#64748b; font-weight:800; font-size:.85rem;"><span class="dot ${tClass}" style="margin-right:8px;"></span>${draft.cps_label}</div>` : '';
            c.innerHTML = `
                ${wizTop(6)}
                <div style="background:white; border:1px solid #e2e8f0; border-radius:18px; padding:16px; margin-bottom:12px;">
                    <div class="form-label" style="margin:0;">Récapitulatif</div>
                    <div style="margin-top:10px; font-weight:900; font-size:1.02rem; color:#0f172a;">${draft.titre || ''}</div>
                    ${cpsLine}
                    <div style="margin-top:10px; display:flex; gap:8px; flex-wrap:wrap;">
                        <span class="obj-badge">${draft.context || ''}</span>
                        <span class="obj-badge">${prettyType(draft.type)}</span>
                        <span class="obj-badge">${draft.detail || 'Non précisé'}</span>
                        <span class="obj-badge">${draft.date || ''}</span>
                    </div>
                </div>
                <button class="btn-main btn-add" onclick="saveWizard()">Valider l'objectif</button>
            `;
        }
    }

    window.setFreeGoalAndContinue = function() {
        const v = (document.getElementById('w-free-goal')?.value || '').trim();
        if(!v) return;
        draft.titre = v;
        if(!draft.origin) draft.origin = 'free';
        wizStep(4);
    }

    window.openCustomGoalFromCps = function() {
        const v = prompt("Écris ton objectif (court et concret) :");
        if(!v) return;
        draft.titre = v.trim();
        draft.origin = 'free';
        wizStep(4);
    }

    window.saveWizard = function() {
        if(!draft.date) draft.date = new Date().toISOString().split('T')[0];
        const payload = {
            context: draft.context || 'Autre',
            type: (draft.type || 'AUTRE'),
            titre: draft.titre || '',
            date_cible: draft.date,
            detail: (draft.detail && String(draft.detail).trim()) ? String(draft.detail).trim() : 'Non précisé',
            done: false,
            created: new Date().toISOString(),
            origin: draft.origin || 'lib',
            cps_id: draft.cps_id || "",
            cps_label: draft.cps_label || ""
        };
        firebase.database().ref(`accompagnement/eleves/${userCode}/objectifs`).push(payload);
        document.getElementById('wizard-overlay').style.display='none';
    }

    window.closeWizard = function(){document.getElementById('wizard-overlay').style.display='none';}

    window.openDetail = function(k) {
        currentEditId = k;
        const g = userData.objectifs?.[k];
        if(!g) return;

        document.getElementById('det-badge').innerText = (g.context || 'AUTRE').toUpperCase();
        document.getElementById('det-title').value = g.titre || '';
        document.getElementById('det-date').value = g.date_cible || '';
        document.getElementById('det-context').value = g.detail || '';

        const isFree = (g.context === 'Autre' || g.type === 'AUTRE' || g.origin === 'free');
        document.getElementById('det-title').disabled = !isFree;
        document.getElementById('det-help').style.display = isFree ? 'none' : 'block';

        const feedback = document.getElementById('qr-feedback');
        if(feedback) feedback.innerText = '';

        document.getElementById('detail-overlay').style.display='flex';
    }

    window.saveDetail = function() {
        const d = document.getElementById('det-date').value;
        const c = document.getElementById('det-context').value;
        const t = document.getElementById('det-title').value;
        let up = {date_cible:d, detail:c};
        if(!document.getElementById('det-title').disabled) up.titre = t;
        firebase.database().ref(`accompagnement/eleves/${userCode}/objectifs/${currentEditId}`).update(up);
        document.getElementById('detail-overlay').style.display='none';
    }

    window.deleteGoal = function() {
        if(confirm("Supprimer ?")) {
            firebase.database().ref(`accompagnement/eleves/${userCode}/objectifs/${currentEditId}`).remove();
            document.getElementById('detail-overlay').style.display='none';
        }
    }

    window.closeDetail = function(){document.getElementById('detail-overlay').style.display='none';}

    window.showQRForGoal = function() {
        if(!currentEditId || !userData.objectifs || !userData.objectifs[currentEditId]) {
            const feedback = document.getElementById('qr-feedback');
            if(feedback) feedback.innerText = "Erreur : objectif introuvable";
            return;
        }
        const g = userData.objectifs[currentEditId];
        const p = {
            eleve: userCode,
            objectif: currentEditId,
            competence: g.type || 'AUTRE',
            timestamp: Date.now(),
            cadre: g.context || 'Autre',
            flux: 1,
            ref_id_officiel: "",
            cps_id: g.cps_id || "",
            cps_label: g.cps_label || ""
        };
        generateQR(JSON.stringify(p));
    }

    window.openRecoModal = function() { document.getElementById('reco-overlay').style.display='flex'; }
    window.closeReco = function() { document.getElementById('reco-overlay').style.display='none'; }
    window.generateRecoQR = function(type) {
        const p = {
            eleve: userCode,
            type_reconnaissance: type,
            competence: type,
            flux: 2,
            timestamp: Date.now(),
            cadre: "Autre",
            ref_id_officiel: ""
        };
        generateQR(JSON.stringify(p));
        closeReco();
    }

    function generateQR(txt) {
        document.getElementById('qrcode-container').innerHTML = '';
        new QRCode(document.getElementById('qrcode-container'), { text: txt, width: 200, height: 200 });
        document.getElementById('qr-overlay').style.display='flex';
    }

    function checkMood() {
        const today = new Date().toISOString().split('T')[0];
        const m = (userData.meteo && userData.meteo[today]);
        if(m) {
            document.getElementById('mood-box').style.display='flex';
            document.getElementById('mood-display').innerText = m.secondary;
        } else {
            openMoodModal();
        }
    }

    window.openMoodModal = function() {
        document.getElementById('mood-overlay').style.display='flex';
        let h = `<h5 style="font-weight:900;">1. Émotion principale</h5>`;
        Object.keys(EMOTIONS).forEach(k => h+=`<button class="list-btn" onclick="moodStep2('${k}')">${k}</button>`);
        document.getElementById('mood-content').innerHTML = h;
    }

    window.moodStep2 = function(p) {
        let h = `<h5 style="font-weight:900;">2. Précisons (${p})</h5>`;
        EMOTIONS[p].forEach(s => h+=`<button class="list-btn" onclick="saveMood('${p}','${s}')">${s}</button>`);
        document.getElementById('mood-content').innerHTML = h;
    }

    window.saveMood = function(p, s) {
        const today = new Date().toISOString().split('T')[0];
        firebase.database().ref(`accompagnement/eleves/${userCode}/meteo/${today}`).set({primary:p, secondary:s});
        document.getElementById('mood-overlay').style.display='none';
    }

    window.openCircleDetail = function(t) {
        document.getElementById('circle-title').innerText = t;
        document.getElementById('circle-overlay').style.display='flex';
        document.getElementById('circle-content').innerHTML = "<p class='text-muted'>Historique complet ici...</p>";
    }

    window.closeCircle = function(){document.getElementById('circle-overlay').style.display='none';}

    window.openAttestation = function() { document.getElementById('attestation-overlay').style.display='flex'; }

    window.renderAttestation = function() {
        document.getElementById('syn-cog').innerText = "Analyse des objectifs cognitifs...";
        document.getElementById('syn-emo').innerText = "Analyse des objectifs émotionnels...";
        document.getElementById('syn-soc').innerText = "Analyse des objectifs sociaux...";
    }

    window.switchView = function(v) {
        document.querySelectorAll('.app-content').forEach(e => e.classList.remove('active'));
        document.getElementById('view-'+v).classList.add('active');
    }

    window.toggleHistory = function() {
        const h = document.getElementById('history-list');
        h.style.display = h.style.display==='none' ? 'block' : 'none';
    }

    window.startBreathing = function() {
        document.getElementById('breath-overlay').style.display='flex';
        const circle = document.getElementById('breath-circle');
        if(breathInterval) clearInterval(breathInterval);

        function cycle() {
            circle.innerText = "Inspirer 5s";
            circle.className = "breath-circle inhale";
            setTimeout(() => {
                circle.innerText = "Expirer 6s";
                circle.className = "breath-circle exhale";
            }, 5000);
        }

        cycle();
        breathInterval = setInterval(cycle, 11000);
    }

    window.stopBreathing = function() {
        document.getElementById('breath-overlay').style.display = 'none';
        if(breathInterval) clearInterval(breathInterval);
        breathInterval = null;
    }
</script>
</body>
</html>
