<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Espace RÃ©ussite</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#faf9f7;--surface:#fff;--border:rgba(0,0,0,.06);
  --text:#1a1a2e;--text2:#64748b;--text3:#94a3b8;
  --primary:#6366f1;--primary-light:#eef2ff;
  --cog:#3b82f6;--emo:#f43f5e;--soc:#8b5cf6;
  --success:#10b981;--warm:#fbbf24;
  --radius:16px;--radius-sm:12px;
  --shadow:0 2px 8px rgba(0,0,0,.04);
  --shadow-lg:0 8px 30px rgba(0,0,0,.08);
  --ease:cubic-bezier(.4,0,.2,1);
  --font:'Outfit',system-ui,sans-serif;
}
html,body{height:100%;overflow:hidden}
body{font-family:var(--font);background:var(--bg);color:var(--text);display:flex;flex-direction:column}

/* â”€â”€ Loader â”€â”€ */
.loader-screen{position:fixed;inset:0;z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;background:linear-gradient(135deg,#6366f1 0%,#8b5cf6 50%,#ec4899 100%)}
.loader-screen .logo{width:80px;height:80px;border-radius:24px;background:rgba(255,255,255,.15);backdrop-filter:blur(10px);display:flex;align-items:center;justify-content:center;font-size:2.2rem;color:#fff;margin-bottom:20px;animation:logoPulse 2s ease infinite}
@keyframes logoPulse{0%,100%{transform:scale(1)}50%{transform:scale(1.05)}}
.loader-screen h1{color:#fff;font-weight:800;font-size:1.5rem;margin-bottom:6px}
.loader-screen p{color:rgba(255,255,255,.7);font-size:.85rem}
.loader-dots{display:flex;gap:6px;margin-top:30px}
.loader-dots span{width:8px;height:8px;border-radius:50%;background:rgba(255,255,255,.4);animation:dotBounce .6s ease infinite alternate}
.loader-dots span:nth-child(2){animation-delay:.2s}
.loader-dots span:nth-child(3){animation-delay:.4s}
@keyframes dotBounce{to{background:#fff;transform:translateY(-4px)}}

/* â”€â”€ Access Denied â”€â”€ */
.denied-screen{position:fixed;inset:0;z-index:9998;display:none;flex-direction:column;align-items:center;justify-content:center;background:var(--bg);padding:40px;text-align:center}
.denied-screen .denied-icon{width:80px;height:80px;border-radius:50%;background:linear-gradient(135deg,#fef3c7,#fde68a);display:flex;align-items:center;justify-content:center;font-size:2.5rem;margin-bottom:24px}
.denied-screen h2{font-size:1.3rem;font-weight:800;margin-bottom:10px;color:var(--text)}
.denied-screen p{color:var(--text2);font-size:.9rem;max-width:300px;line-height:1.6}

/* â”€â”€ App Header â”€â”€ */
.app-header{background:linear-gradient(135deg,#6366f1 0%,#8b5cf6 100%);color:#fff;padding:20px 20px 24px;border-radius:0 0 24px 24px;position:relative;z-index:10}
.header-top{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.header-code{font-size:.7rem;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;opacity:.7}
.header-btn{background:rgba(255,255,255,.15);backdrop-filter:blur(8px);border:none;color:#fff;padding:8px 16px;border-radius:999px;font-family:var(--font);font-size:.75rem;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:6px;transition:background .15s}
.header-btn:hover{background:rgba(255,255,255,.25)}
.header-greeting{font-size:1.2rem;font-weight:800;line-height:1.3}
.header-date{font-size:.8rem;opacity:.7;margin-top:4px}

/* â”€â”€ App Content â”€â”€ */
.app-content{flex:1;overflow-y:auto;padding:20px 16px 120px}
.app-container{max-width:480px;margin:0 auto}

/* â”€â”€ Mood Box â”€â”€ */
.mood-box{background:var(--surface);border-radius:var(--radius);padding:16px 20px;box-shadow:var(--shadow);display:flex;align-items:center;justify-content:space-between;margin-bottom:20px;border:1px solid var(--border)}
.mood-box .mood-left{display:flex;align-items:center;gap:12px}
.mood-emoji{font-size:1.5rem}
.mood-text{font-size:.8rem;color:var(--text2);font-weight:600}
.mood-value{font-weight:700;color:var(--primary)}
.mood-btn{background:var(--primary-light);color:var(--primary);border:none;padding:8px 14px;border-radius:999px;font-family:var(--font);font-size:.7rem;font-weight:700;cursor:pointer}

/* â”€â”€ CPS Progress â”€â”€ */
.cps-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:24px}
.cps-card{background:var(--surface);border-radius:var(--radius);padding:16px 10px;text-align:center;box-shadow:var(--shadow);border:1px solid var(--border);cursor:pointer;transition:all .2s var(--ease)}
.cps-card:hover{transform:translateY(-2px);box-shadow:var(--shadow-lg)}
.cps-ring{width:64px;height:64px;border-radius:50%;margin:0 auto 10px;position:relative;display:flex;align-items:center;justify-content:center}
.cps-ring::before{content:'';position:absolute;inset:0;border-radius:50%;background:conic-gradient(var(--ring-color) calc(var(--pct)*3.6deg),#e2e8f0 0)}
.cps-ring::after{content:'';position:absolute;inset:5px;border-radius:50%;background:var(--surface)}
.cps-ring-value{position:relative;z-index:1;font-size:.85rem;font-weight:800}
.cps-label{font-size:.7rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text3)}
.cps-card.cog .cps-label{color:var(--cog)}.cps-card.emo .cps-label{color:var(--emo)}.cps-card.soc .cps-label{color:var(--soc)}

/* â”€â”€ Action Buttons â”€â”€ */
.actions{display:flex;flex-direction:column;gap:8px;margin-bottom:24px}
.action-btn{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px 18px;display:flex;align-items:center;gap:14px;cursor:pointer;transition:all .15s var(--ease);font-family:var(--font)}
.action-btn:hover{box-shadow:var(--shadow);transform:translateY(-1px)}
.action-btn.primary{background:var(--primary);color:#fff;border-color:transparent}
.action-btn.primary:hover{background:#4f46e5}
.action-icon{width:40px;height:40px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.2rem;flex-shrink:0}
.action-btn.primary .action-icon{background:rgba(255,255,255,.2)}
.action-icon.cog-bg{background:rgba(59,130,246,.1)}
.action-icon.emo-bg{background:rgba(244,63,94,.1)}
.action-icon.soc-bg{background:rgba(139,92,246,.1)}
.action-icon.neutral-bg{background:var(--bg)}
.action-text{font-weight:700;font-size:.85rem}
.action-sub{font-size:.7rem;color:var(--text3);margin-top:2px;font-weight:500}
.action-btn.primary .action-sub{color:rgba(255,255,255,.7)}

/* â”€â”€ Goals List â”€â”€ */
.section-title{font-size:.7rem;font-weight:800;text-transform:uppercase;letter-spacing:1px;color:var(--text3);margin-bottom:12px;display:flex;align-items:center;justify-content:space-between}
.goal-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px 16px;margin-bottom:8px;display:flex;align-items:center;gap:12px;cursor:pointer;transition:all .15s var(--ease);position:relative;overflow:hidden}
.goal-card:hover{box-shadow:var(--shadow)}
.goal-card::before{content:'';position:absolute;left:0;top:0;bottom:0;width:4px}
.goal-card.cog::before{background:var(--cog)}.goal-card.emo::before{background:var(--emo)}.goal-card.soc::before{background:var(--soc)}.goal-card.neu::before{background:var(--text3)}
.goal-check{width:24px;height:24px;border-radius:8px;border:2px solid #d1d5db;display:flex;align-items:center;justify-content:center;flex-shrink:0;cursor:pointer;transition:all .15s}
.goal-check:hover{border-color:var(--success);background:rgba(16,185,129,.1)}
.goal-body{flex:1;min-width:0}
.goal-title{font-weight:700;font-size:.85rem;line-height:1.3;margin-bottom:4px}
.goal-meta{display:flex;align-items:center;gap:8px;font-size:.7rem;color:var(--text3)}
.goal-badge{padding:2px 8px;border-radius:6px;font-weight:700;font-size:.6rem;text-transform:uppercase;letter-spacing:.5px;background:var(--bg)}
.goal-time{font-weight:700;margin-left:auto}
.goal-time.urgent{color:var(--emo)}
.goal-card.done{opacity:.5}
.goal-card.done .goal-title{text-decoration:line-through}
.goal-card.done .goal-check{background:var(--success);border-color:var(--success);color:#fff}
.toggle-history{font-size:.75rem;font-weight:700;color:var(--primary);cursor:pointer;padding:8px 0;display:flex;align-items:center;gap:6px}

/* â”€â”€ Overlays â”€â”€ */
.overlay{position:fixed;inset:0;z-index:200;background:var(--bg);display:none;flex-direction:column;overflow:hidden}
.overlay.show{display:flex}
.overlay-header{padding:16px 20px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;position:sticky;top:0;z-index:10;flex-shrink:0}
.overlay-title{font-weight:800;font-size:1rem}
.overlay-close{width:36px;height:36px;border-radius:10px;border:none;background:var(--bg);cursor:pointer;font-size:1rem;display:flex;align-items:center;justify-content:center}
.overlay-body{flex:1;overflow-y:auto;padding:20px}
.overlay-body .app-container{max-width:480px;margin:0 auto}

/* â”€â”€ Wizard â”€â”€ */
.wiz-step-title{font-size:1.1rem;font-weight:800;margin-bottom:16px;color:var(--text)}
.wiz-option{width:100%;text-align:left;padding:14px 18px;margin-bottom:8px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);font-family:var(--font);font-weight:600;font-size:.85rem;color:var(--text);cursor:pointer;transition:all .15s var(--ease)}
.wiz-option:hover{border-color:var(--primary);background:var(--primary-light)}
.wiz-option:active,.wiz-option.selected{background:var(--primary-light);border-color:var(--primary);color:var(--primary)}
.wiz-back{display:inline-flex;align-items:center;gap:6px;font-size:.8rem;font-weight:700;color:var(--text2);cursor:pointer;margin-bottom:16px;background:none;border:none;font-family:var(--font)}
.wiz-back:hover{color:var(--primary)}
.wiz-search{width:100%;padding:12px 16px;border:1px solid var(--border);border-radius:var(--radius-sm);font-family:var(--font);font-size:.85rem;margin-bottom:16px;outline:none}
.wiz-search:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(99,102,241,.1)}
.wiz-section-h{font-size:.7rem;font-weight:800;text-transform:uppercase;letter-spacing:.8px;color:var(--text3);margin:16px 0 10px}
.wiz-chip{display:inline-flex;align-items:center;gap:8px;padding:10px 14px;border-radius:999px;background:var(--surface);border:1px solid var(--border);font-weight:700;font-size:.8rem;cursor:pointer;transition:all .15s var(--ease);margin:0 6px 8px 0}
.wiz-chip:hover{border-color:var(--primary);box-shadow:var(--shadow)}
.wiz-chip .dot{width:10px;height:10px;border-radius:50%;flex-shrink:0}
.wiz-chip .pill{font-size:.6rem;font-weight:800;padding:2px 8px;border-radius:999px;background:var(--bg);color:var(--text3);text-transform:uppercase;letter-spacing:.5px;margin-left:auto}
.wiz-summary{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px;margin-bottom:16px}
.wiz-summary .ws-row{display:flex;justify-content:space-between;padding:6px 0;font-size:.8rem}
.wiz-summary .ws-label{font-weight:700;color:var(--text3)}
.wiz-summary .ws-value{font-weight:600;text-align:right}
.wiz-confirm{width:100%;padding:14px;background:var(--primary);color:#fff;border:none;border-radius:var(--radius-sm);font-family:var(--font);font-weight:800;font-size:.9rem;cursor:pointer;transition:all .15s}
.wiz-confirm:hover{background:#4f46e5}

/* â”€â”€ Mood Picker â”€â”€ */
.mood-picker{display:flex;flex-direction:column;gap:10px}
.mood-primary{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
.mood-primary-btn{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:16px 10px;text-align:center;cursor:pointer;transition:all .15s var(--ease);font-family:var(--font)}
.mood-primary-btn:hover{border-color:var(--primary);transform:translateY(-2px)}
.mood-primary-btn .mp-emoji{font-size:2rem;margin-bottom:6px}
.mood-primary-btn .mp-label{font-size:.75rem;font-weight:700}
.mood-secondary-btn{width:100%;padding:12px 16px;text-align:left;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);font-family:var(--font);font-weight:600;font-size:.85rem;cursor:pointer;transition:all .15s}
.mood-secondary-btn:hover{border-color:var(--primary);background:var(--primary-light)}

/* â”€â”€ Breathing â”€â”€ */
.breath-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;padding:40px;text-align:center;background:linear-gradient(180deg,#eef2ff 0%,#faf9f7 100%)}
.breath-ring{width:200px;height:200px;border-radius:50%;border:4px solid var(--primary);display:flex;align-items:center;justify-content:center;margin-bottom:30px;transition:transform 5s ease-in-out,border-color .3s;position:relative}
.breath-ring::before{content:'';position:absolute;inset:10px;border-radius:50%;background:rgba(99,102,241,.05);transition:background 5s ease-in-out}
.breath-ring.inhale{transform:scale(1.2);border-color:var(--cog)}.breath-ring.inhale::before{background:rgba(59,130,246,.08)}
.breath-ring.exhale{transform:scale(.9);border-color:var(--soc)}.breath-ring.exhale::before{background:rgba(139,92,246,.05)}
.breath-text{font-size:1.1rem;font-weight:800;color:var(--primary)}
.breath-sub{font-size:.8rem;color:var(--text2);margin-bottom:30px}
.breath-close{background:var(--surface);border:1px solid var(--border);padding:10px 24px;border-radius:999px;font-family:var(--font);font-weight:700;font-size:.8rem;cursor:pointer}

/* â”€â”€ Detail â”€â”€ */
.detail-badge{display:inline-flex;padding:4px 12px;border-radius:8px;font-size:.7rem;font-weight:800;text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px}
.detail-badge.cog{background:rgba(59,130,246,.1);color:var(--cog)}
.detail-badge.emo{background:rgba(244,63,94,.1);color:var(--emo)}
.detail-badge.soc{background:rgba(139,92,246,.1);color:var(--soc)}
.detail-badge.neu{background:var(--bg);color:var(--text3)}
.detail-cps{font-size:.8rem;color:var(--text2);font-weight:600;margin-bottom:16px}
.form-label{font-size:.7rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);margin-bottom:6px;display:block}
.form-input,.form-select{width:100%;padding:12px 14px;border:1px solid var(--border);border-radius:var(--radius-sm);font-family:var(--font);font-size:.85rem;margin-bottom:16px;outline:none}
.form-input:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(99,102,241,.1)}
.btn-block{width:100%;padding:14px;border:none;border-radius:var(--radius-sm);font-family:var(--font);font-weight:700;font-size:.85rem;cursor:pointer;margin-bottom:10px}
.btn-primary-block{background:var(--primary);color:#fff}
.btn-outline-block{background:var(--surface);border:1px solid var(--border);color:var(--primary)}
.btn-danger-block{background:transparent;border:1px solid rgba(239,68,68,.3);color:var(--emo);font-size:.8rem}
.btn-validate-qr{background:rgba(99,102,241,.08);border:2px dashed var(--primary);color:var(--primary)}

/* â”€â”€ QR Overlay â”€â”€ */
.qr-center{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;text-align:center;padding:40px}
.qr-center h3{font-size:1.1rem;font-weight:800;margin-bottom:20px}
.qr-center p{font-size:.8rem;color:var(--text2);margin-top:16px}
#qrcode-container{display:flex;justify-content:center;padding:16px;background:var(--surface);border-radius:var(--radius);box-shadow:var(--shadow)}

/* â”€â”€ Attestation â”€â”€ */
.attest-card{background:var(--surface);border-radius:var(--radius);padding:20px;margin-bottom:12px;border-left:5px solid}
.attest-card.cog{border-left-color:var(--cog)}.attest-card.emo{border-left-color:var(--emo)}.attest-card.soc{border-left-color:var(--soc)}
.attest-card h4{font-size:.9rem;font-weight:800;margin-bottom:6px}
.attest-card p{font-size:.8rem;color:var(--text2);line-height:1.5}
.attest-radar{max-width:280px;margin:0 auto 24px}

/* â”€â”€ Circle Detail â”€â”€ */
.circle-item{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px 16px;margin-bottom:8px}
.circle-item .ci-title{font-weight:700;font-size:.85rem;margin-bottom:4px}
.circle-item .ci-meta{font-size:.7rem;color:var(--text3)}

.empty-msg{text-align:center;color:var(--text3);font-size:.8rem;font-style:italic;padding:30px 0}

/* â”€â”€ Hide/Show â”€â”€ */
.hidden{display:none!important}
</style>
</head>
<body>

<!-- â•â•â• LOADER â•â•â• -->
<div class="loader-screen" id="loader">
  <div class="logo">â—ˆ</div>
  <h1>Espace RÃ©ussite</h1>
  <p>Chargement de ton espace...</p>
  <div class="loader-dots"><span></span><span></span><span></span></div>
</div>

<!-- â•â•â• ACCESS DENIED â•â•â• -->
<div class="denied-screen" id="access-denied">
  <div class="denied-icon">â³</div>
  <h2>Ton espace n'est pas encore actif</h2>
  <p>Ton enseignant doit d'abord activer ton accÃ¨s. Pas d'inquiÃ©tude, Ã§a arrive bientÃ´t !</p>
</div>

<!-- â•â•â• MAIN APP â•â•â• -->
<div id="app" style="display:none">

  <header class="app-header">
    <div class="header-top">
      <span class="header-code" id="display-code">â€”</span>
      <button class="header-btn" onclick="openBreathing()">ğŸŒ¬ Respiration</button>
    </div>
    <div class="header-greeting" id="greeting">Bonjour !</div>
    <div class="header-date" id="header-date"></div>
  </header>

  <div class="app-content">
    <div class="app-container">

      <!-- Mood -->
      <div class="mood-box" id="mood-box" style="display:none">
        <div class="mood-left">
          <span class="mood-emoji" id="mood-emoji">ğŸ˜Š</span>
          <div><div class="mood-text">Humeur du jour</div><div class="mood-value" id="mood-value">â€”</div></div>
        </div>
        <button class="mood-btn" onclick="openMood()">Changer</button>
      </div>

      <!-- CPS Progress -->
      <div class="cps-grid">
        <div class="cps-card cog" onclick="openCircle('COG')">
          <div class="cps-ring" id="ring-cog" style="--ring-color:var(--cog);--pct:0"><span class="cps-ring-value" id="val-cog">0</span></div>
          <div class="cps-label">Cognitif</div>
        </div>
        <div class="cps-card emo" onclick="openCircle('EMO')">
          <div class="cps-ring" id="ring-emo" style="--ring-color:var(--emo);--pct:0"><span class="cps-ring-value" id="val-emo">0</span></div>
          <div class="cps-label">Ã‰motionnel</div>
        </div>
        <div class="cps-card soc" onclick="openCircle('SOC')">
          <div class="cps-ring" id="ring-soc" style="--ring-color:var(--soc);--pct:0"><span class="cps-ring-value" id="val-soc">0</span></div>
          <div class="cps-label">Social</div>
        </div>
      </div>

      <!-- Actions -->
      <div class="actions">
        <div class="action-btn primary" onclick="startWizard()">
          <div class="action-icon">âœ¨</div>
          <div><div class="action-text">Nouvel objectif</div><div class="action-sub">Choisis ta prochaine Ã©tape</div></div>
        </div>
        <div class="action-btn" onclick="openReco()">
          <div class="action-icon neutral-bg">ğŸ…</div>
          <div><div class="action-text">Reconnaissance</div><div class="action-sub">Demander une validation</div></div>
        </div>
        <div class="action-btn" onclick="openAttestation()">
          <div class="action-icon neutral-bg">ğŸ“„</div>
          <div><div class="action-text">Ma SynthÃ¨se CPS</div><div class="action-sub">Bilan de mes compÃ©tences</div></div>
        </div>
      </div>

      <!-- Active Goals -->
      <div class="section-title">Objectifs en cours <span id="goals-count"></span></div>
      <div id="goals-list"></div>

      <!-- Done Goals -->
      <div style="margin-top:16px" id="history-section">
        <div class="toggle-history" onclick="toggleHistory()">
          <span id="history-toggle-text">Voir les objectifs atteints â–¼</span>
        </div>
        <div id="history-list" class="hidden"></div>
      </div>

    </div>
  </div>
</div>

<!-- â•â•â• WIZARD OVERLAY â•â•â• -->
<div class="overlay" id="wizard-overlay">
  <div class="overlay-header"><span class="overlay-title">Nouvel Objectif</span><button class="overlay-close" onclick="closeOverlay('wizard-overlay')">âœ•</button></div>
  <div class="overlay-body"><div class="app-container" id="wizard-content"></div></div>
</div>

<!-- â•â•â• MOOD OVERLAY â•â•â• -->
<div class="overlay" id="mood-overlay">
  <div class="overlay-header"><span class="overlay-title">MÃ©tÃ©o du jour</span><button class="overlay-close" onclick="closeOverlay('mood-overlay')">âœ•</button></div>
  <div class="overlay-body"><div class="app-container" id="mood-content"></div></div>
</div>

<!-- â•â•â• BREATHING OVERLAY â•â•â• -->
<div class="overlay" id="breath-overlay">
  <div class="breath-screen">
    <div class="breath-ring" id="breath-ring"><span class="breath-text" id="breath-text">PrÃªt</span></div>
    <div class="breath-sub">Inspire par le nez, expire par la bouche</div>
    <button class="breath-close" onclick="stopBreathing()">Fermer</button>
  </div>
</div>

<!-- â•â•â• DETAIL OVERLAY â•â•â• -->
<div class="overlay" id="detail-overlay">
  <div class="overlay-header"><span class="overlay-title">DÃ©tail</span><button class="overlay-close" onclick="closeOverlay('detail-overlay')">âœ•</button></div>
  <div class="overlay-body"><div class="app-container">
    <div class="detail-badge" id="det-badge">â€”</div>
    <div class="detail-cps" id="det-cps">â€”</div>
    <label class="form-label">Objectif</label>
    <input type="text" class="form-input" id="det-title" disabled style="background:var(--bg);font-weight:700">
    <label class="form-label">Pour quand ?</label>
    <input type="date" class="form-input" id="det-date">
    <label class="form-label">MatiÃ¨re / Lieu</label>
    <input type="text" class="form-input" id="det-context">
    <button class="btn-block btn-primary-block" onclick="saveDetail()">Enregistrer</button>
    <button class="btn-block btn-validate-qr" onclick="showQRForGoal()">ğŸ”— Faire valider par un prof</button>
    <div id="qr-feedback" style="text-align:center;font-size:.7rem;color:var(--text3);margin:8px 0"></div>
    <button class="btn-block btn-danger-block" onclick="deleteGoal()" style="margin-top:12px">Supprimer cet objectif</button>
  </div></div>
</div>

<!-- â•â•â• QR OVERLAY â•â•â• -->
<div class="overlay" id="qr-overlay">
  <div class="qr-center">
    <h3>Faire valider</h3>
    <div id="qrcode-container"></div>
    <p>PrÃ©sente ce code Ã  l'adulte.</p>
    <button class="breath-close" style="margin-top:20px" onclick="closeOverlay('qr-overlay')">Fermer</button>
  </div>
</div>

<!-- â•â•â• RECOGNITION OVERLAY â•â•â• -->
<div class="overlay" id="reco-overlay">
  <div class="overlay-header"><span class="overlay-title">Reconnaissance</span><button class="overlay-close" onclick="closeOverlay('reco-overlay')">âœ•</button></div>
  <div class="overlay-body"><div class="app-container" style="text-align:center;padding-top:20px">
    <p style="font-size:.85rem;color:var(--text2);margin-bottom:20px">Quel type de rÃ©ussite veux-tu faire reconnaÃ®tre ?</p>
    <div class="actions">
      <div class="action-btn" onclick="generateRecoQR('COG')"><div class="action-icon cog-bg">ğŸ§ </div><div><div class="action-text" style="color:var(--cog)">Cognitif</div><div class="action-sub">RÃ©flexion, analyse, dÃ©cision</div></div></div>
      <div class="action-btn" onclick="generateRecoQR('EMO')"><div class="action-icon emo-bg">â¤ï¸</div><div><div class="action-text" style="color:var(--emo)">Ã‰motionnel</div><div class="action-sub">Gestion des Ã©motions, stress</div></div></div>
      <div class="action-btn" onclick="generateRecoQR('SOC')"><div class="action-icon soc-bg">ğŸ¤</div><div><div class="action-text" style="color:var(--soc)">Social</div><div class="action-sub">Communication, entraide</div></div></div>
    </div>
  </div></div>
</div>

<!-- â•â•â• ATTESTATION OVERLAY â•â•â• -->
<div class="overlay" id="attest-overlay">
  <div class="overlay-header"><span class="overlay-title">Ma SynthÃ¨se CPS</span><button class="overlay-close" onclick="closeOverlay('attest-overlay')">âœ•</button></div>
  <div class="overlay-body"><div class="app-container">
    <h3 style="text-align:center;font-weight:800;margin-bottom:24px">Mon Profil de CompÃ©tences</h3>
    <div class="attest-radar"><canvas id="attest-radar"></canvas></div>
    <div class="attest-card cog"><h4 style="color:var(--cog)">ğŸ§  Mes pensÃ©es & choix</h4><p id="syn-cog">â€”</p></div>
    <div class="attest-card emo"><h4 style="color:var(--emo)">â¤ï¸ Mes Ã©motions</h4><p id="syn-emo">â€”</p></div>
    <div class="attest-card soc"><h4 style="color:var(--soc)">ğŸ¤ Mes relations</h4><p id="syn-soc">â€”</p></div>
  </div></div>
</div>

<!-- â•â•â• CIRCLE DETAIL OVERLAY â•â•â• -->
<div class="overlay" id="circle-overlay">
  <div class="overlay-header"><span class="overlay-title" id="circle-title">â€”</span><button class="overlay-close" onclick="closeOverlay('circle-overlay')">âœ•</button></div>
  <div class="overlay-body"><div class="app-container" id="circle-content"></div></div>
</div>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  FIREBASE CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const firebaseConfig={apiKey:"AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0IQcLI",authDomain:"devoirs-pse.firebaseapp.com",databaseURL:"https://devoirs-pse-default-rtdb.europe-west1.firebasedatabase.app",projectId:"devoirs-pse",storageBucket:"devoirs-pse.appspot.com",messagingSenderId:"614730413904",appId:"1:614730413904:web:a5dd478af5de30f6bede55"};
firebase.initializeApp(firebaseConfig);
const db=firebase.database();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let userCode=new URLSearchParams(window.location.search).get('id');
let userData={objectifs:{},meteo:{}};
let draft={};
let currentEditId=null;
let breathInterval=null;
let CPS_LIBRARY=null;
let attestChart=null;

const MATIERES=["FranÃ§ais","Maths","Anglais","Espagnol","Hist-GÃ©o","Eco-Droit","Ens. Pro","PSE","Arts","EPS","Autre"];
const EMOTIONS={
  "ğŸ˜Š Joie":{emoji:"ğŸ˜Š",subs:["Satisfait","Fier","Enthousiaste","Serein"]},
  "ğŸ˜¢ Tristesse":{emoji:"ğŸ˜¢",subs:["DÃ©Ã§u","DÃ©couragÃ©","Nostalgique"]},
  "ğŸ˜  ColÃ¨re":{emoji:"ğŸ˜ ",subs:["AgacÃ©","FrustrÃ©","En colÃ¨re"]},
  "ğŸ˜° Peur":{emoji:"ğŸ˜°",subs:["Inquiet","StressÃ©","Anxieux"]},
  "ğŸ˜³ Surprise":{emoji:"ğŸ˜³",subs:["Ã‰tonnÃ©","DÃ©stabilisÃ©"]},
  "ğŸ˜ Neutre":{emoji:"ğŸ˜",subs:["Normal","FatiguÃ©","IndiffÃ©rent"]}
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  INIT
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.addEventListener('load',()=>{
  // Set date
  const now=new Date();
  const days=['Dimanche','Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi'];
  const months=['janvier','fÃ©vrier','mars','avril','mai','juin','juillet','aoÃ»t','septembre','octobre','novembre','dÃ©cembre'];
  document.getElementById('header-date').textContent=`${days[now.getDay()]} ${now.getDate()} ${months[now.getMonth()]}`;

  // Set greeting based on time
  const h=now.getHours();
  const greet=h<12?'Bonjour !':h<18?'Bon aprÃ¨s-midi !':'Bonsoir !';
  document.getElementById('greeting').textContent=greet;

  setTimeout(()=>{
    document.getElementById('loader').style.display='none';
    if(!userCode){
      userCode='DEMO';
      document.getElementById('display-code').textContent='DEMO (TEST)';
      document.getElementById('app').style.display='flex';
      document.getElementById('app').style.flexDirection='column';
      document.getElementById('app').style.height='100vh';
      loadData();
      return;
    }
    // Check authorization
    db.ref(`accompagnement/autorisations/${userCode}`).on('value',snap=>{
      const data=snap.val();
      const autorise=data&&data.autorise===true;
      if(autorise){
        document.getElementById('access-denied').style.display='none';
        const app=document.getElementById('app');
        app.style.display='flex';
        app.style.flexDirection='column';
        app.style.height='100vh';
        document.getElementById('display-code').textContent=userCode;
        loadData();
      }else{
        document.getElementById('app').style.display='none';
        document.getElementById('access-denied').style.display='flex';
      }
    });
  },1500);
});

function loadData(){
  db.ref(`accompagnement/eleves/${userCode}`).on('value',snap=>{
    userData=snap.val()||{objectifs:{},meteo:{}};
    if(!userData.objectifs) userData.objectifs={};
    if(!userData.meteo) userData.meteo={};
    renderDashboard();
    checkMood();
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DASHBOARD RENDER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderDashboard(){
  const goals=userData.objectifs||{};
  const keys=Object.keys(goals);
  let counts={COG:0,EMO:0,SOC:0};
  let totals={COG:0,EMO:0,SOC:0};
  
  const active=[],done=[];
  keys.forEach(k=>{
    const g=goals[k];
    const t=(g.type||g.domaine||'').toUpperCase();
    const ax=t.includes('COG')?'COG':t.includes('EMO')?'EMO':t.includes('SOC')?'SOC':null;
    if(ax) totals[ax]++;
    if(g.done){
      if(ax) counts[ax]++;
      done.push({k,...g});
    }else{
      active.push({k,...g});
    }
  });

  // Sort active by date
  active.sort((a,b)=>new Date(a.date_cible||'2099-01-01')-new Date(b.date_cible||'2099-01-01'));

  // Update rings
  ['COG','EMO','SOC'].forEach(ax=>{
    const total=Math.max(totals[ax],1);
    const pct=Math.round((counts[ax]/total)*100);
    const ring=document.getElementById('ring-'+ax.toLowerCase());
    const val=document.getElementById('val-'+ax.toLowerCase());
    if(ring){ring.style.setProperty('--pct',pct)}
    if(val){val.textContent=counts[ax]}
  });

  // Goals count
  document.getElementById('goals-count').textContent=active.length?`(${active.length})`:'';

  // Active goals
  const listEl=document.getElementById('goals-list');
  if(!active.length){
    listEl.innerHTML='<div class="empty-msg">Aucun objectif en cours â€” ajoutes-en un !</div>';
  }else{
    listEl.innerHTML=active.map(g=>{
      const t=(g.type||g.domaine||'').toUpperCase();
      const cls=t.includes('COG')?'cog':t.includes('EMO')?'emo':t.includes('SOC')?'soc':'neu';
      let timeStr='';
      let urgCls='';
      if(g.date_cible){
        const today=new Date();today.setHours(0,0,0,0);
        const target=new Date(g.date_cible);target.setHours(0,0,0,0);
        const diff=Math.ceil((target-today)/86400000);
        if(diff<0){timeStr='DÃ©passÃ©';urgCls='urgent'}
        else if(diff===0){timeStr="Aujourd'hui"}
        else{timeStr=`J-${diff}`}
      }
      return `<div class="goal-card ${cls}" onclick="openDetail('${g.k}')">
        <div class="goal-check" onclick="event.stopPropagation();toggleGoal('${g.k}')">
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#d1d5db" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg>
        </div>
        <div class="goal-body">
          <div class="goal-title">${g.titre||'Sans titre'}</div>
          <div class="goal-meta">
            <span class="goal-badge">${g.context||'Autre'}</span>
            <span>${g.spe_label?g.spe_label.replace(/^[A-Z]\d+\.\d+\s*/,''):g.detail||''}</span>
            ${timeStr?`<span class="goal-time ${urgCls}">${timeStr}</span>`:''}
          </div>
        </div>
      </div>`;
    }).join('');
  }

  // Done goals
  const histEl=document.getElementById('history-list');
  if(!done.length){
    histEl.innerHTML='<div class="empty-msg">Rien pour le moment</div>';
  }else{
    histEl.innerHTML=done.map(g=>{
      const t=(g.type||g.domaine||'').toUpperCase();
      const cls=t.includes('COG')?'cog':t.includes('EMO')?'emo':t.includes('SOC')?'soc':'neu';
      return `<div class="goal-card done ${cls}">
        <div class="goal-check"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div>
        <div class="goal-body"><div class="goal-title">${g.titre||''}</div><div class="goal-meta"><span>ValidÃ© le ${g.date_done?new Date(g.date_done).toLocaleDateString('fr-FR'):'â€”'}</span></div></div>
      </div>`;
    }).join('');
  }

  // Hide history section if no done goals
  document.getElementById('history-section').style.display=done.length?'block':'none';
}

function toggleGoal(k){
  if(confirm("As-tu atteint cet objectif ? ğŸ‰")){
    db.ref(`accompagnement/eleves/${userCode}/objectifs/${k}`).update({done:true,date_done:new Date().toISOString()});
  }
}
function toggleHistory(){
  const el=document.getElementById('history-list');
  const txt=document.getElementById('history-toggle-text');
  if(el.classList.contains('hidden')){
    el.classList.remove('hidden');
    txt.textContent='Masquer les objectifs atteints â–²';
  }else{
    el.classList.add('hidden');
    txt.textContent='Voir les objectifs atteints â–¼';
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MOOD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function checkMood(){
  const today=new Date().toISOString().split('T')[0];
  const m=userData.meteo&&userData.meteo[today];
  if(m){
    document.getElementById('mood-box').style.display='flex';
    document.getElementById('mood-value').textContent=m.secondary||m.primary||'';
    document.getElementById('mood-emoji').textContent=m.emoji||'ğŸ˜Š';
  }else{
    document.getElementById('mood-box').style.display='none';
    openMood();
  }
}
function openMood(){
  document.getElementById('mood-overlay').classList.add('show');
  const c=document.getElementById('mood-content');
  c.innerHTML='<p style="font-size:.85rem;color:var(--text2);margin-bottom:20px;text-align:center">Comment te sens-tu aujourd\'hui ?</p><div class="mood-primary">'+
    Object.entries(EMOTIONS).map(([key,val])=>`<div class="mood-primary-btn" onclick="moodStep2('${key}')"><div class="mp-emoji">${val.emoji}</div><div class="mp-label">${key.split(' ')[1]}</div></div>`).join('')+
  '</div>';
}
window.moodStep2=function(primary){
  const val=EMOTIONS[primary];
  const c=document.getElementById('mood-content');
  c.innerHTML=`<button class="wiz-back" onclick="openMood()">â† Retour</button><p style="font-size:.9rem;font-weight:700;margin-bottom:16px">${primary} â€” prÃ©cise :</p><div class="mood-picker">`+
    val.subs.map(s=>`<button class="mood-secondary-btn" onclick="saveMood('${primary}','${s}','${val.emoji}')">${s}</button>`).join('')+
  '</div>';
}
window.saveMood=function(p,s,emoji){
  const today=new Date().toISOString().split('T')[0];
  db.ref(`accompagnement/eleves/${userCode}/meteo/${today}`).set({primary:p.split(' ')[1],secondary:s,emoji:emoji});
  closeOverlay('mood-overlay');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CPS LIBRARY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function loadCpsLibrary(){
  if(CPS_LIBRARY) return CPS_LIBRARY;
  try{
    const r=await fetch('data/cps_library.json',{cache:'no-store'});
    CPS_LIBRARY=await r.json();
  }catch(e){
    console.warn('CPS library not found',e);
    CPS_LIBRARY={contexts:{}};
  }
  return CPS_LIBRARY;
}
function ctxKey(label){
  if(!label) return 'Autre';
  const v=label.toLowerCase();
  if(v.includes('pfmp')||v.includes('stage')) return 'PFMP';
  if(v.includes('recherche')) return 'Recherche';
  if(v.includes('scol')) return 'Scolaire';
  return 'Autre';
}
function domainLabel(s){return s==='COG'?'Cognitif':s==='EMO'?'Ã‰motionnel':s==='SOC'?'Social':'Autre'}
function domainColor(s){return s==='COG'?'var(--cog)':s==='EMO'?'var(--emo)':s==='SOC'?'var(--soc)':'var(--text3)'}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GOAL WIZARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.startWizard=async function(){
  draft={};
  document.getElementById('wizard-overlay').classList.add('show');
  document.getElementById('wizard-content').innerHTML='<div style="text-align:center;padding:40px;color:var(--text3)">Chargement...</div>';
  await loadCpsLibrary();
  wizStep(1);
}

function wizStep(s){
  draft._step=s;
  const c=document.getElementById('wizard-content');
  c.innerHTML='';
  const backMap={2:1,3:2,4:3,5:4,6:5};
  if(backMap[s]) c.innerHTML+=`<button class="wiz-back" onclick="wizStep(${backMap[s]})">â† Retour</button>`;

  if(s===1){
    c.innerHTML+=`<div class="wiz-step-title">Dans quel cadre ?</div>
    <button class="wiz-option" onclick="draft.context='Scolaire';wizStep(2)">ğŸ“š Scolaire</button>
    <button class="wiz-option" onclick="draft.context='PFMP';wizStep(2)">ğŸ¢ PFMP / Stage</button>
    <button class="wiz-option" onclick="draft.context='Recherche';wizStep(2)">ğŸ” Recherche de stage</button>
    <button class="wiz-option" onclick="draft.context='Autre';draft.type='AUTRE';draft.cps=null;wizStep(3)">âœï¸ Autre (libre)</button>`;
  }
  else if(s===2){
    const key=ctxKey(draft.context);
    const ctx=CPS_LIBRARY?.contexts?.[key];
    c.innerHTML+=`<div class="wiz-step-title">Choisis ta compÃ©tence</div>
    <input type="text" class="wiz-search" id="cps-search" placeholder="Rechercher (stress, empathie, consigne...)" oninput="wizStep(2)">`;
    
    const q=(document.getElementById('cps-search')?.value||'').toLowerCase();
    window.__CPS_MAP={};
    if(!ctx?.domains){c.innerHTML+='<div class="empty-msg">BibliothÃ¨que non disponible</div>';return}
    
    ['COG','EMO','SOC'].forEach(dom=>{
      const d=ctx.domains[dom];
      if(!d?.competences?.length) return;
      const filtered=d.competences.filter(x=>{
        if(!q) return true;
        return `${x.spe_label||''} ${x.gen_label||''} ${x.cat_label||''}`.toLowerCase().includes(q);
      });
      if(!filtered.length) return;
      const color=d.color||domainColor(dom);
      c.innerHTML+=`<div class="wiz-section-h">${d.title||domainLabel(dom)}</div>`;
      filtered.forEach(x=>{
        const uid=`${x.domain||dom}_${x.cat_code}_${x.gen_code}_${x.spe_code}`;
        window.__CPS_MAP[uid]=x;
        // Strip code prefix from label for cleaner display
        const cleanLabel=(x.spe_label||'').replace(/^[A-Z]\d+\.\d+\s*/,'');
        c.innerHTML+=`<div class="wiz-chip" onclick="selectCompetence('${uid}')"><span class="dot" style="background:${color}"></span><span>${cleanLabel}</span></div>`;
      });
    });
    c.innerHTML+='<div style="font-size:.7rem;color:var(--text3);margin-top:12px;text-align:center">RÃ©fÃ©rentiel : SantÃ© publique France</div>';
  }
  else if(s===3){
    if(ctxKey(draft.context)==='Autre'){
      c.innerHTML+=`<div class="wiz-step-title">Objectif libre</div>
      <p style="font-size:.85rem;color:var(--text2);margin-bottom:16px">Ã‰cris ton propre objectif :</p>
      <input type="text" class="form-input" id="free-goal" placeholder="Mon objectif...">
      <button class="wiz-confirm" onclick="draft.titre=document.getElementById('free-goal').value;if(draft.titre){draft.code_ref='';draft.obj=null;wizStep(4)}">Continuer</button>`;
      return;
    }
    if(!draft.cps){c.innerHTML+='<div class="empty-msg">Aucune compÃ©tence sÃ©lectionnÃ©e</div>';return}
    
    const cleanLabel=(draft.cps.spe_label||'').replace(/^[A-Z]\d+\.\d+\s*/,'');
    c.innerHTML+=`<div class="wiz-step-title">Choisis un objectif</div>
    <div style="background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px 18px;margin-bottom:16px;border-left:4px solid ${domainColor(draft.cps.domain||'COG')}">
      <div style="font-weight:800">${cleanLabel}</div>
      <div style="font-size:.75rem;color:var(--text2);margin-top:4px">${domainLabel(draft.cps.domain||'COG')} Â· ${draft.context}</div>
    </div>`;
    
    window.__OBJ_MAP={};
    const list=draft.cps.objectifs||[];
    if(!list.length){c.innerHTML+='<div class="empty-msg">Aucune proposition</div>'}
    else{
      list.forEach((o,i)=>{
        const uid=`${draft.cps.spe_code}_${o.code_ref||i}`;
        window.__OBJ_MAP[uid]=o;
        c.innerHTML+=`<button class="wiz-option" onclick="selectObjectif('${uid}')">${o.texte||''}</button>`;
      });
    }
    c.innerHTML+=`<button class="wiz-option" style="color:var(--primary);border-style:dashed" onclick="var t=prompt('Ton objectif ?');if(t){draft.titre=t;draft.code_ref='';draft.obj=null;wizStep(4)}">âœï¸ Ã‰crire mon propre objectif</button>`;
  }
  else if(s===4){
    c.innerHTML+=`<div class="wiz-step-title">Pour quand ?</div>
    <input type="date" class="form-input" id="w-date" value="${draft.date||new Date().toISOString().split('T')[0]}">
    <button class="wiz-confirm" onclick="draft.date=document.getElementById('w-date').value;wizStep(5)">Continuer</button>`;
  }
  else if(s===5){
    const key=ctxKey(draft.context);
    let label='Contexte',inputHtml='<input type="text" class="form-input" id="w-det" placeholder="PrÃ©cise...">';
    if(key==='Scolaire'){
      label='MatiÃ¨re';
      inputHtml='<select class="form-input" id="w-det">'+MATIERES.map(m=>`<option value="${m}">${m}</option>`).join('')+'</select>';
    }else if(key==='PFMP'){
      label='Lieu / ActivitÃ©';
      inputHtml='<input type="text" class="form-input" id="w-det" placeholder="Ex : atelier, chantier...">';
    }else if(key==='Recherche'){
      label='Cible';
      inputHtml='<input type="text" class="form-input" id="w-det" placeholder="Ex : entreprise, mÃ©tier...">';
    }
    c.innerHTML+=`<div class="wiz-step-title">${label}</div>${inputHtml}
    <button class="wiz-confirm" onclick="draft.detail=document.getElementById('w-det').value;wizStep(6)">Continuer</button>`;
  }
  else if(s===6){
    const dom=draft.type||(draft.cps?.domain)||'AUTRE';
    const compLine=draft.cps?(draft.cps.spe_label||'').replace(/^[A-Z]\d+\.\d+\s*/,''):'Objectif libre';
    c.innerHTML+=`<div class="wiz-step-title">RÃ©capitulatif</div>
    <div class="wiz-summary" style="border-left:4px solid ${domainColor(dom)}">
      <div class="ws-row"><span class="ws-label">Objectif</span><span class="ws-value">${draft.titre||''}</span></div>
      <div class="ws-row"><span class="ws-label">Cadre</span><span class="ws-value">${draft.context||''}</span></div>
      <div class="ws-row"><span class="ws-label">CompÃ©tence</span><span class="ws-value">${compLine}</span></div>
      <div class="ws-row"><span class="ws-label">Type</span><span class="ws-value">${domainLabel(dom)}</span></div>
      <div class="ws-row"><span class="ws-label">Quand</span><span class="ws-value">${draft.date||''}</span></div>
      <div class="ws-row"><span class="ws-label">DÃ©tail</span><span class="ws-value">${draft.detail||'Non prÃ©cisÃ©'}</span></div>
    </div>
    <button class="wiz-confirm" onclick="saveWizard()">âœ… Valider l'objectif</button>`;
  }
}

window.selectCompetence=function(uid){
  if(!window.__CPS_MAP?.[uid]) return;
  draft.cps=window.__CPS_MAP[uid];
  draft.type=draft.cps.domain||'AUTRE';
  wizStep(3);
}
window.selectObjectif=function(uid){
  if(!window.__OBJ_MAP?.[uid]) return;
  draft.obj=window.__OBJ_MAP[uid];
  draft.titre=draft.obj.texte||'';
  draft.code_ref=draft.obj.code_ref||'';
  wizStep(4);
}

window.saveWizard=function(){
  if(!draft.date) draft.date=new Date().toISOString().split('T')[0];
  const dom=draft.type||(draft.cps?.domain)||'AUTRE';
  const payload={
    context:draft.context||'Autre', type:dom,
    titre:draft.titre||'', date_cible:draft.date,
    detail:(draft.detail&&draft.detail.trim())||'Non prÃ©cisÃ©',
    done:false, created:new Date().toISOString(),
    ref_source:"SantÃ© publique France",
    cat_code:draft.cps?.cat_code||"", cat_label:draft.cps?.cat_label||"",
    gen_code:draft.cps?.gen_code||"", gen_label:draft.cps?.gen_label||"",
    spe_code:draft.cps?.spe_code||"", spe_label:draft.cps?.spe_label||"",
    code_ref:draft.code_ref||"", domaine:dom
  };
  db.ref(`accompagnement/eleves/${userCode}/objectifs`).push(payload);
  closeOverlay('wizard-overlay');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  GOAL DETAIL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.openDetail=function(k){
  currentEditId=k;
  const g=userData.objectifs?.[k];
  if(!g) return;
  const t=(g.type||g.domaine||'').toUpperCase();
  const cls=t.includes('COG')?'cog':t.includes('EMO')?'emo':t.includes('SOC')?'soc':'neu';
  const badge=document.getElementById('det-badge');
  badge.className='detail-badge '+cls;
  badge.textContent=(g.context||'Autre').toUpperCase();
  const cleanSpe=(g.spe_label||'').replace(/^[A-Z]\d+\.\d+\s*/,'');
  document.getElementById('det-cps').textContent=(cleanSpe||'Objectif libre')+' Â· '+domainLabel(t);
  document.getElementById('det-title').value=g.titre||'';
  document.getElementById('det-date').value=g.date_cible||'';
  document.getElementById('det-context').value=g.detail||'';
  const isFree=g.context==='Autre'||g.type==='AUTRE';
  document.getElementById('det-title').disabled=!isFree;
  document.getElementById('det-title').style.background=isFree?'var(--surface)':'var(--bg)';
  document.getElementById('qr-feedback').textContent='';
  document.getElementById('detail-overlay').classList.add('show');
}

window.saveDetail=function(){
  const d=document.getElementById('det-date').value;
  const c=document.getElementById('det-context').value;
  const t=document.getElementById('det-title').value;
  let up={date_cible:d,detail:c};
  if(!document.getElementById('det-title').disabled) up.titre=t;
  db.ref(`accompagnement/eleves/${userCode}/objectifs/${currentEditId}`).update(up);
  closeOverlay('detail-overlay');
}

window.deleteGoal=function(){
  if(confirm('Supprimer cet objectif ?')){
    db.ref(`accompagnement/eleves/${userCode}/objectifs/${currentEditId}`).remove();
    closeOverlay('detail-overlay');
  }
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  QR CODES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.showQRForGoal=function(){
  if(!currentEditId||!userData.objectifs?.[currentEditId]){
    document.getElementById('qr-feedback').textContent='Erreur : objectif introuvable';return;
  }
  const g=userData.objectifs[currentEditId];
  generateQR(JSON.stringify({
    eleve:userCode, objectif:currentEditId,
    competence:g.type||'AUTRE', timestamp:Date.now(),
    cadre:g.context||'Autre', flux:1, ref_id_officiel:""
  }));
}
window.generateRecoQR=function(type){
  generateQR(JSON.stringify({
    eleve:userCode, type_reconnaissance:type,
    competence:type, flux:2, timestamp:Date.now(),
    cadre:"Autre", ref_id_officiel:""
  }));
  closeOverlay('reco-overlay');
}
function generateQR(txt){
  document.getElementById('qrcode-container').innerHTML='';
  new QRCode(document.getElementById('qrcode-container'),{text:txt,width:200,height:200,correctLevel:QRCode.CorrectLevel.M});
  document.getElementById('qr-overlay').classList.add('show');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  BREATHING
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.openBreathing=function(){
  document.getElementById('breath-overlay').classList.add('show');
  const ring=document.getElementById('breath-ring');
  const text=document.getElementById('breath-text');
  if(breathInterval) clearInterval(breathInterval);
  function cycle(){
    text.textContent='Inspire 5s';
    ring.className='breath-ring inhale';
    setTimeout(()=>{
      text.textContent='Expire 6s';
      ring.className='breath-ring exhale';
    },5000);
  }
  cycle();
  breathInterval=setInterval(cycle,11000);
}
window.stopBreathing=function(){
  closeOverlay('breath-overlay');
  if(breathInterval) clearInterval(breathInterval);
  breathInterval=null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CIRCLE DETAIL
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.openCircle=function(ax){
  const titles={COG:'ğŸ§  Mes pensÃ©es & choix',EMO:'â¤ï¸ Mes Ã©motions',SOC:'ğŸ¤ Mes relations'};
  document.getElementById('circle-title').textContent=titles[ax]||ax;
  const c=document.getElementById('circle-content');
  const goals=Object.values(userData.objectifs||{}).filter(g=>{
    const t=(g.type||g.domaine||'').toUpperCase();
    return t.includes(ax);
  });
  if(!goals.length){
    c.innerHTML='<div class="empty-msg">Aucun objectif dans cet axe pour le moment</div>';
  }else{
    c.innerHTML=goals.map(g=>`
      <div class="circle-item">
        <div class="ci-title">${g.titre||''}</div>
        <div class="ci-meta">${g.done?'âœ… ValidÃ©':'â³ En cours'} Â· ${g.context||''} Â· ${g.detail||''}</div>
      </div>
    `).join('');
  }
  document.getElementById('circle-overlay').classList.add('show');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  ATTESTATION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.openAttestation=function(){
  document.getElementById('attest-overlay').classList.add('show');
  const goals=Object.values(userData.objectifs||{});
  const counts={COG:0,EMO:0,SOC:0};
  const examples={COG:[],EMO:[],SOC:[]};
  
  goals.filter(g=>g.done).forEach(g=>{
    const t=(g.type||g.domaine||'').toUpperCase();
    const ax=t.includes('COG')?'COG':t.includes('EMO')?'EMO':t.includes('SOC')?'SOC':null;
    if(ax){
      counts[ax]++;
      if(examples[ax].length<2) examples[ax].push(g.titre||'');
    }
  });

  // Radar
  const ctx=document.getElementById('attest-radar');
  if(attestChart) attestChart.destroy();
  attestChart=new Chart(ctx,{
    type:'radar',
    data:{
      labels:['Cognitif','Ã‰motionnel','Social'],
      datasets:[{data:[counts.COG,counts.EMO,counts.SOC],
        backgroundColor:'rgba(99,102,241,.12)',borderColor:'rgba(99,102,241,.5)',
        borderWidth:2,pointBackgroundColor:'#6366f1',pointRadius:5}]
    },
    options:{
      scales:{r:{beginAtZero:true,ticks:{display:false},grid:{color:'rgba(0,0,0,.05)'},
        pointLabels:{font:{size:13,weight:'700',family:'Outfit'}}}},
      plugins:{legend:{display:false}}
    }
  });

  // Summaries
  ['COG','EMO','SOC'].forEach(ax=>{
    const el=document.getElementById('syn-'+ax.toLowerCase());
    if(counts[ax]){
      el.textContent=`${counts[ax]} objectif(s) validÃ©(s)${examples[ax].length?'. Exemples : '+examples[ax].join(', '):''}`;
    }else{
      el.textContent='Pas encore d\'objectif validÃ© dans cet axe.';
    }
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  UTILS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openReco(){document.getElementById('reco-overlay').classList.add('show')}
function closeOverlay(id){document.getElementById(id).classList.remove('show')}
</script>
</body>
</html>
