<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Mon Objectif</title>
<link href="https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
<script>
if (location.protocol === 'http:' && !/^(localhost|127\.0\.0\.1)$/.test(location.hostname)) {
  location.replace('https://' + location.host + location.pathname + location.search + location.hash);
}
</script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
* { -webkit-tap-highlight-color: transparent; }
button, [role="button"], .act-card, .mission-card, .meteo-card,
.cps-item, .mood-big-btn, .mood-sec-chip {
  touch-action: manipulation;
}
:root{
  --bg:#f0f0f5;--surface:#fff;--surface2:#f7f7fb;--border:rgba(0,0,0,.06);
  --text:#1a1a2e;--text2:#64748b;--text3:#94a3b8;
  --primary:#6366f1;--primary-light:#eef2ff;
  --cog:#3b82f6;--cog-bg:rgba(59,130,246,.08);
  --emo:#f43f5e;--emo-bg:rgba(244,63,94,.08);
  --soc:#8b5cf6;--soc-bg:rgba(139,92,246,.08);
  --success:#10b981;--danger:#ef4444;--warn:#f59e0b;
  --radius:20px;--radius-sm:14px;
  --shadow:0 2px 8px rgba(0,0,0,.04);--shadow-lg:0 8px 30px rgba(0,0,0,.08);
  --ease:cubic-bezier(.4,0,.2,1);
  --font:'Plus Jakarta Sans',system-ui,sans-serif;
  --aura-color:rgba(251,191,36,.08);--aura-border:rgba(251,191,36,.15);--aura-glow:rgba(251,191,36,.06);
}
html{height:100%}
body{font-family:var(--font);background:var(--bg);color:var(--text);min-height:100%;overflow-x:hidden;-webkit-font-smoothing:antialiased}

/* â•â• Welcome Screen â•â• */
.welcome-screen{position:fixed;inset:0;z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;background:var(--bg);padding:40px 24px;text-align:center}
.welcome-content{width:100%;max-width:340px}
.welcome-logo{width:80px;height:80px;border-radius:24px;background:linear-gradient(135deg,#6366f1,#8b5cf6);display:flex;align-items:center;justify-content:center;font-size:2.2rem;color:#fff;margin:0 auto 24px;box-shadow:0 8px 32px rgba(99,102,241,.25)}
.welcome-brand{font-size:1.7rem;font-weight:800;color:var(--text);letter-spacing:-.5px;line-height:1.2}
.welcome-brand span{color:var(--primary)}
.welcome-sub{color:var(--text2);font-size:.85rem;margin-top:6px;margin-bottom:36px;font-weight:500}
.welcome-form{width:100%}
.welcome-input{width:100%;padding:15px 18px;border:2px solid rgba(0,0,0,.08);border-radius:14px;font-family:var(--font);font-size:1.1rem;font-weight:700;text-align:center;letter-spacing:3px;text-transform:uppercase;outline:none;transition:border-color .2s,box-shadow .2s;background:var(--surface);margin-bottom:12px}
.welcome-input:focus{border-color:var(--primary);box-shadow:0 0 0 4px rgba(99,102,241,.1)}
.welcome-input::placeholder{letter-spacing:0;text-transform:none;font-weight:500;color:var(--text3)}
.welcome-btn{width:100%;padding:15px;background:linear-gradient(135deg,var(--primary),var(--soc));color:#fff;border:none;border-radius:14px;font-family:var(--font);font-weight:800;font-size:.9rem;cursor:pointer;transition:transform .15s,box-shadow .15s,opacity .15s}
.welcome-btn:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(99,102,241,.3)}
.welcome-btn:active{transform:translateY(0)}
.welcome-btn:disabled{opacity:.5;cursor:not-allowed;transform:none;box-shadow:none}
.welcome-btn .btn-spinner{display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .6s linear infinite;vertical-align:middle;margin-right:8px}
@keyframes spin{to{transform:rotate(360deg)}}
.welcome-error{color:var(--danger);font-size:0.8rem;font-weight:600;margin-top:12px;min-height:20px}
.welcome-footer{margin-top:48px;font-size:0.8rem;color:var(--text3);font-weight:500}

/* â•â• Denied Screen â•â• */
.denied-screen{position:fixed;inset:0;z-index:9998;display:none;flex-direction:column;align-items:center;justify-content:center;background:var(--bg);padding:40px;text-align:center}
.denied-screen .denied-icon{width:80px;height:80px;border-radius:50%;background:linear-gradient(135deg,#fef3c7,#fde68a);display:flex;align-items:center;justify-content:center;font-size:2.5rem;margin-bottom:24px}
.denied-screen h2{font-size:1.2rem;font-weight:800;margin-bottom:10px}
.denied-screen p{color:var(--text2);font-size:.85rem;max-width:300px;line-height:1.6}
.denied-retry{margin-top:24px;padding:10px 24px;background:var(--surface);border:1px solid var(--border);border-radius:999px;font-family:var(--font);font-weight:700;font-size:.8rem;color:var(--text2);cursor:pointer;transition:all .15s}
.denied-retry:hover{background:var(--primary-light);color:var(--primary);border-color:rgba(99,102,241,.2)}

/* â•â• APP SHELL â•â• */
.app-container{max-width:440px;margin:0 auto;padding:0 18px;padding-bottom:calc(40px + env(safe-area-inset-bottom, 0px))}

/* â”€â”€ TOP BAR â”€â”€ */
.top-bar{display:flex;align-items:center;justify-content:space-between;padding:16px 0 8px}
.tb-left{display:flex;align-items:center;gap:10px}
.tb-avatar{width:44px;height:44px;border-radius:12px;background:linear-gradient(135deg,#6366f1,#8b5cf6);display:flex;align-items:center;justify-content:center;font-size:.85rem;font-weight:900;color:#fff;box-shadow:0 3px 12px rgba(99,102,241,.25)}
.tb-code{font-size:0.8rem;font-weight:700;color:var(--text3);letter-spacing:1.5px;text-transform:uppercase}
.tb-date{font-size:.85rem;font-weight:700;color:var(--text);margin-top:1px}
.tb-breath{width:44px;height:44px;border-radius:12px;background:var(--surface);border:1px solid var(--border);display:flex;align-items:center;justify-content:center;cursor:pointer;font-size:1.1rem;transition:all .2s;box-shadow:0 2px 8px rgba(0,0,0,.04)}
.tb-breath:hover{box-shadow:0 4px 16px rgba(99,102,241,.12)}
.tb-breath:active{transform:scale(.93)}

/* â”€â”€ CPS CIRCLES â”€â”€ */
.cps-row{display:flex;align-items:center;justify-content:center;gap:24px;padding:24px 0 20px}
.cps-item{text-align:center;cursor:pointer;transition:transform .2s}
.cps-item:hover{transform:scale(1.08)}
.cps-item:active{transform:scale(.94)}
.ring-box{width:82px;height:82px;position:relative;display:flex;align-items:center;justify-content:center;margin:0 auto 8px}
.ring-box svg{position:absolute;inset:0;transform:rotate(-90deg)}
.ring-box .rbg{fill:none;stroke:#e8e8ef;stroke-width:6}
.ring-box .rfill{fill:none;stroke-width:6;stroke-linecap:round;transition:stroke-dashoffset .8s cubic-bezier(.4,0,.2,1)}
.ring-box .rfill.cog{stroke:var(--cog)}.ring-box .rfill.emo{stroke:var(--emo)}.ring-box .rfill.soc{stroke:var(--soc)}
.ring-num{font-size:1.7rem;font-weight:900;position:relative;z-index:1}
.ring-name{font-size:0.8rem;font-weight:800;letter-spacing:.8px;text-transform:uppercase}
.ring-name.cog{color:var(--cog)}.ring-name.emo{color:var(--emo)}.ring-name.soc{color:var(--soc)}

/* â”€â”€ METEO CARD + AURA â”€â”€ */
.meteo-card{background:var(--surface);border-radius:var(--radius);padding:28px 24px;margin-bottom:20px;text-align:center;box-shadow:0 2px 12px rgba(0,0,0,.04);cursor:pointer;transition:all .5s ease;position:relative;overflow:hidden;border:2px solid var(--aura-border)}
.meteo-card:hover{box-shadow:0 6px 24px rgba(0,0,0,.08)}
.meteo-card::before{content:'';position:absolute;inset:-2px;border-radius:inherit;background:var(--aura-glow);opacity:1;transition:background .6s ease;pointer-events:none;z-index:0}
.meteo-card::after{content:'';position:absolute;top:-60%;left:50%;transform:translateX(-50%);width:200%;height:120%;background:radial-gradient(ellipse,var(--aura-color) 0%,transparent 60%);pointer-events:none;z-index:0;transition:background .6s ease}
.meteo-label{font-size:0.8rem;font-weight:800;text-transform:uppercase;letter-spacing:2px;color:var(--text3);margin-bottom:14px;position:relative;z-index:1}
.meteo-emoji{font-size:3.2rem;margin-bottom:8px;position:relative;z-index:1;transition:transform .3s}
.meteo-card:hover .meteo-emoji{transform:scale(1.1)}
.meteo-primary{font-size:1.4rem;font-weight:900;color:var(--text);position:relative;z-index:1}
.meteo-secondary{font-size:.9rem;color:var(--text2);margin-top:2px;position:relative;z-index:1;font-weight:600}
.meteo-hint{font-size:.82rem;color:var(--text3);margin-top:8px;position:relative;z-index:1;font-weight:500;font-style:italic}
.meteo-btn{margin-top:16px;padding:10px 24px;border-radius:999px;background:var(--surface2);border:1px solid var(--border);color:var(--text2);font-family:var(--font);font-size:.8rem;font-weight:700;cursor:pointer;transition:all .15s;position:relative;z-index:1}
.meteo-btn:hover{background:var(--primary-light);color:var(--primary);border-color:rgba(99,102,241,.2)}

/* â”€â”€ 3 BOUTONS ACTION â”€â”€ */
.actions-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px;margin-bottom:24px}
.act-card{background:var(--surface);border:2px solid var(--border);border-radius:var(--radius);padding:22px 8px 18px;text-align:center;cursor:pointer;transition:all .25s cubic-bezier(.4,0,.2,1);font-family:var(--font)}
.act-card:hover{transform:translateY(-3px);box-shadow:0 8px 28px rgba(0,0,0,.08)}
.act-card:active{transform:translateY(-1px) scale(.97)}
.act-card.lit{animation:card-light .5s ease-out}
@keyframes card-light{0%{box-shadow:0 0 0 0 rgba(99,102,241,.3)}50%{box-shadow:0 0 24px 4px rgba(99,102,241,.12)}100%{box-shadow:0 8px 28px rgba(0,0,0,.08)}}
.act-card.c-stage:hover,.act-card.c-stage.lit{border-color:rgba(245,158,11,.25)}
.act-card.c-objectif:hover,.act-card.c-objectif.lit{border-color:rgba(99,102,241,.25)}
.act-card.c-evolution:hover,.act-card.c-evolution.lit{border-color:rgba(16,185,129,.25)}
.act-name{font-size:.95rem;font-weight:900;color:var(--text);line-height:1.3}
.act-badge{display:inline-block;margin-top:10px;padding:3px 10px;border-radius:999px;font-size:0.8rem;font-weight:800}
.act-badge.warn{background:rgba(245,158,11,.1);color:#92400e}
.act-badge.primary-b{background:rgba(99,102,241,.08);color:var(--primary)}
.act-badge.success{background:rgba(16,185,129,.08);color:#065f46}

/* â”€â”€ PROCHAINES MISSIONS â”€â”€ */
.missions-section{margin-bottom:20px}
.missions-title{font-size:0.8rem;font-weight:800;text-transform:uppercase;letter-spacing:1.5px;color:var(--text3);margin-bottom:12px}
.mission-card{background:var(--surface);border-radius:var(--radius-sm);padding:16px;margin-bottom:10px;display:flex;align-items:center;gap:14px;position:relative;overflow:hidden;cursor:pointer;transition:all .15s;box-shadow:0 1px 4px rgba(0,0,0,.03)}
.mission-card:hover{box-shadow:0 4px 16px rgba(0,0,0,.06);transform:translateX(2px)}
.mission-card::before{content:'';position:absolute;left:0;top:0;bottom:0;width:5px;border-radius:0 4px 4px 0}
.mission-card.urgent::before{background:linear-gradient(180deg,var(--emo),#f97316)}
.mission-card.soon::before{background:linear-gradient(180deg,var(--cog),var(--soc))}
.mission-card.ok::before{background:linear-gradient(180deg,var(--success),#34d399)}
.mission-time{flex-shrink:0;display:flex;flex-direction:column;align-items:center;gap:4px;min-width:68px}
.mission-time-icon{font-size:1.3rem}
.mission-time-label{padding:4px 10px;border-radius:8px;font-size:0.8rem;font-weight:800;text-transform:uppercase;letter-spacing:.3px}
.mission-card.urgent .mission-time-label{background:rgba(244,63,94,.08);color:var(--emo)}
.mission-card.soon .mission-time-label{background:rgba(99,102,241,.06);color:var(--primary)}
.mission-card.ok .mission-time-label{background:rgba(16,185,129,.06);color:var(--success)}
.mission-encourage{font-size:0.8rem;font-weight:700;font-style:italic;margin-top:4px}
.mission-card.urgent .mission-encourage{color:var(--emo)}
.mission-card.soon .mission-encourage{color:var(--primary)}
.mission-card.ok .mission-encourage{color:var(--success)}
.mission-info{flex:1;min-width:0}
.mission-name{font-weight:800;font-size:.92rem;color:var(--text);line-height:1.3;margin-bottom:4px}
.mission-detail{font-size:0.82rem;color:var(--text2);display:flex;align-items:center;gap:6px;font-weight:500}
.mission-dot{width:6px;height:6px;border-radius:50%;flex-shrink:0}
.mission-dot.cog{background:var(--cog)}.mission-dot.emo{background:var(--emo)}.mission-dot.soc{background:var(--soc)}.mission-dot.neu{background:var(--text3)}
.mission-stars{display:flex;gap:2px;margin-top:6px;align-items:center}
.mission-star{font-size:.8rem}.mission-star.on{color:#fbbf24}.mission-star.off{color:#e2e8f0}
.mission-valid{font-size:0.8rem;color:var(--text3);margin-left:4px;font-weight:700}
.empty-missions{text-align:center;color:var(--text3);font-size:.85rem;padding:20px 0;font-style:italic}

/* â”€â”€ OVERLAYS (common) â”€â”€ */
.overlay{position:fixed;inset:0;z-index:200;background:var(--bg);display:none;flex-direction:column;overflow:hidden}
.overlay.show{display:flex}
.overlay-header{padding:14px 20px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;z-index:10}
.overlay-title{font-weight:800;font-size:1.05rem}
.overlay-close{width:44px;height:44px;border-radius:12px;border:none;background:var(--surface2);cursor:pointer;font-size:1rem;display:flex;align-items:center;justify-content:center;transition:all .1s;color:var(--text)}
.overlay-close:active{transform:scale(.9)}
.overlay-body{flex:1;overflow-y:auto;padding:20px}
.oc{max-width:440px;margin:0 auto}

/* â”€â”€ MOOD OVERLAY (BIG buttons) â”€â”€ */
.mood-grid-big{display:grid;grid-template-columns:repeat(2,1fr);gap:14px;max-width:400px;margin:0 auto}
.mood-big-btn{background:var(--surface);border:2px solid var(--border);border-radius:var(--radius);padding:28px 16px;text-align:center;cursor:pointer;transition:all .2s;font-family:var(--font)}
.mood-big-btn:hover{border-color:var(--primary);transform:translateY(-3px);box-shadow:0 6px 20px rgba(0,0,0,.08)}
.mood-big-btn:active{transform:scale(.95)}
.mood-big-btn .mb-emoji{font-size:3rem;margin-bottom:10px}
.mood-big-btn .mb-label{font-size:1.1rem;font-weight:800;color:var(--text)}
.mood-sec-back{display:inline-flex;align-items:center;gap:4px;font-size:.82rem;font-weight:700;color:var(--text2);cursor:pointer;background:none;border:none;font-family:var(--font);margin-bottom:16px;padding:0}
.mood-sec-title{font-size:1.3rem;font-weight:900;text-align:center;margin-bottom:6px}
.mood-sec-sub{text-align:center;color:var(--text2);font-size:.88rem;margin-bottom:24px}
.mood-sec-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:10px;max-width:400px;margin:0 auto}
.mood-sec-chip{padding:16px 10px;background:var(--surface);border:2px solid var(--border);border-radius:var(--radius-sm);font-family:var(--font);font-size:1rem;font-weight:700;color:var(--text);cursor:pointer;transition:all .2s;text-align:center}
.mood-sec-chip:hover{border-color:var(--primary);background:var(--primary-light);color:var(--primary)}
.mood-sec-chip:active{transform:scale(.95)}

/* â”€â”€ OBJECTIFS OVERLAY â”€â”€ */
.add-btn{width:100%;padding:16px;background:linear-gradient(135deg,var(--primary),#8b5cf6);color:#fff;border:none;border-radius:var(--radius-sm);font-family:var(--font);font-weight:800;font-size:.95rem;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;margin-bottom:20px;transition:all .2s;box-shadow:0 4px 20px rgba(99,102,241,.25)}
.add-btn:hover{transform:translateY(-2px);box-shadow:0 8px 28px rgba(99,102,241,.35)}
.add-btn:active{transform:translateY(0)}
.add-btn.stage-add{background:linear-gradient(135deg,#f59e0b,#f97316);box-shadow:0 4px 20px rgba(245,158,11,.25)}
.add-btn.stage-add:hover{box-shadow:0 8px 28px rgba(245,158,11,.35)}
.obj-section-title{font-size:0.8rem;font-weight:800;text-transform:uppercase;letter-spacing:1.5px;color:var(--text3);margin-bottom:12px;display:flex;align-items:center;gap:8px}
.obj-section-title .count{background:var(--primary-light);color:var(--primary);padding:2px 8px;border-radius:99px;font-size:0.8rem}
.obj-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:16px 18px;margin-bottom:10px;display:flex;align-items:flex-start;gap:14px;cursor:pointer;transition:all .15s;position:relative;overflow:hidden}
.obj-card:hover{box-shadow:0 4px 16px rgba(0,0,0,.06)}
.obj-card::before{content:'';position:absolute;left:0;top:0;bottom:0;width:4px}
.obj-card.soc::before{background:var(--soc)}.obj-card.cog::before{background:var(--cog)}.obj-card.emo::before{background:var(--emo)}.obj-card.neu::before{background:var(--text3)}
.obj-check{width:26px;height:26px;border-radius:10px;border:2px solid #d1d5db;background:var(--surface2);display:flex;align-items:center;justify-content:center;flex-shrink:0;margin-top:2px;cursor:pointer;transition:all .15s}
.obj-check:hover{border-color:var(--success);background:rgba(16,185,129,.08)}
.obj-body{flex:1;min-width:0}
.obj-title{font-weight:700;font-size:.92rem;line-height:1.35;margin-bottom:6px;color:var(--text)}
.obj-meta{display:flex;align-items:center;gap:8px;font-size:0.8rem;color:var(--text3);flex-wrap:wrap;margin-bottom:6px}
.obj-badge{padding:3px 10px;border-radius:8px;font-weight:700;font-size:0.8rem;text-transform:uppercase;background:var(--surface2);color:var(--text2)}
.obj-time{font-weight:800}.obj-time.urgent{color:var(--danger)}.obj-time.ok{color:var(--success)}
.obj-stars{display:flex;gap:2px;align-items:center}
.obj-star{font-size:.9rem}.obj-star.on{color:#fbbf24}.obj-star.off{color:#e2e8f0}
.obj-valid{font-size:0.8rem;color:var(--text3);margin-left:4px;font-weight:700}
.obj-card.done{opacity:.5}
.obj-card.done .obj-title{text-decoration:line-through;color:var(--text3)}
.obj-card.done .obj-check{background:var(--success);border-color:var(--success)}

/* â”€â”€ WIZARD STYLES â”€â”€ */
.wiz-title{font-size:1rem;font-weight:800;margin-bottom:14px}
.wiz-option{width:100%;text-align:left;padding:15px 16px;margin-bottom:8px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);font-family:var(--font);font-weight:600;font-size:0.9rem;color:var(--text);cursor:pointer;transition:all .15s}
.wiz-option:hover{border-color:var(--primary);background:var(--primary-light)}
.wiz-option-label{display:block;font-size:0.9rem;font-weight:700;color:var(--text);line-height:1.4;margin-bottom:4px}
.wiz-option-comp{display:block;font-size:0.75rem;font-weight:600;color:var(--text3);font-style:italic}
.wiz-option-comp-row{display:flex;align-items:center;gap:8px;flex-wrap:wrap}
.wiz-option-custom{display:inline-flex;align-items:center;padding:2px 8px;border-radius:999px;font-size:0.7rem;font-weight:700;color:var(--primary);background:var(--primary-light);border:1px solid rgba(99,102,241,.16)}
.wiz-back{display:inline-flex;align-items:center;gap:4px;font-size:.8rem;font-weight:700;color:var(--text2);cursor:pointer;margin-bottom:14px;background:none;border:none;font-family:var(--font)}
.wiz-search{width:100%;padding:11px 14px;border:1px solid var(--border);border-radius:var(--radius-sm);font-family:var(--font);font-size:.8rem;margin-bottom:14px;outline:none}
.wiz-search:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(99,102,241,.08)}
.wiz-section-h{font-size:0.8rem;font-weight:800;text-transform:uppercase;letter-spacing:.8px;color:var(--text3);margin:14px 0 8px}
.wiz-chip{display:inline-flex;align-items:center;gap:8px;padding:9px 14px;border-radius:999px;background:var(--surface);border:1px solid var(--border);font-weight:600;font-size:.85rem;cursor:pointer;transition:all .15s;margin:0 5px 7px 0}
.wiz-chip:hover{border-color:var(--primary);box-shadow:var(--shadow)}
.wiz-chip .dot{width:9px;height:9px;border-radius:50%;flex-shrink:0}
.wiz-summary{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px;margin-bottom:14px}
.wiz-summary .ws-row{display:flex;justify-content:space-between;padding:5px 0;font-size:.85rem}
.wiz-summary .ws-label{font-weight:700;color:var(--text3)}.wiz-summary .ws-value{font-weight:600;text-align:right;max-width:60%}
.wiz-confirm{width:100%;padding:14px;background:var(--primary);color:#fff;border:none;border-radius:var(--radius-sm);font-family:var(--font);font-weight:800;font-size:.85rem;cursor:pointer}
.wiz-confirm:hover{background:#4f46e5}
.wiz-switch{display:flex;gap:0;background:var(--bg);border-radius:var(--radius-sm);padding:3px;margin-bottom:14px}
.wiz-switch-btn{flex:1;padding:8px;border:none;border-radius:9px;font-family:var(--font);font-size:0.8rem;font-weight:700;cursor:pointer;background:transparent;color:var(--text2);transition:all .15s}
.wiz-switch-btn.active{background:var(--surface);color:var(--primary);box-shadow:0 1px 3px rgba(0,0,0,.08)}

/* â”€â”€ RECAP CARD â”€â”€ */
.recap-card{background:var(--surface);border-radius:var(--radius);overflow:hidden;margin-bottom:16px;border:1px solid var(--border)}
.recap-header{padding:22px 20px;position:relative;overflow:hidden}
.recap-header::before{content:'';position:absolute;top:-30px;right:-30px;width:120px;height:120px;border-radius:50%;opacity:.07}
.recap-header.cog{background:linear-gradient(135deg,rgba(59,130,246,.12),rgba(59,130,246,.02))}.recap-header.cog::before{background:#3b82f6}
.recap-header.emo{background:linear-gradient(135deg,rgba(244,63,94,.12),rgba(244,63,94,.02))}.recap-header.emo::before{background:#f43f5e}
.recap-header.soc{background:linear-gradient(135deg,rgba(139,92,246,.12),rgba(139,92,246,.02))}.recap-header.soc::before{background:#8b5cf6}
.recap-header.neu{background:var(--bg)}
.recap-badge{display:inline-flex;align-items:center;gap:6px;padding:4px 12px;border-radius:999px;font-size:0.8rem;font-weight:800;text-transform:uppercase;letter-spacing:1px;background:rgba(255,255,255,.65);backdrop-filter:blur(4px);margin-bottom:10px;color:var(--text2)}
.recap-titre-display{font-weight:800;font-size:1.15rem;line-height:1.3;margin-bottom:8px;letter-spacing:-.3px}
.recap-cps-tree{font-size:0.8rem;color:var(--text2);line-height:1.8}
.recap-cps-node{display:flex;align-items:center;gap:6px}.recap-cps-node.level-1{font-weight:700}.recap-cps-node.level-2{padding-left:16px;opacity:.85}.recap-cps-node.level-3{padding-left:32px;font-weight:800}
.recap-cps-dot{width:8px;height:8px;border-radius:50%;flex-shrink:0}
.recap-body{padding:20px;display:flex;flex-direction:column;gap:18px}
.recap-field-label{font-size:0.8rem;font-weight:800;text-transform:uppercase;letter-spacing:1px;color:var(--text3);margin-bottom:7px;display:flex;align-items:center;gap:5px}
.recap-info-text{font-size:0.8rem;color:var(--text3);margin-top:4px;font-style:italic}
.recap-suggestions{display:flex;flex-wrap:wrap;gap:6px;margin-top:10px}
.recap-sugg{padding:7px 13px;background:var(--bg);border:1px solid var(--border);border-radius:999px;font-size:0.8rem;font-weight:600;cursor:pointer;transition:all .15s;font-family:var(--font);color:var(--text2)}
.recap-sugg:hover,.recap-sugg:active{border-color:var(--primary);color:var(--primary);background:var(--primary-light)}
.recap-demarche{background:var(--bg);border-radius:var(--radius-sm);padding:14px 16px;margin-bottom:10px;position:relative;border:1px solid var(--border)}
.recap-demarche-head{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px}
.recap-demarche-num{font-size:0.8rem;font-weight:800;color:var(--text3);text-transform:uppercase;letter-spacing:.5px}
.recap-demarche-del{background:none;border:none;color:var(--emo);font-size:0.8rem;font-weight:700;cursor:pointer;font-family:var(--font);padding:2px 8px;border-radius:6px}.recap-demarche-del:hover{background:rgba(244,63,94,.06)}
.recap-demarche .fi{margin-bottom:8px}
.recap-demarche label{font-size:0.8rem;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;display:block;margin-bottom:3px}
.recap-contact-grid{display:flex;flex-wrap:wrap;gap:6px;margin-bottom:8px}
.recap-contact-btn{padding:7px 12px;border:1px solid var(--border);border-radius:999px;background:var(--surface);font-size:0.8rem;font-weight:600;cursor:pointer;font-family:var(--font);transition:all .15s;color:var(--text2)}
.recap-contact-btn:hover{border-color:var(--primary)}.recap-contact-btn.active{background:var(--primary);color:#fff;border-color:var(--primary)}
.recap-add-btn{width:100%;padding:13px;border:2px dashed rgba(99,102,241,.25);border-radius:var(--radius-sm);background:none;font-family:var(--font);font-weight:700;font-size:.8rem;color:var(--primary);cursor:pointer;transition:all .15s}
.recap-add-btn:hover{background:var(--primary-light);border-color:var(--primary)}
.recap-warn{padding:12px 16px;background:rgba(245,158,11,.06);border:1px solid rgba(245,158,11,.12);border-radius:var(--radius-sm);font-size:.8rem;color:#92400e;margin-bottom:14px;display:flex;align-items:flex-start;gap:8px;line-height:1.5}
.recap-warn-btns{display:flex;gap:10px;margin-top:4px}
.recap-warn-btns button{flex:1;padding:12px;border:none;border-radius:var(--radius-sm);font-family:var(--font);font-weight:700;font-size:.8rem;cursor:pointer}

/* â”€â”€ DETAIL OVERLAY â”€â”€ */
.mission-header{padding:16px;border-radius:var(--radius);margin-bottom:14px}
.mission-header.cog{background:linear-gradient(135deg,rgba(59,130,246,.08),rgba(59,130,246,.02))}.mission-header.emo{background:linear-gradient(135deg,rgba(244,63,94,.08),rgba(244,63,94,.02))}.mission-header.soc{background:linear-gradient(135deg,rgba(139,92,246,.08),rgba(139,92,246,.02))}.mission-header.neu{background:var(--bg)}
.mission-cadre{display:inline-flex;align-items:center;gap:6px;font-size:0.8rem;font-weight:800;text-transform:uppercase;letter-spacing:.8px;color:var(--text3);margin-bottom:8px}
.mission-titre{font-weight:800;font-size:1.05rem;line-height:1.35;margin-bottom:6px}
.mission-comp-bloc{display:flex;align-items:flex-start;gap:10px;background:var(--primary-light);border:1px solid rgba(99,102,241,.15);border-radius:var(--radius-sm);padding:10px 14px;margin:8px 0 12px}
.mission-comp-icon{font-size:1.1rem;flex-shrink:0;margin-top:1px}
.mission-comp-text{flex:1}
.mission-comp-name{font-size:0.88rem;font-weight:800;color:var(--primary);line-height:1.3}
.mission-comp-code{font-size:0.75rem;font-weight:600;color:var(--text3);margin-top:2px}
.mission-cps{font-size:0.85rem;color:var(--text2);font-weight:600}
.mission-status{display:inline-flex;align-items:center;gap:4px;padding:3px 10px;border-radius:999px;font-size:0.8rem;font-weight:700;margin-top:6px}
.mission-status.en-cours{background:rgba(245,158,11,.1);color:#92400e}.mission-status.valide{background:rgba(16,185,129,.1);color:#065f46}
.mission-block{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px;margin-bottom:10px}
.mission-block-title{font-size:0.8rem;font-weight:800;text-transform:uppercase;letter-spacing:.8px;color:var(--text3);margin-bottom:10px}
.mb-row{display:flex;align-items:center;gap:8px;padding:5px 0;font-size:.8rem}
.mb-row .mb-icon{font-size:1rem;width:22px;text-align:center;flex-shrink:0}
.mb-row .mb-label{color:var(--text2);font-weight:600;min-width:55px}
.mb-row .mb-val{font-weight:700;flex:1}
.mission-timeline{display:flex;align-items:center;gap:10px;padding:6px 0}
.tl-bar{flex:1;height:6px;background:#e2e8f0;border-radius:3px;overflow:hidden}
.tl-fill{height:100%;border-radius:3px;transition:width .5s var(--ease)}
.tl-days{font-size:0.8rem;font-weight:800;white-space:nowrap}
.mission-cps-link{width:100%;padding:11px 14px;background:var(--primary-light);border:1px solid rgba(99,102,241,.15);border-radius:var(--radius-sm);font-family:var(--font);font-weight:700;font-size:0.85rem;color:var(--primary);cursor:pointer;display:flex;align-items:center;gap:8px;margin-bottom:10px;transition:all .15s}
.mission-cps-link:hover{background:rgba(99,102,241,.12)}
.mission-history{font-size:0.8rem;color:var(--text3);line-height:1.8}
.mh-entry{display:flex;gap:8px;align-items:flex-start}.mh-dot{width:6px;height:6px;border-radius:50%;background:var(--text3);margin-top:6px;flex-shrink:0}.mh-text{flex:1}
.mission-actions{display:flex;flex-direction:column;gap:8px;margin-top:14px}
.btn-mission{width:100%;padding:14px;border:none;border-radius:var(--radius-sm);font-family:var(--font);font-weight:700;font-size:.9rem;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px}
.btn-mission.primary{background:var(--primary);color:#fff}.btn-mission.outline{background:transparent;border:2px dashed rgba(99,102,241,.3);color:var(--primary)}
.btn-mission.danger{background:transparent;border:1px solid rgba(239,68,68,.2);color:var(--emo);font-size:0.85rem}

/* â”€â”€ CPS SPACE â”€â”€ */
.cps-space-hero{text-align:center;padding:20px;border-radius:var(--radius);margin-bottom:16px}
.cps-space-hero.cog{background:linear-gradient(135deg,rgba(59,130,246,.08),rgba(59,130,246,.02))}.cps-space-hero.emo{background:linear-gradient(135deg,rgba(244,63,94,.08),rgba(244,63,94,.02))}.cps-space-hero.soc{background:linear-gradient(135deg,rgba(139,92,246,.08),rgba(139,92,246,.02))}
.cps-space-emoji{font-size:2.5rem;margin-bottom:6px}.cps-space-name{font-weight:800;font-size:1.05rem;margin-bottom:2px}.cps-space-sub{font-size:.8rem;color:var(--text2)}
.cps-space-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px}
.cps-stat{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px;text-align:center}
.cps-stat-val{font-weight:800;font-size:1.3rem}.cps-stat-lbl{font-size:0.8rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);margin-top:2px}
.cps-space-section{margin-bottom:16px}
.cps-space-section h4{font-size:0.8rem;font-weight:800;text-transform:uppercase;letter-spacing:.8px;color:var(--text3);margin-bottom:8px}
.cps-comp-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px 14px;margin-bottom:6px;cursor:pointer;transition:all .15s}
.cps-comp-card:hover{box-shadow:var(--shadow)}
.cps-comp-title{font-weight:700;font-size:.82rem;margin-bottom:2px}.cps-comp-gen{font-size:0.8rem;color:var(--text3)}
.cps-formation-btn{width:100%;padding:14px;background:linear-gradient(135deg,var(--primary),var(--soc));color:#fff;border:none;border-radius:var(--radius-sm);font-family:var(--font);font-weight:800;font-size:.85rem;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;margin-top:6px}
.formation-block{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px;margin-bottom:12px}
.formation-block h4{font-size:.85rem;font-weight:800;margin-bottom:8px;display:flex;align-items:center;gap:8px}
.formation-block p{font-size:.8rem;color:var(--text2);line-height:1.6}
.formation-tag{display:inline-flex;padding:4px 10px;border-radius:6px;font-size:0.8rem;font-weight:700;margin:0 4px 4px 0}

/* â”€â”€ RECO / QR â”€â”€ */
.reco-choice{display:flex;flex-direction:column;gap:10px;margin-top:16px}
.reco-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:16px 18px;display:flex;align-items:center;gap:14px;cursor:pointer;transition:all .15s;font-family:var(--font)}
.reco-card:hover{box-shadow:var(--shadow-lg);transform:translateY(-2px)}
.rc-icon{width:42px;height:42px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.3rem;flex-shrink:0}
.rc-text{font-weight:700;font-size:.85rem}.rc-sub{font-size:0.8rem;color:var(--text3);margin-top:2px}
.qr-center{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;text-align:center;padding:40px}
.qr-center h3{font-size:1rem;font-weight:800;margin-bottom:18px}
#qrcode-container{display:flex;justify-content:center;padding:14px;background:var(--surface);border-radius:var(--radius);box-shadow:var(--shadow)}
.qr-center p{font-size:.85rem;color:var(--text2);margin-top:14px}

/* â”€â”€ ATTESTATION â”€â”€ */
.attest-radar{max-width:260px;margin:0 auto 20px}
.attest-card{background:var(--surface);border-radius:var(--radius);padding:18px;margin-bottom:10px;border-left:4px solid}
.attest-card.cog{border-left-color:var(--cog)}.attest-card.emo{border-left-color:var(--emo)}.attest-card.soc{border-left-color:var(--soc)}
.attest-card h4{font-size:.85rem;font-weight:800;margin-bottom:4px}
.attest-card p{font-size:.85rem;color:var(--text2);line-height:1.5}

/* â”€â”€ STAGE LIEUX â”€â”€ */
.stage-lieu{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px 14px;margin-bottom:6px;display:flex;align-items:center;justify-content:space-between}
.stage-lieu-name{font-weight:700;font-size:.8rem}.stage-lieu-meta{font-size:0.8rem;color:var(--text3)}

/* â”€â”€ BREATH OVERLAY â”€â”€ */
.breath-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;padding:40px;text-align:center;background:linear-gradient(180deg,#f0f0ff 0%,var(--bg) 100%)}
.breath-orb{width:200px;height:200px;border-radius:50%;background:radial-gradient(circle at 40% 35%,rgba(99,102,241,.1),rgba(139,92,246,.06));border:3px solid rgba(99,102,241,.2);display:flex;align-items:center;justify-content:center;flex-direction:column;transition:all 4s cubic-bezier(.4,0,.2,1);margin-bottom:36px;box-shadow:0 0 60px rgba(99,102,241,.06);cursor:pointer}
.breath-orb.inhale{width:280px;height:280px;border-color:rgba(59,130,246,.35);box-shadow:0 0 80px rgba(59,130,246,.1)}
.breath-orb.exhale{width:150px;height:150px;border-color:rgba(139,92,246,.25)}
.breath-orb.hold{border-color:rgba(16,185,129,.3);box-shadow:0 0 60px rgba(16,185,129,.08)}
.breath-word{font-size:1.4rem;font-weight:800;color:var(--primary)}
.breath-num{font-size:2.8rem;font-weight:900;color:var(--primary);margin-top:4px;font-variant-numeric:tabular-nums}
.breath-sub{font-size:.85rem;color:var(--text2);margin-bottom:24px}
.breath-elapsed{font-size:.8rem;color:var(--text3);margin-bottom:16px}
.breath-close{background:var(--surface);border:1px solid var(--border);padding:10px 28px;border-radius:999px;font-family:var(--font);font-weight:700;font-size:.8rem;cursor:pointer}

/* â”€â”€ UTILS â”€â”€ */
.fi{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;font-family:var(--font);font-size:.82rem;margin-bottom:8px;outline:none}
.hidden{display:none!important}
.empty-msg{text-align:center;color:var(--text3);font-size:.8rem;font-style:italic;padding:24px 0}
@keyframes fadeUp{from{opacity:0;transform:translateY(14px)}to{opacity:1;transform:translateY(0)}}
.a1{animation:fadeUp .4s .05s both}.a2{animation:fadeUp .4s .12s both}.a3{animation:fadeUp .4s .2s both}.a4{animation:fadeUp .4s .28s both}.a5{animation:fadeUp .4s .36s both}
@keyframes pulse-soft{0%,100%{opacity:.7}50%{opacity:1}}
.pulse{animation:pulse-soft 2s ease-in-out infinite}

@media (max-width: 360px) {
  .actions-grid { grid-template-columns: repeat(2,1fr); gap:10px; }
  .cps-row { gap: 12px; }
  .ring-box { width: 68px; height: 68px; }
  .ring-num { font-size: 1.4rem; }
  .meteo-primary { font-size: 1.15rem; }
  .welcome-brand { font-size: 1.4rem; }
}

@media (max-width: 320px) {
  .actions-grid { grid-template-columns: 1fr 1fr; gap:8px; }
  .act-card { padding: 16px 6px 14px; }
  .cps-row { gap: 8px; }
  .ring-box { width: 60px; height: 60px; }
}
</style>
</head>
<body>

<!-- â•â•â• WELCOME SCREEN â•â•â• -->
<div class="welcome-screen" id="welcome">
  <div class="welcome-content">
    <div class="welcome-logo">â—ˆ</div>
    <h1 class="welcome-brand">mon<span>objectif</span>.fr</h1>
    <p class="welcome-sub">Bienvenue sur ton espace personnel</p>
    <div class="welcome-form">
      <input type="text" class="welcome-input" id="code-input" placeholder="Code secret" maxlength="16" autocomplete="off" spellcheck="false" autofocus>
      <button class="welcome-btn" id="code-btn" onclick="submitCode()">AccÃ©der Ã  mon espace</button>
    </div>
    <p class="welcome-error" id="welcome-error"></p>
    <p class="welcome-footer">Espace sÃ©curisÃ© Â· Code fourni par ton enseignant</p>
  </div>
</div>

<!-- â•â•â• DENIED SCREEN â•â•â• -->
<div class="denied-screen" id="access-denied">
  <div class="denied-icon" id="denied-icon">â³</div>
  <h2 id="denied-title">Ton espace n'est pas encore actif</h2>
  <p id="denied-msg">Ton enseignant doit d'abord activer ton accÃ¨s.</p>
  <button class="denied-retry" onclick="backToWelcome()">â† RÃ©essayer</button>
</div>

<!-- â•â•â• APP (V3b Dashboard) â•â•â• -->
<div id="app" style="display:none">
  <div class="app-container">

    <!-- TOP BAR -->
    <div class="top-bar a1">
      <div class="tb-left">
        <div class="tb-avatar" id="tb-avatar">â€”</div>
        <div>
          <div class="tb-code" id="display-code">â€”</div>
          <div class="tb-date" id="h-date"></div>
        </div>
      </div>
      <button class="tb-breath" onclick="openBreathing()">ğŸŒ¬</button>
    </div>

    <!-- CPS CIRCLES -->
    <div class="cps-row a2">
      <div class="cps-item" onclick="openCpsSpace('COG')">
        <div class="ring-box">
          <svg viewBox="0 0 82 82"><circle class="rbg" cx="41" cy="41" r="36"/><circle class="rfill cog" cx="41" cy="41" r="36" stroke-dasharray="226.19" id="ring-cog-circle" stroke-dashoffset="226.19"/></svg>
          <span class="ring-num" style="color:var(--cog)" id="val-cog">0</span>
        </div>
        <div class="ring-name cog">Cognitif</div>
      </div>
      <div class="cps-item" onclick="openCpsSpace('EMO')">
        <div class="ring-box">
          <svg viewBox="0 0 82 82"><circle class="rbg" cx="41" cy="41" r="36"/><circle class="rfill emo" cx="41" cy="41" r="36" stroke-dasharray="226.19" id="ring-emo-circle" stroke-dashoffset="226.19"/></svg>
          <span class="ring-num" style="color:var(--emo)" id="val-emo">0</span>
        </div>
        <div class="ring-name emo">Ã‰motion</div>
      </div>
      <div class="cps-item" onclick="openCpsSpace('SOC')">
        <div class="ring-box">
          <svg viewBox="0 0 82 82"><circle class="rbg" cx="41" cy="41" r="36"/><circle class="rfill soc" cx="41" cy="41" r="36" stroke-dasharray="226.19" id="ring-soc-circle" stroke-dashoffset="226.19"/></svg>
          <span class="ring-num" style="color:var(--soc)" id="val-soc">0</span>
        </div>
        <div class="ring-name soc">Social</div>
      </div>
    </div>

    <!-- METEO with AURA -->
    <div class="meteo-card a3" id="meteo-card" onclick="openMood()">
      <div class="meteo-label">Humeur du jour</div>
      <div class="meteo-emoji" id="m-emoji">ğŸ˜Š</div>
      <div class="meteo-primary" id="m-primary">â€”</div>
      <div class="meteo-secondary" id="m-secondary"></div>
      <div class="meteo-hint" id="m-hint"></div>
      <button class="meteo-btn">Changer l'humeur</button>
    </div>

    <!-- 3 BOUTONS -->
    <div class="actions-grid a4">
      <div class="act-card c-stage" onclick="litCard(this);openStageOverlay()">
        <div class="act-name">Mon<br>Stage</div>
        <div class="act-badge warn" id="badge-stage">0</div>
      </div>
      <div class="act-card c-objectif" onclick="litCard(this);openObjectifsOverlay()">
        <div class="act-name">Mon<br>Objectif</div>
        <div class="act-badge primary-b" id="badge-objectif">0</div>
      </div>
      <div class="act-card c-evolution" onclick="litCard(this);openAttestation()">
        <div class="act-name">Mon<br>Ã‰volution</div>
        <div class="act-badge success">Voir</div>
      </div>
    </div>

    <!-- PROCHAINES MISSIONS -->
    <div class="missions-section a5">
      <div class="missions-title">â³ Prochaines missions</div>
      <div id="missions-list"><div class="empty-missions">Ajoute un objectif pour voir tes missions ici</div></div>
    </div>

  </div>
</div>

<!-- â•â•â• OVERLAYS â•â•â• -->

<!-- OBJECTIFS -->
<div class="overlay" id="objectifs-overlay">
  <div class="overlay-header"><span class="overlay-title">ğŸ¯ Mon Objectif</span><button class="overlay-close" onclick="closeOv('objectifs-overlay')">âœ•</button></div>
  <div class="overlay-body"><div class="oc" id="objectifs-content"></div></div>
</div>

<!-- STAGE -->
<div class="overlay" id="stage-overlay">
  <div class="overlay-header"><span class="overlay-title">ğŸ¢ Mon Stage</span><button class="overlay-close" onclick="closeOv('stage-overlay')">âœ•</button></div>
  <div class="overlay-body"><div class="oc" id="stage-content"></div></div>
</div>

<!-- WIZARD -->
<div class="overlay" id="wizard-overlay">
  <div class="overlay-header"><span class="overlay-title">Nouvel Objectif</span><button class="overlay-close" onclick="closeOv('wizard-overlay')">âœ•</button></div>
  <div class="overlay-body"><div class="oc" id="wizard-content"></div></div>
</div>

<!-- MOOD -->
<div class="overlay" id="mood-overlay">
  <div class="overlay-header"><span class="overlay-title">Comment te sens-tu ?</span><button class="overlay-close" onclick="closeOv('mood-overlay')">âœ•</button></div>
  <div class="overlay-body"><div class="oc" id="mood-content"></div></div>
</div>

<!-- BREATHING -->
<div class="overlay" id="breath-overlay">
  <div class="breath-screen">
    <div class="breath-orb" id="b-orb" onclick="startBreath()">
      <div class="breath-word" id="b-word">PrÃªt ?</div>
      <div class="breath-num" id="b-num"></div>
    </div>
    <div class="breath-sub">Inspire par le nez Â· Expire par la bouche</div>
    <div class="breath-elapsed" id="b-elapsed">Touche le cercle pour commencer</div>
    <button class="breath-close" onclick="stopBreathing()">Fermer</button>
  </div>
</div>

<!-- DETAIL -->
<div class="overlay" id="detail-overlay">
  <div class="overlay-header"><span class="overlay-title">Mon objectif</span><button class="overlay-close" onclick="closeOv('detail-overlay')">âœ•</button></div>
  <div class="overlay-body"><div class="oc" id="detail-content"></div></div>
</div>

<!-- CPS SPACE -->
<div class="overlay" id="cps-overlay">
  <div class="overlay-header"><span class="overlay-title" id="cps-space-title">â€”</span><button class="overlay-close" onclick="closeOv('cps-overlay')">âœ•</button></div>
  <div class="overlay-body"><div class="oc" id="cps-space-content"></div></div>
</div>

<!-- FORMATION -->
<div class="overlay" id="formation-overlay">
  <div class="overlay-header"><span class="overlay-title" id="formation-title">Explorer</span><button class="overlay-close" onclick="closeOv('formation-overlay')">âœ•</button></div>
  <div class="overlay-body"><div class="oc" id="formation-content"></div></div>
</div>

<!-- QR -->
<div class="overlay" id="qr-overlay">
  <div class="qr-center"><h3>Faire valider</h3><div id="qrcode-container"></div><p>PrÃ©sente ce code Ã  l'adulte.</p><button class="breath-close" style="margin-top:18px" onclick="closeOv('qr-overlay')">Fermer</button></div>
</div>

<!-- RECO -->
<div class="overlay" id="reco-overlay">
  <div class="overlay-header"><span class="overlay-title">Reconnaissance</span><button class="overlay-close" onclick="closeOv('reco-overlay')">âœ•</button></div>
  <div class="overlay-body"><div class="oc">
    <p style="font-size:.82rem;color:var(--text2);text-align:center;margin-bottom:8px">Quel type de rÃ©ussite ?</p>
    <div class="reco-choice">
      <div class="reco-card" onclick="genRecoQR('COG')"><div class="rc-icon" style="background:rgba(59,130,246,.1)">ğŸ§ </div><div><div class="rc-text" style="color:var(--cog)">Cognitif</div><div class="rc-sub">RÃ©flexion, analyse, dÃ©cision</div></div></div>
      <div class="reco-card" onclick="genRecoQR('EMO')"><div class="rc-icon" style="background:rgba(244,63,94,.1)">â¤ï¸</div><div><div class="rc-text" style="color:var(--emo)">Ã‰motionnel</div><div class="rc-sub">Gestion des Ã©motions, stress</div></div></div>
      <div class="reco-card" onclick="genRecoQR('SOC')"><div class="rc-icon" style="background:rgba(139,92,246,.1)">ğŸ¤</div><div><div class="rc-text" style="color:var(--soc)">Social</div><div class="rc-sub">Communication, entraide</div></div></div>
    </div>
  </div></div>
</div>

<!-- ATTESTATION -->
<div class="overlay" id="attest-overlay">
  <div class="overlay-header"><span class="overlay-title">SynthÃ¨se</span><button class="overlay-close" onclick="closeOv('attest-overlay')">âœ•</button></div>
  <div class="overlay-body"><div class="oc">
    <h3 style="text-align:center;font-weight:800;margin-bottom:20px;font-size:1rem">Mon profil de compÃ©tences</h3>
    <div class="attest-radar"><canvas id="attest-radar"></canvas></div>
    <div class="attest-card cog"><h4 style="color:var(--cog)">ğŸ§  Cognitif</h4><p id="syn-cog">â€”</p></div>
    <div class="attest-card emo"><h4 style="color:var(--emo)">â¤ï¸ Ã‰motionnel</h4><p id="syn-emo">â€”</p></div>
    <div class="attest-card soc"><h4 style="color:var(--soc)">ğŸ¤ Social</h4><p id="syn-soc">â€”</p></div>
  </div></div>
</div>

<script src="js/data_eleves.js"></script>
<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FIREBASE CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const firebaseConfig={apiKey:"AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0IQcLI",authDomain:"devoirs-pse.firebaseapp.com",databaseURL:"https://devoirs-pse-default-rtdb.europe-west1.firebasedatabase.app",projectId:"devoirs-pse",storageBucket:"devoirs-pse.appspot.com",messagingSenderId:"614730413904",appId:"1:614730413904:web:a5dd478af5de30f6bede55"};
firebase.initializeApp(firebaseConfig);const db=firebase.database();

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let userCode=null;
let dataCode=null;
let userData={objectifs:{},meteo:{}},draft={},currentEditId=null,breathRunning=false,breathInterval=null,breathTimeout=null,breathSec=0,attestChart=null,contextData={},wizMode='competence',customBiblioCache={};
const SESSION_CODE_KEY='accompagnement_session_code';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CONSTANTS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const MATIERES=["FranÃ§ais","MathÃ©matiques","Anglais LV1","Espagnol LV2","Histoire-GÃ©ographie / EMC","Ã‰conomie-Droit","Enseignement professionnel","PrÃ©vention SantÃ© Environnement","PSE","Arts appliquÃ©s","EPS","DNL","Soutien au parcours","Professeur absent","Projet","Sortie","Travail personnel"];

const EMOTIONS={
  "Joie":{emoji:"ğŸ˜Š",subs:["Ã€ l'aise","Amoureux","Content","ExcitÃ©","Satisfait","Serein","EnjouÃ©","Enthousiaste","Reconnaissant"],hint:"Super journÃ©e en vue !"},
  "Tristesse":{emoji:"ğŸ˜¢",subs:["Abattu","AccablÃ©","AffectÃ©","AffligÃ©","AnÃ©anti","BlessÃ©","ChagrinÃ©","MÃ©lancolique","DÃ©couragÃ©"],hint:"C'est ok, on est lÃ ."},
  "ColÃ¨re":{emoji:"ğŸ˜ ",subs:["AgacÃ©","AgitÃ©","Agressif","ContrariÃ©","EnragÃ©","Furieux","Haineux","FrustrÃ©","Impatient"],hint:"On prend une grande inspiration ?"},
  "Peur":{emoji:"ğŸ˜°",subs:["AngoissÃ©","Anxieux","Craintif","EffrayÃ©","MÃ©fiant","InsÃ©cure","IndÃ©cis","Inquiet","StressÃ©"],hint:"Respire, un pas Ã  la fois."},
  "Surprise":{emoji:"ğŸ˜²",subs:["Ã‰bahi","Ã‰tonnÃ©","Ã‰merveillÃ©","TroublÃ©","SecouÃ©","StupÃ©fait","ImpressionnÃ©","DÃ©stabilisÃ©"],hint:"Plein de surprises !"},
  "DÃ©goÃ»t":{emoji:"ğŸ˜–",subs:["Aigri","Amer","Antipathique","Ã‰cÅ“urÃ©","MÃ©pris","LassÃ©","BlasÃ©","SaturÃ©"],hint:"Ã‡a va aller, accroche-toi."}
};

const MOOD_COLORS={
  "Joie":{aura:'rgba(251,191,36,.1)',border:'rgba(251,191,36,.2)',glow:'rgba(251,191,36,.08)'},
  "Tristesse":{aura:'rgba(59,130,246,.08)',border:'rgba(59,130,246,.15)',glow:'rgba(59,130,246,.06)'},
  "ColÃ¨re":{aura:'rgba(244,63,94,.08)',border:'rgba(244,63,94,.15)',glow:'rgba(244,63,94,.06)'},
  "Peur":{aura:'rgba(139,92,246,.08)',border:'rgba(139,92,246,.15)',glow:'rgba(139,92,246,.06)'},
  "Surprise":{aura:'rgba(52,211,153,.08)',border:'rgba(52,211,153,.15)',glow:'rgba(52,211,153,.06)'},
  "DÃ©goÃ»t":{aura:'rgba(249,115,22,.08)',border:'rgba(249,115,22,.15)',glow:'rgba(249,115,22,.06)'}
};

const AX={COG:{emoji:'ğŸ§ ',label:'Cognitif',color:'var(--cog)',cls:'cog',desc:'RÃ©flexion, analyse, prise de dÃ©cision, pensÃ©e critique'},EMO:{emoji:'â¤ï¸',label:'Ã‰motionnel',color:'var(--emo)',cls:'emo',desc:'Gestion des Ã©motions, du stress, conscience Ã©motionnelle'},SOC:{emoji:'ğŸ¤',label:'Social',color:'var(--soc)',cls:'soc',desc:'Communication, coopÃ©ration, rÃ©solution de conflits'}};
const CTX_FILES={Scolaire:'scolaire.json',PFMP:'pfmp_stage.json',Recherche:'recherche_stage.json',Autre:'autre.json'};
const REF_CUSTOM_GLOBAL='accompagnement/bibliotheque_custom/global';
const REF_CUSTOM_PAR_ELEVE='accompagnement/bibliotheque_custom/par_eleve';
var CONTACT_MODES=[{v:'telephone',l:'ğŸ“ Par tÃ©lÃ©phone'},{v:'personne',l:'ğŸš¶ En personne'},{v:'email',l:'ğŸ“§ Par email'},{v:'courrier',l:'âœ‰ï¸ Par courrier'},{v:'reseau',l:'ğŸ¤ Via un contact'}];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// UTILITY FUNCTIONS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getAx(g){const t=(g.type||g.domaine||'').toUpperCase();return t.includes('COG')?'COG':t.includes('EMO')?'EMO':t.includes('SOC')?'SOC':'NEU'}
function axCls(a){return a==='COG'?'cog':a==='EMO'?'emo':a==='SOC'?'soc':'neu'}
function domainLabel(s){return AX[s]?.label||'Autre'}
function domainColor(s){return s==='COG'?'#3b82f6':s==='EMO'?'#f43f5e':s==='SOC'?'#8b5cf6':'#94a3b8'}
function domainKey(k){return k.includes('cognitif')?'COG':k.includes('emotionnel')?'EMO':k.includes('social')?'SOC':'NEU'}
function dateFr(d){if(!d)return'â€”';return new Date(d).toLocaleDateString('fr-FR',{day:'numeric',month:'short',year:'numeric'})}
function daysLeft(d){if(!d)return null;const t=new Date();t.setHours(0,0,0,0);const x=new Date(d);x.setHours(0,0,0,0);return Math.ceil((x-t)/864e5)}
function closeOv(id){document.getElementById(id).classList.remove('show')}
function litCard(el){el.classList.remove('lit');void el.offsetWidth;el.classList.add('lit');setTimeout(function(){el.classList.remove('lit')},500)}
async function loadContext(key){if(contextData[key])return contextData[key];try{const r=await fetch('data/bibliotheque/'+(CTX_FILES[key]||'autre.json'),{cache:'no-store'});contextData[key]=await r.json();return contextData[key]}catch(e){return null}}
function addHistory(k,action){db.ref('accompagnement/eleves/'+dataCode+'/objectifs/'+k+'/historique').push({action:action,date:new Date().toISOString()})}
function renderHistory(g){const h=g.historique?Object.values(g.historique).sort(function(a,b){return new Date(b.date)-new Date(a.date)}):[];const entries=[{action:'CrÃ©Ã©',date:g.created||''}].concat(h);return entries.map(function(e){return '<div class="mh-entry"><span class="mh-dot"></span><span class="mh-text">'+dateFr(e.date)+' â€” '+escHtml(e.action||'')+'</span></div>'}).join('')}
function escHtml(v){return String(v==null?'':v).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;')}
function escAttr(v){return escHtml(v).replace(/`/g,'&#96;')}
function safeId(v){return String(v||'').replace(/[^A-Za-z0-9_-]/g,'')}
function sanitizeCode(v){return String(v||'').toUpperCase().replace(/[^A-Z0-9]/g,'').slice(0,16)}
function setSessionCode(code){sessionStorage.setItem(SESSION_CODE_KEY,sanitizeCode(code))}
function getSessionCode(){return sanitizeCode(sessionStorage.getItem(SESSION_CODE_KEY)||'')}
function clearSessionCode(){sessionStorage.removeItem(SESSION_CODE_KEY)}
function upper(v){return String(v||'').trim().toUpperCase()}
function normalizeContextName(v){var x=String(v||'').trim().toLowerCase();if(x==='scolaire')return'Scolaire';if(x==='pfmp')return'PFMP';if(x==='recherche')return'Recherche';return'Autre'}
function dedupeNormText(v){return String(v||'').trim().toLowerCase().replace(/\s+/g,' ')}
function guessDomainFromCode(code){var c=upper(code);if(c.indexOf('C')===0)return'COG';if(c.indexOf('E')===0)return'EMO';if(c.indexOf('S')===0)return'SOC';return'NEU'}
function buildCompetenceIndex(data){var idx={};if(!data||typeof data!=='object')return idx;Object.entries(data).forEach(function(entry){var domK=entry[0],dom=entry[1],ax=domainKey(domK);(dom.categories||[]).forEach(function(cat){(cat.competences_generales||[]).forEach(function(gen){(gen.competences_specifiques||[]).forEach(function(spe){idx[upper(spe.code_spe)]={domain:ax,cat_code:cat.code_cat,cat_label:cat.nom_cat,gen_code:gen.code_gen,gen_label:gen.nom_gen,spe_code:spe.code_spe,spe_label:spe.nom_spe,color:domainColor(ax)}})})})});return idx}
function customCacheKey(context){return sanitizeCode(userCode||'')+'|'+normalizeContextName(context)}
function parseCustomEntries(obj,scope,context){var out=[];Object.keys(obj||{}).forEach(function(id){var r=obj[id]||{};if(r.actif!==true)return;var texte=String(r.texte||'').trim();if(!texte)return;var ctx=normalizeContextName(r.contexte||context);if(ctx!==context)return;out.push({id:id,scope:scope,texte:texte,competence_code:upper(r.competence_code),competence_nom:String(r.competence_nom||'').trim(),contexte:ctx,created_at:Number(r.created_at||r.updated_at||0)})});out.sort(function(a,b){return b.created_at-a.created_at});return out}
async function loadCustomEntriesForContext(context){var ctx=normalizeContextName(context),key=customCacheKey(ctx);if(customBiblioCache[key])return customBiblioCache[key];if(!userCode){customBiblioCache[key]={eleve:[],global:[]};return customBiblioCache[key]}try{var snaps=await Promise.all([db.ref(REF_CUSTOM_GLOBAL).once('value'),db.ref(REF_CUSTOM_PAR_ELEVE+'/'+userCode).once('value')]);var globalItems=parseCustomEntries(snaps[0].val()||{},'global',ctx);var eleveItems=parseCustomEntries(snaps[1].val()||{},'eleve',ctx);customBiblioCache[key]={eleve:eleveItems,global:globalItems};return customBiblioCache[key]}catch(e){customBiblioCache[key]={eleve:[],global:[]};return customBiblioCache[key}}
function mapCustomToWizardItem(entry,compIndex){var code=upper(entry.competence_code),map=compIndex[code],domain=map?map.domain:guessDomainFromCode(code);return{texte:entry.texte,code_ref:'',domain:domain,cat_code:map?map.cat_code:'',cat_label:map?map.cat_label:'',gen_code:map?map.gen_code:'',gen_label:map?map.gen_label:'',spe_code:map?map.spe_code:code,spe_label:map?map.spe_label:(entry.competence_nom||code||'CompÃ©tence personnalisÃ©e'),color:domainColor(domain),is_custom:true,custom_scope:entry.scope,uid:'CUS_'+entry.scope+'_'+entry.id,created_at:entry.created_at}}
function mergeWizardItems(customItems,staticItems,context){var all=customItems.concat(staticItems),seen={},out=[];all.forEach(function(it){var key=dedupeNormText(it.texte)+'|'+upper(it.spe_code||'')+'|'+normalizeContextName(context);if(seen[key])return;seen[key]=1;out.push(it)});return out}
function wizOptionContentHtml(item){var lbl=escHtml(item.texte||''),comp=escHtml(item.spe_label||'');var badge=item.is_custom?'<span class="wiz-option-custom">âœ¦ PersonnalisÃ©</span>':'';return'<span class="wiz-option-label">'+lbl+'</span><span class="wiz-option-comp-row"><span class="wiz-option-comp">'+comp+'</span>'+badge+'</span>'}
function resolveDataCode(loginCode,auth){
  var candidate=(auth&&auth.userCode)?String(auth.userCode).toUpperCase():'';
  if(candidate)return candidate;
  if(typeof window.trouverEleve==='function'){
    var el=window.trouverEleve(loginCode);
    if(el&&el.userCode)return String(el.userCode).toUpperCase();
  }
  return String(loginCode||'').toUpperCase();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// AUTH â€” Welcome / Denied / Schedule
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var authListener=null;
window.addEventListener('load',function(){
  var now=new Date();
  var jours=['Dimanche','Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi'];
  var mois=['janvier','fÃ©vrier','mars','avril','mai','juin','juillet','aoÃ»t','septembre','octobre','novembre','dÃ©cembre'];
  var codeInput=document.getElementById('code-input');
  if(window.location.search){window.history.replaceState({},'',window.location.pathname+window.location.hash)}
  document.getElementById('h-date').textContent=jours[now.getDay()]+' '+now.getDate()+' '+mois[now.getMonth()];
  codeInput.addEventListener('input',function(e){
    e.target.value=e.target.value.toUpperCase().replace(/[^A-Z0-9]/g,'').slice(0,16);
  });
  codeInput.addEventListener('keydown',function(e){if(e.key==='Enter')submitCode()});
  var sessionCode=getSessionCode();
  if(sessionCode&&/^[A-Z0-9]{4,16}$/.test(sessionCode)){codeInput.value=sessionCode;submitCode()}
});

function submitCode(){
  var input=document.getElementById('code-input');var btn=document.getElementById('code-btn');var err=document.getElementById('welcome-error');
  var raw=input.value.trim().toUpperCase().replace(/[^A-Z0-9]/g,'').slice(0,16);
  var aliases={PROFPSE:'PROFPSE',INVITE:'INVITE',INVITES:'INVITE'};
  var code=aliases[raw]||raw;
  var isSpecial=(code==='PROFPSE'||code==='INVITE');
  input.value=code;
  if(!/^[A-Z0-9]{4,16}$/.test(code)){err.textContent='Code secret invalide.';return}
  err.textContent='';btn.disabled=true;btn.innerHTML='<span class="btn-spinner"></span> VÃ©rificationâ€¦';
  db.ref('accompagnement/autorisations/'+code).once('value',function(snap){
    var auth=snap.val();
    if(!auth&&isSpecial){
      auth={autorise:true,userCode:code,bypass_schedule:true,special:true};
    }
    if(!auth){btn.disabled=false;btn.textContent='AccÃ©der Ã  mon espace';err.textContent='Code incorrect.';return}
    if(auth.autorise!==true){btn.disabled=false;btn.textContent='AccÃ©der Ã  mon espace';showDenied('not-authorized');return}
    checkSchedule(code,auth,function(allowed){
      if(!allowed){btn.disabled=false;btn.textContent='AccÃ©der Ã  mon espace';showDenied('outside-hours');return}
      userCode=code;
      dataCode=resolveDataCode(code,auth);
      customBiblioCache={};
      setSessionCode(code);
      window.history.replaceState({},'',window.location.pathname+window.location.hash);
      document.getElementById('welcome').style.display='none';
      document.getElementById('access-denied').style.display='none';
      document.getElementById('display-code').textContent=code;
      document.getElementById('tb-avatar').textContent=code.substring(0,2);
      showApp();loadData();
      if(authListener)db.ref('accompagnement/autorisations/'+code).off('value',authListener);
      authListener=db.ref('accompagnement/autorisations/'+code).on('value',function(s){var d=s.val();if(!d||d.autorise!==true){document.getElementById('app').style.display='none';showDenied('not-authorized')}});
    });
  });
}

function checkSchedule(code,auth,callback){
  if(auth&&auth.bypass_schedule===true){callback(true);return}
  if(code==='PROFPSE'||code==='INVITE'){callback(true);return}
  if(auth.horaires){callback(isWithinSchedule(auth.horaires));return}
  db.ref('accompagnement/config/horaires_global').once('value',function(snap){var global=snap.val();if(!global){callback(true);return}callback(isWithinSchedule(global))});
}
function isWithinSchedule(horaires){var joursRef=['dimanche','lundi','mardi','mercredi','jeudi','vendredi','samedi'];var now=new Date();var jour=joursRef[now.getDay()];var schedule=horaires[jour];if(!schedule||!schedule.actif)return false;var currentMinutes=now.getHours()*60+now.getMinutes();var parts=schedule.debut.split(':');var debutMinutes=parseInt(parts[0])*60+parseInt(parts[1]);parts=schedule.fin.split(':');var finMinutes=parseInt(parts[0])*60+parseInt(parts[1]);return currentMinutes>=debutMinutes&&currentMinutes<=finMinutes}
function showDenied(reason){var icon=document.getElementById('denied-icon');var title=document.getElementById('denied-title');var msg=document.getElementById('denied-msg');if(reason==='unknown'){icon.textContent='ğŸ”';title.textContent='Code non reconnu';msg.textContent='VÃ©rifie ton code et rÃ©essaie. Il t\u2019a Ã©tÃ© donnÃ© par ton enseignant.'}else if(reason==='outside-hours'){icon.textContent='ğŸ•';title.textContent='AccÃ¨s fermÃ© pour le moment';msg.textContent='L\u2019espace est disponible uniquement pendant les horaires dÃ©finis par ton enseignant. Reviens plus tard\u00a0!'}else{icon.textContent='â³';title.textContent='Ton espace n\u2019est pas encore actif';msg.textContent='Ton enseignant doit d\u2019abord activer ton accÃ¨s.'}document.getElementById('welcome').style.display='none';document.getElementById('access-denied').style.display='flex'}
function backToWelcome(){clearSessionCode();customBiblioCache={};document.getElementById('access-denied').style.display='none';document.getElementById('welcome').style.display='flex';document.getElementById('code-input').value='';document.getElementById('code-input').focus();document.getElementById('welcome-error').textContent='';window.history.replaceState({},'',window.location.pathname)}
function showApp(){var a=document.getElementById('app');a.style.display='block'}
function loadData(){db.ref('accompagnement/eleves/'+dataCode).on('value',function(snap){userData=snap.val()||{};if(!userData.objectifs)userData.objectifs={};if(!userData.meteo)userData.meteo={};render();checkMood()})}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RENDER DASHBOARD
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function render(){
  var goals=userData.objectifs||{},keys=Object.keys(goals);
  var counts={COG:0,EMO:0,SOC:0},totals={COG:0,EMO:0,SOC:0};
  var active=[],done=[],stageActive=[],stageTotal=0,objActive=0;

  keys.forEach(function(k){
    var g=goals[k],ax=getAx(g);
    if(ax!=='NEU')totals[ax]++;
    if(g.done){if(ax!=='NEU')counts[ax]++;done.push(Object.assign({k:k},g))}
    else{active.push(Object.assign({k:k},g))}
    // Count stage vs objectif
    if(g.context==='PFMP'||g.context==='Recherche'){stageTotal++;if(!g.done)stageActive.push(Object.assign({k:k},g))}
    else{if(!g.done)objActive++}
  });

  active.sort(function(a,b){return new Date(a.date_cible||'2099-01-01')-new Date(b.date_cible||'2099-01-01')});

  // CPS Circles (SVG stroke)
  var circumference=226.19;
  ['COG','EMO','SOC'].forEach(function(ax){
    var total=Math.max(totals[ax],1);
    var pct=Math.round((counts[ax]/total)*100);
    var offset=circumference-((pct/100)*circumference);
    var circle=document.getElementById('ring-'+ax.toLowerCase()+'-circle');
    if(circle)circle.setAttribute('stroke-dashoffset',offset);
    var val=document.getElementById('val-'+ax.toLowerCase());
    if(val)val.textContent=counts[ax];
  });

  // Badges on 3 buttons
  document.getElementById('badge-stage').textContent=stageActive.length?stageActive.length+' en cours':'0';
  document.getElementById('badge-objectif').textContent=objActive?objActive+' actif'+(objActive>1?'s':''):'0';

  // Prochaines Missions (next 2 active, non-done)
  renderMissions(active);
}

function renderMissions(active){
  var el=document.getElementById('missions-list');
  if(!active.length){el.innerHTML='<div class="empty-missions">Ajoute un objectif pour voir tes missions ici</div>';return}
  var top=active.slice(0,2);
  el.innerHTML=top.map(function(g){
    var dl=daysLeft(g.date_cible);
    var cls='ok',timeLabel='BientÃ´t',icon='ğŸ“…',encourage='Tu vas gÃ©rer !';
    if(dl!==null){
      if(dl<0){cls='urgent';timeLabel='DÃ©passÃ©';icon='â°';encourage='Vite, rattrape !'}
      else if(dl===0){cls='urgent';timeLabel="Auj.";icon='â°';encourage="C'est maintenant !"}
      else if(dl===1){cls='soon';timeLabel='Demain';icon='ğŸ“…';encourage='Tu vas gÃ©rer !'}
      else if(dl<=3){cls='urgent';timeLabel='J-'+dl;icon='â°';encourage="C'est bientÃ´t !"}
      else if(dl<=7){cls='soon';timeLabel='J-'+dl;icon='ğŸ“…';encourage='PrÃ©pare-toi !'}
      else{cls='ok';timeLabel='J-'+dl;icon='ğŸ“…';encourage='Tranquille !'}
    }
    var ax=getAx(g),dotCls=axCls(ax);
    var gKey=safeId(g.k);
    var gTitle=escHtml(g.titre||'Sans titre');
    var gContext=escHtml(g.context||'Autre');
    var rawCompName=(g.cps&&(g.cps.spe_label||g.cps.nom_spe))||g.spe_label||g.nom_spe||'';
    var compName=String(rawCompName||'').trim();
    if(compName.length>30)compName=compName.slice(0,29)+'â€¦';
    var compPart=compName?' Â· '+escHtml(compName):'';
    // Stars (validations count â€” placeholder, uses 0-5)
    var valCount=g.validations_count||0;
    var stars='';for(var i=0;i<5;i++)stars+='<span class="mission-star '+(i<valCount?'on':'off')+'">â˜…</span>';
    return '<div class="mission-card '+cls+'" onclick="openDetail(\''+gKey+'\')">'+
      '<div class="mission-time"><div class="mission-time-icon '+(cls==='urgent'?'pulse':'')+'">'+ icon+'</div><div class="mission-time-label">'+timeLabel+'</div><div class="mission-encourage">'+encourage+'</div></div>'+
      '<div class="mission-info"><div class="mission-name">'+gTitle+'</div>'+
      '<div class="mission-detail"><span class="mission-dot '+dotCls+'"></span>'+gContext+compPart+'</div>'+
      '<div class="mission-stars">'+stars+'<span class="mission-valid">'+valCount+'/5</span></div></div></div>';
  }).join('');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// OVERLAYS â€” Objectifs / Stage
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function openObjectifsOverlay(){
  var c=document.getElementById('objectifs-content');
  var goals=userData.objectifs||{},activeList=[],doneList=[];
  Object.entries(goals).forEach(function(e){
    var k=e[0],g=e[1];
    if(g.context==='PFMP'||g.context==='Recherche')return; // skip stage
    if(g.done)doneList.push(Object.assign({k:k},g));else activeList.push(Object.assign({k:k},g));
  });
  activeList.sort(function(a,b){return new Date(a.date_cible||'2099-01-01')-new Date(b.date_cible||'2099-01-01')});

  var html='<button class="add-btn" onclick="closeOv(\'objectifs-overlay\');startWizard()">+ Ajouter un objectif</button>';
  html+='<div class="obj-section-title">En cours <span class="count">'+activeList.length+'</span></div>';
  if(!activeList.length)html+='<div class="empty-msg">Aucun objectif â€” appuie sur + pour commencer</div>';
  else html+=activeList.map(function(g){return renderObjCard(g,false)}).join('');

  if(doneList.length){
    html+='<div class="obj-section-title" style="margin-top:20px">Atteints <span class="count">'+doneList.length+'</span></div>';
    html+=doneList.map(function(g){return renderObjCard(g,true)}).join('');
  }
  c.innerHTML=html;
  document.getElementById('objectifs-overlay').classList.add('show');
}

function openStageOverlay(){
  var c=document.getElementById('stage-content');
  var goals=userData.objectifs||{},pfmpList=[],rechList=[],donePfmp=[],doneRech=[];
  Object.entries(goals).forEach(function(e){
    var k=e[0],g=e[1];
    if(g.context==='PFMP'){if(g.done)donePfmp.push(Object.assign({k:k},g));else pfmpList.push(Object.assign({k:k},g))}
    if(g.context==='Recherche'){if(g.done)doneRech.push(Object.assign({k:k},g));else rechList.push(Object.assign({k:k},g))}
  });

  var html='<button class="add-btn stage-add" onclick="closeOv(\'stage-overlay\');startWizardStage()">+ Ajouter un objectif stage</button>';

  html+='<div class="obj-section-title">Objectifs PFMP <span class="count">'+pfmpList.length+'</span></div>';
  if(!pfmpList.length)html+='<div class="empty-msg">Aucun objectif PFMP</div>';
  else html+=pfmpList.map(function(g){return renderObjCard(g,false)}).join('');

  html+='<div class="obj-section-title" style="margin-top:20px">Recherche de stage <span class="count">'+rechList.length+'</span></div>';
  if(!rechList.length)html+='<div class="empty-msg">Aucune recherche de stage</div>';
  else html+=rechList.map(function(g){return renderObjCard(g,false)}).join('');

  var allDone=donePfmp.concat(doneRech);
  if(allDone.length){
    html+='<div class="obj-section-title" style="margin-top:20px">Atteints <span class="count">'+allDone.length+'</span></div>';
    html+=allDone.map(function(g){return renderObjCard(g,true)}).join('');
  }
  c.innerHTML=html;
  document.getElementById('stage-overlay').classList.add('show');
}

function renderObjCard(g,isDone){
  var ax=getAx(g),cls=axCls(ax);
  var gKey=safeId(g.k);
  var gTitle=escHtml(g.titre||'Sans titre');
  var gContext=escHtml(g.context||'Autre');
  var gDetail=escHtml(g.detail||'');
  var dl=daysLeft(g.date_cible);var timeStr='',urgCls='';
  if(dl!==null&&!isDone){if(dl<0){timeStr='DÃ©passÃ©';urgCls='urgent'}else if(dl===0){timeStr="Aujourd'hui";urgCls='ok'}else{timeStr='J-'+dl;urgCls=dl<=3?'urgent':'ok'}}
  var valCount=g.validations_count||0;
  var stars='';for(var i=0;i<5;i++)stars+='<span class="obj-star '+(i<valCount?'on':'off')+'">â˜…</span>';

  if(isDone){
    return '<div class="obj-card done '+cls+'" onclick="openDetail(\''+gKey+'\')"><div class="obj-check"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div><div class="obj-body"><div class="obj-title">'+gTitle+'</div><div class="obj-meta"><span>ValidÃ© le '+dateFr(g.date_done)+'</span></div></div></div>';
  }
  return '<div class="obj-card '+cls+'" onclick="openDetail(\''+gKey+'\')"><div class="obj-check" onclick="event.stopPropagation();markDone(\''+gKey+'\')"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="#d1d5db" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div><div class="obj-body"><div class="obj-title">'+gTitle+'</div><div class="obj-meta"><span class="obj-badge">'+gContext+'</span><span>'+gDetail+'</span>'+(timeStr?'<span class="obj-time '+urgCls+'">'+timeStr+'</span>':'')+'</div><div class="obj-stars">'+stars+'<span class="obj-valid">'+valCount+'/5</span></div></div></div>';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MOOD â€” Big buttons + Aura
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function checkMood(){
  var today=new Date().toISOString().split('T')[0];
  var m=userData.meteo&&userData.meteo[today];
  if(m){
    document.getElementById('m-emoji').textContent=m.emoji||'ğŸ˜Š';
    document.getElementById('m-primary').textContent=m.primary||'â€”';
    document.getElementById('m-secondary').textContent=m.secondary||'';
    document.getElementById('m-hint').textContent=(EMOTIONS[m.primary]||{}).hint||'';
    applyAura(m.primary);
  } else {
    document.getElementById('m-emoji').textContent='â“';
    document.getElementById('m-primary').textContent='Pas encore dÃ©finie';
    document.getElementById('m-secondary').textContent='';
    document.getElementById('m-hint').textContent='Clique pour dire comment tu te sens';
    applyAura(null);
    // Auto-open mood on first visit
    setTimeout(function(){openMood()},600);
  }
}

function applyAura(primary){
  var card=document.getElementById('meteo-card');
  var c=MOOD_COLORS[primary]||{aura:'rgba(148,163,184,.06)',border:'rgba(148,163,184,.1)',glow:'rgba(148,163,184,.04)'};
  card.style.setProperty('--aura-color',c.aura);
  card.style.setProperty('--aura-border',c.border);
  card.style.setProperty('--aura-glow',c.glow);
  card.style.borderColor=c.border;
}

function openMood(){
  document.getElementById('mood-overlay').classList.add('show');
  document.getElementById('mood-content').innerHTML=
    '<div style="text-align:center;margin-bottom:20px;font-size:.9rem;color:var(--text2)">Choisis ton Ã©motion principale</div>'+
    '<div class="mood-grid-big">'+
    Object.entries(EMOTIONS).map(function(e){
      return '<div class="mood-big-btn" onclick="moodStep2(\''+e[0]+'\')"><div class="mb-emoji">'+e[1].emoji+'</div><div class="mb-label">'+e[0]+'</div></div>';
    }).join('')+'</div>';
}

window.moodStep2=function(primary){
  var v=EMOTIONS[primary];
  document.getElementById('mood-content').innerHTML=
    '<div style="max-width:400px;margin:0 auto">'+
    '<button class="mood-sec-back" onclick="openMood()">â† Retour</button>'+
    '<div class="mood-sec-title">'+v.emoji+' '+primary+'</div>'+
    '<div class="mood-sec-sub">Plus prÃ©cisÃ©ment, tu te sens...</div>'+
    '<div class="mood-sec-grid">'+
    v.subs.map(function(s){return '<button class="mood-sec-chip" onclick="saveMood(\''+primary+'\',\''+s+'\',\''+v.emoji+'\')">'+s+'</button>'}).join('')+
    '</div></div>';
};

window.saveMood=function(p,s,emoji){
  db.ref('accompagnement/eleves/'+dataCode+'/meteo/'+new Date().toISOString().split('T')[0]).set({primary:p,secondary:s,emoji:emoji});
  closeOv('mood-overlay');
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// BREATHING â€” functional cycle
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.openBreathing=function(){
  document.getElementById('breath-overlay').classList.add('show');
  breathRunning=false;breathSec=0;
  document.getElementById('b-word').textContent='PrÃªt ?';
  document.getElementById('b-num').textContent='';
  document.getElementById('b-elapsed').textContent='Touche le cercle pour commencer';
  document.getElementById('b-orb').className='breath-orb';
};
window.stopBreathing=function(){closeOv('breath-overlay');stopBreathEngine()};
function stopBreathEngine(){breathRunning=false;if(breathInterval)clearInterval(breathInterval);if(breathTimeout)clearTimeout(breathTimeout);breathInterval=null;breathTimeout=null}

window.startBreath=function(){
  if(breathRunning)return;breathRunning=true;breathSec=0;
  breathInterval=setInterval(function(){breathSec++;var m=Math.floor(breathSec/60),s=breathSec%60;document.getElementById('b-elapsed').textContent=(m>0?m+' min ':'')+s+' sec'},1000);
  breathCycle();
};
function breathCycle(){
  if(!breathRunning)return;
  var orb=document.getElementById('b-orb'),w=document.getElementById('b-word'),n=document.getElementById('b-num');
  orb.className='breath-orb inhale';w.textContent='Inspire';
  var c=4;n.textContent=c;var i1=setInterval(function(){c--;if(c>0)n.textContent=c;else clearInterval(i1)},1000);
  breathTimeout=setTimeout(function(){if(!breathRunning)return;
    orb.className='breath-orb hold';w.textContent='Retiens';var h=4;n.textContent=h;var i2=setInterval(function(){h--;if(h>0)n.textContent=h;else clearInterval(i2)},1000);
    breathTimeout=setTimeout(function(){if(!breathRunning)return;
      orb.className='breath-orb exhale';w.textContent='Expire';var e=6;n.textContent=e;var i3=setInterval(function(){e--;if(e>0)n.textContent=e;else clearInterval(i3)},1000);
      breathTimeout=setTimeout(function(){if(!breathRunning)return;
        orb.className='breath-orb';w.textContent='Pause';n.textContent='';
        breathTimeout=setTimeout(function(){breathCycle()},2000);
      },6000);
    },4000);
  },4000);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// MARK DONE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.markDone=function(k){if(confirm("Objectif atteint ? ğŸ‰")){db.ref('accompagnement/eleves/'+dataCode+'/objectifs/'+k).update({done:true,date_done:new Date().toISOString()});addHistory(k,'MarquÃ© comme atteint')}}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// DETAIL OVERLAY
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.openDetail=function(k){
  currentEditId=k;var g=userData.objectifs[k];if(!g)return;
  var ax=getAx(g),cls=axCls(ax),meta=AX[ax]||{emoji:'ğŸ“‹',label:'Autre',color:'var(--text3)'};
  var detailKey=safeId(k);
  var safeContext=escHtml(g.context||'Autre');
  var safeTitle=escHtml(g.titre||'Sans titre');
  var safeSpeLabel=escHtml(g.spe_label||'Objectif libre');
  var safeGenLabel=g.gen_label?' Â· '+escHtml(g.gen_label):'';
  var safeDetail=escHtml(g.detail||'Non prÃ©cisÃ©');
  var safeSpeCode=String(g.spe_code||'').replace(/['\\]/g,'');
  var compBlocHtml='';
  if(g.cps){
    var compName=escHtml((g.cps.spe_label||g.cps.label||''));
    var compCode=escHtml((g.cps.spe_code||g.cps.code||''));
    var compDesc=compCode?(compCode+' Â· Ce savoir-faire contribue Ã  cette compÃ©tence'):'Ce savoir-faire contribue Ã  cette compÃ©tence';
    compBlocHtml='<div class="mission-comp-bloc"><span class="mission-comp-icon">ğŸ¯</span><div class="mission-comp-text"><div class="mission-comp-name">'+compName+'</div><div class="mission-comp-code">'+compDesc+'</div></div></div>';
  }
  var dl=daysLeft(g.date_cible),created=new Date(g.created||Date.now()),target=g.date_cible?new Date(g.date_cible):null;
  var pct=0;if(target){var total=Math.max((target-created)/864e5,1);var elapsed=Math.max((new Date()-created)/864e5,0);pct=Math.min(Math.round((elapsed/total)*100),100)}
  var statusTxt=g.done?'ValidÃ©':'En cours',statusCls=g.done?'valide':'en-cours';
  var timeColor=domainColor(ax);if(dl!==null&&dl<=3&&!g.done)timeColor='var(--emo)';
  var tlHtml='';
  if(dl!==null&&!g.done){var lbl=dl<0?'DÃ©passÃ© de '+Math.abs(dl)+' j':dl===0?"Aujourd'hui":'J-'+dl;tlHtml='<div class="mission-timeline"><div class="tl-bar"><div class="tl-fill" style="width:'+pct+'%;background:'+timeColor+'"></div></div><div class="tl-days" style="color:'+timeColor+'">'+lbl+'</div></div>'}
  var cadreIcon=g.context==='Scolaire'?'ğŸ“š':g.context==='PFMP'?'ğŸ¢':g.context==='Recherche'?'ğŸ”':'âœï¸';
  var isStage=g.context==='Recherche';
  var matSelect='';
  if(g.context==='Scolaire'){matSelect='<select class="fi" id="det-context">'+MATIERES.map(function(m){return '<option value="'+m+'"'+(m===g.detail?' selected':'')+'>'+m+'</option>'}).join('')+'<option value="__autre"'+(MATIERES.indexOf(g.detail)===-1?' selected':'')+'>Autreâ€¦</option></select>'}
  else{matSelect='<input type="text" class="fi" id="det-context" value="'+escAttr(g.detail||'')+'">'}
  var c=document.getElementById('detail-content');
  c.innerHTML='<div class="mission-header '+cls+'"><div class="mission-cadre">'+cadreIcon+' '+safeContext+'</div><div class="mission-titre">'+safeTitle+'</div>'+compBlocHtml+'<div class="mission-cps">'+(meta.emoji||'')+' '+safeSpeLabel+safeGenLabel+'</div><span class="mission-status '+statusCls+'">'+(statusCls==='valide'?'âœ…':'â³')+' '+statusTxt+'</span></div>'
    +'<div class="mission-block"><div class="mission-block-title">Contexte</div><div class="mb-row"><span class="mb-icon">ğŸ“…</span><span class="mb-label">Ã‰chÃ©ance</span><span class="mb-val">'+dateFr(g.date_cible)+'</span></div><div class="mb-row"><span class="mb-icon">ğŸ“</span><span class="mb-label">'+(g.context==='Scolaire'?'MatiÃ¨re':'Lieu')+'</span><span class="mb-val">'+safeDetail+'</span></div><div class="mb-row"><span class="mb-icon">ğŸ§­</span><span class="mb-label">Axe</span><span class="mb-val" style="color:'+domainColor(ax)+'">'+(meta.label||'')+'</span></div>'+tlHtml+'</div>'
    +(g.spe_label?'<button class="mission-cps-link" onclick="openFormationFor(\''+ax+'\',\''+safeSpeCode+'\')">ğŸ’¡ Comprendre cette compÃ©tence</button>':'')
    +(isStage?'<div class="mission-block"><div class="mission-block-title">Pistes de recherche</div><div id="stage-lieux-list"></div><button class="wiz-option" style="margin-top:6px;border-style:dashed;text-align:center;color:var(--primary)" onclick="addStageLieu()">+ Ajouter un lieu / entreprise</button><button class="wiz-option" style="margin-top:4px;text-align:center;color:var(--warn);font-weight:800" onclick="window.location.href=\'stage.html\'">ğŸ¢ Voir mon espace Stage complet</button></div>':'')
    +'<div class="mission-block"><div class="mission-block-title">Modifier</div><label style="font-size:0.8rem;font-weight:700;color:var(--text3);display:block;margin-bottom:3px">Ã‰chÃ©ance</label><input type="date" class="fi" id="det-date" value="'+(g.date_cible||'')+'"><label style="font-size:0.8rem;font-weight:700;color:var(--text3);display:block;margin-bottom:3px">'+(g.context==='Scolaire'?'MatiÃ¨re':'DÃ©tail')+'</label>'+matSelect+'</div>'
    +'<div class="mission-block"><div class="mission-block-title">Historique</div><div class="mission-history">'+renderHistory(g)+'</div></div>'
    +'<div class="mission-actions"><button class="btn-mission primary" onclick="saveDetail()">ğŸ’¾ Enregistrer</button><button class="btn-mission outline" onclick="showQRForGoal()">ğŸ”— Faire valider par un adulte</button>'
    +(!g.done?'<button class="btn-mission success" onclick="markDone(\''+detailKey+'\');closeOv(\'detail-overlay\')">âœ… Marquer comme atteint</button>':'')
    +'<button class="btn-mission danger" onclick="deleteGoal()">Supprimer</button></div>';
  if(isStage)renderStageLieux(k);
  document.getElementById('detail-overlay').classList.add('show');
};

window.saveDetail=function(){db.ref('accompagnement/eleves/'+dataCode+'/objectifs/'+currentEditId).update({date_cible:document.getElementById('det-date').value,detail:document.getElementById('det-context').value});addHistory(currentEditId,'ModifiÃ©');closeOv('detail-overlay')}
window.deleteGoal=function(){if(confirm('Supprimer ?')){db.ref('accompagnement/eleves/'+dataCode+'/objectifs/'+currentEditId).remove();closeOv('detail-overlay')}}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STAGE LIEUX
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function renderStageLieux(goalId){var el=document.getElementById('stage-lieux-list');if(!el)return;var lieux=userData.objectifs[goalId]&&userData.objectifs[goalId].lieux||{};var keys=Object.keys(lieux);if(!keys.length){el.innerHTML='<div class="empty-msg" style="padding:8px 0">Aucune piste</div>';return}
  el.innerHTML=keys.map(function(lk){var l=lieux[lk];var statuses=['contactÃ©','relancÃ©','rÃ©ponse reÃ§ue','stage trouvÃ©'];return '<div class="stage-lieu"><div><div class="stage-lieu-name">'+escHtml(l.nom||'â€”')+'</div><div class="stage-lieu-meta">'+escHtml(l.ville||'')+'</div></div><select onchange="updateStageLieu(\''+safeId(goalId)+'\',\''+safeId(lk)+'\',this.value)" style="padding:4px 8px;border:1px solid var(--border);border-radius:8px;font-family:var(--font);font-size:0.8rem;font-weight:700">'+statuses.map(function(s){return '<option value="'+s+'"'+(s===l.statut?' selected':'')+'>'+s+'</option>'}).join('')+'</select></div>'}).join('')}
window.addStageLieu=function(){var nom=prompt("Nom de l'entreprise ?");if(!nom)return;var ville=prompt("Ville ?");db.ref('accompagnement/eleves/'+dataCode+'/objectifs/'+currentEditId+'/lieux').push({nom:nom,ville:ville||'',statut:'contactÃ©',created:new Date().toISOString()});addHistory(currentEditId,'Piste ajoutÃ©e : '+nom)}
window.updateStageLieu=function(gId,lId,statut){db.ref('accompagnement/eleves/'+dataCode+'/objectifs/'+gId+'/lieux/'+lId+'/statut').set(statut);addHistory(gId,'Statut : '+statut)}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// CPS SPACE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.openCpsSpace=async function(ax){
  var meta=AX[ax];document.getElementById('cps-space-title').textContent=meta.emoji+' '+meta.label;
  var goals=Object.entries(userData.objectifs||{}).filter(function(e){return getAx(e[1])===ax});
  var doneC=goals.filter(function(e){return e[1].done}).length,activeC=goals.filter(function(e){return!e[1].done}).length;
  var biblio=await loadContext('Scolaire');var domK=ax==='COG'?'domaine_cognitif':ax==='EMO'?'domaine_emotionnel':'domaine_social';
  var dom=biblio&&biblio[domK];var comps=[];
  if(dom)(dom.categories||[]).forEach(function(cat){(cat.competences_generales||[]).forEach(function(gen){(gen.competences_specifiques||[]).forEach(function(spe){comps.push({nom_spe:spe.nom_spe,code_spe:spe.code_spe,gen_label:gen.nom_gen})})})});
  var c=document.getElementById('cps-space-content');
  c.innerHTML='<div class="cps-space-hero '+meta.cls+'"><div class="cps-space-emoji">'+meta.emoji+'</div><div class="cps-space-name">'+meta.label+'</div><div class="cps-space-sub">'+meta.desc+'</div></div>'
    +'<div class="cps-space-stats"><div class="cps-stat"><div class="cps-stat-val" style="color:'+domainColor(ax)+'">'+goals.length+'</div><div class="cps-stat-lbl">Total</div></div><div class="cps-stat"><div class="cps-stat-val" style="color:var(--success)">'+doneC+'</div><div class="cps-stat-lbl">ValidÃ©s</div></div><div class="cps-stat"><div class="cps-stat-val" style="color:var(--warn)">'+activeC+'</div><div class="cps-stat-lbl">En cours</div></div></div>';
  if(activeC){c.innerHTML+='<div class="cps-space-section"><h4>â³ En cours</h4>'+goals.filter(function(e){return!e[1].done}).map(function(e){var dl=daysLeft(e[1].date_cible);var lbl=dl!==null?(dl<0?'DÃ©passÃ©':dl===0?"Auj.":'J-'+dl):'';return '<div class="cps-comp-card" onclick="closeOv(\'cps-overlay\');openDetail(\''+safeId(e[0])+'\')"><div class="cps-comp-title">'+escHtml(e[1].titre||'')+'</div><div class="cps-comp-gen">'+escHtml(e[1].detail||'')+' '+(lbl?'Â· '+lbl:'')+'</div></div>'}).join('')+'</div>'}
  if(doneC){c.innerHTML+='<div class="cps-space-section"><h4>âœ… ValidÃ©s</h4>'+goals.filter(function(e){return e[1].done}).map(function(e){return '<div class="cps-comp-card" style="opacity:.6"><div class="cps-comp-title">'+escHtml(e[1].titre||'')+'</div><div class="cps-comp-gen">ValidÃ© le '+dateFr(e[1].date_done)+'</div></div>'}).join('')+'</div>'}
  c.innerHTML+='<div class="cps-space-section"><h4>ğŸ“š RÃ©fÃ©rentiel</h4>'+comps.map(function(s){return '<div class="cps-comp-card" onclick="openFormationFor(\''+ax+'\',\''+String(s.code_spe||'').replace(/['\\]/g,'')+'\')">'+'<div class="cps-comp-title">'+escHtml(s.nom_spe)+'</div><div class="cps-comp-gen">'+escHtml(s.gen_label)+'</div></div>'}).join('')+'</div>'
    +'<button class="cps-formation-btn" onclick="openFormation(\''+ax+'\')">ğŸ“– Explorer l\'espace '+meta.label+'</button>';
  document.getElementById('cps-overlay').classList.add('show');
};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// FORMATION CPS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.openFormation=function(ax){var pages={COG:'formation-cognitif.html',EMO:'formation-emotionnel.html',SOC:'formation-social.html'};window.location.href=(pages[ax]||'formation-cognitif.html')}
window.openFormationFor=function(ax,speCode){var pages={COG:'formation-cognitif.html',EMO:'formation-emotionnel.html',SOC:'formation-social.html'};window.location.href=(pages[ax]||'formation-cognitif.html')+'#'+encodeURIComponent(speCode)}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// QR / RECO
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.showQRForGoal=function(){if(!currentEditId||!userData.objectifs[currentEditId])return;var g=userData.objectifs[currentEditId];genQR(JSON.stringify({eleve:userCode,objectif:currentEditId,competence:g.type||'AUTRE',timestamp:Date.now(),cadre:g.context||'Autre',flux:1}))}
window.genRecoQR=function(type){genQR(JSON.stringify({eleve:userCode,type_reconnaissance:type,competence:type,flux:2,timestamp:Date.now()}));closeOv('reco-overlay')}
function genQR(txt){document.getElementById('qrcode-container').innerHTML='';new QRCode(document.getElementById('qrcode-container'),{text:txt,width:200,height:200,correctLevel:QRCode.CorrectLevel.M});document.getElementById('qr-overlay').classList.add('show')}
function openReco(){document.getElementById('reco-overlay').classList.add('show')}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ATTESTATION / EVOLUTION
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.openAttestation=function(){window.location.href='synthese.html'}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// WIZARD â€” Start
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
window.startWizard=function(){draft={};document.getElementById('wizard-overlay').classList.add('show');wizStep(1)}
window.startWizardStage=function(){draft={};document.getElementById('wizard-overlay').classList.add('show');
  // Pre-select stage context choices
  var c=document.getElementById('wizard-content');c.innerHTML='';
  c.innerHTML='<div class="wiz-title">Quel type d\'objectif stage ?</div><button class="wiz-option" onclick="draft.context=\'PFMP\';wizStep(2)">ğŸ¢ PFMP / Stage</button><button class="wiz-option" onclick="draft.context=\'Recherche\';wizStep(2)">ğŸ” Recherche de stage</button>';
}

function wizStep(s){
  draft._step=s;var c=document.getElementById('wizard-content');c.innerHTML='';
  var backMap={2:1,3:2,4:3,5:4};if(backMap[s])c.innerHTML+='<button class="wiz-back" onclick="wizStep('+backMap[s]+')">â† Retour</button>';
  if(s===1){c.innerHTML+='<div class="wiz-title">Dans quel cadre ?</div><button class="wiz-option" onclick="draft.context=\'Scolaire\';wizStep(2)">ğŸ“š Scolaire</button><button class="wiz-option" onclick="draft.context=\'PFMP\';wizStep(2)">ğŸ¢ PFMP / Stage</button><button class="wiz-option" onclick="draft.context=\'Recherche\';wizStep(2)">ğŸ” Recherche de stage</button><button class="wiz-option" onclick="draft.context=\'Autre\';draft.type=\'NEU\';draft.cps=null;wizStep(3)">âœï¸ Autre (libre)</button>'}
  else if(s===2){
    c.innerHTML+='<div class="wiz-title">Choisis ton entrÃ©e</div><div class="wiz-switch"><button class="wiz-switch-btn '+(wizMode==='competence'?'active':'')+'" onclick="wizMode=\'competence\';wizStep(2)">Par compÃ©tence</button><button class="wiz-switch-btn '+(wizMode==='objectif'?'active':'')+'" onclick="wizMode=\'objectif\';wizStep(2)">Par savoir-faire</button></div><input type="text" class="wiz-search" id="cps-search" placeholder="Rechercherâ€¦" oninput="wizStep(2)">';
    var contextSnapshot=draft.context,modeSnapshot=wizMode;
    loadContext(contextSnapshot).then(async function(data){
      if(!data){c.innerHTML+='<div class="empty-msg">BibliothÃ¨que non disponible</div>';return}
      if(draft._step!==2||contextSnapshot!==draft.context||modeSnapshot!==wizMode)return;
      var q=(document.getElementById('cps-search')?document.getElementById('cps-search').value:'').toLowerCase();
      window.__CPS_MAP={};window.__OBJ_MAP={};
      var compIndex=buildCompetenceIndex(data);
      if(wizMode==='competence'){
        Object.entries(data).forEach(function(entry){var domK=entry[0],dom=entry[1],ax=domainKey(domK),color=domainColor(ax),chips=[];(dom.categories||[]).forEach(function(cat){(cat.competences_generales||[]).forEach(function(gen){(gen.competences_specifiques||[]).forEach(function(spe){if(q&&(spe.nom_spe+' '+gen.nom_gen+' '+cat.nom_cat).toLowerCase().indexOf(q)===-1)return;var uid=ax+'_'+spe.code_spe;window.__CPS_MAP[uid]={domain:ax,cat_code:cat.code_cat,cat_label:cat.nom_cat,gen_code:gen.code_gen,gen_label:gen.nom_gen,spe_code:spe.code_spe,spe_label:spe.nom_spe,objectifs:spe.objectifs_eleve||[],color:color};chips.push('<div class="wiz-chip" onclick="selectCps(\''+uid+'\')"><span class="dot" style="background:'+color+'"></span><span>'+spe.nom_spe+'</span></div>')})})});if(chips.length)c.innerHTML+='<div class="wiz-section-h" style="color:'+color+'">'+domainLabel(ax)+'</div>'+chips.join('')});
      }else{
        var staticItems=[];Object.entries(data).forEach(function(entry){var domK=entry[0],dom=entry[1],ax=domainKey(domK),color=domainColor(ax);(dom.categories||[]).forEach(function(cat){(cat.competences_generales||[]).forEach(function(gen){(gen.competences_specifiques||[]).forEach(function(spe){(spe.objectifs_eleve||[]).forEach(function(obj,i){var txt=String(obj.texte||'');if(q&&(txt+' '+spe.nom_spe).toLowerCase().indexOf(q)===-1)return;var uid='OBJ_'+ax+'_'+spe.code_spe+'_'+i;staticItems.push({uid:uid,texte:txt,code_ref:obj.code_ref||'',domain:ax,cat_code:cat.code_cat,cat_label:cat.nom_cat,gen_code:gen.code_gen,gen_label:gen.nom_gen,spe_code:spe.code_spe,spe_label:spe.nom_spe,color:color,is_custom:false})})})})})});
        var customPack=await loadCustomEntriesForContext(contextSnapshot);
        if(draft._step!==2||contextSnapshot!==draft.context||modeSnapshot!==wizMode)return;
        var customItems=customPack.eleve.concat(customPack.global).map(function(raw){return mapCustomToWizardItem(raw,compIndex)}).filter(function(it){return!q||(String(it.texte||'')+' '+String(it.spe_label||'')).toLowerCase().indexOf(q)!==-1});
        var merged=mergeWizardItems(customItems,staticItems,contextSnapshot),groups={COG:[],EMO:[],SOC:[],NEU:[]};
        merged.forEach(function(it){var ax=it.domain||'NEU';if(!groups[ax])groups[ax]=[];groups[ax].push(it)});
        ['COG','EMO','SOC','NEU'].forEach(function(ax){var list=groups[ax]||[];if(!list.length)return;var color=domainColor(ax);c.innerHTML+='<div class="wiz-section-h" style="color:'+color+'">'+domainLabel(ax)+'</div>'+list.map(function(it){window.__OBJ_MAP[it.uid]=Object.assign({},it);return'<button class="wiz-option" style="border-left:4px solid '+(it.color||color)+'" onclick="selectObj(\''+it.uid+'\')">'+wizOptionContentHtml(it)+'</button>'}).join('')});
      }
      c.innerHTML+='<div style="font-size:0.8rem;color:var(--text3);margin-top:10px;text-align:center">RÃ©fÃ©rentiel : SantÃ© publique France</div>';
    });
  }
  else if(s===3){
    if(draft.context==='Autre'||!draft.cps){c.innerHTML+='<div class="wiz-title">Objectif libre</div><p style="font-size:.8rem;color:var(--text2);margin-bottom:12px">Ã‰cris ton propre objectif :</p><input type="text" class="fi" id="free-goal" placeholder="Mon objectifâ€¦"><button class="wiz-confirm" onclick="if(document.getElementById(\'free-goal\').value){draft.titre=document.getElementById(\'free-goal\').value;draft.code_ref=\'\';draft._backTo=3;wizStep(6)}">Continuer</button>';return}
    c.innerHTML+='<div class="wiz-title">Choisis un objectif</div><div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:12px 16px;margin-bottom:14px;border-left:4px solid '+(draft.cps.color||domainColor(draft.cps.domain))+'"><div style="font-weight:700;font-size:.82rem">'+draft.cps.spe_label+'</div><div style="font-size:0.8rem;color:var(--text2);margin-top:3px">'+domainLabel(draft.cps.domain)+' Â· '+draft.cps.gen_label+'</div></div>';
    var speCode=upper(draft.cps.spe_code),contextSnapshot3=draft.context,speSnapshot=speCode;
    window.__OBJ_MAP=window.__OBJ_MAP||{};
    var staticItems=(draft.cps.objectifs||[]).map(function(o,i){return{uid:'SEL_'+draft.cps.spe_code+'_'+i,texte:String(o.texte||''),code_ref:o.code_ref||'',domain:draft.cps.domain||guessDomainFromCode(draft.cps.spe_code),cat_code:draft.cps.cat_code,cat_label:draft.cps.cat_label,gen_code:draft.cps.gen_code,gen_label:draft.cps.gen_label,spe_code:draft.cps.spe_code,spe_label:draft.cps.spe_label,color:draft.cps.color||domainColor(draft.cps.domain),is_custom:false}});
    loadCustomEntriesForContext(contextSnapshot3).then(function(customPack){
      if(draft._step!==3||upper(draft.cps&&draft.cps.spe_code)!==speSnapshot)return;
      var customItems=customPack.eleve.concat(customPack.global).filter(function(raw){return upper(raw.competence_code)===speSnapshot}).map(function(raw){var item=mapCustomToWizardItem(raw,{});item.domain=draft.cps.domain||item.domain;item.cat_code=draft.cps.cat_code||item.cat_code;item.cat_label=draft.cps.cat_label||item.cat_label;item.gen_code=draft.cps.gen_code||item.gen_code;item.gen_label=draft.cps.gen_label||item.gen_label;item.spe_code=draft.cps.spe_code||item.spe_code;item.spe_label=draft.cps.spe_label||item.spe_label;item.color=draft.cps.color||item.color||domainColor(item.domain);return item});
      var merged=mergeWizardItems(customItems,staticItems,contextSnapshot3);
      c.innerHTML+=merged.map(function(it){window.__OBJ_MAP[it.uid]=Object.assign({},it);return'<button class="wiz-option" onclick="selectObj(\''+it.uid+'\')">'+wizOptionContentHtml(it)+'</button>'}).join('');
      c.innerHTML+='<button class="wiz-option" style="color:var(--primary);border-style:dashed" onclick="var t=prompt(\'Ton objectif ?\');if(t){draft.titre=t;draft.code_ref=\'\';draft._backTo=3;wizStep(6)}">âœï¸ Ã‰crire mon propre objectif</button>';
    }).catch(function(){c.innerHTML+=staticItems.map(function(it){window.__OBJ_MAP[it.uid]=Object.assign({},it);return'<button class="wiz-option" onclick="selectObj(\''+it.uid+'\')">'+wizOptionContentHtml(it)+'</button>'}).join('')+'<button class="wiz-option" style="color:var(--primary);border-style:dashed" onclick="var t=prompt(\'Ton objectif ?\');if(t){draft.titre=t;draft.code_ref=\'\';draft._backTo=3;wizStep(6)}">âœï¸ Ã‰crire mon propre objectif</button>'});
  }
  else if(s===4){c.innerHTML+='<div class="wiz-title">Pour quand ?</div><input type="date" class="fi" id="w-date" value="'+(draft.date||new Date().toISOString().split('T')[0])+'"><button class="wiz-confirm" onclick="draft.date=document.getElementById(\'w-date\').value;wizStep(5)">Continuer</button>'}
  else if(s===5){
    if(draft.context==='Scolaire'){c.innerHTML+='<div class="wiz-title">MatiÃ¨re</div><select class="fi" id="w-det">'+MATIERES.map(function(m){return '<option value="'+m+'">'+m+'</option>'}).join('')+'<option value="__autre">Autreâ€¦</option></select><input type="text" class="fi" id="w-det-autre" placeholder="PrÃ©ciseâ€¦" style="display:none"><button class="wiz-confirm" onclick="var v=document.getElementById(\'w-det\').value;draft.detail=v===\'__autre\'?document.getElementById(\'w-det-autre\').value:v;wizStep(6)">Continuer</button>';setTimeout(function(){var sel=document.getElementById('w-det');if(sel)sel.onchange=function(){document.getElementById('w-det-autre').style.display=sel.value==='__autre'?'block':'none'}},50)}
    else if(draft.context==='PFMP'){c.innerHTML+='<div class="wiz-title">Lieu / ActivitÃ©</div><input type="text" class="fi" id="w-det" placeholder="Atelier, chantier, serviceâ€¦"><button class="wiz-confirm" onclick="draft.detail=document.getElementById(\'w-det\').value;wizStep(6)">Continuer</button>'}
    else if(draft.context==='Recherche'){c.innerHTML+='<div class="wiz-title">Cible</div><input type="text" class="fi" id="w-det" placeholder="MÃ©tier, secteur, zoneâ€¦"><button class="wiz-confirm" onclick="draft.detail=document.getElementById(\'w-det\').value;wizStep(6)">Continuer</button>'}
    else{c.innerHTML+='<div class="wiz-title">Contexte</div><input type="text" class="fi" id="w-det" placeholder="PrÃ©ciseâ€¦"><button class="wiz-confirm" onclick="draft.detail=document.getElementById(\'w-det\').value;wizStep(6)">Continuer</button>'}}
  else if(s===6){renderRecapStep(c)}
}

window.selectCps=function(uid){if(!window.__CPS_MAP||!window.__CPS_MAP[uid])return;draft.cps=window.__CPS_MAP[uid];draft.type=draft.cps.domain||'NEU';wizStep(3)}
window.selectObj=function(uid){var o=window.__OBJ_MAP&&window.__OBJ_MAP[uid];if(!o)return;draft.obj=o;draft.titre=o.texte||'';draft.code_ref=o.code_ref||'';draft.type=o.domain||'NEU';draft.cps={domain:o.domain,cat_code:o.cat_code,cat_label:o.cat_label,gen_code:o.gen_code,gen_label:o.gen_label,spe_code:o.spe_code,spe_label:o.spe_label,color:domainColor(o.domain)};draft._backTo=draft._step;wizStep(6)}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// RECAP STEP
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function getRecapSuggestions(){var s=[],ctx=draft.context||'',dom=draft.type||(draft.cps&&draft.cps.domain)||'';if(ctx==='Scolaire'){s.push("Quand le prof me le confirmera","Quand j'aurai rÃ©ussi l'Ã©valuation","Quand j'y arriverai seul(e)")}else if(ctx==='PFMP'){s.push("Quand mon tuteur me le dira","Quand je rÃ©aliserai la tÃ¢che seul(e)")}else if(ctx==='Recherche'){s.push("Quand j'aurai trouvÃ© mon stage","Quand j'aurai ma convention signÃ©e","Quand j'aurai contactÃ© 5 entreprises")}if(dom==='COG'&&ctx!=='Recherche')s.push("Quand j'aurai compris le sujet");if(dom==='EMO')s.push("Quand je me sentirai plus Ã  l'aise");if(dom==='SOC')s.push("Quand j'aurai amÃ©liorÃ© mes Ã©changes");if(s.length<2)s.push("Quand j'aurai atteint mon objectif");return s.slice(0,4)}

function renderRecapStep(c){
  var dom=draft.type||(draft.cps&&draft.cps.domain)||'NEU',color=domainColor(dom),ax=AX[dom]||{cls:'neu',emoji:'ğŸ“‹',label:'Autre'};
  var isStage=draft.context==='Recherche',isScolaire=draft.context==='Scolaire';
  var cadreIcons={'Scolaire':'ğŸ“š','PFMP':'ğŸ¢','Recherche':'ğŸ”','Autre':'âœï¸'};
  var recapTitle=escHtml(draft.titre||'Mon objectif');
  if(!draft.demarches)draft.demarches=[];
  if(draft._backTo)c.innerHTML+='<button class="wiz-back" onclick="collectRecapDraft();wizStep('+draft._backTo+')">â† Retour</button>';
  var h='<div class="recap-card"><div class="recap-header '+(ax.cls||'neu')+'">';
  h+='<div class="recap-badge">'+(cadreIcons[draft.context]||'âœï¸')+' '+(draft.context||'Autre')+'</div>';
  h+='<div class="recap-titre-display">'+recapTitle+'</div>';
  if(draft.cps){h+='<div class="recap-cps-tree">';h+='<div class="recap-cps-node level-1"><span class="recap-cps-dot" style="background:'+color+'"></span>'+(ax.emoji||'')+' '+escHtml(draft.cps.cat_label||ax.label)+'</div>';if(draft.cps.gen_label)h+='<div class="recap-cps-node level-2">â†³ '+escHtml(draft.cps.gen_label)+'</div>';if(draft.cps.spe_label)h+='<div class="recap-cps-node level-3">â†³ '+escHtml(draft.cps.spe_label)+'</div>';h+='</div>'}else{h+='<div class="recap-cps-tree" style="color:var(--text3)">Objectif libre â€” hors rÃ©fÃ©rentiel</div>'}
  h+='</div><div class="recap-body">';
  h+='<div class="recap-field"><div class="recap-field-label">ğŸ¯ Objectif</div><input type="text" class="fi" id="r-titre" value="'+(draft.titre||'').replace(/"/g,'&quot;')+'">';
  if(draft.code_ref)h+='<div class="recap-info-text">Issu du rÃ©fÃ©rentiel CPS â€” modifiable</div>';
  h+='</div>';
  h+='<div class="recap-field"><div class="recap-field-label">ğŸ“… Pour quand ?</div><input type="date" class="fi" id="r-date" value="'+(draft.date||new Date().toISOString().split('T')[0])+'"></div>';
  if(!isStage){
    if(isScolaire){h+='<div class="recap-field"><div class="recap-field-label">ğŸ“š MatiÃ¨re / Discipline</div><select class="fi" id="r-matiere">'+MATIERES.map(function(m){return '<option value="'+m+'"'+(m===(draft.detail||'')?' selected':'')+'>'+m+'</option>'}).join('')+'<option value="__autre"'+(MATIERES.indexOf(draft.detail||'')===-1&&draft.detail?' selected':'')+'>Autreâ€¦</option></select><input type="text" class="fi" id="r-matiere-autre" placeholder="PrÃ©cise ta matiÃ¨reâ€¦" style="display:'+(MATIERES.indexOf(draft.detail||'')===-1&&draft.detail?'block':'none')+';margin-top:8px" value="'+(MATIERES.indexOf(draft.detail||'')===-1?(draft.detail||'').replace(/"/g,'&quot;'):'')+'"></div>'}
    else if(draft.context==='PFMP'){h+='<div class="recap-field"><div class="recap-field-label">ğŸ¢ Lieu / ActivitÃ©</div><input type="text" class="fi" id="r-detail" value="'+(draft.detail||'').replace(/"/g,'&quot;')+'" placeholder="Atelier, chantier, serviceâ€¦"></div>'}
    else{h+='<div class="recap-field"><div class="recap-field-label">ğŸ“ Contexte</div><input type="text" class="fi" id="r-detail" value="'+(draft.detail||'').replace(/"/g,'&quot;')+'" placeholder="PrÃ©ciseâ€¦"></div>'}
  }
  var suggs=getRecapSuggestions();
  h+='<div class="recap-field"><div class="recap-field-label">ğŸ“ Comment je saurai que c\'est rÃ©ussi ?</div><input type="text" class="fi" id="r-critere" value="'+(draft.critere||'').replace(/"/g,'&quot;')+'" placeholder="Ex : Quand j\'auraiâ€¦"><div class="recap-suggestions">'+suggs.map(function(sg){return '<button type="button" class="recap-sugg" onclick="document.getElementById(\'r-critere\').value=this.textContent">'+sg+'</button>'}).join('')+'</div></div>';
  if(isStage){h+='<div class="recap-field"><div class="recap-field-label">ğŸ¢ Mes dÃ©marches de recherche</div><div id="r-demarches-list">'+renderDemarchesHTML(draft.demarches)+'</div><button type="button" class="recap-add-btn" onclick="addDemarcheUI()">+ Ajouter une dÃ©marche</button></div>'}
  h+='</div></div>';
  h+='<div id="r-warnings"></div>';
  h+='<button class="wiz-confirm" onclick="validateRecap()">âœ… Valider mon objectif</button>';
  c.innerHTML+=h;
  setTimeout(function(){var sel=document.getElementById('r-matiere');if(sel)sel.onchange=function(){document.getElementById('r-matiere-autre').style.display=sel.value==='__autre'?'block':'none'}},50);
}

function renderDemarchesHTML(list){if(!list||!list.length)return '<div style="font-size:.85rem;color:var(--text3);padding:8px 0;font-style:italic">Aucune dÃ©marche pour le moment</div>';
  return list.map(function(d,i){var h='<div class="recap-demarche" data-idx="'+i+'"><div class="recap-demarche-head"><span class="recap-demarche-num">DÃ©marche '+(i+1)+'</span><button type="button" class="recap-demarche-del" onclick="removeDemarcheUI('+i+')">Supprimer</button></div>';
  h+='<label>Entreprise *</label><input type="text" class="fi dem-entreprise" value="'+(d.entreprise||'').replace(/"/g,'&quot;')+'" placeholder="Nom de l\'entreprise">';
  h+='<label>Ville</label><input type="text" class="fi dem-ville" value="'+(d.ville||'').replace(/"/g,'&quot;')+'" placeholder="Optionnel">';
  h+='<label>Mode de contact</label><div class="recap-contact-grid">'+CONTACT_MODES.map(function(m){return '<button type="button" class="recap-contact-btn'+(d.contact_mode===m.v?' active':'')+'" data-mode="'+m.v+'" onclick="this.parentNode.querySelectorAll(\'.recap-contact-btn\').forEach(function(b){b.classList.remove(\'active\')});this.classList.add(\'active\')">'+m.l+'</button>'}).join('')+'</div>';
  h+='<label>Date de la dÃ©marche</label><input type="date" class="fi dem-date" value="'+(d.date_demarche||'')+'">';
  h+='</div>';return h}).join('')}

window.addDemarcheUI=function(){collectDemarches();draft.demarches.push({entreprise:'',ville:'',contact_mode:'',date_demarche:'',statut:'a_faire'});document.getElementById('r-demarches-list').innerHTML=renderDemarchesHTML(draft.demarches);var inputs=document.querySelectorAll('.recap-demarche:last-child .dem-entreprise');if(inputs.length)inputs[inputs.length-1].focus()}
window.removeDemarcheUI=function(idx){collectDemarches();draft.demarches.splice(idx,1);document.getElementById('r-demarches-list').innerHTML=renderDemarchesHTML(draft.demarches)}

function collectDemarches(){var cards=document.querySelectorAll('.recap-demarche');draft.demarches=[];cards.forEach(function(card){var ent=card.querySelector('.dem-entreprise'),vil=card.querySelector('.dem-ville'),dat=card.querySelector('.dem-date');var activeBtn=card.querySelector('.recap-contact-btn.active');draft.demarches.push({entreprise:ent?ent.value.trim():'',ville:vil?vil.value.trim():'',contact_mode:activeBtn?activeBtn.dataset.mode:'',date_demarche:dat?dat.value:'',statut:'a_faire'})})}

window.collectRecapDraft=function(){var t=document.getElementById('r-titre');if(t)draft.titre=t.value;var d=document.getElementById('r-date');if(d)draft.date=d.value;var cr=document.getElementById('r-critere');if(cr)draft.critere=cr.value;var ms=document.getElementById('r-matiere');if(ms)draft.detail=ms.value==='__autre'?(document.getElementById('r-matiere-autre')||{}).value||'':ms.value;var det=document.getElementById('r-detail');if(det)draft.detail=det.value;if(draft.context==='Recherche')collectDemarches()}

window.validateRecap=function(){
  collectRecapDraft();
  var missing=[],isStage=draft.context==='Recherche';
  if(!draft.date)missing.push('la date');
  if(!isStage&&!draft.detail)missing.push(draft.context==='Scolaire'?'la matiÃ¨re':'le lieu / contexte');
  if(!draft.critere)missing.push('le critÃ¨re de rÃ©ussite');
  if(isStage){var validDem=(draft.demarches||[]).filter(function(d){return d.entreprise});if(!validDem.length)missing.push('au moins une dÃ©marche');
    var noVille=(draft.demarches||[]).filter(function(d){return d.entreprise&&!d.ville});if(noVille.length){var vMsg=noVille.length===1?'la ville pour Â« '+escHtml(noVille[0].entreprise)+' Â»':'la ville pour '+noVille.length+' dÃ©marches';missing.push(vMsg)}}
  if(missing.length){var w=document.getElementById('r-warnings');w.innerHTML='<div class="recap-warn">ğŸ’¡ Tu n\'as pas renseignÃ© : '+missing.map(escHtml).join(', ')+'. Tu peux enregistrer quand mÃªme et complÃ©ter plus tard.</div><div class="recap-warn-btns"><button onclick="saveWizard()" style="background:var(--primary);color:#fff">Enregistrer quand mÃªme</button><button onclick="document.getElementById(\'r-warnings\').innerHTML=\'\'" style="background:var(--bg);color:var(--text);border:1px solid var(--border)">ComplÃ©ter</button></div>';return}
  saveWizard()}

window.saveWizard=function(){
  collectRecapDraft();
  if(!draft.date)draft.date=new Date().toISOString().split('T')[0];
  var dom=draft.type||(draft.cps&&draft.cps.domain)||'NEU';
  var pushData={context:draft.context||'Autre',type:dom,titre:draft.titre||'',date_cible:draft.date,detail:(draft.detail&&draft.detail.trim())||'Non prÃ©cisÃ©',done:false,created:new Date().toISOString(),ref_source:"SantÃ© publique France",cat_code:(draft.cps&&draft.cps.cat_code)||"",cat_label:(draft.cps&&draft.cps.cat_label)||"",gen_code:(draft.cps&&draft.cps.gen_code)||"",gen_label:(draft.cps&&draft.cps.gen_label)||"",spe_code:(draft.cps&&draft.cps.spe_code)||"",spe_label:(draft.cps&&draft.cps.spe_label)||"",code_ref:draft.code_ref||"",domaine:dom,critere_reussite:draft.critere||""};
  if(draft.context==='Recherche'&&draft.demarches&&draft.demarches.length){var dems={};draft.demarches.forEach(function(d,i){if(d.entreprise)dems['d'+i]=d});if(Object.keys(dems).length)pushData.demarches=dems}
  db.ref('accompagnement/eleves/'+dataCode+'/objectifs').push(pushData);closeOv('wizard-overlay')}
</script>
</body>
</html>
