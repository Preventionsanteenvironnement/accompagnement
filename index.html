<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Espace Réussite</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="js/firebase-config.js"></script>

    <style>
        :root { 
            --bg-app: #f8fafc; --surface: #ffffff; --text-main: #0f172a; --primary: #4f46e5; --radius: 8px;
            --cog-color: #3b82f6; --emo-color: #ec4899; --soc-color: #8b5cf6; --neu-color: #64748b;
        }
        body { background-color: var(--bg-app); color: var(--text-main); font-family: 'Outfit', sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* HEADER SOBRE (G) */
        .app-header { background: var(--surface); padding: 1rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e2e8f0; z-index: 20; }
        .student-id { font-weight: 700; color: var(--text-main); font-size: 0.9rem; letter-spacing: 0.5px; text-transform: uppercase; }
        .btn-header { background: none; border: 1px solid #cbd5e1; color: var(--neu-color); padding: 4px 10px; border-radius: 4px; font-size: 0.75rem; font-weight: 600; text-decoration: none; }

        .app-content { flex: 1; overflow-y: auto; padding: 1rem; padding-bottom: 100px; display: none; }
        .app-content.active { display: block; }

        /* METEO */
        .mood-box { background: white; padding: 15px; border-radius: var(--radius); border: 1px solid #e2e8f0; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        
        /* CERCLES */
        .kpi-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 1.5rem; }
        .kpi-item { background: white; border-radius: var(--radius); padding: 10px 5px; text-align: center; border: 1px solid #e2e8f0; cursor: pointer; }
        .chart-mini { position: relative; height: 50px; width: 50px; margin: 0 auto 5px auto; }
        .kpi-title { font-weight: 700; font-size: 0.7rem; text-transform: uppercase; color: var(--neu-color); }

        /* LISTE OBJECTIFS (B) */
        .obj-card { background: white; border-radius: var(--radius); padding: 12px; margin-bottom: 8px; border: 1px solid #e2e8f0; border-left-width: 4px; display: flex; align-items: center; cursor: pointer; }
        .obj-card.cog { border-left-color: var(--cog-color); }
        .obj-card.emo { border-left-color: var(--emo-color); }
        .obj-card.soc { border-left-color: var(--soc-color); }
        .obj-card.neu { border-left-color: var(--neu-color); }
        
        .obj-content { flex: 1; margin-left: 10px; }
        .obj-title { font-weight: 600; font-size: 0.9rem; line-height: 1.2; margin-bottom: 4px; }
        .obj-meta { font-size: 0.75rem; color: #64748b; display: flex; gap: 8px; align-items: center; }
        .obj-badge { background: #f1f5f9; padding: 2px 6px; border-radius: 4px; font-weight: 700; font-size: 0.65rem; text-transform: uppercase; letter-spacing: 0.5px; }
        .obj-time { font-weight: 600; margin-left: auto; }
        .obj-time.urgent { color: #dc2626; }

        /* BOUTONS ACTIONS */
        .btn-main { display: block; width: 100%; background: white; border: 1px solid #e2e8f0; padding: 12px; margin-bottom: 10px; border-radius: var(--radius); text-align: left; font-weight: 600; color: var(--primary); }
        .btn-add { background: var(--primary); color: white; text-align: center; border: none; }

        /* NAV BAS */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid #e2e8f0; display: flex; justify-content: space-around; padding: 12px 0; z-index: 30; }
        .nav-btn { background: none; border: none; color: #94a3b8; font-size: 0.75rem; font-weight: 600; }
        .nav-btn.active { color: var(--primary); }

        /* OVERLAYS */
        .overlay-full { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f8fafc; z-index: 100; display: none; flex-direction: column; overflow-y: auto; }
        .overlay-header { padding: 1rem; background: white; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; }
        .step-content { padding: 1.5rem; flex: 1; }
        
        .list-btn { width: 100%; text-align: left; padding: 12px; margin-bottom: 8px; background: white; border: 1px solid #e2e8f0; border-radius: var(--radius); font-weight: 500; color: var(--text-main); }
        .list-btn:active, .list-btn.selected { background: #e0e7ff; border-color: var(--primary); color: var(--primary); font-weight: 700; }

        /* FORMULAIRES */
        .form-label { font-size: 0.75rem; font-weight: 700; color: var(--neu-color); text-transform: uppercase; margin-bottom: 5px; display: block; }
        .form-control, .form-select { border-radius: 6px; border: 1px solid #cbd5e1; padding: 10px; width: 100%; margin-bottom: 15px; font-size: 0.9rem; }

        .hidden { display: none !important; }
        #qrcode-container { display: flex; justify-content: center; margin: 20px 0; padding: 10px; background: white; border-radius: 8px; }
    </style>
</head>
<body>

<div id="loader" style="position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; display:flex; align-items:center; justify-content:center;">
    <div class="spinner-border text-primary" role="status"></div>
</div>

<header class="app-header">
    <div class="student-id"><span id="display-code">--</span></div>
    <button class="btn-header" onclick="startBreathing()">Respiration</button>
</header>

<main class="app-content active" id="view-dashboard">
    
    <div class="mood-box" id="mood-box" style="display:none;">
        <div>
            <div style="font-size:0.75rem; color:#64748b; font-weight:600;">HUMEUR DU JOUR</div>
            <div style="font-weight:700; color:#4f46e5;" id="mood-display">--</div>
        </div>
        <button class="btn-header" onclick="openMoodModal()">Changer</button>
    </div>

    <div class="kpi-grid">
        <div class="kpi-item" onclick="openCircleDetail('COG')"><div class="chart-mini"><canvas id="chartCog"></canvas></div><div class="kpi-title">Cognitif</div></div>
        <div class="kpi-item" onclick="openCircleDetail('EMO')"><div class="chart-mini"><canvas id="chartEmo"></canvas></div><div class="kpi-title">Émotionnel</div></div>
        <div class="kpi-item" onclick="openCircleDetail('SOC')"><div class="chart-mini"><canvas id="chartSoc"></canvas></div><div class="kpi-title">Social</div></div>
    </div>

    <button class="btn-main btn-add" onclick="startGoalWizard()">+ Ajouter un objectif</button>
    <button class="btn-main" onclick="openRecoModal()">Ajouter une reconnaissance</button>
    <button class="btn-main" onclick="openAttestation()">Ma Synthèse CPS</button>

    <h6 style="font-weight:700; margin-top:20px; margin-bottom:10px; font-size:0.85rem; color:#334155;">OBJECTIFS À ATTEINDRE</h6>
    <div id="goals-list"></div>

    <div style="margin-top:20px; border-top:1px solid #e2e8f0; padding-top:10px;">
        <div onclick="toggleHistory()" style="cursor:pointer; font-size:0.8rem; font-weight:600; color:#64748b;">
            Voir les objectifs atteints ▼
        </div>
        <div id="history-list" style="display:none; margin-top:10px;"></div>
    </div>
</main>

<div class="bottom-nav">
    <button class="nav-btn active" onclick="switchView('dashboard')">ACCUEIL</button>
    <button class="nav-btn" onclick="openAttestation()">BILAN</button>
</div>

<div id="wizard-overlay" class="overlay-full">
    <div class="overlay-header">
        <h5 style="margin:0; font-weight:700;">Nouvel Objectif</h5>
        <button class="btn-header" onclick="closeWizard()">Fermer</button>
    </div>
    <div class="step-content" id="wizard-content"></div>
</div>

<div id="detail-overlay" class="overlay-full">
    <div class="overlay-header">
        <h5 style="margin:0; font-weight:700;">Détail Objectif</h5>
        <button class="btn-header" onclick="closeDetail()">Fermer</button>
    </div>
    <div class="step-content">
        <div class="mb-3">
            <span id="det-badge" class="obj-badge">CADRE</span>
        </div>
        
        <label class="form-label">Objectif</label>
        <input type="text" id="det-title" class="form-control" disabled style="background:#f1f5f9; font-weight:600;">
        <small class="text-muted d-block mb-3" id="det-help">Texte issu du référentiel (non modifiable).</small>

        <label class="form-label">Pour quand ?</label>
        <input type="date" id="det-date" class="form-control">

        <label class="form-label">Matière / Lieu</label>
        <input type="text" id="det-context" class="form-control">

        <button class="btn-main btn-add" onclick="saveDetail()">Enregistrer les modifications</button>

        <hr style="margin: 20px 0; border-color:#e2e8f0;">

        <button class="btn-main" style="border-color:#4f46e5; color:#4f46e5;" onclick="showQRForGoal()">Demander validation adulte</button>
        
        <button class="btn-header w-100 mt-3" style="color:#dc2626; border-color:#fca5a5;" onclick="deleteGoal()">Supprimer</button>
    </div>
</div>

<div id="qr-overlay" class="overlay-full" style="justify-content:center; align-items:center;">
    <div style="text-align:center; padding:20px;">
        <h4 style="font-weight:700; margin-bottom:20px;">Faire valider</h4>
        <div id="qrcode-container"></div>
        <p class="text-muted small mt-3">Présente ce code à l'adulte.</p>
        <button class="btn-header" onclick="document.getElementById('qr-overlay').style.display='none'">Fermer</button>
    </div>
</div>

<div id="mood-overlay" class="overlay-full">
    <div class="overlay-header"><h5 style="margin:0; font-weight:700;">Météo du jour</h5></div>
    <div class="step-content" id="mood-content"></div>
</div>

<div id="circle-overlay" class="overlay-full">
    <div class="overlay-header"><h5 id="circle-title" style="margin:0; font-weight:700;">--</h5><button class="btn-header" onclick="closeCircle()">Fermer</button></div>
    <div class="step-content" id="circle-content"></div>
</div>

<div id="attestation-overlay" class="overlay-full">
    <div class="overlay-header no-print"><h5 style="margin:0; font-weight:700;">Synthèse</h5><button class="btn-header" onclick="document.getElementById('attestation-overlay').style.display='none'">Fermer</button></div>
    <div class="step-content" id="attestation-content">
        <h3 class="fw-bold mb-4 text-center">Profil de Compétences</h3>
        <div class="card p-3 mb-3" style="border-left:5px solid var(--cog-color)"><h5 style="color:var(--cog-color); margin:0 0 10px 0;">Cognitif</h5><p id="syn-cog" class="small m-0 text-muted">...</p></div>
        <div class="card p-3 mb-3" style="border-left:5px solid var(--emo-color)"><h5 style="color:var(--emo-color); margin:0 0 10px 0;">Émotionnel</h5><p id="syn-emo" class="small m-0 text-muted">...</p></div>
        <div class="card p-3 mb-3" style="border-left:5px solid var(--soc-color)"><h5 style="color:var(--soc-color); margin:0 0 10px 0;">Social</h5><p id="syn-soc" class="small m-0 text-muted">...</p></div>
        <button class="btn-main no-print mt-4" onclick="window.print()">Imprimer</button>
    </div>
</div>

<script>
    // --- CONFIG & SECU ---
    if (typeof firebaseConfig !== 'undefined') firebase.initializeApp(firebaseConfig);
    let userCode = new URLSearchParams(window.location.search).get("id");
    
    // Fallback Secu
    window.addEventListener('load', () => {
        setTimeout(() => {
            document.getElementById('loader').style.display = 'none';
            if(!userCode) { userCode = "KA47"; document.getElementById('display-code').innerText = "KA47 (TEST)"; loadData(); }
        }, 2000);
    });

    let userData = {};
    let draft = {};
    let currentEditId = null;
    let charts = {};

    // --- DATA ---
    const GOAL_LIB = {
        "Scolaire": {
            "COG": ["Se concentrer", "Comprendre consigne", "Organiser matériel", "Planifier travail", "Appliquer méthode", "Vérifier travail"],
            "EMO": ["Identifier émotions", "Exprimer ressenti", "Réguler stress", "Prendre confiance", "Accepter correction"],
            "SOC": ["Participer oralement", "Lever la main", "Parler clairement", "Écouter sans couper", "Travailler en groupe"]
        },
        "PFMP": {
            "COG": ["Comprendre consigne pro", "Observer avant d'agir", "Appliquer procédure", "Gérer temps", "Respecter sécurité"],
            "EMO": ["Gérer stress tâche", "Accepter remarque", "Gérer fatigue", "Rester motivé"],
            "SOC": ["Saluer", "Se présenter", "Parler poliment", "Posture pro", "Respecter hiérarchie"]
        },
        "Recherche": {
            "COG": ["Identifier entreprises", "Préparer CV", "Adapter candidature", "Planifier actions"],
            "EMO": ["Gérer peur refus", "Oser contacter", "Persévérer", "Se rassurer"],
            "SOC": ["Se présenter tél", "Exprimer motivation", "Remercier", "Posture entretien"]
        }
    };
    const MATIERES = ["Français","Maths","Anglais","Espagnol","Hist-Géo","Eco-Droit","Ens. Pro","PSE","Arts","EPS","Autre"];
    const EMOTIONS = {
        "Joie": ["Satisfait","Fier","Enthousiaste"], "Tristesse": ["Déçu","Découragé"], "Colère": ["Agacé","Frustré"], 
        "Peur": ["Inquiet","Stressé"], "Dégoût": ["Gêné"], "Surprise": ["Étonné"]
    };

    function loadData() {
        if(!userCode) return;
        document.getElementById('display-code').innerText = userCode;
        firebase.database().ref(`accompagnement/eleves/${userCode}`).on('value', (snap) => {
            userData = snap.val() || { objectifs: {}, meteo: {} };
            renderDashboard();
            checkMood();
            renderAttestation();
        });
    }

    // --- DASHBOARD (F) ---
    function renderDashboard() {
        const list = document.getElementById('goals-list'); list.innerHTML = '';
        const hist = document.getElementById('history-list'); hist.innerHTML = '';
        const goals = userData.objectifs || {};
        const keys = Object.keys(goals);
        let counts = {COG:0, EMO:0, SOC:0};

        // Tri (F) : Date proche d'abord
        keys.sort((a,b) => {
            const da = new Date(goals[a].date_cible || '2099-01-01');
            const db = new Date(goals[b].date_cible || '2099-01-01');
            return da - db;
        });

        keys.forEach(k => {
            const g = goals[k];
            const type = (g.type || 'NEU').toLowerCase();
            const badge = g.context || 'Autre';
            
            // Calcul J-x (E)
            let timeStr = "Date à définir";
            let urgent = false;
            if(g.date_cible) {
                const today = new Date(); today.setHours(0,0,0,0);
                const target = new Date(g.date_cible); target.setHours(0,0,0,0);
                const diff = Math.ceil((target - today) / (86400000));
                if(!isNaN(diff)) {
                    timeStr = diff === 0 ? "Aujourd'hui" : (diff < 0 ? "Dépassé" : `J-${diff}`);
                    if(diff < 0) urgent = true;
                }
            }

            if(g.done) {
                if(counts[g.type]) counts[g.type]++;
                hist.innerHTML += `<div class="obj-card ${type}" style="opacity:0.6"><div class="obj-content"><div class="obj-title">${g.titre}</div><div class="obj-meta">Validé</div></div></div>`;
            } else {
                list.innerHTML += `
                <div class="obj-card ${type}" onclick="openDetail('${k}')">
                    <input type="checkbox" onclick="event.stopPropagation(); toggleGoal('${k}', true)" style="width:20px;height:20px;">
                    <div class="obj-content">
                        <div class="obj-title">${g.titre}</div>
                        <div class="obj-meta">
                            <span class="obj-badge">${badge}</span>
                            <span>${g.detail || ''}</span>
                            <span class="obj-time ${urgent?'urgent':''}">${timeStr}</span>
                        </div>
                    </div>
                </div>`;
            }
        });

        if(list.innerHTML === '') list.innerHTML = '<div style="text-align:center; color:#94a3b8; font-style:italic; padding:20px;">Aucun objectif en cours.</div>';

        // Charts
        ['Cog','Emo','Soc'].forEach(t => {
            const ctx = document.getElementById('chart'+t);
            if(ctx) new Chart(ctx, { type:'doughnut', data:{datasets:[{data:[counts[t.toUpperCase()], 10], backgroundColor:['#4f46e5','#f1f5f9'], borderWidth:0}]}, options:{cutout:'75%', events:[], plugins:{tooltip:false}} });
        });
    }

    function toggleGoal(k, status) {
        if(confirm("As-tu atteint cet objectif ?")) {
            firebase.database().ref(`accompagnement/eleves/${userCode}/objectifs/${k}`).update({done: status, date_done: new Date().toISOString()});
        } else {
            renderDashboard(); // Reset checkbox
        }
    }

    // --- WIZARD 6 ETAPES (A) ---
    window.startGoalWizard = function() { draft = {}; document.getElementById('wizard-overlay').style.display='flex'; wizStep(1); }
    
    function wizStep(s) {
        const c = document.getElementById('wizard-content'); c.innerHTML = '';
        if(s===1) { // CADRE
            c.innerHTML = `<h5>1. Dans quel cadre ?</h5>
            <button class="list-btn" onclick="draft.context='Scolaire'; wizStep(2)">Scolaire</button>
            <button class="list-btn" onclick="draft.context='PFMP'; wizStep(2)">PFMP / Stage</button>
            <button class="list-btn" onclick="draft.context='Recherche'; wizStep(2)">Recherche de stage</button>
            <button class="list-btn" onclick="draft.context='Autre'; wizStep(2)">Autre (Libre)</button>`;
        } else if(s===2) { // TYPE
            c.innerHTML = `<h5>2. Quel type de progrès ?</h5>
            <button class="list-btn" onclick="draft.type='COG'; wizStep(3)">Cognitif (Tête)</button>
            <button class="list-btn" onclick="draft.type='EMO'; wizStep(3)">Émotionnel (Cœur)</button>
            <button class="list-btn" onclick="draft.type='SOC'; wizStep(3)">Social (Lien)</button>
            <button class="list-btn" onclick="draft.type='AUTRE'; wizStep(3)">Autre</button>`;
        } else if(s===3) { // BUT
            const list = GOAL_LIB[draft.context]?.[draft.type] || [];
            let h = `<h5>3. Choisis ton but</h5>`;
            list.forEach(g => h+=`<button class="list-btn" onclick="draft.titre='${g}'; wizStep(4)">${g}</button>`);
            h+=`<button class="list-btn" onclick="draft.titre=prompt('Ton objectif ?'); if(draft.titre) wizStep(4)">Autre (Écrire)...</button>`;
            c.innerHTML = h;
        } else if(s===4) { // DATE
            c.innerHTML = `<h5>4. Pour quand ?</h5>
            <input type="date" id="w-date" class="form-control" value="${new Date().toISOString().split('T')[0]}">
            <button class="btn-main btn-add" onclick="draft.date=document.getElementById('w-date').value; wizStep(5)">Continuer</button>`;
        } else if(s===5) { // MATIERE/LIEU
            let inputHtml = `<input type="text" id="w-det" class="form-control" placeholder="Précise...">`;
            if(draft.context === 'Scolaire') {
                inputHtml = `<select id="w-det" class="form-select">${MATIERES.map(m=>`<option value="${m}">${m}</option>`).join('')}</select>`;
            }
            c.innerHTML = `<h5>5. Matière / Lieu</h5>${inputHtml}
            <button class="btn-main btn-add" onclick="draft.detail=document.getElementById('w-det').value; wizStep(6)">Continuer</button>`;
        } else if(s===6) { // VALIDATION
            c.innerHTML = `<h5>6. Récapitulatif</h5>
            <div class="card p-3 mb-3 bg-light">
                <strong>${draft.titre}</strong><br>
                ${draft.context} • ${draft.type}<br>
                ${draft.detail} • ${draft.date}
            </div>
            <button class="btn-main btn-add" onclick="saveWizard()">Valider l'objectif</button>`;
        }
    }
    window.saveWizard = function() {
        if(!draft.date) draft.date = new Date().toISOString().split('T')[0]; // Fallback date
        firebase.database().ref(`accompagnement/eleves/${userCode}/objectifs`).push({
            context: draft.context, type: draft.type, titre: draft.titre,
            date_cible: draft.date, detail: draft.detail || 'Non précisé',
            done: false, created: new Date().toISOString()
        });
        document.getElementById('wizard-overlay').style.display='none';
    }
    window.closeWizard = function(){document.getElementById('wizard-overlay').style.display='none';}

    // --- DETAIL OBJECTIF & QR (C) ---
    window.openDetail = function(k) {
        currentEditId = k;
        const g = userData.objectifs[k];
        document.getElementById('detail-overlay').style.display='flex';
        document.getElementById('det-badge').innerText = g.context || 'AUTRE';
        document.getElementById('det-title').value = g.titre;
        document.getElementById('det-date').value = g.date_cible || '';
        document.getElementById('det-context').value = g.detail || '';
        
        // Verrouillage titre si liste (E)
        const isFree = (g.context === 'Autre' || g.type === 'AUTRE');
        document.getElementById('det-title').disabled = !isFree;
        document.getElementById('det-help').style.display = isFree ? 'none' : 'block';
    }
    window.saveDetail = function() {
        const d = document.getElementById('det-date').value;
        const c = document.getElementById('det-context').value;
        const t = document.getElementById('det-title').value;
        let up = {date_cible:d, detail:c};
        if(!document.getElementById('det-title').disabled) up.titre = t;
        firebase.database().ref(`accompagnement/eleves/${userCode}/objectifs/${currentEditId}`).update(up);
        document.getElementById('detail-overlay').style.display='none';
    }
    window.deleteGoal = function() {
        if(confirm("Supprimer ?")) {
            firebase.database().ref(`accompagnement/eleves/${userCode}/objectifs/${currentEditId}`).remove();
            document.getElementById('detail-overlay').style.display='none';
        }
    }
    window.closeDetail = function(){document.getElementById('detail-overlay').style.display='none';}

    window.showQRForGoal = function() {
        const g = userData.objectifs[currentEditId];
        const p = { eleve: userCode, objectif: currentEditId, competence: g.type, timestamp: Date.now(), cadre: g.context };
        generateQR(JSON.stringify(p));
    }
    window.openRecoModal = function() {
        const type = prompt("Type ? (COG, EMO, SOC)"); // Simplifié pour code, à remplacer par boutons si besoin
        if(type) {
            const p = { eleve: userCode, type_reconnaissance: type.toUpperCase(), competence: type.toUpperCase(), timestamp: Date.now() };
            generateQR(JSON.stringify(p));
        }
    }
    function generateQR(txt) {
        document.getElementById('qrcode-container').innerHTML = '';
        new QRCode(document.getElementById('qrcode-container'), { text: txt, width: 200, height: 200 });
        document.getElementById('qr-overlay').style.display='flex';
    }

    // --- METEO (2 Niveaux) ---
    function checkMood() {
        const today = new Date().toISOString().split('T')[0];
        const m = (userData.meteo && userData.meteo[today]);
        if(m) {
            document.getElementById('mood-box').style.display='flex';
            document.getElementById('mood-display').innerText = m.secondary;
        } else {
            openMoodModal();
        }
    }
    window.openMoodModal = function() {
        document.getElementById('mood-overlay').style.display='flex';
        let h = `<h5>1. Émotion principale</h5>`;
        Object.keys(EMOTIONS).forEach(k => h+=`<button class="list-btn" onclick="moodStep2('${k}')">${k}</button>`);
        document.getElementById('mood-content').innerHTML = h;
    }
    window.moodStep2 = function(p) {
        let h = `<h5>2. Précisons (${p})</h5>`;
        EMOTIONS[p].forEach(s => h+=`<button class="list-btn" onclick="saveMood('${p}','${s}')">${s}</button>`);
        document.getElementById('mood-content').innerHTML = h;
    }
    window.saveMood = function(p, s) {
        const today = new Date().toISOString().split('T')[0];
        firebase.database().ref(`accompagnement/eleves/${userCode}/meteo/${today}`).set({primary:p, secondary:s});
        document.getElementById('mood-overlay').style.display='none';
    }

    // --- CERCLES & ATTESTATION ---
    window.openCircleDetail = function(t) {
        document.getElementById('circle-title').innerText = t;
        // Ici on afficherait l'historique complet filtré par type (omis pour brièveté code V24)
        document.getElementById('circle-overlay').style.display='flex';
        document.getElementById('circle-content').innerHTML = "<p class='text-muted'>Historique complet ici...</p>";
    }
    window.closeCircle = function(){document.getElementById('circle-overlay').style.display='none';}
    
    window.openAttestation = function() { document.getElementById('attestation-overlay').style.display='flex'; }
    window.renderAttestation = function() {
        document.getElementById('syn-cog').innerText = "Analyse des objectifs cognitifs...";
        document.getElementById('syn-emo').innerText = "Analyse des objectifs émotionnels...";
        document.getElementById('syn-soc').innerText = "Analyse des objectifs sociaux...";
    }

    // --- NAV ---
    window.switchView = function(v) {
        document.querySelectorAll('.app-content').forEach(e => e.classList.remove('active'));
        document.getElementById('view-'+v).classList.add('active');
    }
    window.toggleHistory = function() {
        const h = document.getElementById('history-list'); h.style.display = h.style.display==='none'?'block':'none';
    }
</script>
</body>
</html>
