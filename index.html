<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Mon Objectif</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{--bg:#faf9f7;--surface:#fff;--border:rgba(0,0,0,.06);--text:#1a1a2e;--text2:#64748b;--text3:#94a3b8;--primary:#6366f1;--primary-light:#eef2ff;--cog:#3b82f6;--cog-bg:rgba(59,130,246,.08);--emo:#f43f5e;--emo-bg:rgba(244,63,94,.08);--soc:#8b5cf6;--soc-bg:rgba(139,92,246,.08);--success:#10b981;--danger:#ef4444;--warn:#f59e0b;--radius:16px;--radius-sm:12px;--shadow:0 2px 8px rgba(0,0,0,.04);--shadow-lg:0 8px 30px rgba(0,0,0,.08);--ease:cubic-bezier(.4,0,.2,1);--font:'Outfit',system-ui,sans-serif}
html,body{height:100%;overflow:hidden}
body{font-family:var(--font);background:var(--bg);color:var(--text);display:flex;flex-direction:column}

/* ‚îÄ‚îÄ Welcome Screen (instant, no Firebase) ‚îÄ‚îÄ */
.welcome-screen{position:fixed;inset:0;z-index:9999;display:flex;flex-direction:column;align-items:center;justify-content:center;background:var(--bg);padding:40px 24px;text-align:center}
.welcome-content{width:100%;max-width:340px}
.welcome-logo{width:80px;height:80px;border-radius:24px;background:linear-gradient(135deg,#6366f1,#8b5cf6);display:flex;align-items:center;justify-content:center;font-size:2.2rem;color:#fff;margin:0 auto 24px;box-shadow:0 8px 32px rgba(99,102,241,.25)}
.welcome-brand{font-size:1.7rem;font-weight:800;color:var(--text);letter-spacing:-.5px;line-height:1.2}
.welcome-brand span{color:var(--primary)}
.welcome-sub{color:var(--text2);font-size:.85rem;margin-top:6px;margin-bottom:36px;font-weight:500}
.welcome-form{width:100%}
.welcome-input{width:100%;padding:15px 18px;border:2px solid rgba(0,0,0,.08);border-radius:14px;font-family:var(--font);font-size:1.1rem;font-weight:700;text-align:center;letter-spacing:3px;text-transform:uppercase;outline:none;transition:border-color .2s,box-shadow .2s;background:var(--surface);margin-bottom:12px}
.welcome-input:focus{border-color:var(--primary);box-shadow:0 0 0 4px rgba(99,102,241,.1)}
.welcome-input::placeholder{letter-spacing:0;text-transform:none;font-weight:500;color:var(--text3)}
.welcome-btn{width:100%;padding:15px;background:linear-gradient(135deg,var(--primary),var(--soc));color:#fff;border:none;border-radius:14px;font-family:var(--font);font-weight:800;font-size:.9rem;cursor:pointer;transition:transform .15s,box-shadow .15s,opacity .15s}
.welcome-btn:hover{transform:translateY(-1px);box-shadow:0 6px 20px rgba(99,102,241,.3)}
.welcome-btn:active{transform:translateY(0)}
.welcome-btn:disabled{opacity:.5;cursor:not-allowed;transform:none;box-shadow:none}
.welcome-btn .btn-spinner{display:inline-block;width:16px;height:16px;border:2px solid rgba(255,255,255,.3);border-top-color:#fff;border-radius:50%;animation:spin .6s linear infinite;vertical-align:middle;margin-right:8px}
@keyframes spin{to{transform:rotate(360deg)}}
.welcome-error{color:var(--danger);font-size:.78rem;font-weight:600;margin-top:12px;min-height:20px}
.welcome-footer{margin-top:48px;font-size:.7rem;color:var(--text3);font-weight:500}

/* ‚îÄ‚îÄ Denied Screen ‚îÄ‚îÄ */
.denied-screen{position:fixed;inset:0;z-index:9998;display:none;flex-direction:column;align-items:center;justify-content:center;background:var(--bg);padding:40px;text-align:center}
.denied-screen .denied-icon{width:80px;height:80px;border-radius:50%;background:linear-gradient(135deg,#fef3c7,#fde68a);display:flex;align-items:center;justify-content:center;font-size:2.5rem;margin-bottom:24px}
.denied-screen h2{font-size:1.2rem;font-weight:800;margin-bottom:10px}
.denied-screen p{color:var(--text2);font-size:.85rem;max-width:300px;line-height:1.6}
.denied-retry{margin-top:24px;padding:10px 24px;background:var(--surface);border:1px solid var(--border);border-radius:999px;font-family:var(--font);font-weight:700;font-size:.8rem;color:var(--text2);cursor:pointer;transition:all .15s}
.denied-retry:hover{background:var(--primary-light);color:var(--primary);border-color:rgba(99,102,241,.2)}

.app-header{background:var(--surface);padding:16px 20px;display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid var(--border);flex-shrink:0;z-index:10}
.header-left .h-code{font-size:.65rem;font-weight:700;text-transform:uppercase;letter-spacing:1.5px;color:var(--text3)}
.header-left .h-date{font-size:.95rem;font-weight:700;color:var(--text);margin-top:2px}
.header-btn{background:rgba(99,102,241,.08);border:none;color:var(--primary);padding:10px 18px;border-radius:999px;font-family:var(--font);font-size:.75rem;font-weight:700;cursor:pointer;display:flex;align-items:center;gap:6px;transition:all .15s}
.app-content{flex:1;overflow-y:auto;padding:16px 16px 140px}
.app-container{max-width:480px;margin:0 auto}
.mood-box{background:var(--surface);border-radius:var(--radius);padding:14px 18px;box-shadow:var(--shadow);display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;border:1px solid var(--border)}
.mood-left{display:flex;align-items:center;gap:12px}
.mood-emoji{font-size:1.6rem}
.mood-text{font-size:.7rem;color:var(--text3);font-weight:600;text-transform:uppercase;letter-spacing:.5px}
.mood-value{font-weight:700;font-size:.85rem;color:var(--text);margin-top:1px}
.mood-btn{background:var(--primary-light);color:var(--primary);border:none;padding:7px 14px;border-radius:999px;font-family:var(--font);font-size:.7rem;font-weight:700;cursor:pointer}
.cps-box{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:20px 16px;margin-bottom:16px;box-shadow:var(--shadow)}
.cps-box-title{font-size:.65rem;font-weight:800;text-transform:uppercase;letter-spacing:1.2px;color:var(--text3);text-align:center;margin-bottom:16px}
.cps-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px;margin-bottom:16px}
.cps-card{text-align:center;cursor:pointer;transition:all .2s var(--ease);padding:8px 4px;border-radius:var(--radius-sm)}
.cps-card:hover{background:var(--bg)}
.cps-ring{width:64px;height:64px;border-radius:50%;margin:0 auto 8px;position:relative;display:flex;align-items:center;justify-content:center}
.cps-ring::before{content:'';position:absolute;inset:0;border-radius:50%;background:conic-gradient(var(--ring-color) calc(var(--pct)*3.6deg),#e2e8f0 0);transition:all .6s var(--ease)}
.cps-ring::after{content:'';position:absolute;inset:5px;border-radius:50%;background:var(--surface)}
.cps-ring-value{position:relative;z-index:1;font-size:.9rem;font-weight:800}
.cps-label{font-size:.7rem;font-weight:700}
.cps-card.cog .cps-label{color:var(--cog)}.cps-card.emo .cps-label{color:var(--emo)}.cps-card.soc .cps-label{color:var(--soc)}
.cps-divider{border:none;border-top:1px solid var(--border);margin:0 0 14px}
.synthese-btn{width:100%;background:var(--bg);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px;display:flex;align-items:center;justify-content:center;gap:8px;font-family:var(--font);font-weight:700;font-size:.8rem;color:var(--text2);cursor:pointer;transition:all .15s}
.synthese-btn:hover{background:var(--primary-light);color:var(--primary)}
.reco-btn{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:14px 18px;display:flex;align-items:center;gap:14px;cursor:pointer;transition:all .15s;font-family:var(--font);margin-bottom:16px;width:100%}
.reco-btn:hover{box-shadow:var(--shadow)}
.reco-icon{width:38px;height:38px;border-radius:10px;background:rgba(251,191,36,.1);display:flex;align-items:center;justify-content:center;font-size:1.1rem;flex-shrink:0}
.reco-text{font-weight:700;font-size:.8rem}.reco-sub{font-size:.7rem;color:var(--text3);margin-top:2px}
.section-title{font-size:.65rem;font-weight:800;text-transform:uppercase;letter-spacing:1px;color:var(--text3);margin-bottom:10px;display:flex;align-items:center;justify-content:space-between}
.goal-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px 14px;margin-bottom:8px;display:flex;align-items:center;gap:10px;cursor:pointer;transition:all .15s;position:relative;overflow:hidden}
.goal-card:hover{box-shadow:var(--shadow)}
.goal-card::before{content:'';position:absolute;left:0;top:0;bottom:0;width:4px}
.goal-card.cog::before{background:var(--cog)}.goal-card.emo::before{background:var(--emo)}.goal-card.soc::before{background:var(--soc)}.goal-card.neu::before{background:var(--text3)}
.goal-check{width:22px;height:22px;border-radius:7px;border:2px solid #d1d5db;display:flex;align-items:center;justify-content:center;flex-shrink:0;cursor:pointer;transition:all .15s}
.goal-check:hover{border-color:var(--success);background:rgba(16,185,129,.1)}
.goal-body{flex:1;min-width:0}
.goal-title{font-weight:700;font-size:.8rem;line-height:1.3;margin-bottom:3px}
.goal-card.cog .goal-title{color:#1e40af}.goal-card.emo .goal-title{color:#be123c}.goal-card.soc .goal-title{color:#6d28d9}
.goal-meta{display:flex;align-items:center;gap:6px;font-size:.65rem;color:var(--text3);flex-wrap:wrap}
.goal-badge{padding:2px 7px;border-radius:5px;font-weight:700;font-size:.55rem;text-transform:uppercase;letter-spacing:.3px;background:var(--bg)}
.goal-time{font-weight:700;margin-left:auto}.goal-time.urgent{color:var(--emo)}.goal-time.ok{color:var(--success)}
.goal-card.done{opacity:.45}.goal-card.done .goal-title{text-decoration:line-through;color:var(--text2)}
.goal-card.done .goal-check{background:var(--success);border-color:var(--success);color:#fff}
.toggle-history{font-size:.7rem;font-weight:700;color:var(--primary);cursor:pointer;padding:6px 0}
.empty-msg{text-align:center;color:var(--text3);font-size:.8rem;font-style:italic;padding:24px 0}
.fab{position:fixed;bottom:24px;left:50%;transform:translateX(-50%);width:64px;height:64px;border-radius:50%;background:linear-gradient(135deg,var(--primary),var(--soc));color:#fff;border:none;font-size:1.8rem;font-weight:300;cursor:pointer;box-shadow:0 6px 24px rgba(99,102,241,.4);z-index:50;display:flex;align-items:center;justify-content:center;transition:all .2s var(--ease)}
.fab:hover{transform:translateX(-50%) scale(1.08)}.fab:active{transform:translateX(-50%) scale(.95)}
.overlay{position:fixed;inset:0;z-index:200;background:var(--bg);display:none;flex-direction:column;overflow:hidden}
.overlay.show{display:flex}
.overlay-header{padding:14px 20px;background:var(--surface);border-bottom:1px solid var(--border);display:flex;align-items:center;justify-content:space-between;flex-shrink:0;z-index:10}
.overlay-title{font-weight:800;font-size:.95rem}
.overlay-close{width:36px;height:36px;border-radius:10px;border:none;background:var(--bg);cursor:pointer;font-size:1rem;display:flex;align-items:center;justify-content:center}
.overlay-body{flex:1;overflow-y:auto;padding:20px}
.oc{max-width:480px;margin:0 auto}
.wiz-title{font-size:1rem;font-weight:800;margin-bottom:14px}
.wiz-option{width:100%;text-align:left;padding:13px 16px;margin-bottom:8px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);font-family:var(--font);font-weight:600;font-size:.8rem;color:var(--text);cursor:pointer;transition:all .15s}
.wiz-option:hover{border-color:var(--primary);background:var(--primary-light)}
.wiz-back{display:inline-flex;align-items:center;gap:4px;font-size:.75rem;font-weight:700;color:var(--text2);cursor:pointer;margin-bottom:14px;background:none;border:none;font-family:var(--font)}
.wiz-search{width:100%;padding:11px 14px;border:1px solid var(--border);border-radius:var(--radius-sm);font-family:var(--font);font-size:.8rem;margin-bottom:14px;outline:none}
.wiz-search:focus{border-color:var(--primary);box-shadow:0 0 0 3px rgba(99,102,241,.08)}
.wiz-section-h{font-size:.65rem;font-weight:800;text-transform:uppercase;letter-spacing:.8px;color:var(--text3);margin:14px 0 8px}
.wiz-chip{display:inline-flex;align-items:center;gap:8px;padding:9px 14px;border-radius:999px;background:var(--surface);border:1px solid var(--border);font-weight:600;font-size:.78rem;cursor:pointer;transition:all .15s;margin:0 5px 7px 0}
.wiz-chip:hover{border-color:var(--primary);box-shadow:var(--shadow)}
.wiz-chip .dot{width:9px;height:9px;border-radius:50%;flex-shrink:0}
.wiz-summary{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px;margin-bottom:14px}
.wiz-summary .ws-row{display:flex;justify-content:space-between;padding:5px 0;font-size:.78rem}
.wiz-summary .ws-label{font-weight:700;color:var(--text3)}
.wiz-summary .ws-value{font-weight:600;text-align:right;max-width:60%}
.wiz-confirm{width:100%;padding:14px;background:var(--primary);color:#fff;border:none;border-radius:var(--radius-sm);font-family:var(--font);font-weight:800;font-size:.85rem;cursor:pointer}
.wiz-confirm:hover{background:#4f46e5}
.wiz-switch{display:flex;gap:0;background:var(--bg);border-radius:var(--radius-sm);padding:3px;margin-bottom:14px}
.wiz-switch-btn{flex:1;padding:8px;border:none;border-radius:9px;font-family:var(--font);font-size:.7rem;font-weight:700;cursor:pointer;background:transparent;color:var(--text2);transition:all .15s}
.wiz-switch-btn.active{background:var(--surface);color:var(--primary);box-shadow:0 1px 3px rgba(0,0,0,.08)}
.mood-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px}
.mood-primary-btn{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px 8px;text-align:center;cursor:pointer;transition:all .15s;font-family:var(--font)}
.mood-primary-btn:hover{border-color:var(--primary);transform:translateY(-2px);box-shadow:var(--shadow)}
.mood-primary-btn .mp-emoji{font-size:1.8rem;margin-bottom:4px}
.mood-primary-btn .mp-label{font-size:.7rem;font-weight:700}
.mood-chips{display:flex;flex-wrap:wrap;gap:8px}
.mood-chip-btn{padding:10px 16px;background:var(--surface);border:1px solid var(--border);border-radius:999px;font-family:var(--font);font-size:.8rem;font-weight:600;cursor:pointer;transition:all .12s}
.mood-chip-btn:hover{border-color:var(--primary);background:var(--primary-light);color:var(--primary)}
.breath-screen{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;padding:40px;text-align:center;background:linear-gradient(180deg,#f0f0ff 0%,var(--bg) 100%)}
.breath-bubble{width:180px;height:180px;border-radius:50%;background:radial-gradient(circle at 40% 35%,rgba(99,102,241,.12),rgba(139,92,246,.08));border:3px solid rgba(99,102,241,.25);display:flex;align-items:center;justify-content:center;transition:all 5s ease-in-out;margin-bottom:32px}
.breath-bubble.inhale{width:260px;height:260px;border-color:rgba(59,130,246,.4)}
.breath-bubble.exhale{width:160px;height:160px;border-color:rgba(139,92,246,.3)}
.breath-word{font-size:1.1rem;font-weight:700;color:var(--primary);letter-spacing:.5px}
.breath-info{font-size:.8rem;color:var(--text3);margin-bottom:28px}
.breath-close{background:var(--surface);border:1px solid var(--border);padding:10px 28px;border-radius:999px;font-family:var(--font);font-weight:700;font-size:.8rem;cursor:pointer}
.mission-header{padding:16px;border-radius:var(--radius);margin-bottom:14px}
.mission-header.cog{background:linear-gradient(135deg,rgba(59,130,246,.08),rgba(59,130,246,.02))}.mission-header.emo{background:linear-gradient(135deg,rgba(244,63,94,.08),rgba(244,63,94,.02))}.mission-header.soc{background:linear-gradient(135deg,rgba(139,92,246,.08),rgba(139,92,246,.02))}.mission-header.neu{background:var(--bg)}
.mission-cadre{display:inline-flex;align-items:center;gap:6px;font-size:.68rem;font-weight:800;text-transform:uppercase;letter-spacing:.8px;color:var(--text3);margin-bottom:8px}
.mission-titre{font-weight:800;font-size:1.05rem;line-height:1.35;margin-bottom:6px}
.mission-cps{font-size:.78rem;color:var(--text2);font-weight:600}
.mission-status{display:inline-flex;align-items:center;gap:4px;padding:4px 10px;border-radius:999px;font-size:.68rem;font-weight:700;margin-top:8px}
.mission-status.en-cours{background:rgba(245,158,11,.1);color:var(--warn)}.mission-status.valide{background:rgba(16,185,129,.1);color:var(--success)}
.mission-block{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:14px 16px;margin-bottom:10px}
.mission-block-title{font-size:.6rem;font-weight:800;text-transform:uppercase;letter-spacing:.8px;color:var(--text3);margin-bottom:8px}
.mb-row{display:flex;align-items:center;gap:8px;padding:5px 0;font-size:.8rem}
.mb-row .mb-icon{font-size:1rem;width:22px;text-align:center;flex-shrink:0}
.mb-row .mb-label{color:var(--text2);font-weight:600;min-width:55px}
.mb-row .mb-val{font-weight:700;flex:1}
.mission-timeline{display:flex;align-items:center;gap:10px;padding:6px 0}
.tl-bar{flex:1;height:6px;background:#e2e8f0;border-radius:3px;overflow:hidden}
.tl-fill{height:100%;border-radius:3px;transition:width .5s var(--ease)}
.tl-days{font-size:.72rem;font-weight:800;white-space:nowrap}
.mission-cps-link{width:100%;padding:11px 14px;background:var(--primary-light);border:1px solid rgba(99,102,241,.15);border-radius:var(--radius-sm);font-family:var(--font);font-weight:700;font-size:.78rem;color:var(--primary);cursor:pointer;display:flex;align-items:center;gap:8px;margin-bottom:10px;transition:all .15s}
.mission-cps-link:hover{background:rgba(99,102,241,.12)}
.mission-history{font-size:.72rem;color:var(--text3);line-height:1.8}
.mh-entry{display:flex;gap:8px;align-items:flex-start}
.mh-dot{width:6px;height:6px;border-radius:50%;background:var(--text3);margin-top:6px;flex-shrink:0}
.mh-text{flex:1}
.mission-actions{display:flex;flex-direction:column;gap:8px;margin-top:14px}
.btn-mission{width:100%;padding:12px;border:none;border-radius:var(--radius-sm);font-family:var(--font);font-weight:700;font-size:.8rem;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:6px}
.btn-mission.primary{background:var(--primary);color:#fff}
.btn-mission.outline{background:transparent;border:2px dashed rgba(99,102,241,.3);color:var(--primary)}
.btn-mission.danger{background:transparent;border:1px solid rgba(239,68,68,.2);color:var(--emo);font-size:.72rem}
.btn-mission.success{background:var(--success);color:#fff}
.cps-space-hero{text-align:center;padding:20px;border-radius:var(--radius);margin-bottom:16px}
.cps-space-hero.cog{background:linear-gradient(135deg,rgba(59,130,246,.08),rgba(59,130,246,.02))}.cps-space-hero.emo{background:linear-gradient(135deg,rgba(244,63,94,.08),rgba(244,63,94,.02))}.cps-space-hero.soc{background:linear-gradient(135deg,rgba(139,92,246,.08),rgba(139,92,246,.02))}
.cps-space-emoji{font-size:2.5rem;margin-bottom:6px}
.cps-space-name{font-weight:800;font-size:1.05rem;margin-bottom:2px}
.cps-space-sub{font-size:.75rem;color:var(--text2)}
.cps-space-stats{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-bottom:16px}
.cps-stat{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px;text-align:center}
.cps-stat-val{font-weight:800;font-size:1.3rem}
.cps-stat-lbl{font-size:.62rem;font-weight:700;text-transform:uppercase;letter-spacing:.5px;color:var(--text3);margin-top:2px}
.cps-space-section{margin-bottom:16px}
.cps-space-section h4{font-size:.68rem;font-weight:800;text-transform:uppercase;letter-spacing:.8px;color:var(--text3);margin-bottom:8px}
.cps-comp-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px 14px;margin-bottom:6px;cursor:pointer;transition:all .15s}
.cps-comp-card:hover{box-shadow:var(--shadow)}
.cps-comp-title{font-weight:700;font-size:.82rem;margin-bottom:2px}
.cps-comp-gen{font-size:.68rem;color:var(--text3)}
.cps-formation-btn{width:100%;padding:14px;background:linear-gradient(135deg,var(--primary),var(--soc));color:#fff;border:none;border-radius:var(--radius-sm);font-family:var(--font);font-weight:800;font-size:.85rem;cursor:pointer;display:flex;align-items:center;justify-content:center;gap:8px;margin-top:6px}
.formation-block{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px;margin-bottom:12px}
.formation-block h4{font-size:.85rem;font-weight:800;margin-bottom:8px;display:flex;align-items:center;gap:8px}
.formation-block p{font-size:.8rem;color:var(--text2);line-height:1.6}
.formation-tag{display:inline-flex;padding:4px 10px;border-radius:6px;font-size:.68rem;font-weight:700;margin:0 4px 4px 0}
.stage-lieu{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:12px 14px;margin-bottom:6px;display:flex;align-items:center;justify-content:space-between}
.stage-lieu-name{font-weight:700;font-size:.8rem}
.stage-lieu-meta{font-size:.68rem;color:var(--text3)}
.qr-center{display:flex;flex-direction:column;align-items:center;justify-content:center;height:100%;text-align:center;padding:40px}
.qr-center h3{font-size:1rem;font-weight:800;margin-bottom:18px}
#qrcode-container{display:flex;justify-content:center;padding:14px;background:var(--surface);border-radius:var(--radius);box-shadow:var(--shadow)}
.qr-center p{font-size:.78rem;color:var(--text2);margin-top:14px}
.attest-radar{max-width:260px;margin:0 auto 20px}
.attest-card{background:var(--surface);border-radius:var(--radius);padding:18px;margin-bottom:10px;border-left:4px solid}
.attest-card.cog{border-left-color:var(--cog)}.attest-card.emo{border-left-color:var(--emo)}.attest-card.soc{border-left-color:var(--soc)}
.attest-card h4{font-size:.85rem;font-weight:800;margin-bottom:4px}
.attest-card p{font-size:.78rem;color:var(--text2);line-height:1.5}
.reco-choice{display:flex;flex-direction:column;gap:10px;margin-top:16px}
.reco-card{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius-sm);padding:16px 18px;display:flex;align-items:center;gap:14px;cursor:pointer;transition:all .15s;font-family:var(--font)}
.reco-card:hover{box-shadow:var(--shadow-lg);transform:translateY(-2px)}
.rc-icon{width:42px;height:42px;border-radius:12px;display:flex;align-items:center;justify-content:center;font-size:1.3rem;flex-shrink:0}
.rc-text{font-weight:700;font-size:.85rem}.rc-sub{font-size:.7rem;color:var(--text3);margin-top:2px}
.fi{width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;font-family:var(--font);font-size:.82rem;margin-bottom:8px;outline:none}
.hidden{display:none!important}
</style>
</head>
<body>

<!-- ‚ïê‚ïê‚ïê WELCOME SCREEN (instant, zero Firebase) ‚ïê‚ïê‚ïê -->
<div class="welcome-screen" id="welcome">
  <div class="welcome-content">
    <div class="welcome-logo">‚óà</div>
    <h1 class="welcome-brand">mon<span>objectif</span>.fr</h1>
    <p class="welcome-sub">Bienvenue sur ton espace personnel</p>
    <div class="welcome-form">
      <input type="text" class="welcome-input" id="code-input" placeholder="Entre ton code" maxlength="8" autocomplete="off" spellcheck="false" autofocus>
      <button class="welcome-btn" id="code-btn" onclick="submitCode()">Acc√©der √† mon espace</button>
    </div>
    <p class="welcome-error" id="welcome-error"></p>
    <p class="welcome-footer">Espace s√©curis√© ¬∑ Code fourni par ton enseignant</p>
  </div>
</div>

<!-- ‚ïê‚ïê‚ïê DENIED SCREEN (dynamic messages) ‚ïê‚ïê‚ïê -->
<div class="denied-screen" id="access-denied">
  <div class="denied-icon" id="denied-icon">‚è≥</div>
  <h2 id="denied-title">Ton espace n'est pas encore actif</h2>
  <p id="denied-msg">Ton enseignant doit d'abord activer ton acc√®s.</p>
  <button class="denied-retry" onclick="backToWelcome()">‚Üê R√©essayer</button>
</div>

<!-- ‚ïê‚ïê‚ïê APP ‚ïê‚ïê‚ïê -->
<div id="app" style="display:none">
  <header class="app-header"><div class="header-left"><div class="h-code" id="display-code">‚Äî</div><div class="h-date" id="h-date"></div></div><button class="header-btn" onclick="openBreathing()">üå¨ Respiration</button></header>
  <div class="app-content"><div class="app-container">
    <div class="mood-box" id="mood-box" style="display:none"><div class="mood-left"><span class="mood-emoji" id="mood-emoji">üòä</span><div><div class="mood-text">Humeur du jour</div><div class="mood-value" id="mood-value">‚Äî</div></div></div><button class="mood-btn" onclick="openMood()">Changer</button></div>
    <div class="cps-box"><div class="cps-box-title">Comp√©tences Psychosociales</div><div class="cps-grid">
      <div class="cps-card cog" onclick="openCpsSpace('COG')"><div class="cps-ring" id="ring-cog" style="--ring-color:var(--cog);--pct:0"><span class="cps-ring-value" id="val-cog">0</span></div><div class="cps-label">Cognitif</div></div>
      <div class="cps-card emo" onclick="openCpsSpace('EMO')"><div class="cps-ring" id="ring-emo" style="--ring-color:var(--emo);--pct:0"><span class="cps-ring-value" id="val-emo">0</span></div><div class="cps-label">√âmotionnel</div></div>
      <div class="cps-card soc" onclick="openCpsSpace('SOC')"><div class="cps-ring" id="ring-soc" style="--ring-color:var(--soc);--pct:0"><span class="cps-ring-value" id="val-soc">0</span></div><div class="cps-label">Social</div></div>
    </div><hr class="cps-divider"><button class="synthese-btn" onclick="openAttestation()">üìÑ Synth√®se</button></div>
    <button class="reco-btn" onclick="openReco()"><div class="reco-icon">üèÖ</div><div><div class="reco-text">Demande de reconnaissance</div><div class="reco-sub">Faire valider une r√©ussite par un adulte</div></div></button>
    <div class="section-title">Objectifs en cours <span id="goals-count"></span></div>
    <div id="goals-list"></div>
    <div id="history-section" style="display:none;margin-top:12px"><div class="toggle-history" onclick="toggleHistory()"><span id="history-toggle-text">Voir les objectifs atteints ‚ñº</span></div><div id="history-list" class="hidden"></div></div>
  </div></div>
  <button class="fab" onclick="startWizard()">+</button>
</div>
<div class="overlay" id="wizard-overlay"><div class="overlay-header"><span class="overlay-title">Nouvel Objectif</span><button class="overlay-close" onclick="closeOv('wizard-overlay')">‚úï</button></div><div class="overlay-body"><div class="oc" id="wizard-content"></div></div></div>
<div class="overlay" id="mood-overlay"><div class="overlay-header"><span class="overlay-title">M√©t√©o du jour</span><button class="overlay-close" onclick="closeOv('mood-overlay')">‚úï</button></div><div class="overlay-body"><div class="oc" id="mood-content"></div></div></div>
<div class="overlay" id="breath-overlay"><div class="breath-screen"><div class="breath-bubble" id="breath-bubble"><span class="breath-word" id="breath-word">Pr√™t</span></div><div class="breath-info">Inspire par le nez, expire par la bouche</div><button class="breath-close" onclick="stopBreathing()">Fermer</button></div></div>
<div class="overlay" id="detail-overlay"><div class="overlay-header"><span class="overlay-title">Mon objectif</span><button class="overlay-close" onclick="closeOv('detail-overlay')">‚úï</button></div><div class="overlay-body"><div class="oc" id="detail-content"></div></div></div>
<div class="overlay" id="cps-overlay"><div class="overlay-header"><span class="overlay-title" id="cps-space-title">‚Äî</span><button class="overlay-close" onclick="closeOv('cps-overlay')">‚úï</button></div><div class="overlay-body"><div class="oc" id="cps-space-content"></div></div></div>
<div class="overlay" id="formation-overlay"><div class="overlay-header"><span class="overlay-title" id="formation-title">Explorer</span><button class="overlay-close" onclick="closeOv('formation-overlay')">‚úï</button></div><div class="overlay-body"><div class="oc" id="formation-content"></div></div></div>
<div class="overlay" id="qr-overlay"><div class="qr-center"><h3>Faire valider</h3><div id="qrcode-container"></div><p>Pr√©sente ce code √† l'adulte.</p><button class="breath-close" style="margin-top:18px" onclick="closeOv('qr-overlay')">Fermer</button></div></div>
<div class="overlay" id="reco-overlay"><div class="overlay-header"><span class="overlay-title">Reconnaissance</span><button class="overlay-close" onclick="closeOv('reco-overlay')">‚úï</button></div><div class="overlay-body"><div class="oc"><p style="font-size:.82rem;color:var(--text2);text-align:center;margin-bottom:8px">Quel type de r√©ussite ?</p><div class="reco-choice">
  <div class="reco-card" onclick="genRecoQR('COG')"><div class="rc-icon" style="background:rgba(59,130,246,.1)">üß†</div><div><div class="rc-text" style="color:var(--cog)">Cognitif</div><div class="rc-sub">R√©flexion, analyse, d√©cision</div></div></div>
  <div class="reco-card" onclick="genRecoQR('EMO')"><div class="rc-icon" style="background:rgba(244,63,94,.1)">‚ù§Ô∏è</div><div><div class="rc-text" style="color:var(--emo)">√âmotionnel</div><div class="rc-sub">Gestion des √©motions, stress</div></div></div>
  <div class="reco-card" onclick="genRecoQR('SOC')"><div class="rc-icon" style="background:rgba(139,92,246,.1)">ü§ù</div><div><div class="rc-text" style="color:var(--soc)">Social</div><div class="rc-sub">Communication, entraide</div></div></div>
</div></div></div></div>
<div class="overlay" id="attest-overlay"><div class="overlay-header"><span class="overlay-title">Synth√®se</span><button class="overlay-close" onclick="closeOv('attest-overlay')">‚úï</button></div><div class="overlay-body"><div class="oc">
  <h3 style="text-align:center;font-weight:800;margin-bottom:20px;font-size:1rem">Mon profil de comp√©tences</h3>
  <div class="attest-radar"><canvas id="attest-radar"></canvas></div>
  <div class="attest-card cog"><h4 style="color:var(--cog)">üß† Cognitif</h4><p id="syn-cog">‚Äî</p></div>
  <div class="attest-card emo"><h4 style="color:var(--emo)">‚ù§Ô∏è √âmotionnel</h4><p id="syn-emo">‚Äî</p></div>
  <div class="attest-card soc"><h4 style="color:var(--soc)">ü§ù Social</h4><p id="syn-soc">‚Äî</p></div>
</div></div></div>
<script>
const firebaseConfig={apiKey:"AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0IQcLI",authDomain:"devoirs-pse.firebaseapp.com",databaseURL:"https://devoirs-pse-default-rtdb.europe-west1.firebasedatabase.app",projectId:"devoirs-pse",storageBucket:"devoirs-pse.appspot.com",messagingSenderId:"614730413904",appId:"1:614730413904:web:a5dd478af5de30f6bede55"};
firebase.initializeApp(firebaseConfig);const db=firebase.database();
let userCode=null;
let userData={objectifs:{},meteo:{}},draft={},currentEditId=null,breathInterval=null,attestChart=null,contextData={},wizMode='competence';
const MATIERES=["Fran√ßais","Math√©matiques","Anglais LV1","Espagnol LV2","Histoire-G√©ographie / EMC","√âconomie-Droit","Enseignement professionnel","Pr√©vention Sant√© Environnement","PSE","Arts appliqu√©s","EPS","DNL","Soutien au parcours","Professeur absent","Projet","Sortie","Travail personnel"];
const EMOTIONS={"Joie":{emoji:"üòä",subs:["√Ä l'aise","Amoureux","Content","Excit√©","Satisfait","Serein","Enjou√©","Enthousiaste"]},"Tristesse":{emoji:"üò¢",subs:["Abattu","Accabl√©","Affect√©","Afflig√©","An√©anti","Bless√©","Chagrin√©","M√©lancolique"]},"Col√®re":{emoji:"üò†",subs:["Agac√©","Agit√©","Agressif","Contrari√©","Enrag√©","Furieux","Haineux"]},"Peur":{emoji:"üò∞",subs:["Angoiss√©","Anxieux","Craintif","Effray√©","M√©fiant","Ins√©cure","Ind√©cis","Inquiet"]},"Surprise":{emoji:"üò≤",subs:["√âbahi","√âtonn√©","√âmerveill√©","Troubl√©","Ins√©cure","Secou√©","Stup√©fait"]},"D√©go√ªt":{emoji:"üòñ",subs:["Aigri","Amer","Antipathique","Aversion","Bless√©","√âc≈ìur√©","M√©pris"]}};
const AX={COG:{emoji:'üß†',label:'Cognitif',color:'var(--cog)',cls:'cog',desc:'R√©flexion, analyse, prise de d√©cision, pens√©e critique'},EMO:{emoji:'‚ù§Ô∏è',label:'√âmotionnel',color:'var(--emo)',cls:'emo',desc:'Gestion des √©motions, du stress, conscience √©motionnelle'},SOC:{emoji:'ü§ù',label:'Social',color:'var(--soc)',cls:'soc',desc:'Communication, coop√©ration, r√©solution de conflits'}};
const CTX_FILES={Scolaire:'scolaire.json',PFMP:'pfmp_stage.json',Recherche:'recherche_stage.json',Autre:'autre.json'};
function getAx(g){const t=(g.type||g.domaine||'').toUpperCase();return t.includes('COG')?'COG':t.includes('EMO')?'EMO':t.includes('SOC')?'SOC':'NEU'}
function axCls(a){return a==='COG'?'cog':a==='EMO'?'emo':a==='SOC'?'soc':'neu'}
function domainLabel(s){return AX[s]?.label||'Autre'}
function domainColor(s){return s==='COG'?'#3b82f6':s==='EMO'?'#f43f5e':s==='SOC'?'#8b5cf6':'#94a3b8'}
function domainKey(k){return k.includes('cognitif')?'COG':k.includes('emotionnel')?'EMO':k.includes('social')?'SOC':'NEU'}
function dateFr(d){if(!d)return'‚Äî';return new Date(d).toLocaleDateString('fr-FR',{day:'numeric',month:'short',year:'numeric'})}
function daysLeft(d){if(!d)return null;const t=new Date();t.setHours(0,0,0,0);const x=new Date(d);x.setHours(0,0,0,0);return Math.ceil((x-t)/864e5)}
function closeOv(id){document.getElementById(id).classList.remove('show')}
async function loadContext(key){if(contextData[key])return contextData[key];try{const r=await fetch('data/bibliotheque/'+(CTX_FILES[key]||'autre.json'),{cache:'no-store'});contextData[key]=await r.json();return contextData[key]}catch(e){return null}}
function addHistory(k,action){db.ref('accompagnement/eleves/'+userCode+'/objectifs/'+k+'/historique').push({action,date:new Date().toISOString()})}
function renderHistory(g){const h=g.historique?Object.values(g.historique).sort((a,b)=>new Date(b.date)-new Date(a.date)):[];const entries=[{action:'Cr√©√©',date:g.created||''},...h];return entries.map(e=>'<div class="mh-entry"><span class="mh-dot"></span><span class="mh-text">'+dateFr(e.date)+' ‚Äî '+e.action+'</span></div>').join('')}

// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
// INIT ‚Äî Welcome screen (zero Firebase)
// ‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê
var authListener=null;
window.addEventListener('load',function(){
  var now=new Date();var jours=['Dimanche','Lundi','Mardi','Mercredi','Jeudi','Vendredi','Samedi'];var mois=['janvier','f√©vrier','mars','avril','mai','juin','juillet','ao√ªt','septembre','octobre','novembre','d√©cembre'];
  document.getElementById('h-date').textContent=jours[now.getDay()]+' '+now.getDate()+' '+mois[now.getMonth()];
  // Enter key on code input
  document.getElementById('code-input').addEventListener('keydown',function(e){if(e.key==='Enter')submitCode()});
  // Backward compat: auto-submit if ?id= in URL
  var urlCode=new URLSearchParams(window.location.search).get('id');
  if(urlCode){
    document.getElementById('code-input').value=urlCode;
    submitCode();
  }
});

function submitCode(){
  var input=document.getElementById('code-input');
  var btn=document.getElementById('code-btn');
  var err=document.getElementById('welcome-error');
  var code=input.value.trim().toUpperCase();
  if(!code||code.length<2){err.textContent='Entre ton code pour continuer.';return}
  // Loading state
  err.textContent='';
  btn.disabled=true;
  btn.innerHTML='<span class="btn-spinner"></span> V√©rification‚Ä¶';
  // Check authorization in Firebase
  db.ref('accompagnement/autorisations/'+code).once('value',function(snap){
    var auth=snap.val();
    if(!auth||auth.autorise!==true){
      btn.disabled=false;btn.textContent='Acc√©der √† mon espace';
      if(!auth){showDenied('unknown')}else{showDenied('not-authorized')}
      return;
    }
    // Authorized ‚Äî now check schedule
    checkSchedule(code,auth,function(allowed){
      if(!allowed){
        btn.disabled=false;btn.textContent='Acc√©der √† mon espace';
        showDenied('outside-hours');
        return;
      }
      // SUCCESS ‚Äî grant access
      userCode=code;
      window.history.replaceState({},'','?id='+code);
      document.getElementById('welcome').style.display='none';
      document.getElementById('access-denied').style.display='none';
      document.getElementById('display-code').textContent=code;
      showApp();
      loadData();
      // Real-time listener for ongoing auth changes
      if(authListener)db.ref('accompagnement/autorisations/'+code).off('value',authListener);
      authListener=db.ref('accompagnement/autorisations/'+code).on('value',function(s){
        var d=s.val();
        if(!d||d.autorise!==true){
          document.getElementById('app').style.display='none';
          showDenied('not-authorized');
        }
      });
    });
  });
}

function checkSchedule(code,auth,callback){
  // Individual schedule takes priority
  if(auth.horaires){callback(isWithinSchedule(auth.horaires));return}
  // Otherwise check global schedule
  db.ref('accompagnement/config/horaires_global').once('value',function(snap){
    var global=snap.val();
    if(!global){callback(true);return}// No schedule = always allowed
    callback(isWithinSchedule(global));
  });
}

function isWithinSchedule(horaires){
  var joursRef=['dimanche','lundi','mardi','mercredi','jeudi','vendredi','samedi'];
  var now=new Date();
  var jour=joursRef[now.getDay()];
  var schedule=horaires[jour];
  if(!schedule||!schedule.actif)return false;
  var currentMinutes=now.getHours()*60+now.getMinutes();
  var parts=schedule.debut.split(':');
  var debutMinutes=parseInt(parts[0])*60+parseInt(parts[1]);
  parts=schedule.fin.split(':');
  var finMinutes=parseInt(parts[0])*60+parseInt(parts[1]);
  return currentMinutes>=debutMinutes&&currentMinutes<=finMinutes;
}

function showDenied(reason){
  var icon=document.getElementById('denied-icon');
  var title=document.getElementById('denied-title');
  var msg=document.getElementById('denied-msg');
  if(reason==='unknown'){
    icon.textContent='üîç';
    title.textContent='Code non reconnu';
    msg.textContent='V√©rifie ton code et r√©essaie. Il t\u2019a √©t√© donn√© par ton enseignant.';
  }else if(reason==='outside-hours'){
    icon.textContent='üïê';
    title.textContent='Acc√®s ferm√© pour le moment';
    msg.textContent='L\u2019espace est disponible uniquement pendant les horaires d√©finis par ton enseignant. Reviens plus tard\u00a0!';
  }else{
    icon.textContent='‚è≥';
    title.textContent='Ton espace n\u2019est pas encore actif';
    msg.textContent='Ton enseignant doit d\u2019abord activer ton acc√®s.';
  }
  document.getElementById('welcome').style.display='none';
  document.getElementById('access-denied').style.display='flex';
}

function backToWelcome(){
  document.getElementById('access-denied').style.display='none';
  document.getElementById('welcome').style.display='flex';
  document.getElementById('code-input').value='';
  document.getElementById('code-input').focus();
  document.getElementById('welcome-error').textContent='';
  // Clear ?id= from URL
  window.history.replaceState({},'',window.location.pathname);
}

function showApp(){var a=document.getElementById('app');a.style.display='flex';a.style.flexDirection='column';a.style.height='100vh'}
function loadData(){db.ref('accompagnement/eleves/'+userCode).on('value',function(snap){userData=snap.val()||{};if(!userData.objectifs)userData.objectifs={};if(!userData.meteo)userData.meteo={};render();checkMood()})}

// DASHBOARD
function render(){
  var goals=userData.objectifs||{},keys=Object.keys(goals);
  var counts={COG:0,EMO:0,SOC:0},totals={COG:0,EMO:0,SOC:0};var active=[],done=[];
  keys.forEach(function(k){var g=goals[k],ax=getAx(g);if(ax!=='NEU')totals[ax]++;if(g.done){if(ax!=='NEU')counts[ax]++;done.push(Object.assign({k:k},g))}else{active.push(Object.assign({k:k},g))}});
  active.sort(function(a,b){return new Date(a.date_cible||'2099-01-01')-new Date(b.date_cible||'2099-01-01')});
  ['COG','EMO','SOC'].forEach(function(ax){var total=Math.max(totals[ax],1);var pct=Math.round((counts[ax]/total)*100);var ring=document.getElementById('ring-'+ax.toLowerCase());var val=document.getElementById('val-'+ax.toLowerCase());if(ring)ring.style.setProperty('--pct',pct);if(val)val.textContent=counts[ax]});
  document.getElementById('goals-count').textContent=active.length?'('+active.length+')':'';
  var listEl=document.getElementById('goals-list');
  if(!active.length){listEl.innerHTML='<div class="empty-msg">Aucun objectif ‚Äî appuie sur + pour commencer</div>'}
  else{listEl.innerHTML=active.map(function(g){var cls=axCls(getAx(g));var dl=daysLeft(g.date_cible);var timeStr='',urgCls='';if(dl!==null){if(dl<0){timeStr='D√©pass√©';urgCls='urgent'}else if(dl===0)timeStr="Aujourd'hui";else{timeStr='J-'+dl;urgCls=dl<=3?'urgent':'ok'}}
    return '<div class="goal-card '+cls+'" onclick="openDetail(\''+g.k+'\')"><div class="goal-check" onclick="event.stopPropagation();markDone(\''+g.k+'\')"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="#d1d5db" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div><div class="goal-body"><div class="goal-title">'+((g.titre||'Sans titre'))+'</div><div class="goal-meta"><span class="goal-badge">'+(g.context||'Autre')+'</span><span>'+(g.detail||'')+'</span>'+(timeStr?'<span class="goal-time '+urgCls+'">'+timeStr+'</span>':'')+'</div></div></div>'}).join('')}
  var histEl=document.getElementById('history-list');
  if(!done.length){histEl.innerHTML='<div class="empty-msg">Rien encore</div>'}
  else{histEl.innerHTML=done.map(function(g){var cls=axCls(getAx(g));return '<div class="goal-card done '+cls+'"><div class="goal-check"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="3"><path d="M20 6L9 17l-5-5"/></svg></div><div class="goal-body"><div class="goal-title">'+(g.titre||'')+'</div><div class="goal-meta"><span>Valid√© le '+dateFr(g.date_done)+'</span></div></div></div>'}).join('')}
  document.getElementById('history-section').style.display=done.length?'block':'none';
}
window.markDone=function(k){if(confirm("Objectif atteint ? üéâ")){db.ref('accompagnement/eleves/'+userCode+'/objectifs/'+k).update({done:true,date_done:new Date().toISOString()});addHistory(k,'Marqu√© comme atteint')}}
function toggleHistory(){var el=document.getElementById('history-list');el.classList.toggle('hidden');document.getElementById('history-toggle-text').textContent=el.classList.contains('hidden')?'Voir les objectifs atteints ‚ñº':'Masquer ‚ñ≤'}

// DETAIL ‚Äî MISSION CARD
window.openDetail=function(k){
  currentEditId=k;var g=userData.objectifs[k];if(!g)return;
  var ax=getAx(g),cls=axCls(ax),meta=AX[ax]||{emoji:'üìã',label:'Autre',color:'var(--text3)'};
  var dl=daysLeft(g.date_cible),created=new Date(g.created||Date.now()),target=g.date_cible?new Date(g.date_cible):null;
  var pct=0;if(target){var total=Math.max((target-created)/864e5,1);var elapsed=Math.max((new Date()-created)/864e5,0);pct=Math.min(Math.round((elapsed/total)*100),100)}
  var statusTxt=g.done?'Valid√©':'En cours',statusCls=g.done?'valide':'en-cours';
  var timeColor=domainColor(ax);if(dl!==null&&dl<=3&&!g.done)timeColor='var(--emo)';
  var tlHtml='';
  if(dl!==null&&!g.done){var lbl=dl<0?'D√©pass√© de '+Math.abs(dl)+' j':dl===0?"Aujourd'hui":'J-'+dl;tlHtml='<div class="mission-timeline"><div class="tl-bar"><div class="tl-fill" style="width:'+pct+'%;background:'+timeColor+'"></div></div><div class="tl-days" style="color:'+timeColor+'">'+lbl+'</div></div>'}
  var cadreIcon=g.context==='Scolaire'?'üìö':g.context==='PFMP'?'üè¢':g.context==='Recherche'?'üîç':'‚úèÔ∏è';
  var isStage=g.context==='Recherche';
  var matSelect='';
  if(g.context==='Scolaire'){matSelect='<select class="fi" id="det-context">'+MATIERES.map(function(m){return '<option value="'+m+'"'+(m===g.detail?' selected':'')+'>'+m+'</option>'}).join('')+'<option value="__autre"'+(MATIERES.indexOf(g.detail)===-1?' selected':'')+'>Autre‚Ä¶</option></select>'}
  else{matSelect='<input type="text" class="fi" id="det-context" value="'+(g.detail||'')+'">'}
  var c=document.getElementById('detail-content');
  c.innerHTML='<div class="mission-header '+cls+'"><div class="mission-cadre">'+cadreIcon+' '+(g.context||'Autre')+'</div><div class="mission-titre">'+(g.titre||'Sans titre')+'</div><div class="mission-cps">'+(meta.emoji||'')+' '+(g.spe_label||'Objectif libre')+(g.gen_label?' ¬∑ '+g.gen_label:'')+'</div><span class="mission-status '+statusCls+'">'+(statusCls==='valide'?'‚úÖ':'‚è≥')+' '+statusTxt+'</span></div>'
    +'<div class="mission-block"><div class="mission-block-title">Contexte</div><div class="mb-row"><span class="mb-icon">üìÖ</span><span class="mb-label">√âch√©ance</span><span class="mb-val">'+dateFr(g.date_cible)+'</span></div><div class="mb-row"><span class="mb-icon">üìç</span><span class="mb-label">'+(g.context==='Scolaire'?'Mati√®re':'Lieu')+'</span><span class="mb-val">'+(g.detail||'Non pr√©cis√©')+'</span></div><div class="mb-row"><span class="mb-icon">üß≠</span><span class="mb-label">Axe</span><span class="mb-val" style="color:'+domainColor(ax)+'">'+(meta.label||'')+'</span></div>'+tlHtml+'</div>'
    +(g.spe_label?'<button class="mission-cps-link" onclick="openFormationFor(\''+ax+'\',\''+(g.spe_code||'').replace(/'/g,"\\'")+'\')">\uD83D\uDCA1 Comprendre cette comp√©tence</button>':'')
    +(isStage?'<div class="mission-block"><div class="mission-block-title">Pistes de recherche</div><div id="stage-lieux-list"></div><button class="wiz-option" style="margin-top:6px;border-style:dashed;text-align:center;color:var(--primary)" onclick="addStageLieu()">+ Ajouter un lieu / entreprise</button><button class="wiz-option" style="margin-top:4px;text-align:center;color:var(--warn);font-weight:800" onclick="window.location.href=\'stage.html'+(userCode?'?id='+userCode:'')+'\'">üè¢ Voir mon espace Stage complet</button></div>':'')
    +'<div class="mission-block"><div class="mission-block-title">Modifier</div><label style="font-size:.65rem;font-weight:700;color:var(--text3);display:block;margin-bottom:3px">√âch√©ance</label><input type="date" class="fi" id="det-date" value="'+(g.date_cible||'')+'"><label style="font-size:.65rem;font-weight:700;color:var(--text3);display:block;margin-bottom:3px">'+(g.context==='Scolaire'?'Mati√®re':'D√©tail')+'</label>'+matSelect+'</div>'
    +'<div class="mission-block"><div class="mission-block-title">Historique</div><div class="mission-history">'+renderHistory(g)+'</div></div>'
    +'<div class="mission-actions"><button class="btn-mission primary" onclick="saveDetail()">\uD83D\uDCBE Enregistrer</button><button class="btn-mission outline" onclick="showQRForGoal()">üîó Faire valider par un adulte</button>'
    +(!g.done?'<button class="btn-mission success" onclick="markDone(\''+k+'\');closeOv(\'detail-overlay\')">‚úÖ Marquer comme atteint</button>':'')
    +'<button class="btn-mission danger" onclick="deleteGoal()">Supprimer</button></div>';
  if(isStage)renderStageLieux(k);
  document.getElementById('detail-overlay').classList.add('show');
}
window.saveDetail=function(){db.ref('accompagnement/eleves/'+userCode+'/objectifs/'+currentEditId).update({date_cible:document.getElementById('det-date').value,detail:document.getElementById('det-context').value});addHistory(currentEditId,'Modifi√©');closeOv('detail-overlay')}
window.deleteGoal=function(){if(confirm('Supprimer ?')){db.ref('accompagnement/eleves/'+userCode+'/objectifs/'+currentEditId).remove();closeOv('detail-overlay')}}

// STAGE LIEUX
function renderStageLieux(goalId){var el=document.getElementById('stage-lieux-list');if(!el)return;var lieux=userData.objectifs[goalId]&&userData.objectifs[goalId].lieux||{};var keys=Object.keys(lieux);if(!keys.length){el.innerHTML='<div class="empty-msg" style="padding:8px 0">Aucune piste</div>';return}
  el.innerHTML=keys.map(function(lk){var l=lieux[lk];var statuses=['contact√©','relanc√©','r√©ponse re√ßue','stage trouv√©'];return '<div class="stage-lieu"><div><div class="stage-lieu-name">'+(l.nom||'‚Äî')+'</div><div class="stage-lieu-meta">'+(l.ville||'')+'</div></div><select onchange="updateStageLieu(\''+goalId+'\',\''+lk+'\',this.value)" style="padding:4px 8px;border:1px solid var(--border);border-radius:8px;font-family:var(--font);font-size:.68rem;font-weight:700">'+statuses.map(function(s){return '<option value="'+s+'"'+(s===l.statut?' selected':'')+'>'+s+'</option>'}).join('')+'</select></div>'}).join('')}
window.addStageLieu=function(){var nom=prompt("Nom de l'entreprise ?");if(!nom)return;var ville=prompt("Ville ?");db.ref('accompagnement/eleves/'+userCode+'/objectifs/'+currentEditId+'/lieux').push({nom:nom,ville:ville||'',statut:'contact√©',created:new Date().toISOString()});addHistory(currentEditId,'Piste ajout√©e : '+nom)}
window.updateStageLieu=function(gId,lId,statut){db.ref('accompagnement/eleves/'+userCode+'/objectifs/'+gId+'/lieux/'+lId+'/statut').set(statut);addHistory(gId,'Statut : '+statut)}

// CPS SPACE
window.openCpsSpace=async function(ax){
  var meta=AX[ax];document.getElementById('cps-space-title').textContent=meta.emoji+' '+meta.label;
  var goals=Object.entries(userData.objectifs||{}).filter(function(e){return getAx(e[1])===ax});
  var doneC=goals.filter(function(e){return e[1].done}).length,activeC=goals.filter(function(e){return!e[1].done}).length;
  var biblio=await loadContext('Scolaire');var domK=ax==='COG'?'domaine_cognitif':ax==='EMO'?'domaine_emotionnel':'domaine_social';
  var dom=biblio&&biblio[domK];var comps=[];
  if(dom)(dom.categories||[]).forEach(function(cat){(cat.competences_generales||[]).forEach(function(gen){(gen.competences_specifiques||[]).forEach(function(spe){comps.push({nom_spe:spe.nom_spe,code_spe:spe.code_spe,gen_label:gen.nom_gen})})})});
  var c=document.getElementById('cps-space-content');
  c.innerHTML='<div class="cps-space-hero '+meta.cls+'"><div class="cps-space-emoji">'+meta.emoji+'</div><div class="cps-space-name">'+meta.label+'</div><div class="cps-space-sub">'+meta.desc+'</div></div>'
    +'<div class="cps-space-stats"><div class="cps-stat"><div class="cps-stat-val" style="color:'+domainColor(ax)+'">'+goals.length+'</div><div class="cps-stat-lbl">Total</div></div><div class="cps-stat"><div class="cps-stat-val" style="color:var(--success)">'+doneC+'</div><div class="cps-stat-lbl">Valid√©s</div></div><div class="cps-stat"><div class="cps-stat-val" style="color:var(--warn)">'+activeC+'</div><div class="cps-stat-lbl">En cours</div></div></div>';
  if(activeC){c.innerHTML+='<div class="cps-space-section"><h4>‚è≥ En cours</h4>'+goals.filter(function(e){return!e[1].done}).map(function(e){var dl=daysLeft(e[1].date_cible);var lbl=dl!==null?(dl<0?'D√©pass√©':dl===0?"Auj.":'J-'+dl):'';return '<div class="cps-comp-card" onclick="closeOv(\'cps-overlay\');openDetail(\''+e[0]+'\')"><div class="cps-comp-title">'+(e[1].titre||'')+'</div><div class="cps-comp-gen">'+(e[1].detail||'')+' '+(lbl?'¬∑ '+lbl:'')+'</div></div>'}).join('')+'</div>'}
  if(doneC){c.innerHTML+='<div class="cps-space-section"><h4>‚úÖ Valid√©s</h4>'+goals.filter(function(e){return e[1].done}).map(function(e){return '<div class="cps-comp-card" style="opacity:.6"><div class="cps-comp-title">'+(e[1].titre||'')+'</div><div class="cps-comp-gen">Valid√© le '+dateFr(e[1].date_done)+'</div></div>'}).join('')+'</div>'}
  c.innerHTML+='<div class="cps-space-section"><h4>üìö R√©f√©rentiel</h4>'+comps.map(function(s){return '<div class="cps-comp-card" onclick="openFormationFor(\''+ax+'\',\''+(s.code_spe||'').replace(/'/g,"\\'")+'\')">'+'<div class="cps-comp-title">'+s.nom_spe+'</div><div class="cps-comp-gen">'+s.gen_label+'</div></div>'}).join('')+'</div>'
    +'<button class="cps-formation-btn" onclick="openFormation(\''+ax+'\')">üìñ Explorer l\'espace '+meta.label+'</button>';
  document.getElementById('cps-overlay').classList.add('show');
}

// FORMATION CPS
window.openFormation=function(ax){
  var id=userCode?'?id='+userCode:'';
  var pages={COG:'formation-cognitif.html',EMO:'formation-emotionnel.html',SOC:'formation-social.html'};
  window.location.href=(pages[ax]||'formation-cognitif.html')+id;
}
window.openFormationFor=function(ax,speCode){
  var id=userCode?'?id='+userCode:'';
  var pages={COG:'formation-cognitif.html',EMO:'formation-emotionnel.html',SOC:'formation-social.html'};
  window.location.href=(pages[ax]||'formation-cognitif.html')+id+'#'+encodeURIComponent(speCode);
}

// MOOD
function checkMood(){var today=new Date().toISOString().split('T')[0];var m=userData.meteo&&userData.meteo[today];if(m){document.getElementById('mood-box').style.display='flex';document.getElementById('mood-value').textContent=m.primary+' ¬∑ '+m.secondary;document.getElementById('mood-emoji').textContent=m.emoji||'üòä'}else{document.getElementById('mood-box').style.display='none';openMood()}}
function openMood(){document.getElementById('mood-overlay').classList.add('show');document.getElementById('mood-content').innerHTML='<p style="text-align:center;color:var(--text2);font-size:.82rem;margin-bottom:16px">Comment te sens-tu aujourd\'hui ?</p><div class="mood-grid">'+Object.entries(EMOTIONS).map(function(e){return '<div class="mood-primary-btn" onclick="moodStep2(\''+e[0]+'\')"><div class="mp-emoji">'+e[1].emoji+'</div><div class="mp-label">'+e[0]+'</div></div>'}).join('')+'</div>'}
window.moodStep2=function(primary){var v=EMOTIONS[primary];document.getElementById('mood-content').innerHTML='<button class="wiz-back" onclick="openMood()">‚Üê Retour</button><p style="font-size:.9rem;font-weight:700;margin-bottom:14px">'+v.emoji+' '+primary+'</p><div class="mood-chips">'+v.subs.map(function(s){return '<button class="mood-chip-btn" onclick="saveMood(\''+primary+'\',\''+s+'\',\''+v.emoji+'\')">'+s+'</button>'}).join('')+'</div>'}
window.saveMood=function(p,s,emoji){db.ref('accompagnement/eleves/'+userCode+'/meteo/'+new Date().toISOString().split('T')[0]).set({primary:p,secondary:s,emoji:emoji});closeOv('mood-overlay')}

// BREATHING
window.openBreathing=function(){document.getElementById('breath-overlay').classList.add('show');var bubble=document.getElementById('breath-bubble'),word=document.getElementById('breath-word');if(breathInterval)clearInterval(breathInterval);function cycle(){word.textContent='Inspirer';bubble.className='breath-bubble inhale';setTimeout(function(){word.textContent='Expirer';bubble.className='breath-bubble exhale'},5000)}cycle();breathInterval=setInterval(cycle,11000)}
window.stopBreathing=function(){closeOv('breath-overlay');if(breathInterval)clearInterval(breathInterval);breathInterval=null}

// QR
window.showQRForGoal=function(){if(!currentEditId||!userData.objectifs[currentEditId])return;var g=userData.objectifs[currentEditId];genQR(JSON.stringify({eleve:userCode,objectif:currentEditId,competence:g.type||'AUTRE',timestamp:Date.now(),cadre:g.context||'Autre',flux:1}))}
window.genRecoQR=function(type){genQR(JSON.stringify({eleve:userCode,type_reconnaissance:type,competence:type,flux:2,timestamp:Date.now()}));closeOv('reco-overlay')}
function genQR(txt){document.getElementById('qrcode-container').innerHTML='';new QRCode(document.getElementById('qrcode-container'),{text:txt,width:200,height:200,correctLevel:QRCode.CorrectLevel.M});document.getElementById('qr-overlay').classList.add('show')}

// ATTESTATION
window.openAttestation=function(){
  var id=userCode?'?id='+userCode:'';
  window.location.href='synthese.html'+id;
}
function openReco(){document.getElementById('reco-overlay').classList.add('show')}

// WIZARD
window.startWizard=function(){draft={};document.getElementById('wizard-overlay').classList.add('show');wizStep(1)}
function wizStep(s){
  draft._step=s;var c=document.getElementById('wizard-content');c.innerHTML='';
  var backMap={2:1,3:2,4:3,5:4,6:5};if(backMap[s])c.innerHTML+='<button class="wiz-back" onclick="wizStep('+backMap[s]+')">‚Üê Retour</button>';
  if(s===1){c.innerHTML+='<div class="wiz-title">Dans quel cadre ?</div><button class="wiz-option" onclick="draft.context=\'Scolaire\';wizStep(2)">üìö Scolaire</button><button class="wiz-option" onclick="draft.context=\'PFMP\';wizStep(2)">üè¢ PFMP / Stage</button><button class="wiz-option" onclick="draft.context=\'Recherche\';wizStep(2)">üîç Recherche de stage</button><button class="wiz-option" onclick="draft.context=\'Autre\';draft.type=\'NEU\';draft.cps=null;wizStep(3)">‚úèÔ∏è Autre (libre)</button>'}
  else if(s===2){
    c.innerHTML+='<div class="wiz-title">Choisis ton entr√©e</div><div class="wiz-switch"><button class="wiz-switch-btn '+(wizMode==='competence'?'active':'')+'" onclick="wizMode=\'competence\';wizStep(2)">Par comp√©tence</button><button class="wiz-switch-btn '+(wizMode==='objectif'?'active':'')+'" onclick="wizMode=\'objectif\';wizStep(2)">Par savoir-faire</button></div><input type="text" class="wiz-search" id="cps-search" placeholder="Rechercher‚Ä¶" oninput="wizStep(2)">';
    loadContext(draft.context).then(function(data){if(!data){c.innerHTML+='<div class="empty-msg">Biblioth√®que non disponible</div>';return}var q=(document.getElementById('cps-search')?document.getElementById('cps-search').value:'').toLowerCase();window.__CPS_MAP={};window.__OBJ_MAP={};
    Object.entries(data).forEach(function(entry){var domK=entry[0],dom=entry[1],ax=domainKey(domK),color=domainColor(ax);
      if(wizMode==='competence'){var chips=[];(dom.categories||[]).forEach(function(cat){(cat.competences_generales||[]).forEach(function(gen){(gen.competences_specifiques||[]).forEach(function(spe){if(q&&(spe.nom_spe+' '+gen.nom_gen+' '+cat.nom_cat).toLowerCase().indexOf(q)===-1)return;var uid=ax+'_'+spe.code_spe;window.__CPS_MAP[uid]={domain:ax,cat_code:cat.code_cat,cat_label:cat.nom_cat,gen_code:gen.code_gen,gen_label:gen.nom_gen,spe_code:spe.code_spe,spe_label:spe.nom_spe,objectifs:spe.objectifs_eleve||[],color:color};chips.push('<div class="wiz-chip" onclick="selectCps(\''+uid+'\')"><span class="dot" style="background:'+color+'"></span><span>'+spe.nom_spe+'</span></div>')})})});if(chips.length)c.innerHTML+='<div class="wiz-section-h" style="color:'+color+'">'+domainLabel(ax)+'</div>'+chips.join('')}
      else{var items=[];(dom.categories||[]).forEach(function(cat){(cat.competences_generales||[]).forEach(function(gen){(gen.competences_specifiques||[]).forEach(function(spe){(spe.objectifs_eleve||[]).forEach(function(obj,i){if(q&&(obj.texte+' '+spe.nom_spe).toLowerCase().indexOf(q)===-1)return;var uid='OBJ_'+ax+'_'+spe.code_spe+'_'+i;window.__OBJ_MAP[uid]=Object.assign({},obj,{domain:ax,cat_code:cat.code_cat,cat_label:cat.nom_cat,gen_code:gen.code_gen,gen_label:gen.nom_gen,spe_code:spe.code_spe,spe_label:spe.nom_spe,color:color});items.push('<button class="wiz-option" style="border-left:4px solid '+color+'" onclick="selectObj(\''+uid+'\')">'+obj.texte+'</button>')})})})});if(items.length)c.innerHTML+='<div class="wiz-section-h" style="color:'+color+'">'+domainLabel(ax)+'</div>'+items.join('')}
    });c.innerHTML+='<div style="font-size:.65rem;color:var(--text3);margin-top:10px;text-align:center">R√©f√©rentiel : Sant√© publique France</div>'})}
  else if(s===3){
    if(draft.context==='Autre'||!draft.cps){c.innerHTML+='<div class="wiz-title">Objectif libre</div><p style="font-size:.8rem;color:var(--text2);margin-bottom:12px">√âcris ton propre objectif :</p><input type="text" class="fi" id="free-goal" placeholder="Mon objectif‚Ä¶"><button class="wiz-confirm" onclick="if(document.getElementById(\'free-goal\').value){draft.titre=document.getElementById(\'free-goal\').value;draft.code_ref=\'\';wizStep(4)}">Continuer</button>';return}
    c.innerHTML+='<div class="wiz-title">Choisis un objectif</div><div style="background:var(--surface);border:1px solid var(--border);border-radius:12px;padding:12px 16px;margin-bottom:14px;border-left:4px solid '+(draft.cps.color||domainColor(draft.cps.domain))+'"><div style="font-weight:700;font-size:.82rem">'+draft.cps.spe_label+'</div><div style="font-size:.7rem;color:var(--text2);margin-top:3px">'+domainLabel(draft.cps.domain)+' ¬∑ '+draft.cps.gen_label+'</div></div>';
    (draft.cps.objectifs||[]).forEach(function(o,i){var uid='SEL_'+draft.cps.spe_code+'_'+i;window.__OBJ_MAP=window.__OBJ_MAP||{};window.__OBJ_MAP[uid]=Object.assign({},o,{domain:draft.cps.domain,spe_code:draft.cps.spe_code,spe_label:draft.cps.spe_label,gen_code:draft.cps.gen_code,gen_label:draft.cps.gen_label,cat_code:draft.cps.cat_code,cat_label:draft.cps.cat_label});c.innerHTML+='<button class="wiz-option" onclick="selectObj(\''+uid+'\')">'+o.texte+'</button>'});
    c.innerHTML+='<button class="wiz-option" style="color:var(--primary);border-style:dashed" onclick="var t=prompt(\'Ton objectif ?\');if(t){draft.titre=t;draft.code_ref=\'\';wizStep(4)}">‚úèÔ∏è √âcrire mon propre objectif</button>'}
  else if(s===4){c.innerHTML+='<div class="wiz-title">Pour quand ?</div><input type="date" class="fi" id="w-date" value="'+(draft.date||new Date().toISOString().split('T')[0])+'"><button class="wiz-confirm" onclick="draft.date=document.getElementById(\'w-date\').value;wizStep(5)">Continuer</button>'}
  else if(s===5){
    if(draft.context==='Scolaire'){c.innerHTML+='<div class="wiz-title">Mati√®re</div><select class="fi" id="w-det">'+MATIERES.map(function(m){return '<option value="'+m+'">'+m+'</option>'}).join('')+'<option value="__autre">Autre‚Ä¶</option></select><input type="text" class="fi" id="w-det-autre" placeholder="Pr√©cise‚Ä¶" style="display:none"><button class="wiz-confirm" onclick="var v=document.getElementById(\'w-det\').value;draft.detail=v===\'__autre\'?document.getElementById(\'w-det-autre\').value:v;wizStep(6)">Continuer</button>';setTimeout(function(){var sel=document.getElementById('w-det');if(sel)sel.onchange=function(){document.getElementById('w-det-autre').style.display=sel.value==='__autre'?'block':'none'}},50)}
    else if(draft.context==='PFMP'){c.innerHTML+='<div class="wiz-title">Lieu / Activit√©</div><input type="text" class="fi" id="w-det" placeholder="Atelier, chantier, service‚Ä¶"><button class="wiz-confirm" onclick="draft.detail=document.getElementById(\'w-det\').value;wizStep(6)">Continuer</button>'}
    else if(draft.context==='Recherche'){c.innerHTML+='<div class="wiz-title">Cible</div><input type="text" class="fi" id="w-det" placeholder="M√©tier, secteur, zone‚Ä¶"><button class="wiz-confirm" onclick="draft.detail=document.getElementById(\'w-det\').value;wizStep(6)">Continuer</button>'}
    else{c.innerHTML+='<div class="wiz-title">Contexte</div><input type="text" class="fi" id="w-det" placeholder="Pr√©cise‚Ä¶"><button class="wiz-confirm" onclick="draft.detail=document.getElementById(\'w-det\').value;wizStep(6)">Continuer</button>'}}
  else if(s===6){var dom=draft.type||(draft.cps&&draft.cps.domain)||'NEU';var color=domainColor(dom);c.innerHTML+='<div class="wiz-title">R√©capitulatif</div><div class="wiz-summary" style="border-left:4px solid '+color+'"><div class="ws-row"><span class="ws-label">Objectif</span><span class="ws-value">'+(draft.titre||'')+'</span></div><div class="ws-row"><span class="ws-label">Cadre</span><span class="ws-value">'+(draft.context||'')+'</span></div><div class="ws-row"><span class="ws-label">Comp√©tence</span><span class="ws-value">'+(draft.cps?draft.cps.spe_label:'Libre')+'</span></div><div class="ws-row"><span class="ws-label">Type</span><span class="ws-value">'+domainLabel(dom)+'</span></div><div class="ws-row"><span class="ws-label">Quand</span><span class="ws-value">'+(draft.date||'')+'</span></div><div class="ws-row"><span class="ws-label">D√©tail</span><span class="ws-value">'+(draft.detail||'Non pr√©cis√©')+'</span></div></div><button class="wiz-confirm" onclick="saveWizard()">‚úÖ Valider l\'objectif</button>'}
}
window.selectCps=function(uid){if(!window.__CPS_MAP||!window.__CPS_MAP[uid])return;draft.cps=window.__CPS_MAP[uid];draft.type=draft.cps.domain||'NEU';wizStep(3)}
window.selectObj=function(uid){var o=window.__OBJ_MAP&&window.__OBJ_MAP[uid];if(!o)return;draft.obj=o;draft.titre=o.texte||'';draft.code_ref=o.code_ref||'';draft.type=o.domain||'NEU';draft.cps={domain:o.domain,cat_code:o.cat_code,cat_label:o.cat_label,gen_code:o.gen_code,gen_label:o.gen_label,spe_code:o.spe_code,spe_label:o.spe_label,color:domainColor(o.domain)};wizStep(4)}
window.saveWizard=function(){if(!draft.date)draft.date=new Date().toISOString().split('T')[0];var dom=draft.type||(draft.cps&&draft.cps.domain)||'NEU';db.ref('accompagnement/eleves/'+userCode+'/objectifs').push({context:draft.context||'Autre',type:dom,titre:draft.titre||'',date_cible:draft.date,detail:(draft.detail&&draft.detail.trim())||'Non pr√©cis√©',done:false,created:new Date().toISOString(),ref_source:"Sant√© publique France",cat_code:(draft.cps&&draft.cps.cat_code)||"",cat_label:(draft.cps&&draft.cps.cat_label)||"",gen_code:(draft.cps&&draft.cps.gen_code)||"",gen_label:(draft.cps&&draft.cps.gen_label)||"",spe_code:(draft.cps&&draft.cps.spe_code)||"",spe_label:(draft.cps&&draft.cps.spe_label)||"",code_ref:draft.code_ref||"",domaine:dom});closeOv('wizard-overlay')}
</script>
</body>
</html>
