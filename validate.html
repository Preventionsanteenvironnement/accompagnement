<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Validation CPS</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@400;500;600;700;800;900&display=swap" rel="stylesheet">
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        :root{
            --bg:#faf9f7;
            --surface:#fff;
            --text:#1a1a2e;
            --text2:#64748b;
            --text3:#94a3b8;
            --border:rgba(0,0,0,.06);
            --primary:#6366f1;
            --primary-light:#eef2ff;
            --success:#10b981;
            --success-light:#d1fae5;
            --danger:#ef4444;
            --warn:#f59e0b;
            --cog:#3b82f6;
            --emo:#f43f5e;
            --soc:#8b5cf6;
            --radius:20px;
            --radius-sm:12px;
            --shadow:0 4px 20px rgba(0,0,0,.06);
            --shadow-lg:0 12px 40px rgba(0,0,0,.1);
            --font:'Outfit',system-ui,sans-serif;
        }
        body{font-family:var(--font);background:var(--bg);color:var(--text);min-height:100vh}
        
        .header{
            background:linear-gradient(135deg,var(--primary),var(--soc));
            color:#fff;
            padding:32px 24px;
            text-align:center;
            border-radius:0 0 32px 32px;
            box-shadow:0 8px 32px rgba(99,102,241,.25);
        }
        .header h1{font-size:1.4rem;font-weight:800;margin-bottom:4px}
        .header p{font-size:.85rem;opacity:.85;font-weight:500}
        
        .container{max-width:480px;margin:0 auto;padding:24px 20px}
        
        .card{
            background:var(--surface);
            border-radius:var(--radius);
            padding:24px;
            box-shadow:var(--shadow);
            margin-bottom:16px;
            border:1px solid var(--border);
        }
        
        /* Student badge */
        .student-badge{display:flex;align-items:center;gap:16px}
        .student-icon{
            width:56px;
            height:56px;
            border-radius:16px;
            background:linear-gradient(135deg,var(--primary-light),rgba(139,92,246,.1));
            display:flex;
            align-items:center;
            justify-content:center;
            font-size:1.6rem;
        }
        .student-label{font-size:0.75rem;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:1px}
        .student-code{font-size:1.4rem;font-weight:800;color:var(--primary);letter-spacing:2px;margin-top:2px}
        
        /* Objectif card */
        .objectif-card{
            background:linear-gradient(135deg,rgba(99,102,241,.04),rgba(139,92,246,.02));
            border-radius:var(--radius-sm);
            padding:16px;
            margin-top:16px;
            border-left:4px solid var(--primary);
        }
        .objectif-label{font-size:0.75rem;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px}
        .objectif-titre{font-size:1rem;font-weight:700;color:var(--text);line-height:1.4}
        .objectif-meta{font-size:.8rem;color:var(--text2);margin-top:6px}
        
        /* Code enseignant */
        .code-section{text-align:center;padding:20px 0}
        .code-title{font-size:.9rem;font-weight:700;color:var(--text);margin-bottom:16px}
        .code-input-wrapper{display:flex;justify-content:center;gap:8px;margin-bottom:16px}
        .code-digit{
            width:48px;
            height:56px;
            border:2px solid var(--border);
            border-radius:12px;
            font-family:var(--font);
            font-size:1.4rem;
            font-weight:800;
            text-align:center;
            text-transform:uppercase;
            outline:none;
            transition:all .2s;
            background:var(--surface);
        }
        .code-digit:focus{border-color:var(--primary);box-shadow:0 0 0 4px rgba(99,102,241,.1)}
        .code-digit.valid{border-color:var(--success);background:var(--success-light)}
        .code-digit.invalid{border-color:var(--danger);animation:shake .3s}
        @keyframes shake{0%,100%{transform:translateX(0)}25%{transform:translateX(-5px)}75%{transform:translateX(5px)}}
        
        .code-hint{font-size:.75rem;color:var(--text3);font-weight:500}
        
        /* Form */
        .form-label{
            display:block;
            font-size:0.75rem;
            font-weight:700;
            color:var(--text3);
            text-transform:uppercase;
            letter-spacing:.5px;
            margin-bottom:8px;
        }
        .form-select,.form-input{
            width:100%;
            padding:14px 16px;
            border:2px solid var(--border);
            border-radius:var(--radius-sm);
            font-size:.95rem;
            font-family:var(--font);
            font-weight:600;
            outline:none;
            transition:all .2s;
            background:var(--surface);
            margin-bottom:16px;
            color:var(--text);
        }
        .form-select:focus,.form-input:focus{border-color:var(--primary);box-shadow:0 0 0 4px rgba(99,102,241,.1)}
        .form-select:disabled{background:#f8fafc;color:var(--text3)}
        textarea.form-input{min-height:80px;resize:vertical}
        
        .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
        hr{border:none;border-top:1px solid var(--border);margin:20px 0}
        
        .btn-submit{
            display:block;
            width:100%;
            padding:18px;
            border-radius:var(--radius-sm);
            background:linear-gradient(135deg,var(--success),#059669);
            color:#fff;
            font-weight:800;
            font-size:1rem;
            border:none;
            cursor:pointer;
            font-family:var(--font);
            transition:all .2s;
            box-shadow:0 4px 16px rgba(16,185,129,.3);
        }
        .btn-submit:hover{transform:translateY(-2px);box-shadow:0 8px 24px rgba(16,185,129,.4)}
        .btn-submit:disabled{background:#94a3b8;cursor:not-allowed;transform:none;box-shadow:none}
        
        /* Loading */
        #loading{display:flex;flex-direction:column;align-items:center;justify-content:center;padding:80px 20px;gap:16px}
        .spinner{width:48px;height:48px;border:4px solid var(--primary-light);border-top-color:var(--primary);border-radius:50%;animation:spin .7s linear infinite}
        @keyframes spin{to{transform:rotate(360deg)}}
        
        /* Error */
        #error{display:none;text-align:center;padding:60px 20px}
        .error-icon{width:80px;height:80px;border-radius:50%;background:linear-gradient(135deg,#fef2f2,#fee2e2);display:flex;align-items:center;justify-content:center;font-size:2rem;margin:0 auto 20px}
        
        #form-section{display:none}
        
        /* ========================================
           CELEBRATION SCREEN
           ======================================== */
        #celebration{
            display:none;
            position:fixed;
            inset:0;
            background:var(--bg);
            z-index:9999;
            flex-direction:column;
            align-items:center;
            justify-content:center;
            padding:40px;
            text-align:center;
        }
        #celebration.show{display:flex;animation:fadeIn .3s ease}
        @keyframes fadeIn{from{opacity:0}to{opacity:1}}
        
        .celeb-emoji{font-size:5rem;margin-bottom:24px;animation:bounce 1s ease infinite}
        @keyframes bounce{0%,100%{transform:translateY(0)}50%{transform:translateY(-20px)}}
        
        .celeb-title{font-size:2rem;font-weight:900;background:linear-gradient(135deg,var(--primary),var(--soc));-webkit-background-clip:text;-webkit-text-fill-color:transparent;margin-bottom:12px}
        .celeb-subtitle{font-size:1.1rem;font-weight:600;color:var(--text2);margin-bottom:32px}
        
        .celeb-stars{display:flex;justify-content:center;gap:8px;margin-bottom:32px}
        .celeb-star{font-size:2.5rem;animation:starPop .5s ease forwards;opacity:0;transform:scale(0)}
        .celeb-star:nth-child(1){animation-delay:.1s}
        .celeb-star:nth-child(2){animation-delay:.2s}
        .celeb-star:nth-child(3){animation-delay:.3s}
        .celeb-star:nth-child(4){animation-delay:.4s}
        .celeb-star:nth-child(5){animation-delay:.5s}
        @keyframes starPop{to{opacity:1;transform:scale(1)}}
        
        .celeb-objectif{
            background:var(--surface);
            border-radius:var(--radius);
            padding:20px;
            margin-bottom:32px;
            box-shadow:var(--shadow-lg);
            max-width:320px;
        }
        .celeb-objectif-label{font-size:0.75rem;font-weight:700;color:var(--text3);text-transform:uppercase;letter-spacing:.5px;margin-bottom:8px}
        .celeb-objectif-titre{font-size:1rem;font-weight:700;color:var(--text)}
        
        .celeb-count{
            background:linear-gradient(135deg,var(--primary-light),rgba(139,92,246,.1));
            border-radius:var(--radius-sm);
            padding:16px 32px;
            margin-bottom:32px;
        }
        .celeb-count-value{font-size:2rem;font-weight:900;color:var(--primary)}
        .celeb-count-label{font-size:.8rem;font-weight:600;color:var(--text2)}
        
        .celeb-btn{
            padding:16px 48px;
            background:var(--primary);
            color:#fff;
            border:none;
            border-radius:999px;
            font-family:var(--font);
            font-weight:700;
            font-size:1rem;
            cursor:pointer;
            transition:all .2s;
        }
        .celeb-btn:hover{transform:scale(1.05);box-shadow:0 8px 24px rgba(99,102,241,.4)}
        
        /* Confetti canvas */
        #confetti-canvas{position:fixed;inset:0;pointer-events:none;z-index:10000}
        
        /* Messages encouragement */
        .encouragements{
            position:absolute;
            top:15%;
            width:100%;
            display:flex;
            justify-content:space-around;
            padding:0 20px;
            font-size:1.5rem;
            font-weight:800;
            opacity:.3;
        }
    </style>
</head>
<body>

<canvas id="confetti-canvas"></canvas>

<div class="header">
    <h1>‚úÖ Validation d'objectif</h1>
    <p>Accompagnement CPS</p>
</div>

<div class="container">
    <!-- Loading -->
    <div id="loading">
        <div class="spinner"></div>
        <div style="font-weight:700;color:var(--text2)">Chargement...</div>
    </div>

    <!-- Error -->
    <div id="error">
        <div class="error-icon">‚ö†Ô∏è</div>
        <h3 style="font-weight:800;margin-bottom:8px">Oups !</h3>
        <p style="color:var(--text2);font-size:.9rem" id="error-text">Une erreur est survenue.</p>
    </div>

    <!-- Main form -->
    <div id="form-section">
        <!-- Student info -->
        <div class="card">
            <div class="student-badge">
                <div class="student-icon">üéì</div>
                <div>
                    <div class="student-label">√âl√®ve</div>
                    <div class="student-code" id="display-code">--</div>
                </div>
            </div>
            
            <div class="objectif-card" id="objectif-display" style="display:none">
                <div class="objectif-label">Objectif √† valider</div>
                <div class="objectif-titre" id="objectif-titre">--</div>
                <div class="objectif-meta" id="objectif-meta">--</div>
            </div>
        </div>

        <!-- Code enseignant -->
        <div class="card">
            <div class="code-section">
                <div class="code-title">üîê Code enseignant</div>
                <div class="code-input-wrapper">
                    <input type="text" class="code-digit" maxlength="1" id="code-1" autocomplete="off">
                    <input type="text" class="code-digit" maxlength="1" id="code-2" autocomplete="off">
                    <input type="text" class="code-digit" maxlength="1" id="code-3" autocomplete="off">
                    <input type="text" class="code-digit" maxlength="1" id="code-4" autocomplete="off">
                    <input type="text" class="code-digit" maxlength="1" id="code-5" autocomplete="off">
                    <input type="text" class="code-digit" maxlength="1" id="code-6" autocomplete="off">
                    <input type="text" class="code-digit" maxlength="1" id="code-7" autocomplete="off">
                </div>
                <div class="code-hint">Demande le code √† ton enseignant</div>
            </div>
        </div>

        <!-- Validation form -->
        <div class="card" id="validation-form" style="display:none">
            <form id="form-cps">
                <label class="form-label">Contexte</label>
                <select class="form-select" id="contexte" required>
                    <option value="Classe">En classe</option>
                    <option value="Atelier">Atelier CPS</option>
                    <option value="Stage">Stage / Entreprise</option>
                    <option value="Entretien">Entretien individuel</option>
                    <option value="Autre">Autre</option>
                </select>

                <label class="form-label">Commentaire (optionnel)</label>
                <textarea class="form-input" id="commentaire" placeholder="Bravo pour... / Tu as r√©ussi √†..."></textarea>

                <button type="submit" class="btn-submit" id="btn-submit">‚úÖ Valider cet objectif</button>
            </form>
        </div>
    </div>
</div>

<!-- Celebration screen -->
<div id="celebration">
    <div class="celeb-emoji">üéâ</div>
    <div class="celeb-title">BRAVO !</div>
    <div class="celeb-subtitle">Tu as valid√© un objectif</div>
    
    <div class="celeb-stars">
        <span class="celeb-star">‚≠ê</span>
        <span class="celeb-star">‚≠ê</span>
        <span class="celeb-star">‚≠ê</span>
        <span class="celeb-star">‚≠ê</span>
        <span class="celeb-star">‚≠ê</span>
    </div>
    
    <div class="celeb-objectif">
        <div class="celeb-objectif-label">Objectif valid√©</div>
        <div class="celeb-objectif-titre" id="celeb-objectif-titre">--</div>
    </div>
    
    <div class="celeb-count">
        <div class="celeb-count-value" id="celeb-count">+1</div>
        <div class="celeb-count-label">validation obtenue</div>
    </div>
    
    <button class="celeb-btn" onclick="closeCelebration()">Continuer üöÄ</button>
</div>

<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<script>
// Firebase config
const firebaseConfig = {
    apiKey: "AIzaSyAWdCMvOiAJln3eT9LIAQD3RWJUD0IQcLI",
    authDomain: "devoirs-pse.firebaseapp.com",
    databaseURL: "https://devoirs-pse-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "devoirs-pse",
    storageBucket: "devoirs-pse.appspot.com",
    messagingSenderId: "614730413904",
    appId: "1:614730413904:web:a5dd478af5de30f6bede55"
};
firebase.initializeApp(firebaseConfig);
const db = firebase.database();

// Variables
let eleveId = null;
let objectifId = null;
let objectifData = null;
let codeEnseignant = "CPS2026"; // Code par d√©faut, sera charg√© depuis Firebase

// Parse URL params
const params = new URLSearchParams(location.search);
eleveId = params.get('id');
objectifId = params.get('obj');

// On load
window.onload = async function() {
    if (!eleveId) {
        showError("Code √©l√®ve manquant. Scanne un QR code valide.");
        return;
    }
    
    document.getElementById('display-code').textContent = eleveId;
    
    try {
        // Charger le code enseignant depuis Firebase
        const configSnap = await db.ref('accompagnement/config/code_validation').once('value');
        if (configSnap.exists()) {
            codeEnseignant = configSnap.val();
        }
        
        // Si on a un objectif ID, charger ses infos
        if (objectifId) {
            const objSnap = await db.ref(`accompagnement/eleves/${eleveId}/objectifs/${objectifId}`).once('value');
            if (objSnap.exists()) {
                objectifData = objSnap.val();
                document.getElementById('objectif-display').style.display = 'block';
                document.getElementById('objectif-titre').textContent = objectifData.titre || 'Objectif';
                document.getElementById('objectif-meta').textContent = `${objectifData.context || ''} ¬∑ ${objectifData.type || ''}`;
            }
        }
        
        document.getElementById('loading').style.display = 'none';
        document.getElementById('form-section').style.display = 'block';
        
        // Focus first digit
        document.getElementById('code-1').focus();
        
        // Setup code inputs
        setupCodeInputs();
        
    } catch(e) {
        showError(e.message);
    }
};

function showError(msg) {
    document.getElementById('loading').style.display = 'none';
    document.getElementById('error-text').textContent = msg;
    document.getElementById('error').style.display = 'block';
}

// Code input handling
function setupCodeInputs() {
    const inputs = document.querySelectorAll('.code-digit');
    
    inputs.forEach((input, index) => {
        input.addEventListener('input', (e) => {
            const val = e.target.value.toUpperCase();
            e.target.value = val;
            
            if (val && index < inputs.length - 1) {
                inputs[index + 1].focus();
            }
            
            checkCode();
        });
        
        input.addEventListener('keydown', (e) => {
            if (e.key === 'Backspace' && !e.target.value && index > 0) {
                inputs[index - 1].focus();
            }
        });
        
        input.addEventListener('paste', (e) => {
            e.preventDefault();
            const paste = (e.clipboardData || window.clipboardData).getData('text').toUpperCase();
            paste.split('').forEach((char, i) => {
                if (inputs[i]) inputs[i].value = char;
            });
            checkCode();
        });
    });
}

function checkCode() {
    const inputs = document.querySelectorAll('.code-digit');
    let enteredCode = '';
    inputs.forEach(input => enteredCode += input.value);
    
    if (enteredCode.length === 7) {
        if (enteredCode === codeEnseignant) {
            // Code valide
            inputs.forEach(input => {
                input.classList.remove('invalid');
                input.classList.add('valid');
            });
            document.getElementById('validation-form').style.display = 'block';
        } else {
            // Code invalide
            inputs.forEach(input => {
                input.classList.remove('valid');
                input.classList.add('invalid');
            });
            setTimeout(() => {
                inputs.forEach(input => {
                    input.classList.remove('invalid');
                    input.value = '';
                });
                inputs[0].focus();
            }, 500);
        }
    }
}

// Form submission
document.getElementById('form-cps').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const btn = document.getElementById('btn-submit');
    btn.disabled = true;
    btn.textContent = 'Validation...';
    
    try {
        // Enregistrer la validation
        const validationData = {
            eleve_id: eleveId,
            objectif_id: objectifId || null,
            objectif_titre: objectifData?.titre || 'Validation libre',
            contexte: document.getElementById('contexte').value,
            commentaire: document.getElementById('commentaire').value,
            timestamp: firebase.database.ServerValue.TIMESTAMP,
            date_lisible: new Date().toLocaleDateString('fr-FR'),
            axe: objectifData?.type || 'AUTRE',
            cps_code: objectifData?.cps_code || null
        };
        
        await db.ref('accompagnement/validations').push(validationData);
        
        // Si on a un objectif, mettre √† jour ses validations
        if (objectifId) {
            const valRef = db.ref(`accompagnement/eleves/${eleveId}/objectifs/${objectifId}/validations`);
            const valSnap = await valRef.once('value');
            const currentCount = valSnap.val() || 0;
            await valRef.set(currentCount + 1);
            
            // Ajouter √† l'historique de l'objectif
            await db.ref(`accompagnement/eleves/${eleveId}/objectifs/${objectifId}/historique`).push({
                action: 'Valid√© par un enseignant',
                date: new Date().toISOString(),
                contexte: document.getElementById('contexte').value
            });
        }
        
        // Montrer la c√©l√©bration
        showCelebration();
        
    } catch(err) {
        alert('Erreur : ' + err.message);
        btn.disabled = false;
        btn.textContent = '‚úÖ Valider cet objectif';
    }
});

// Celebration
function showCelebration() {
    document.getElementById('celeb-objectif-titre').textContent = objectifData?.titre || 'Objectif valid√©';
    document.getElementById('celebration').classList.add('show');
    launchConfetti();
}

function closeCelebration() {
    document.getElementById('celebration').classList.remove('show');
    // Retour √† l'app √©l√®ve
    window.location.href = 'index.html?id=' + eleveId;
}

// Confetti animation
function launchConfetti() {
    const canvas = document.getElementById('confetti-canvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth;
    canvas.height = window.innerHeight;
    
    const confetti = [];
    const colors = ['#6366f1', '#8b5cf6', '#f43f5e', '#10b981', '#f59e0b', '#3b82f6'];
    
    for (let i = 0; i < 150; i++) {
        confetti.push({
            x: Math.random() * canvas.width,
            y: Math.random() * canvas.height - canvas.height,
            r: Math.random() * 6 + 4,
            d: Math.random() * 150,
            color: colors[Math.floor(Math.random() * colors.length)],
            tilt: Math.floor(Math.random() * 10) - 10,
            tiltAngleIncrement: Math.random() * 0.07 + 0.05,
            tiltAngle: 0
        });
    }
    
    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        confetti.forEach((c, i) => {
            c.tiltAngle += c.tiltAngleIncrement;
            c.y += (Math.cos(c.d) + 3 + c.r / 2) / 2;
            c.x += Math.sin(c.d);
            c.tilt = Math.sin(c.tiltAngle) * 15;
            
            ctx.beginPath();
            ctx.lineWidth = c.r / 2;
            ctx.strokeStyle = c.color;
            ctx.moveTo(c.x + c.tilt + c.r / 4, c.y);
            ctx.lineTo(c.x + c.tilt, c.y + c.tilt + c.r / 4);
            ctx.stroke();
            
            if (c.y > canvas.height) {
                confetti[i] = {
                    x: Math.random() * canvas.width,
                    y: -10,
                    r: c.r,
                    d: c.d,
                    color: c.color,
                    tilt: c.tilt,
                    tiltAngleIncrement: c.tiltAngleIncrement,
                    tiltAngle: c.tiltAngle
                };
            }
        });
    }
    
    let frames = 0;
    function animate() {
        draw();
        frames++;
        if (frames < 200) {
            requestAnimationFrame(animate);
        } else {
            ctx.clearRect(0, 0, canvas.width, canvas.height);
        }
    }
    animate();
}
</script>
</body>
</html>
