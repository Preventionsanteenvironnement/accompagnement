<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Espace R√©ussite</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg-app: #f8fafc; 
            --surface: #ffffff; 
            --text-main: #1e293b; 
            --primary: #4f46e5; 
            --radius: 12px;
            /* COULEURS CPS */
            --cog-color: #3b82f6; /* Bleu */
            --emo-color: #ec4899; /* Rose */
            --soc-color: #8b5cf6; /* Violet */
            --neu-color: #64748b; /* Gris */
        }
        body { background-color: var(--bg-app); color: var(--text-main); font-family: 'Outfit', sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* HEADER SOBRE (8 bis) */
        .app-header { background: var(--surface); padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid #e2e8f0; z-index: 20; }
        .student-id { font-weight: 700; color: var(--text-main); font-size: 1rem; letter-spacing: 0.5px; }
        .btn-breath { background: none; border: 1px solid #e2e8f0; color: var(--neu-color); padding: 5px 12px; border-radius: 20px; font-size: 0.8rem; font-weight: 600; }

        /* CONTENU */
        .app-content { flex: 1; overflow-y: auto; padding: 1.5rem; padding-bottom: 100px; display: none; }
        .app-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* METEO DU JOUR */
        .mood-summary { background: white; padding: 12px; border-radius: var(--radius); border: 1px solid #e2e8f0; margin-bottom: 20px; display: flex; justify-content: space-between; align-items: center; }
        .mood-tag { font-weight: 700; color: var(--primary); }

        /* KPI CERCLES */
        .kpi-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 2rem; }
        .kpi-item { background: white; border-radius: var(--radius); padding: 15px 5px; text-align: center; border: 1px solid #f1f5f9; box-shadow: 0 2px 4px rgba(0,0,0,0.02); cursor: pointer; }
        .kpi-item:active { background: #f8fafc; }
        .chart-mini { position: relative; height: 60px; width: 60px; margin: 0 auto 8px auto; }
        .kpi-title { font-weight: 700; font-size: 0.75rem; text-transform: uppercase; color: var(--neu-color); }

        /* OBJECTIFS LISTE */
        .obj-card { background: white; border-radius: var(--radius); padding: 15px; margin-bottom: 10px; border: 1px solid #e2e8f0; position: relative; border-left-width: 5px; cursor: pointer; }
        .obj-card.cog { border-left-color: var(--cog-color); }
        .obj-card.emo { border-left-color: var(--emo-color); }
        .obj-card.soc { border-left-color: var(--soc-color); }
        .obj-card.neu { border-left-color: var(--neu-color); }
        
        .obj-badge { font-size: 0.65rem; padding: 2px 6px; border-radius: 4px; font-weight: 700; text-transform: uppercase; background: #f1f5f9; color: #475569; margin-left: 8px; }
        .countdown { font-size: 0.75rem; font-weight: 600; color: #64748b; margin-top: 4px; display: block; }
        .countdown.urgent { color: #ef4444; }

        /* NAV BAS */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid #e2e8f0; display: flex; justify-content: space-around; padding: 12px 0; z-index: 30; }
        .nav-btn { background: none; border: none; color: #94a3b8; font-size: 0.75rem; display: flex; flex-direction: column; align-items: center; font-weight: 500; }
        .nav-btn.active { color: var(--primary); font-weight: 700; }
        .nav-btn i { font-size: 1.2rem; margin-bottom: 4px; }

        /* OVERLAYS */
        .overlay-full { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f8fafc; z-index: 100; display: none; flex-direction: column; overflow-y: auto; }
        .overlay-header { padding: 1.5rem; background: white; border-bottom: 1px solid #e2e8f0; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10; }
        .step-content { padding: 1.5rem; flex: 1; }

        /* BOUTONS LISTE (Wizard & Mood) */
        .list-btn { width: 100%; text-align: left; padding: 15px; margin-bottom: 8px; background: white; border: 1px solid #e2e8f0; border-radius: 8px; font-weight: 600; color: var(--text-main); }
        .list-btn:active { background: #e0e7ff; border-color: var(--primary); }
        
        /* RESPIRATION */
        .breath-circle { width: 200px; height: 200px; background: #e0e7ff; border-radius: 50%; margin: auto; display: flex; align-items: center; justify-content: center; color: var(--primary); font-size: 1.2rem; font-weight: bold; transition: all 5s ease-in-out; }
        .inhale { transform: scale(1.5); background-color: #c7d2fe; }
        .exhale { transform: scale(1.0); background-color: #e0e7ff; }

        .hidden { display: none !important; }
        
        /* EDIT MODAL SPECIFIC */
        .edit-label { font-size: 0.75rem; font-weight: 700; color: #64748b; text-transform: uppercase; margin-bottom: 5px; display: block; }
    </style>
</head>
<body>

<div id="loader" style="position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; display:flex; align-items:center; justify-content:center;">
    <div class="spinner-border text-primary" role="status"></div>
</div>

<header class="app-header">
    <div class="student-id"><span id="display-code">--</span></div>
    <button class="btn-breath" onclick="startBreathing()">Respiration</button>
</header>

<main class="app-content active" id="view-dashboard">
    
    <div class="mood-summary" id="mood-summary-box" style="display:none;">
        <div>
            <div class="small text-muted">Humeur du jour</div>
            <div class="mood-tag" id="mood-display-val">--</div>
        </div>
        <button class="btn btn-sm btn-outline-secondary rounded-pill" onclick="openMoodModal()">Changer</button>
    </div>

    <div class="kpi-grid">
        <div class="kpi-item" onclick="openCircleDetail('COG')">
            <div class="chart-mini"><canvas id="chartCog"></canvas></div>
            <div class="kpi-title">Cognitif</div>
        </div>
        <div class="kpi-item" onclick="openCircleDetail('EMO')">
            <div class="chart-mini"><canvas id="chartEmo"></canvas></div>
            <div class="kpi-title">√âmotionnel</div>
        </div>
        <div class="kpi-item" onclick="openCircleDetail('SOC')">
            <div class="chart-mini"><canvas id="chartSoc"></canvas></div>
            <div class="kpi-title">Social</div>
        </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3">
        <h6 class="fw-bold mb-0 text-dark">Objectifs √† atteindre</h6>
        <button class="btn btn-sm btn-primary rounded-pill px-3" onclick="startGoalWizard()">+ Ajouter</button>
    </div>
    
    <div id="active-goals-list"></div>

    <div class="mt-4 border-top pt-3">
        <div class="d-flex justify-content-between align-items-center mb-2" onclick="toggleHistory()" style="cursor:pointer">
            <span class="small fw-bold text-muted">Objectifs atteints / Historique</span>
            <i class="fas fa-chevron-down text-muted"></i>
        </div>
        <div id="history-goals-list" style="display:none;"></div>
    </div>

</main>

<main class="app-content" id="view-library">
    <h4 class="fw-bold mb-3">Ressources</h4>
    <div id="library-list"></div>
</main>

<div class="bottom-nav">
    <button class="nav-btn active" onclick="switchView('dashboard')"><i class="fas fa-home"></i>Accueil</button>
    <button class="nav-btn" onclick="switchView('library')"><i class="fas fa-book-open"></i>Savoir</button>
</div>

<div id="wizard-overlay" class="overlay-full">
    <div class="overlay-header">
        <h5 class="fw-bold mb-0">Nouvel Objectif</h5>
        <button class="btn-close" onclick="closeWizard()"></button>
    </div>
    <div class="step-content" id="wizard-steps"></div>
</div>

<div id="edit-goal-overlay" class="overlay-full">
    <div class="overlay-header">
        <h5 class="fw-bold mb-0">Modifier l'objectif</h5>
        <button class="btn-close" onclick="closeEditGoal()"></button>
    </div>
    <div class="step-content">
        <div class="mb-4">
            <label class="edit-label">Objectif</label>
            <input type="text" id="edit-goal-title" class="form-control fw-bold" disabled>
            <div class="form-text small" id="edit-goal-help">Texte non modifiable (issu de la liste).</div>
        </div>

        <div class="mb-4">
            <label class="edit-label">Pour quand ?</label>
            <input type="date" id="edit-goal-date" class="form-control">
        </div>

        <div class="mb-4">
            <label class="edit-label">Mati√®re / Lieu</label>
            <input type="text" id="edit-goal-context" class="form-control">
        </div>

        <button class="btn btn-primary w-100 rounded-pill py-3 fw-bold" onclick="saveEditedGoal()">Enregistrer les modifications</button>
        
        <div class="text-center mt-4">
            <button class="btn btn-outline-danger btn-sm" onclick="deleteGoal()">Supprimer cet objectif</button>
        </div>
    </div>
</div>

<div id="circle-overlay" class="overlay-full">
    <div class="overlay-header">
        <h5 class="fw-bold mb-0" id="circle-title">--</h5>
        <button class="btn-close" onclick="closeCircle()"></button>
    </div>
    <div class="step-content">
        <ul class="nav nav-pills mb-3 nav-fill" id="pills-tab" role="tablist">
            <li class="nav-item"><button class="nav-link active btn-sm" onclick="switchCircleTab('suivi')">Suivi</button></li>
            <li class="nav-item"><button class="nav-link btn-sm" onclick="switchCircleTab('comprendre')">Comprendre</button></li>
            <li class="nav-item"><button class="nav-link btn-sm" onclick="switchCircleTab('pratique')">Pratique</button></li>
        </ul>

        <div id="tab-suivi">
            <h6 class="text-muted small fw-bold mb-2">√Ä VENIR / EN COURS</h6>
            <div id="circle-active-list" class="mb-4"></div>
            <h6 class="text-muted small fw-bold mb-2">ATTEINTS</h6>
            <div id="circle-done-list"></div>
        </div>

        <div id="tab-comprendre" class="hidden">
            <div class="card p-3 mb-3 border-0 bg-light">
                <strong class="d-block mb-2">C'est quoi ?</strong>
                <p class="mb-0 small" id="circle-def">--</p>
            </div>
            <div class="card p-3 mb-3 border-0 bg-light">
                <strong class="d-block mb-2">Pourquoi au lyc√©e/stage ?</strong>
                <p class="mb-0 small" id="circle-exp">--</p>
            </div>
            <h6 class="fw-bold mt-4 mb-2">Dictionnaire</h6>
            <div id="circle-dict-list" class="list-group list-group-flush small"></div>
        </div>

        <div id="tab-pratique" class="hidden">
            <h6 class="fw-bold mb-3">Exercices d'entra√Ænement</h6>
            <div id="circle-ex-list" class="list-group list-group-flush"></div>
        </div>
    </div>
</div>

<div id="mood-overlay" class="overlay-full">
    <div class="overlay-header">
        <h5 class="fw-bold mb-0">M√©t√©o du jour</h5>
        <button class="btn-close" id="mood-close-btn" onclick="document.getElementById('mood-overlay').style.display='none'"></button>
    </div>
    <div class="step-content" id="mood-step-container">
        </div>
</div>

<div id="breath-overlay" class="overlay-full" style="justify-content:center; background:#f8fafc;">
    <div class="text-center">
        <div id="breath-circle" class="breath-circle">Pr√™t ?</div>
        <button class="btn btn-outline-dark rounded-pill mt-5 px-5" onclick="stopBreathing()">Fermer</button>
    </div>
</div>

<div id="school-closed" style="display:none; height:100vh; align-items:center; justify-content:center; flex-direction:column; background: #1e293b; color: white;">
    <h3 class="fw-bold">Pause</h3><p class="text-white-50 px-4 text-center">Disponible sur temps scolaire.</p>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<script src="js/firebase-config.js"></script>

<script>
    if (typeof firebaseConfig !== 'undefined') firebase.initializeApp(firebaseConfig);
    const userCode = new URLSearchParams(window.location.search).get("id");
    let CONFIG_ECOLE = { ouverture: 6, fermeture: 23, jours: [0,1,2,3,4,5,6], maintenance: false };
    
    // --- DONN√âES STATIQUES ---
    const EMOTIONS_V2 = {
        "Joie": ["Satisfait", "Fier", "Soulag√©", "Enthousiaste", "Serein"],
        "Tristesse": ["D√©√ßu", "D√©courag√©", "Nostalgique", "Seul", "Abattu"],
        "Col√®re": ["Agac√©", "Frustr√©", "√ânerv√©", "Irrit√©", "R√©volt√©"],
        "Peur": ["Anxieux", "Inquiet", "Stress√©", "Paniqu√©", "M√©fiant"],
        "D√©go√ªt": ["G√™n√©", "√âc≈ìur√©", "Mal √† l'aise", "Repouss√©"],
        "Surprise": ["√âtonn√©", "Choqu√©", "Impressionn√©", "Perplexe"]
    };

    const DICTIONNAIRE = {
        "Cognitif": "Ce qui concerne la pens√©e, la m√©moire, l'attention et le raisonnement.",
        "√âmotionnel": "Ce qui concerne ce que l'on ressent (sentiments, humeur).",
        "Social": "Ce qui concerne les relations avec les autres.",
        "Empathie": "Savoir se mettre √† la place de l'autre pour comprendre ce qu'il ressent.",
        "Estime de soi": "La valeur que l'on se donne √† soi-m√™me."
    };

    const EXERCICES = {
        "COG": ["Lister 3 choses apprises aujourd'hui", "Faire une to-do list pour demain", "Relire une consigne 2 fois"],
        "EMO": ["Nommer l'√©motion ressentie maintenant", "Respiration 5s/6s", "√âcrire ce qui me stresse"],
        "SOC": ["Dire bonjour en regardant les yeux", "√âcouter un camarade sans couper la parole", "Reformuler ce que l'autre a dit"]
    };

    const EXPLICATIONS = {
        "COG": "Au lyc√©e et en stage, cela t'aide √† comprendre les consignes, √† t'organiser et √† r√©soudre des probl√®mes techniques.",
        "EMO": "Cela t'aide √† ne pas te laisser d√©border par le stress ou la col√®re, et √† rester professionnel m√™me quand c'est difficile.",
        "SOC": "Indispensable pour travailler en √©quipe, respecter la hi√©rarchie et bien s'entendre avec les clients ou coll√®gues."
    };

    const GOAL_LIBRARY = {
        "Scolaire": {
            "EMO": ["Identifier ses √©motions avant le cours", "Exprimer calmement un ressenti", "R√©guler son stress", "Prendre confiance"],
            "COG": ["Se concentrer sur une t√¢che", "Comprendre une consigne", "Organiser son mat√©riel", "Planifier le travail"],
            "SOC": ["Participer oralement", "Lever la main", "√âcouter sans interrompre", "Travailler en groupe"]
        },
        "PFMP": {
            "EMO": ["G√©rer son stress t√¢che nouvelle", "Accepter une remarque", "G√©rer la fatigue", "Rester motiv√©"],
            "COG": ["Appliquer une proc√©dure", "Organiser poste de travail", "G√©rer temps de travail", "Respecter s√©curit√©"],
            "SOC": ["Saluer l'√©quipe", "Adapter vocabulaire pro", "Adopter posture pro", "Respecter hi√©rarchie"]
        },
        "Recherche": {
            "EMO": ["G√©rer peur du refus", "Oser contacter entreprise", "Pers√©v√©rer"],
            "COG": ["Identifier entreprises", "Pr√©parer CV", "Planifier d√©marches"],
            "SOC": ["Se pr√©senter au t√©l√©phone", "Se pr√©senter en entretien", "Remercier"]
        }
    };

    // --- VARIABLES ---
    let userData = {};
    let draftGoal = {};
    let editGoalId = null;
    let charts = {};
    let breathInterval;

    // --- INIT ---
    window.onload = function() {
        if (!userCode) return;
        document.getElementById('display-code').innerText = userCode;
        
        firebase.database().ref('accompagnement/config/horaires').on('value', (snap) => {
            if(snap.val()) CONFIG_ECOLE = snap.val(); checkAccess();
        });
    };

    function checkAccess() {
        const now = new Date(); const h = now.getHours(); const d = now.getDay();
        if (CONFIG_ECOLE.maintenance || !CONFIG_ECOLE.jours.includes(d) || h < CONFIG_ECOLE.ouverture || h >= CONFIG_ECOLE.fermeture) {
            document.getElementById('loader').style.display='none'; document.getElementById('school-closed').style.display='flex'; return;
        } else { document.getElementById('school-closed').style.display='none'; }

        firebase.database().ref(`accompagnement/autorisations/${userCode}`).on('value', (snap) => {
            const val = snap.val(); document.getElementById('loader').style.display='none';
            if(val && val.autorise) loadData(); 
        });
    }

    function loadData() {
        firebase.database().ref(`accompagnement/eleves/${userCode}`).on('value', (snap) => {
            userData = snap.val() || { objectifs: {}, meteo: {} };
            updateDashboard();
            checkMoodToday();
        });
    }

    // --- DASHBOARD ---
    function updateDashboard() {
        const activeList = document.getElementById('active-goals-list');
        const historyList = document.getElementById('history-goals-list');
        activeList.innerHTML = ''; historyList.innerHTML = '';
        
        let counts = { COG: 0, EMO: 0, SOC: 0 };
        const goals = userData.objectifs || {};
        // Trier : Non faits d'abord, puis par date
        const keys = Object.keys(goals).sort((a,b) => {
            if (goals[a].done === goals[b].done) return new Date(goals[a].date_cible) - new Date(goals[b].date_cible);
            return goals[a].done ? 1 : -1;
        });

        keys.forEach(key => {
            const g = goals[key];
            const type = g.type || 'AUTRE';
            const typeClass = type === 'COG' ? 'cog' : (type === 'EMO' ? 'emo' : (type === 'SOC' ? 'soc' : 'neu'));
            
            // Calcul Date (Correction Bug J-NaN)
            let timeStr = "Date √† d√©finir";
            let isUrgent = false;
            if(g.date_cible) {
                const target = new Date(g.date_cible);
                const today = new Date(); today.setHours(0,0,0,0); target.setHours(0,0,0,0);
                const diff = Math.ceil((target - today) / (1000 * 60 * 60 * 24));
                if (!isNaN(diff)) {
                    timeStr = diff === 0 ? "Aujourd'hui" : (diff < 0 ? "D√©pass√©" : `J-${diff}`);
                    if(diff < 0) isUrgent = true;
                }
            }

            if(g.done) {
                if(counts[type] !== undefined) counts[type]++;
                historyList.innerHTML += `
                <div class="obj-card done ${typeClass}">
                    <div style="font-size:0.8rem; font-weight:bold; color:#10b981;">ATTEINT</div>
                    <div class="fw-bold">${g.titre}</div>
                    <div class="small text-muted">${g.context}</div>
                </div>`;
            } else {
                activeList.innerHTML += `
                <div class="obj-card ${typeClass}" onclick="openEditGoal('${key}')">
                    <div class="d-flex align-items-center w-100">
                        <input type="checkbox" class="form-check-input me-3" style="width:24px;height:24px;" onclick="event.stopPropagation(); validateGoal('${key}')">
                        <div class="w-100">
                            <div class="d-flex justify-content-between align-items-start">
                                <span class="fw-bold lh-sm">${g.titre}</span>
                                <span class="obj-badge">${g.context}</span>
                            </div>
                            <div class="d-flex justify-content-between mt-2">
                                <small class="text-muted">${g.detail || '√Ä compl√©ter'}</small>
                                <small class="countdown ${isUrgent?'urgent':''}">${timeStr}</small>
                            </div>
                        </div>
                    </div>
                </div>`;
            }
        });

        if(activeList.innerHTML === '') activeList.innerHTML = `<div class="text-center py-4 text-muted small">Aucun objectif en cours.</div>`;

        renderDonut('chartCog', counts.COG, '#3b82f6');
        renderDonut('chartEmo', counts.EMO, '#ec4899');
        renderDonut('chartSoc', counts.SOC, '#8b5cf6');
    }

    function validateGoal(key) {
        if(confirm("Confirmer la r√©ussite de cet objectif ?")) {
            firebase.database().ref(`accompagnement/eleves/${userCode}/objectifs/${key}`).update({
                done: true,
                date_done: new Date().toISOString()
            });
        } else {
            updateDashboard(); // Refresh pour d√©cocher
        }
    }

    // --- √âDITION OBJECTIF ---
    window.openEditGoal = function(key) {
        const g = userData.objectifs[key];
        if(!g) return;
        editGoalId = key;
        
        document.getElementById('edit-goal-title').value = g.titre;
        document.getElementById('edit-goal-date').value = g.date_cible || '';
        document.getElementById('edit-goal-context').value = g.detail || '';
        
        // Logique : Titre modifiable SEULEMENT si type AUTRE
        const isFree = (g.type === 'AUTRE' || g.context === 'Autre');
        document.getElementById('edit-goal-title').disabled = !isFree;
        document.getElementById('edit-goal-help').style.display = isFree ? 'none' : 'block';

        document.getElementById('edit-goal-overlay').style.display = 'flex';
    }

    window.saveEditedGoal = function() {
        if(!editGoalId) return;
        const date = document.getElementById('edit-goal-date').value;
        const detail = document.getElementById('edit-goal-context').value;
        const titre = document.getElementById('edit-goal-title').value;

        let updates = { date_cible: date, detail: detail };
        if(!document.getElementById('edit-goal-title').disabled) updates.titre = titre;

        firebase.database().ref(`accompagnement/eleves/${userCode}/objectifs/${editGoalId}`).update(updates);
        closeEditGoal();
    }

    window.deleteGoal = function() {
        if(confirm("Supprimer d√©finitivement cet objectif ?")) {
            firebase.database().ref(`accompagnement/eleves/${userCode}/objectifs/${editGoalId}`).remove();
            closeEditGoal();
        }
    }
    window.closeEditGoal = function() { document.getElementById('edit-goal-overlay').style.display = 'none'; }

    // --- WIZARD CREATION (Pas de changements majeurs, juste s√©curisation) ---
    window.startGoalWizard = function() { draftGoal = {}; document.getElementById('wizard-overlay').style.display = 'flex'; renderWizardStep(1); }
    function renderWizardStep(step) {
        const cont = document.getElementById('wizard-steps'); cont.innerHTML = '';
        if(step===1) {
            cont.innerHTML = `<h5 class="mb-4 fw-bold">1. Choisis le cadre</h5>
                <button class="list-btn" onclick="draftGoal.context='Scolaire'; renderWizardStep(2)">üè´ Scolaire</button>
                <button class="list-btn" onclick="draftGoal.context='PFMP'; renderWizardStep(2)">üíº PFMP / Stage</button>
                <button class="list-btn" onclick="draftGoal.context='Recherche'; renderWizardStep(2)">üîé Recherche Stage</button>
                <button class="list-btn" onclick="draftGoal.context='Autre'; renderWizardStep(4)">‚ú® Autre (Libre)</button>`;
        } else if(step===2) {
            cont.innerHTML = `<button class="btn btn-sm btn-light mb-3" onclick="renderWizardStep(1)">Retour</button><h5 class="mb-4 fw-bold">2. Quel domaine ?</h5>
                <button class="list-btn" onclick="draftGoal.type='COG'; renderWizardStep(3)" style="color:var(--cog-color)">Cognitif (T√™te)</button>
                <button class="list-btn" onclick="draftGoal.type='EMO'; renderWizardStep(3)" style="color:var(--emo-color)">√âmotionnel (C≈ìur)</button>
                <button class="list-btn" onclick="draftGoal.type='SOC'; renderWizardStep(3)" style="color:var(--soc-color)">Social (Lien)</button>
                <button class="list-btn" onclick="draftGoal.type='AUTRE'; renderWizardStep(4)">Autre</button>`;
        } else if(step===3) {
            const list = GOAL_LIBRARY[draftGoal.context]?.[draftGoal.type] || [];
            let h = `<button class="btn btn-sm btn-light mb-3" onclick="renderWizardStep(2)">Retour</button><h5 class="mb-4 fw-bold">3. Choisis ton objectif</h5><div class="list-group">`;
            list.forEach(g => h+=`<button class="list-group-item list-group-item-action" onclick="draftGoal.titre='${g}'; renderWizardStep(4)">${g}</button>`);
            h+=`</div>`; cont.innerHTML = h;
        } else if(step===4) {
            cont.innerHTML = `<button class="btn btn-sm btn-light mb-3" onclick="renderWizardStep(1)">Recommencer</button>
                <h5 class="mb-3 fw-bold">4. D√©tails</h5>
                <label class="edit-label">Pour quand ?</label><input type="date" id="wiz-date" class="form-control mb-3" value="${new Date().toISOString().split('T')[0]}">
                <label class="edit-label">Mati√®re / Lieu</label><input type="text" id="wiz-det" class="form-control mb-3">
                <div class="alert alert-light mt-3"><strong>${draftGoal.titre || 'Libre'}</strong></div>
                <button class="btn btn-primary w-100 rounded-pill py-3 fw-bold" onclick="saveWizard()">Valider</button>`;
        }
    }
    window.saveWizard = function() {
        const d = document.getElementById('wiz-date').value;
        const det = document.getElementById('wiz-det').value;
        if(!d) return alert("Date obligatoire");
        firebase.database().ref(`accompagnement/eleves/${userCode}/objectifs`).push({
            context: draftGoal.context, type: draftGoal.type||'AUTRE', titre: draftGoal.titre||'Objectif Libre',
            date_cible: d, detail: det, done: false, created: new Date().toISOString()
        });
        document.getElementById('wizard-overlay').style.display='none';
    }
    window.closeWizard = function(){document.getElementById('wizard-overlay').style.display='none';}

    // --- CERCLES COMPLETS (V19) ---
    window.openCircleDetail = function(type) {
        const colors = {COG:'var(--cog-color)', EMO:'var(--emo-color)', SOC:'var(--soc-color)'};
        const titles = {COG:'Cognitif', EMO:'√âmotionnel', SOC:'Social'};
        document.getElementById('circle-title').innerText = titles[type];
        document.getElementById('circle-title').style.color = colors[type];
        
        // Remplir Listes
        const goals = userData.objectifs || {};
        let htmlActive = ''; let htmlDone = '';
        Object.values(goals).forEach(g => {
            if(g.type === type) {
                if(g.done) htmlDone += `<div class="mb-2"><i class="fas fa-check text-success me-2"></i>${g.titre}</div>`;
                else htmlActive += `<div class="mb-2 text-dark">‚Ä¢ ${g.titre}</div>`;
            }
        });
        document.getElementById('circle-active-list').innerHTML = htmlActive || '<i class="text-muted small">Aucun</i>';
        document.getElementById('circle-done-list').innerHTML = htmlDone || '<i class="text-muted small">Aucun</i>';

        // Remplir Defs
        document.getElementById('circle-def').innerText = DICTIONNAIRE[titles[type]];
        document.getElementById('circle-exp').innerText = EXPLICATIONS[type];

        // Remplir Dico & Exos
        let htmlDico = ''; Object.keys(DICTIONNAIRE).forEach(k => htmlDico += `<div class="list-group-item"><strong>${k}:</strong> ${DICTIONNAIRE[k]}</div>`);
        document.getElementById('circle-dict-list').innerHTML = htmlDico;

        let htmlExo = ''; (EXERCICES[type]||[]).forEach(e => htmlExo += `<div class="list-group-item">${e}</div>`);
        document.getElementById('circle-ex-list').innerHTML = htmlExo;

        switchCircleTab('suivi'); // Reset tab
        document.getElementById('circle-overlay').style.display = 'flex';
    }
    window.closeCircle = function(){document.getElementById('circle-overlay').style.display='none';}
    window.switchCircleTab = function(tab) {
        document.querySelectorAll('#circle-overlay .nav-link').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        ['suivi','comprendre','pratique'].forEach(t => document.getElementById('tab-'+t).classList.add('hidden'));
        document.getElementById('tab-'+tab).classList.remove('hidden');
    }

    // --- M√âT√âO V19 (2 NIVEAUX) ---
    function checkMoodToday() {
        const today = new Date().toISOString().split('T')[0];
        const m = (userData.meteo && userData.meteo[today]);
        if(m) {
            document.getElementById('mood-summary-box').style.display='flex';
            document.getElementById('mood-display-val').innerText = m.secondary + " (" + m.primary + ")";
        } else {
            openMoodModal(); // Ouvre auto si vide
        }
    }
    window.openMoodModal = function() {
        document.getElementById('mood-overlay').style.display = 'flex';
        // Afficher Etape 1 (Primaire)
        let h = `<h5 class="mb-4 fw-bold text-center">√âtape 1 : L'√©motion principale</h5>`;
        Object.keys(EMOTIONS_V2).forEach(k => {
            h += `<button class="list-btn" onclick="renderMoodStep2('${k}')">${k}</button>`;
        });
        document.getElementById('mood-step-container').innerHTML = h;
    }
    window.renderMoodStep2 = function(prim) {
        let h = `<button class="btn btn-sm btn-light mb-3" onclick="openMoodModal()">Retour</button>
                 <h5 class="mb-4 fw-bold text-center">√âtape 2 : Pr√©cisons (${prim})</h5>`;
        EMOTIONS_V2[prim].forEach(sec => {
            h += `<button class="list-btn" onclick="saveMoodFinal('${prim}', '${sec}')">${sec}</button>`;
        });
        document.getElementById('mood-step-container').innerHTML = h;
    }
    window.saveMoodFinal = function(p, s) {
        const today = new Date().toISOString().split('T')[0];
        firebase.database().ref(`accompagnement/eleves/${userCode}/meteo/${today}`).set({primary: p, secondary: s});
        document.getElementById('mood-overlay').style.display = 'none';
    }

    // --- CHART TOOL ---
    function renderDonut(id, val, col) {
        const ctx = document.getElementById(id); if(!ctx) return;
        if(charts[id]) charts[id].destroy();
        charts[id] = new Chart(ctx.getContext('2d'), {
            type: 'doughnut', 
            data: { datasets: [{ data: val>0?[val, 10]:[0,1], backgroundColor: val>0?[col, '#f1f5f9']:['transparent','#f1f5f9'], borderWidth: 0 }] },
            options: { cutout: '75%', responsive: true, maintainAspectRatio: false, events: [], plugins:{tooltip:{enabled:false}} }
        });
    }

    // --- RESPIRATION ---
    window.startBreathing = function() {
        document.getElementById('breath-overlay').style.display = 'flex';
        const circle = document.getElementById('breath-circle');
        function cycle() {
            circle.innerText = "Inspirer (5s)"; circle.className = "breath-circle inhale";
            setTimeout(() => { circle.innerText = "Expirer (6s)"; circle.className = "breath-circle exhale"; }, 5000);
        }
        cycle(); breathInterval = setInterval(cycle, 11000);
    }
    window.stopBreathing = function() {
        document.getElementById('breath-overlay').style.display = 'none'; clearInterval(breathInterval);
    }
    
    // --- NAV ---
    window.switchView = function(view) {
        document.querySelectorAll('.app-content').forEach(e => e.classList.remove('active'));
        document.getElementById('view-'+view).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(e => e.classList.remove('active'));
        event.currentTarget.classList.add('active');
    }
    window.toggleHistory = function() {
        const h = document.getElementById('history-goals-list'); h.style.display = h.style.display==='none'?'block':'none';
    }
</script>
</body>
</html>
