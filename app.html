<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mon Espace CPS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg-app: #f3f4f6; --surface: #ffffff; --text-main: #1f2937; --text-sec: #6b7280; --primary: #4f46e5; --cog-color: #3b82f6; --emo-color: #ef4444; --soc-color: #10b981; --radius: 16px; --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05); }
        body { background-color: var(--bg-app); color: var(--text-main); font-family: 'Inter', sans-serif; height: 100vh; display: flex; flex-direction: column; }
        
        .app-header { background: var(--surface); padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05); z-index: 10; }
        .user-badge { background: #e0e7ff; color: var(--primary); padding: 0.5rem 1rem; border-radius: 50px; font-weight: 700; font-size: 0.9rem; }
        
        .app-content { flex: 1; overflow-y: auto; padding: 1.5rem; padding-bottom: 100px; display: none; }
        .app-content.active { display: block; animation: fadeIn 0.3s; }
        @keyframes fadeIn { from { opacity:0; } to { opacity:1; } }

        .kpi-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; margin-bottom: 1.5rem; }
        .kpi-card { background: var(--surface); border-radius: var(--radius); padding: 1rem 0.5rem; text-align: center; box-shadow: var(--shadow); display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .kpi-label { font-size: 0.7rem; font-weight: 600; color: var(--text-sec); text-transform: uppercase; margin-top: 5px; }
        .chart-container { position: relative; height: 60px; width: 60px; }
        
        .action-card { background: linear-gradient(135deg, var(--primary), #6366f1); color: white; border-radius: var(--radius); padding: 1.5rem; box-shadow: 0 10px 15px -3px rgba(79, 70, 229, 0.3); margin-bottom: 1.5rem; cursor: pointer; display: flex; align-items: center; justify-content: space-between; }
        .context-card { background: var(--surface); border-radius: var(--radius); padding: 1.2rem; box-shadow: var(--shadow); margin-bottom: 1.5rem; border-left: 5px solid var(--soc-color); }
        .recent-item { background: var(--surface); padding: 1rem; border-radius: 12px; margin-bottom: 0.8rem; display: flex; align-items: center; box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05); }
        .icon-box { width: 40px; height: 40px; border-radius: 10px; display: flex; align-items: center; justify-content: center; margin-right: 1rem; font-size: 1.2rem; }

        .objective-card { background: #fffbeb; border-left: 4px solid #f59e0b; border-radius: 12px; padding: 1rem; margin-bottom: 1.5rem; box-shadow: var(--shadow); display: none; }

        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--surface); border-top: 1px solid #e5e7eb; display: flex; justify-content: space-around; padding: 0.8rem 0; z-index: 20; }
        .nav-item { text-align: center; color: var(--text-sec); background: none; border: none; font-size: 0.8rem; }
        .nav-item.active { color: var(--primary); font-weight: 600; }
        .nav-icon { font-size: 1.4rem; display: block; margin-bottom: 2px; }

        .overlay-full { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-app); z-index: 50; display: none; flex-direction: column; }
        .wizard-header { padding: 1.5rem; background: var(--surface); display: flex; justify-content: space-between; align-items: center; }
        .wizard-content { flex: 1; padding: 2rem 1.5rem; overflow-y: auto; }
        .big-btn-white { background: var(--surface); border: 1px solid #e5e7eb; padding: 1.2rem; border-radius: 12px; width: 100%; margin-bottom: 1rem; text-align: left; display: flex; align-items: center; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        
        .lib-card { background: var(--surface); border-radius: 12px; padding: 1.5rem; margin-bottom: 1rem; cursor: pointer; border-left: 4px solid #ddd; }
        .lib-tag { font-size: 0.7rem; text-transform: uppercase; font-weight: bold; padding: 2px 6px; border-radius: 4px; margin-bottom: 5px; display: inline-block; }
        
        #school-closed { display:none; height:100vh; align-items:center; justify-content:center; flex-direction:column; background: #1e293b; color: white; }
    </style>
</head>
<body>

<div id="loader" style="position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; display:flex; align-items:center; justify-content:center;">
    <div class="spinner-border text-primary" role="status"></div>
</div>

<header class="app-header">
    <div><h5 class="mb-0 fw-bold">Bonjour <span id="display-code">...</span> üëã</h5><small class="text-muted" id="date-display">--</small></div>
    <div class="user-badge"><i class="fas fa-user-graduate"></i></div>
</header>

<main class="app-content active" id="view-dashboard">
    <div id="objectives-card" class="objective-card">
        <h6 class="fw-bold text-warning mb-2">üéØ MON D√âFI SEMAINE</h6>
        <div id="student-obj-list"></div>
    </div>
    <div class="kpi-grid">
        <div class="kpi-card"><div class="chart-container"><canvas id="chartCog"></canvas></div><div class="kpi-label" style="color:var(--cog-color)">Cognitif</div></div>
        <div class="kpi-card"><div class="chart-container"><canvas id="chartEmo"></canvas></div><div class="kpi-label" style="color:var(--emo-color)">√âmotionnel</div></div>
        <div class="kpi-card"><div class="chart-container"><canvas id="chartSoc"></canvas></div><div class="kpi-label" style="color:var(--soc-color)">Social</div></div>
    </div>
    <div class="context-card d-flex align-items-center justify-content-between">
        <div><div class="small text-muted fw-bold mb-1">SUGG√âR√â MAINTENANT</div><h5 class="mb-0 fw-bold" id="current-course">Pause / Libre</h5></div>
        <i class="fas fa-clock text-muted fs-4"></i>
    </div>
    <div class="action-card" onclick="lancerRituel()">
        <div><h4 class="mb-1 fw-bold">Faire le point</h4><div class="small opacity-75">Valider une r√©ussite maintenant</div></div>
        <div style="background:rgba(255,255,255,0.2); width:50px; height:50px; border-radius:50%; display:flex; align-items:center; justify-content:center;"><i class="fas fa-plus fs-4"></i></div>
    </div>
    <h6 class="text-muted fw-bold mb-3 ms-1">DERNI√àRES R√âUSSITES</h6>
    <div id="recent-list"></div>
</main>

<main class="app-content" id="view-library">
    <h4 class="fw-bold mb-3">üéì Mon Espace Savoir</h4>
    <p class="text-muted small mb-4">Comprendre pour mieux agir. Choisis une comp√©tence :</p>
    <div id="library-list"></div>
</main>

<nav class="bottom-nav">
    <button class="nav-item active" onclick="switchView('dashboard')"><i class="nav-icon fas fa-home"></i>Accueil</button>
    <button class="nav-item" onclick="switchView('library')"><i class="nav-icon fas fa-book-open"></i>Savoir</button>
</nav>

<div id="wizard-overlay" class="overlay-full"></div>
<div id="knowledge-overlay" class="overlay-full"></div>
<div id="school-closed"><i class="fas fa-moon mb-3" style="font-size:4rem; color:#fbbf24;"></i><h3 class="fw-bold">Espace en pause</h3><p class="text-white-50 px-4 text-center">Accessible uniquement sur temps scolaire.</p></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<script src="js/firebase-config.js"></script>

<script>
    if (typeof firebaseConfig !== 'undefined') firebase.initializeApp(firebaseConfig);
    const userCode = new URLSearchParams(window.location.search).get("id");
    let CONFIG_ECOLE = { ouverture: 7, fermeture: 22, jours: [1,2,3,4,5,6], maintenance: false };
    
    // --- LISTE COMPL√àTE DES COMP√âTENCES (PRO & D√âTAILL√âE) ---
    const REF_STRUCT = [
        // COGNITIF C1
        { id: "C1.1", default:"Connaissance de soi", axe: "COG", color: "#3b82f6" },
        { id: "C1.2", default:"Pens√©e critique", axe: "COG", color: "#3b82f6" },
        { id: "C1.3", default:"Valeurs et besoins", axe: "COG", color: "#3b82f6" },
        { id: "C1.4", default:"D√©cisions constructives", axe: "COG", color: "#3b82f6" },
        { id: "C1.5", default:"Auto-√©valuation positive", axe: "COG", color: "#3b82f6" },
        { id: "C1.6", default:"Pleine attention", axe: "COG", color: "#3b82f6" },
        // COGNITIF C2
        { id: "C2.1", default:"Atteindre ses buts", axe: "COG", color: "#3b82f6" },
        { id: "C2.2", default:"G√©rer ses impulsions", axe: "COG", color: "#3b82f6" },
        { id: "C2.3", default:"R√©soudre des probl√®mes", axe: "COG", color: "#3b82f6" },
        { id: "C2.4", default:"Demander de l'aide", axe: "COG", color: "#3b82f6" },
        
        // EMOTIONNEL E1
        { id: "E1.1", default:"Comprendre les √©motions", axe: "EMO", color: "#ef4444" },
        { id: "E1.2", default:"Identifier les √©motions", axe: "EMO", color: "#ef4444" },
        // EMOTIONNEL E2
        { id: "E2.2", default:"Exprimer ses √©motions", axe: "EMO", color: "#ef4444" },
        { id: "E2.3", default:"G√©rer son stress", axe: "EMO", color: "#ef4444" },

        // SOCIAL S1
        { id: "S1.1", default:"Communication positive", axe: "SOC", color: "#10b981" },
        { id: "S1.2", default:"Empathie", axe: "SOC", color: "#10b981" },
        { id: "S1.3", default:"Liens prosociaux", axe: "SOC", color: "#10b981" },
        // SOCIAL S2
        { id: "S2.1", default:"S'affirmer / R√©sister", axe: "SOC", color: "#10b981" },
        { id: "S2.2", default:"R√©soudre les conflits", axe: "SOC", color: "#10b981" }
    ];

    let userData = {};
    let libraryData = {}; 
    let wizardData = {};
    let charts = {};

    window.onload = function() {
        if (!userCode) return;
        document.getElementById('display-code').innerText = userCode;
        document.getElementById('date-display').innerText = new Date().toLocaleDateString('fr-FR', { weekday: 'long', day: 'numeric', month: 'long' });

        firebase.database().ref('accompagnement/config/horaires').on('value', (snap) => {
            if(snap.val()) CONFIG_ECOLE = snap.val();
            checkAccess();
        });
        
        firebase.database().ref('accompagnement/contenu_pedagogique').on('value', (snap) => {
            libraryData = snap.val() || {};
            renderLibraryList();
        });
    };

    function checkAccess() {
        const now = new Date(); const jour = now.getDay(); const heure = now.getHours();
        document.getElementById('current-course').innerText = "En Classe / Atelier"; 
        if (CONFIG_ECOLE.maintenance || !CONFIG_ECOLE.jours.includes(jour) || heure < CONFIG_ECOLE.ouverture || heure >= CONFIG_ECOLE.fermeture) {
            document.getElementById('loader').style.display = 'none'; document.getElementById('school-closed').style.display = 'flex'; return;
        } else { document.getElementById('school-closed').style.display = 'none'; }
        firebase.database().ref(`accompagnement/autorisations/${userCode}`).on('value', (snap) => {
            const val = snap.val(); document.getElementById('loader').style.display = 'none';
            if(val && val.autorise) { loadData(); } else { alert("Profil non activ√©."); }
        });
    }

    function loadData() {
        firebase.database().ref(`accompagnement/eleves/${userCode}`).on('value', (snap) => {
            userData = snap.val() || { competences_validees: {}, objectifs: {} };
            updateDashboard();
            renderObjectives(userData.objectifs);
        });
    }

    window.switchView = function(viewName) {
        document.querySelectorAll('.app-content').forEach(el => el.classList.remove('active'));
        document.getElementById('view-' + viewName).classList.add('active');
        document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
        event.currentTarget.classList.add('active');
    }

    function updateDashboard() {
        let counts = { COG: 0, EMO: 0, SOC: 0 };
        let recent = [];
        Object.keys(userData.competences_validees || {}).forEach(key => {
            const item = userData.competences_validees[key];
            if(item.valide) {
                const refItem = REF_STRUCT.find(r => r.id === key.replace('_', '.'));
                if(refItem) counts[refItem.axe]++;
                const safeId = key;
                const customData = libraryData[safeId] || {};
                const titreAffiche = customData.titre_eleve || refItem.default;
                recent.push({ ...item, text: titreAffiche, color: refItem.color });
            }
        });

        renderDonut('chartCog', counts.COG, '#3b82f6');
        renderDonut('chartEmo', counts.EMO, '#ef4444');
        renderDonut('chartSoc', counts.SOC, '#10b981');

        const listContainer = document.getElementById('recent-list');
        listContainer.innerHTML = '';
        recent.sort((a,b) => new Date(b.date) - new Date(a.date)).slice(0, 3).forEach(item => {
            listContainer.innerHTML += `<div class="recent-item"><div class="icon-box" style="background:${item.color}20; color:${item.color}"><i class="fas fa-check"></i></div><div><div class="fw-bold" style="font-size:0.9rem;">${item.text}</div><div class="text-muted" style="font-size:0.75rem;">${item.contexte || 'Autre'}</div></div></div>`;
        });
        if(recent.length === 0) listContainer.innerHTML = '<div class="text-center text-muted small py-3">Rien pour l\'instant.</div>';
    }

    function renderDonut(id, val, col) {
        new Chart(document.getElementById(id).getContext('2d'), {
            type: 'doughnut', data: { datasets: [{ data: val>0?[val,10-val]:[0,1], backgroundColor: val>0?[col,'#e5e7eb']:['transparent','#e5e7eb'], borderWidth: 0 }] }, options: { cutout: '75%', events: [], plugins: { tooltip: { enabled: false } } }
        });
    }

    function renderObjectives(objData) {
        const card = document.getElementById('objectives-card');
        const list = document.getElementById('student-obj-list');
        list.innerHTML = '';
        if(!objData) { card.style.display = 'none'; return; }
        const keys = Object.keys(objData);
        if(keys.length === 0) { card.style.display = 'none'; return; }

        let hasActive = false;
        keys.forEach(key => {
            const obj = objData[key];
            if(!obj.done) {
                hasActive = true;
                list.innerHTML += `<div class="d-flex align-items-center mb-2"><input type="checkbox" class="form-check-input me-2" onchange="checkObjective('${key}')" style="width:20px;height:20px;"><div><div class="fw-bold text-dark">${obj.titre}</div><div class="small text-muted">${obj.mesure || ''}</div></div></div>`;
            }
        });
        card.style.display = hasActive ? 'block' : 'none';
    }

    window.checkObjective = function(key) {
        if(confirm("Bravo ! Tu as r√©ussi ce d√©fi ?")) {
            firebase.database().ref(`accompagnement/eleves/${userCode}/objectifs/${key}`).update({ done: true });
        }
    }

    function renderLibraryList() {
        const container = document.getElementById('library-list');
        container.innerHTML = '';
        REF_STRUCT.forEach(ref => {
            const safeId = ref.id.replace('.', '_');
            const data = libraryData[safeId] || {};
            const title = data.titre_eleve || ref.default;
            container.innerHTML += `<div class="lib-card" style="border-left-color: ${ref.color}" onclick="openKnowledge('${safeId}', '${ref.color}', '${ref.id}')"><span class="lib-tag" style="background:${ref.color}20; color:${ref.color}">${ref.axe}</span><h6 class="fw-bold mb-1">${title}</h6><small class="text-muted">Clique pour comprendre</small></div>`;
        });
    }

    window.openKnowledge = function(safeId, color, codeOfficiel) {
        const data = libraryData[safeId] || {};
        const title = data.titre_eleve || "Titre √† d√©finir";
        const science = data.explication_scientifique || "Pas encore d'explication.";
        const pourquoi = data.pourquoi_scolaire || "Pas encore pr√©cis√©.";
        const outils = data.boite_a_outils || ["Aucun exercice."];
        const lienExterne = data.lien_externe || ""; 

        let outilsHtml = "";
        if(Array.isArray(outils)) outils.forEach(o => outilsHtml += `<li>${o}</li>`); else outilsHtml = `<li>${outils}</li>`;

        let boutonExercice = "";
        if(lienExterne && lienExterne.startsWith("http")) {
            boutonExercice = `<div class="mt-4 pt-3 border-top"><label class="small fw-bold text-primary mb-2">PRATIQUE EXT√âRIEURE</label><a href="${lienExterne}" target="_blank" class="btn btn-outline-primary w-100 py-3 fw-bold rounded-pill"><i class="fas fa-external-link-alt me-2"></i> Faire l'exercice en ligne</a><div class="text-center mt-2"><small class="text-muted fst-italic">Ouvre une nouvelle page. Reviens ici quand tu as fini ! ‚Ü©Ô∏è</small></div></div>`;
        }

        const overlay = document.getElementById('knowledge-overlay');
        overlay.innerHTML = `<div class="wizard-header border-bottom"><button class="btn btn-sm btn-light rounded-circle" onclick="closeKnowledge()">‚úï</button><span class="badge bg-light text-dark">${codeOfficiel}</span></div><div class="wizard-content"><h3 class="fw-bold mb-3" style="color:${color}">${title}</h3><div class="card border-0 shadow-sm p-3 mb-3 bg-white"><label class="small fw-bold text-muted">üí° C'EST QUOI ?</label><p class="mb-0">${science}</p></div><div class="card border-0 shadow-sm p-3 mb-3 bg-white"><label class="small fw-bold text-muted">üéì POURQUOI √Ä L'√âCOLE ?</label><p class="mb-0">${pourquoi}</p></div><div class="card border-0 shadow-sm p-3 mb-3 bg-white"><label class="small fw-bold text-muted">üõ†Ô∏è BO√éTE √Ä OUTILS</label><ul class="mb-0 ps-3">${outilsHtml}</ul></div>${boutonExercice}</div>`;
        overlay.style.display = 'flex';
    }
    window.closeKnowledge = function() { document.getElementById('knowledge-overlay').style.display = 'none'; }

    window.lancerRituel = function() { document.getElementById('wizard-overlay').style.display = 'flex'; showStep(1); }
    window.showStep = function(step) {
        const overlay = document.getElementById('wizard-overlay'); overlay.innerHTML = '';
        if(step===1) {
            overlay.innerHTML = `<div class="wizard-header"><h5 class="fw-bold mb-0">C'√©tait o√π ? üè´</h5><button class="btn-close" onclick="closeWizard()"></button></div><div class="wizard-content"><button class="big-btn-white" onclick="selectContext('COURS')"><div><div class="fw-bold">En Cours</div></div></button><button class="big-btn-white" onclick="selectContext('ATELIER')"><div><div class="fw-bold">En Atelier</div></div></button><button class="big-btn-white" onclick="selectContext('STAGE')"><div><div class="fw-bold">En Stage</div></div></button></div>`;
        } else if(step===2) {
             let html = `<div class="wizard-header"><button class="btn btn-sm btn-light" onclick="showStep(1)">‚Üê</button><h5 class="fw-bold mb-0">Ta R√©ussite</h5><div></div></div><div class="wizard-content">`;
             REF_STRUCT.forEach(c => { const safeId = c.id.replace('.','_'); const titre = (libraryData[safeId] && libraryData[safeId].titre_eleve) || c.default; html += `<button class="big-btn-white" onclick="selectComp('${c.id}')" style="border-left:4px solid ${c.color}"><div><div class="fw-bold">${titre}</div></div></button>`; });
             html += `</div>`; overlay.innerHTML = html;
        } else if(step===3) {
            overlay.innerHTML = `<div class="wizard-header"><button class="btn btn-sm btn-light" onclick="showStep(2)">‚Üê</button><h5 class="fw-bold mb-0">D√©tails</h5><div></div></div><div class="wizard-content text-start"><label class="form-label fw-bold small">NIVEAU</label><select id="wiz-niveau" class="form-select mb-3"><option value="1">‚≠ê D√©couverte</option><option value="2">‚≠ê‚≠ê Application</option><option value="3">‚≠ê‚≠ê‚≠ê Ma√Ætrise</option></select><label class="form-label fw-bold small">PREUVE</label><textarea id="wiz-preuve" class="form-control mb-4" rows="3"></textarea><button class="btn btn-primary w-100 py-3 rounded-pill fw-bold" onclick="save()">‚úÖ Valider</button></div>`;
        }
    }
    window.closeWizard = function() { document.getElementById('wizard-overlay').style.display = 'none'; }
    window.selectContext = function(ctx) { wizardData.contexte = ctx; showStep(2); }
    window.selectComp = function(id) { wizardData.comp = id; showStep(3); }
    window.save = function() {
        const preuve = document.getElementById('wiz-preuve').value; const niveau = document.getElementById('wiz-niveau').value;
        if(preuve.length<3) { alert("Preuve requise"); return; }
        const safeId = wizardData.comp.replace(/\./g, '_');
        const data = { valide: true, niveau: parseInt(niveau), preuve: preuve, contexte: wizardData.contexte, date: new Date().toISOString() };
        firebase.database().ref(`accompagnement/eleves/${userCode}/competences_validees/${safeId}`).set(data).then(() => { closeWizard(); });
    }
</script>
</body>
</html>
