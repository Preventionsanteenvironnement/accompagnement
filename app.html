<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>My CPS Space</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg-dark: #0f172a; --card-dark: #1e293b; --neon-blue: #38bdf8; --neon-purple: #c084fc; --neon-green: #4ade80; }
        body { background-color: var(--bg-dark); color: #f1f5f9; font-family: 'Outfit', sans-serif; padding-bottom: 80px; }
        .hero-section { background: radial-gradient(circle at top right, rgba(192, 132, 252, 0.15), transparent 40%), radial-gradient(circle at top left, rgba(56, 189, 248, 0.15), transparent 40%); padding: 2rem 1.5rem; text-align: center; border-bottom: 1px solid rgba(255,255,255,0.05); }
        .badge-code { background: rgba(255,255,255,0.1); border: 1px solid rgba(255,255,255,0.2); backdrop-filter: blur(10px); padding: 0.5rem 1.2rem; border-radius: 50px; font-weight: 700; color: var(--neon-blue); box-shadow: 0 0 15px rgba(56, 189, 248, 0.3); }
        .card-stats, .card { background: var(--card-dark); border: 1px solid rgba(255,255,255,0.05); border-radius: 20px; box-shadow: 0 10px 30px rgba(0,0,0,0.3); color: white; }
        .form-check-input { background-color: #334155; border-color: #475569; height: 1.5em; width: 3em; }
        .form-check-input:checked { background-color: var(--neon-green); border-color: var(--neon-green); box-shadow: 0 0 10px rgba(74, 222, 128, 0.5); }
        #access-denied .card { border: 1px solid rgba(239, 68, 68, 0.3); }
        .modal-content { background-color: #1e293b; border: 1px solid rgba(255,255,255,0.1); color: white; border-radius: 20px; }
        .modal-header, .modal-footer { border-color: rgba(255,255,255,0.05); }
        .form-control, .form-select { background-color: #0f172a; border: 1px solid #334155; color: white; border-radius: 10px; }
        .form-control:focus { background-color: #0f172a; color: white; border-color: var(--neon-purple); box-shadow: 0 0 0 0.25rem rgba(192, 132, 252, 0.25); }
        .fade-in { animation: fadeIn 0.8s ease-out; }
        #school-closed .icon-closed { font-size: 4rem; margin-bottom: 1rem; }
    </style>
</head>
<body>

<div id="loader" class="text-center mt-5 pt-5">
    <div class="spinner-border text-info" role="status" style="width: 3rem; height: 3rem;"></div>
    <p class="mt-3 opacity-75">Chargement...</p>
</div>

<div id="access-denied" class="container mt-5 pt-5 text-center" style="display:none;">
    <div class="card p-5">
        <h3 class="mb-3 text-danger">‚õî Acc√®s Restreint</h3>
        <p class="text-white-50">Ton profil n'est pas activ√© par ton professeur.</p>
    </div>
</div>

<div id="school-closed" class="container mt-5 pt-5 text-center" style="display:none;">
    <div class="card p-5 border-warning">
        <div class="icon-closed">üåô</div>
        <h3 class="mb-3 text-warning">Espace Ferm√©</h3>
        <p class="text-white-50">L'application est accessible uniquement<br>pendant les heures scolaires.</p>
        <div class="badge bg-dark mt-3 p-3">
            Lundi - Vendredi<br>
            08:00 - 18:00
        </div>
    </div>
</div>

<div id="dashboard-content" style="display:none;" class="fade-in">
    <div class="hero-section">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <span style="font-size: 1.2rem;">üëã Hello !</span>
            <span id="code-eleve-display" class="badge-code">--</span>
        </div>
        <h1 class="display-6 fw-bold mb-0">Mon Parcours <span style="color:var(--neon-purple)">CPS</span></h1>
    </div>
    <div class="container mt-4">
        <div class="row g-4 justify-content-center">
            <div class="col-md-8 col-lg-6">
                <div class="card-stats p-3 text-center">
                    <h5 class="mb-4 text-white-50 text-start ps-2">üî• Mes Stats</h5>
                    <div style="position: relative; height: 300px;"><canvas id="radarChart"></canvas></div>
                </div>
            </div>
            <div class="col-md-8 col-lg-6">
                <h5 class="mb-3 ps-2 text-white-50">üöÄ Mes Objectifs</h5>
                <div id="actions-container" class="pb-5"></div>
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="proofModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">‚ú® Valider une r√©ussite</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <h6 id="modal-comp-title" class="text-info mb-3">--</h6>
                <label class="form-label small text-muted">Mon niveau d'autonomie :</label>
                <div class="mb-3">
                    <select id="input-niveau" class="form-select">
                        <option value="1">‚≠ê J'ai d√©couvert (Niveau 1)</option>
                        <option value="2">‚≠ê‚≠ê J'ai appliqu√© (Niveau 2)</option>
                        <option value="3">‚≠ê‚≠ê‚≠ê Je ma√Ætrise (Niveau 3)</option>
                        <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê Je peux transmettre (Expert)</option>
                    </select>
                </div>
                <label class="form-label small text-muted">Ma preuve (O√π ? Quand ? Comment ?) :</label>
                <textarea id="input-preuve" class="form-control" rows="3" placeholder="Ex: J'ai r√©ussi √† g√©rer mon stress..."></textarea>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary rounded-pill" data-bs-dismiss="modal">Annuler</button>
                <button type="button" class="btn btn-primary rounded-pill" onclick="sauvegarderPreuve()">‚úÖ Valider</button>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<script src="js/firebase-config.js"></script>

<script>
    if (typeof firebaseConfig !== 'undefined') firebase.initializeApp(firebaseConfig);
    const userCode = new URLSearchParams(window.location.search).get("id");
    
    // --- CONFIGURATION HORAIRES ---
    const HEURE_OUVERTURE = 8;
    const HEURE_FERMETURE = 18;
    const JOURS_OUVERTS = [1, 2, 3, 4, 5];

    // --- LE DICTIONNAIRE TRADUIT (Simplifi√© pour l'√©l√®ve) ---
    const REFERENTIEL_DATA = { 
      "axes": [
        { 
          "id": "COG", "nom": "Mes Pens√©es", "phases": [ 
            { "id": 1, "competences_generales": [ 
              { "id": "C1", "nom": "Savoir qui je suis", "competences_specifiques": [ 
                  { "id": "C1.1", "nom": "Savoir ce que je vaux et qui je suis" }, 
                  { "id": "C1.2", "nom": "Prendre du recul / Ne pas juger trop vite" }, 
                  { "id": "C1.3", "nom": "Identifier ce qui est important pour moi" }, 
                  { "id": "C1.4", "nom": "Faire des choix r√©fl√©chis" }, 
                  { "id": "C1.5", "nom": "Reconna√Ætre mes r√©ussites" }, 
                  { "id": "C1.6", "nom": "Rester concentr√© sur l'instant" } 
              ] } 
            ] } 
          ] 
        },
        { 
          "id": "EMO", "nom": "Mes √âmotions", "phases": [ 
            { "id": 1, "competences_generales": [ 
              { "id": "E1", "nom": "G√©rer mes √©motions", "competences_specifiques": [ 
                  { "id": "E1.1", "nom": "Comprendre pourquoi je r√©agis comme √ßa" }, 
                  { "id": "E1.2", "nom": "Mettre un nom sur ce que je ressens" } 
              ] } 
            ] } 
          ] 
        },
        { 
          "id": "SOC", "nom": "Mes Relations", "phases": [ 
            { "id": 1, "competences_generales": [ 
              { "id": "S1", "nom": "Avoir de bonnes relations", "competences_specifiques": [ 
                  { "id": "S1.1", "nom": "M'exprimer calmement et clairement" }, 
                  { "id": "S1.2", "nom": "√âcouter et comprendre les autres" }, 
                  { "id": "S1.3", "nom": "√ätre solidaire et respectueux" } 
              ] } 
            ] } 
          ] 
        }
      ]
    };
    
    let userData = { competences_validees: {} };
    let currentCompId = null;
    let proofModal = null;

    const sanitize = (id) => id.replace(/\./g, '_');

    Chart.defaults.color = '#94a3b8'; Chart.defaults.borderColor = 'rgba(255,255,255,0.1)';
    const ctx = document.getElementById('radarChart').getContext('2d');
    let gradient = ctx.createLinearGradient(0, 0, 0, 400); gradient.addColorStop(0, 'rgba(192, 132, 252, 0.5)'); gradient.addColorStop(1, 'rgba(56, 189, 248, 0.1)');
    window.myRadarChart = new Chart(ctx, { type: 'radar', data: { labels: ['Pens√©es', 'Relations', '√âmotions'], datasets: [{ label: 'Score', data: [0, 0, 0], backgroundColor: gradient, borderColor: '#c084fc', pointBackgroundColor: '#fff', borderWidth: 3 }] }, options: { scales: { r: { angleLines: { color: 'rgba(255,255,255,0.1)' }, grid: { color: 'rgba(255,255,255,0.05)' }, pointLabels: { font: { size: 14, family: "'Outfit', sans-serif" }, color: '#f1f5f9' }, suggestedMin: 0, suggestedMax: 100, ticks: { display: false } } }, plugins: { legend: { display: false } }, maintainAspectRatio: false } });

    function estDansLesHoraires() {
        const now = new Date();
        const jour = now.getDay(); 
        const heure = now.getHours();
        if (!JOURS_OUVERTS.includes(jour) || heure < HEURE_OUVERTURE || heure >= HEURE_FERMETURE) {
            return false;
        }
        return true;
    }

    window.onload = function() {
        if (!userCode) return;
        document.getElementById('code-eleve-display').innerText = userCode;
        proofModal = new bootstrap.Modal(document.getElementById('proofModal'));

        // V√©rification Horaire
        if (!estDansLesHoraires()) {
            document.getElementById('loader').style.display = 'none';
            document.getElementById('school-closed').style.display = 'block';
            return; 
        }

        // V√©rification Firebase
        firebase.database().ref(`accompagnement/autorisations/${userCode}`).on('value', (snapshot) => {
            const data = snapshot.val();
            const estAutorise = (data && data.autorise === true);
            document.getElementById('loader').style.display = 'none';
            
            if (estAutorise) {
                document.getElementById('access-denied').style.display = 'none';
                document.getElementById('dashboard-content').style.display = 'block';
                chargerDonneesEleve();
            } else {
                document.getElementById('dashboard-content').style.display = 'none';
                document.getElementById('access-denied').style.display = 'block';
            }
        });
    };

    function chargerDonneesEleve() {
        firebase.database().ref(`accompagnement/eleves/${userCode}`).on('value', (snapshot) => {
            const val = snapshot.val();
            if (val) { userData = val; if (!userData.competences_validees) userData.competences_validees = {}; }
            updateUI();
        });
    }

    function updateUI() {
        const scores = { "COG": 0, "EMO": 0, "SOC": 0 }; const totals = { "COG": 0, "EMO": 0, "SOC": 0 };
        REFERENTIEL_DATA.axes.forEach(axe => { axe.phases.forEach(phase => { phase.competences_generales.forEach(cg => { cg.competences_specifiques.forEach(cs => { 
            totals[axe.id]++; 
            const safeId = sanitize(cs.id);
            if (userData.competences_validees && userData.competences_validees[safeId] && userData.competences_validees[safeId].valide) {
                scores[axe.id]++; 
            }
        }); }); }); });
        window.myRadarChart.data.datasets[0].data = [ totals["COG"]?Math.round((scores["COG"]/totals["COG"])*100):0, totals["SOC"]?Math.round((scores["SOC"]/totals["SOC"])*100):0, totals["EMO"]?Math.round((scores["EMO"]/totals["EMO"])*100):0 ];
        window.myRadarChart.update();

        const container = document.getElementById('actions-container'); container.innerHTML = '';
        REFERENTIEL_DATA.axes.forEach(axe => { axe.phases.forEach(phase => { phase.competences_generales.forEach(cg => { cg.competences_specifiques.forEach(cs => {
            const safeId = sanitize(cs.id);
            const infoComp = (userData.competences_validees && userData.competences_validees[safeId]) ? userData.competences_validees[safeId] : null;
            const estValide = infoComp && infoComp.valide;
            
            const card = document.createElement('div');
            card.className = `card mb-3 p-3 ${estValide ? 'border-success' : ''}`; card.style.cursor = 'pointer'; card.style.background = '#1e293b'; card.style.borderColor = estValide ? '#4ade80' : 'rgba(255,255,255,0.1)';
            
            let detailsHtml = '';
            if(estValide) {
                const etoiles = "‚≠ê".repeat(infoComp.niveau || 1);
                detailsHtml = `<div class="mt-2 small text-muted border-top border-secondary pt-2"><span class="text-warning">${etoiles}</span> <br> <em>"${infoComp.preuve || ''}"</em></div>`;
            }

            // Ici on affiche cs.nom qui contient maintenant la phrase simple (ex: Savoir ce que je vaux)
            card.innerHTML = `<div class="d-flex justify-content-between align-items-center text-white"><div style="width: 100%"><strong style="font-size: 1.1em;">${cs.nom}</strong><br><small style="color: #94a3b8;">${cg.nom}</small>${detailsHtml}</div><div class="form-check form-switch ms-2"><input class="form-check-input" type="checkbox" ${estValide ? 'checked' : ''} disabled></div></div>`;
            card.onclick = () => ouvrirModalePreuve(cs.id, cs.nom, estValide, safeId);
            container.appendChild(card);
        }); }); }); });
    }

    function ouvrirModalePreuve(id, nom, estDejaValide, safeId) {
        currentCompId = safeId;
        document.getElementById('modal-comp-title').innerText = nom;
        document.getElementById('input-preuve').value = "";
        document.getElementById('input-niveau').value = "1";

        if (userData.competences_validees && userData.competences_validees[safeId]) {
            document.getElementById('input-preuve').value = userData.competences_validees[safeId].preuve || "";
            document.getElementById('input-niveau').value = userData.competences_validees[safeId].niveau || "1";
        }
        proofModal.show();
    }

    function sauvegarderPreuve() {
        if(!currentCompId) return;
        const niveau = parseInt(document.getElementById('input-niveau').value);
        const preuve = document.getElementById('input-preuve').value;

        if(preuve.length < 3) { alert("Merci d'√©crire une phrase !"); return; }

        const dataToSave = { valide: true, niveau: niveau, preuve: preuve, date: new Date().toISOString() };
        firebase.database().ref(`accompagnement/eleves/${userCode}/competences_validees/${currentCompId}`).set(dataToSave);
        proofModal.hide();
    }
</script>
</body>
</html>
