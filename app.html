<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mon Rituel CPS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;500;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg-dark: #0f172a; --card-dark: #1e293b; --neon-blue: #38bdf8; --neon-purple: #c084fc; --neon-green: #4ade80; }
        body { background-color: var(--bg-dark); color: #f1f5f9; font-family: 'Outfit', sans-serif; height: 100vh; overflow: hidden; }
        
        /* Structure du Wizard (√âtapes) */
        .step-container { display: none; height: 100%; flex-direction: column; justify-content: center; align-items: center; padding: 20px; text-align: center; animation: fadeIn 0.5s ease; }
        .step-active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Boutons G√©ants */
        .btn-big-choice { background: var(--card-dark); border: 2px solid rgba(255,255,255,0.1); color: white; width: 100%; padding: 1.5rem; margin-bottom: 1rem; border-radius: 20px; transition: all 0.2s; text-align: left; display: flex; align-items: center; justify-content: space-between; }
        .btn-big-choice:active { transform: scale(0.98); border-color: var(--neon-blue); background: rgba(56, 189, 248, 0.1); }
        .btn-big-choice h5 { margin: 0; font-weight: 700; }
        .btn-big-choice small { color: #94a3b8; }
        .btn-icon { font-size: 2rem; margin-right: 15px; }

        /* Indicateur de progression */
        .progress-dots { position: fixed; top: 20px; left: 0; width: 100%; text-align: center; z-index: 100; }
        .dot { height: 8px; width: 8px; background-color: rgba(255,255,255,0.2); border-radius: 50%; display: inline-block; margin: 0 5px; transition: all 0.3s; }
        .dot.active { background-color: var(--neon-blue); transform: scale(1.5); }

        /* Emojis Ressenti */
        .emoji-btn { font-size: 3rem; background: transparent; border: none; transition: transform 0.2s; margin: 0 10px; cursor: pointer; opacity: 0.6; }
        .emoji-btn.selected { transform: scale(1.3); opacity: 1; filter: drop-shadow(0 0 10px var(--neon-purple)); }
        
        /* Espace Ferm√© */
        #school-closed { display:none; height:100vh; align-items:center; justify-content:center; flex-direction:column; }
        .closed-icon { font-size: 5rem; margin-bottom: 20px; opacity: 0.5; }
    </style>
</head>
<body>

<div id="loader" class="text-center mt-5 pt-5"><div class="spinner-border text-info" role="status"></div></div>

<div id="progress-bar" class="progress-dots" style="display:none;">
    <span class="dot active" id="dot-1"></span>
    <span class="dot" id="dot-2"></span>
    <span class="dot" id="dot-3"></span>
    <span class="dot" id="dot-4"></span>
</div>

<div id="step-0" class="step-container">
    <h1 class="fw-bold mb-4">Hello <span class="text-info" id="display-code">--</span> ! üëã</h1>
    <div class="card p-3 mb-4" style="background: rgba(255,255,255,0.05); border-radius: 15px; width: 100%; max-width: 400px;">
        <h6 class="text-white-50">Ma Progression</h6>
        <canvas id="miniRadar" style="max-height: 200px;"></canvas>
    </div>
    <button class="btn btn-lg btn-primary rounded-pill w-100 py-3 fw-bold" style="max-width: 400px; background: linear-gradient(45deg, var(--neon-blue), var(--neon-purple)); border:none;" onclick="goToStep(1)">
        ‚ú® Faire mon point du jour
    </button>
</div>

<div id="step-1" class="step-container">
    <h2 class="mb-2">C'√©tait o√π ? üè´</h2>
    <p class="text-white-50 mb-4">S√©lectionne le moment cl√© de ta journ√©e.</p>
    
    <div id="context-suggestions" style="width: 100%; max-width: 400px;">
        </div>

    <button class="btn btn-outline-secondary rounded-pill mt-3" onclick="goToStep(0)">Annuler</button>
</div>

<div id="step-2" class="step-container">
    <h2 class="mb-2">Ta r√©ussite üöÄ</h2>
    <p class="text-white-50 mb-4">Qu'as-tu r√©ussi √† faire dans ce contexte ?</p>
    
    <div id="competence-list" style="width: 100%; max-width: 400px; overflow-y: auto; max-height: 60vh;">
        </div>
    <button class="btn btn-outline-secondary rounded-pill mt-3" onclick="goToStep(1)">Retour</button>
</div>

<div id="step-3" class="step-container">
    <h2 class="mb-3 text-info" id="selected-comp-title">...</h2>
    
    <div style="width: 100%; max-width: 400px;">
        <label class="small text-muted mb-2">Mon niveau d'autonomie :</label>
        <select id="input-niveau" class="form-select form-select-lg mb-4 bg-dark text-white border-secondary">
            <option value="1">‚≠ê J'ai d√©couvert (Niveau 1)</option>
            <option value="2">‚≠ê‚≠ê J'ai appliqu√© (Niveau 2)</option>
            <option value="3">‚≠ê‚≠ê‚≠ê Je ma√Ætrise (Niveau 3)</option>
            <option value="4">‚≠ê‚≠ê‚≠ê‚≠ê Je transmets (Expert)</option>
        </select>

        <label class="small text-muted mb-2">Raconte ce moment (Preuve) :</label>
        <textarea id="input-preuve" class="form-control bg-dark text-white border-secondary mb-4" rows="4" placeholder="Ex: Pendant l'exercice de maths, j'ai..."></textarea>
        
        <button class="btn btn-primary btn-lg w-100 rounded-pill" onclick="goToStep(4)">Continuer ‚û°</button>
    </div>
    <button class="btn btn-link text-white-50 mt-2" onclick="goToStep(2)">Retour</button>
</div>

<div id="step-4" class="step-container">
    <h2 class="mb-4">Comment tu te sens ? üå§Ô∏è</h2>
    
    <div class="d-flex justify-content-center flex-wrap mb-5">
        <button class="emoji-btn" onclick="selectFeeling('fier', this)">üòé<div class="fs-6 mt-2">Fier(e)</div></button>
        <button class="emoji-btn" onclick="selectFeeling('bien', this)">üôÇ<div class="fs-6 mt-2">Bien</div></button>
        <button class="emoji-btn" onclick="selectFeeling('mitige', this)">üòê<div class="fs-6 mt-2">Mitig√©(e)</div></button>
        <button class="emoji-btn" onclick="selectFeeling('stresse', this)">ü§Ø<div class="fs-6 mt-2">Stress√©(e)</div></button>
        <button class="emoji-btn" onclick="selectFeeling('fatigue', this)">üò¥<div class="fs-6 mt-2">Fatigu√©(e)</div></button>
    </div>

    <button id="btn-save-final" class="btn btn-success btn-lg rounded-pill w-100 py-3 fw-bold" style="max-width: 400px; display:none;" onclick="finaliserSauvegarde()">
        ‚úÖ Valider ma journ√©e
    </button>
</div>

<div id="school-closed">
    <div class="closed-icon">üåô</div>
    <h3 class="text-warning">Espace en pause</h3>
    <p class="text-white-50 text-center px-4">L'application est accessible uniquement<br>pendant les heures scolaires.</p>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<script src="js/firebase-config.js"></script>

<script>
    // --- 1. CONFIGURATION MODIFIABLE ---
    const CONFIG_ECOLE = { ouverture: 7, fermeture: 22, jours: [1,2,3,4,5,6], maintenance: false }; // Large pour tests

    // --- EMPLOI DU TEMPS INTELLIGENT (A/B) ---
    // Vous pouvez modifier les mati√®res ici. Si une case est vide, on propose "Cours".
    const EMPLOI_DU_TEMPS = {
        "A": {
            1: ["Francais", "Maths", "Anglais", "Atelier Pro"], // Lundi (1)
            2: ["Histoire", "Eco-Gestion", "EPS", "Vie de Classe"], // Mardi (2)
            3: ["Anglais", "Maths", "Soutien"], // Mercredi (3)
            4: ["Atelier Pro", "Atelier Pro", "PSE", "Espagnol"], // Jeudi (4)
            5: ["Chef d'Oeuvre", "Co-Intervention", "Fran√ßais", "Arts"] // Vendredi (5)
        },
        "B": {
            // Copiez la structure de A si c'est pareil, ou changez pour B
            1: ["Francais", "Maths", "Anglais", "Atelier Pro"],
            2: ["Histoire", "Eco-Gestion", "EPS", "Vie de Classe"],
            3: ["Anglais", "Maths", "Soutien"],
            4: ["Atelier Pro", "Atelier Pro", "PSE", "Espagnol"],
            5: ["Chef d'Oeuvre", "Co-Intervention", "Fran√ßais", "Arts"]
        }
    };

    // --- DICTIONNAIRE TRADUIT ---
    const REF_SIMPLE = [
        { id: "C1.1", text: "Savoir ce que je vaux", axe: "COG" },
        { id: "C1.2", text: "Ne pas juger trop vite", axe: "COG" },
        { id: "C1.4", text: "Faire des choix r√©fl√©chis", axe: "COG" },
        { id: "C1.6", text: "Rester concentr√©", axe: "COG" },
        { id: "E1.1", text: "Comprendre ma r√©action", axe: "EMO" },
        { id: "E1.2", text: "Nommer mon √©motion", axe: "EMO" },
        { id: "S1.1", text: "Parler calmement", axe: "SOC" },
        { id: "S1.2", text: "√âcouter les autres", axe: "SOC" },
        { id: "S1.3", text: "Aider ou encourager", axe: "SOC" }
    ];

    // --- VARIABLES ---
    if (typeof firebaseConfig !== 'undefined') firebase.initializeApp(firebaseConfig);
    const userCode = new URLSearchParams(window.location.search).get("id");
    let currentData = { contexte: "", competenceId: "", niveau: 1, preuve: "", feeling: "" };
    let userData = {};

    // --- INITIALISATION ---
    window.onload = function() {
        if (!userCode) return;
        document.getElementById('display-code').innerText = userCode;

        // V√©rif Horaires
        if(!checkHoraires()) return;

        // Firebase Auth
        firebase.database().ref(`accompagnement/autorisations/${userCode}`).on('value', (snap) => {
            const val = snap.val();
            document.getElementById('loader').style.display = 'none';
            if(val && val.autorise) {
                document.querySelector('.step-container').classList.add('step-active');
                loadUserData();
            } else {
                alert("Acc√®s non activ√© par le professeur.");
            }
        });
    };

    function checkHoraires() {
        const now = new Date();
        const jour = now.getDay();
        const heure = now.getHours();
        if (CONFIG_ECOLE.maintenance || !CONFIG_ECOLE.jours.includes(jour) || heure < CONFIG_ECOLE.ouverture || heure >= CONFIG_ECOLE.fermeture) {
            document.getElementById('loader').style.display = 'none';
            document.getElementById('school-closed').style.display = 'flex';
            return false;
        }
        return true;
    }

    function loadUserData() {
        firebase.database().ref(`accompagnement/eleves/${userCode}`).once('value', (snap) => {
            userData = snap.val() || { competences_validees: {} };
            initMiniChart();
        });
    }

    // --- NAVIGATION WIZARD ---
    window.goToStep = function(stepNum) {
        // Masquer toutes les √©tapes
        document.querySelectorAll('.step-container').forEach(el => el.classList.remove('step-active'));
        
        // Afficher la bonne
        document.getElementById(`step-${stepNum}`).classList.add('step-active');
        
        // G√©rer la barre de progression
        const dots = document.getElementById('progress-bar');
        if(stepNum > 0) {
            dots.style.display = 'block';
            document.querySelectorAll('.dot').forEach((d, i) => {
                d.classList.toggle('active', i < stepNum);
            });
        } else {
            dots.style.display = 'none';
        }

        // Logique sp√©cifique par √©tape
        if(stepNum === 1) generateContextSuggestions();
        if(stepNum === 2) generateCompetenceList();
    };

    // --- √âTAPE 1 : CONTEXTE INTELLIGENT ---
    function generateContextSuggestions() {
        const container = document.getElementById('context-suggestions');
        container.innerHTML = '';

        // 1. D√©terminer Semaine A ou B (Simple simulation bas√©e sur le num√©ro de semaine)
        const now = new Date();
        const weekNum = getWeekNumber(now);
        const typeSemaine = (weekNum % 2 === 0) ? "B" : "A"; // Impair=A, Pair=B (modifiable)
        const jourSemaine = now.getDay(); // 1 = Lundi
        
        let suggestions = [];

        // 2. Chercher dans l'emploi du temps
        if(EMPLOI_DU_TEMPS[typeSemaine] && EMPLOI_DU_TEMPS[typeSemaine][jourSemaine]) {
            const matieres = EMPLOI_DU_TEMPS[typeSemaine][jourSemaine];
            // On prend tout pour l'instant (ou on pourrait filtrer matin/aprem)
            matieres.forEach(m => suggestions.push({ type: 'COURS', label: m, icon: 'üìö' }));
        }

        // 3. Ajouter les options fixes
        suggestions.push({ type: 'ATELIER', label: 'En Atelier', icon: 'üõ†Ô∏è' });
        suggestions.push({ type: 'STAGE', label: 'En Stage / PFMP', icon: 'üíº' });
        suggestions.push({ type: 'AUTRE', label: 'Autre / Vie Scolaire', icon: 'üè†' });

        // 4. G√©n√©rer les boutons
        suggestions.forEach(sugg => {
            const btn = document.createElement('button');
            btn.className = 'btn-big-choice';
            btn.innerHTML = `<span class="btn-icon">${sugg.icon}</span> <div><h5>${sugg.label}</h5><small>${sugg.type === 'COURS' ? 'Sugg√©r√© par l\'emploi du temps' : 'Contexte g√©n√©ral'}</small></div>`;
            btn.onclick = () => selectContexte(sugg.label, sugg.type);
            container.appendChild(btn);
        });
    }

    function selectContexte(label, type) {
        currentData.contexte = label; // On garde le nom pr√©cis (ex: Maths)
        goToStep(2);
    }

    // --- √âTAPE 2 : LISTE COMP√âTENCES ---
    function generateCompetenceList() {
        const container = document.getElementById('competence-list');
        container.innerHTML = '';
        
        REF_SIMPLE.forEach(comp => {
            const btn = document.createElement('button');
            btn.className = 'btn-big-choice p-3 mb-2';
            // Couleur selon l'axe
            let color = comp.axe === 'COG' ? '#38bdf8' : (comp.axe === 'EMO' ? '#f87171' : '#4ade80');
            
            btn.style.borderLeft = `5px solid ${color}`;
            btn.innerHTML = `<div><h6 class="mb-0">${comp.text}</h6></div><span style="color:${color}">‚ûú</span>`;
            
            btn.onclick = () => {
                currentData.competenceId = comp.id;
                document.getElementById('selected-comp-title').innerText = comp.text;
                goToStep(3);
            };
            container.appendChild(btn);
        });
    }

    // --- √âTAPE 4 : RESSENTI & SAVE ---
    window.selectFeeling = function(feel, btnElement) {
        currentData.feeling = feel;
        document.querySelectorAll('.emoji-btn').forEach(b => b.classList.remove('selected'));
        btnElement.classList.add('selected');
        document.getElementById('btn-save-final').style.display = 'block';
    }

    window.finaliserSauvegarde = function() {
        // R√©cup√©ration des donn√©es formulaire √âtape 3
        currentData.niveau = parseInt(document.getElementById('input-niveau').value);
        currentData.preuve = document.getElementById('input-preuve').value;
        
        if(currentData.preuve.length < 3) { alert("N'oublie pas de raconter ta preuve !"); return; }

        // Sauvegarde Firebase
        const safeId = currentData.competenceId.replace(/\./g, '_');
        const dataToSave = {
            valide: true,
            niveau: currentData.niveau,
            preuve: currentData.preuve,
            contexte: currentData.contexte, // Ex: "Maths" ou "Stage"
            feeling: currentData.feeling,
            date: new Date().toISOString()
        };

        firebase.database().ref(`accompagnement/eleves/${userCode}/competences_validees/${safeId}`).set(dataToSave)
        .then(() => {
            alert("‚úÖ C'est not√© ! Bravo pour cette relecture.");
            window.location.reload(); // On recharge pour revenir √† l'accueil
        });
    }

    // --- UTILS ---
    function getWeekNumber(d) {
        d = new Date(Date.UTC(d.getFullYear(), d.getMonth(), d.getDate()));
        d.setUTCDate(d.getUTCDate() + 4 - (d.getUTCDay()||7));
        var yearStart = new Date(Date.UTC(d.getUTCFullYear(),0,1));
        var weekNo = Math.ceil(( ( (d - yearStart) / 86400000) + 1)/7);
        return weekNo;
    }

    function initMiniChart() {
        // Mini graphique simplifi√© pour l'accueil
        const ctx = document.getElementById('miniRadar').getContext('2d');
        new Chart(ctx, {
            type: 'radar',
            data: {
                labels: ['T√™te', 'C≈ìur', 'Social'],
                datasets: [{
                    data: [50, 60, 40], // Valeurs fictives pour l'instant (√† connecter aux vrais calculs si besoin)
                    backgroundColor: 'rgba(56, 189, 248, 0.2)',
                    borderColor: '#38bdf8',
                    borderWidth: 2,
                    pointRadius: 0
                }]
            },
            options: { scales: { r: { ticks: { display: false }, pointLabels: { color: 'white' } } }, plugins: { legend: { display: false } } }
        });
    }
</script>
</body>
</html>
