<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mon Espace R√©ussite</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { 
            --bg-app: #f8fafc; 
            --surface: #ffffff; 
            --text-main: #1e293b; 
            --primary: #4f46e5; 
            --radius: 20px;
            /* NOUVELLES COULEURS CPS */
            --cog-color: #3b82f6; /* Bleu */
            --emo-color: #ec4899; /* Rose */
            --soc-color: #8b5cf6; /* Violet/Mauve */
            --neu-color: #64748b; /* Gris Neutre */
        }
        body { background-color: var(--bg-app); color: var(--text-main); font-family: 'Outfit', sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* HEADER */
        .app-header { background: var(--surface); padding: 1rem 1.5rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 4px 20px rgba(0,0,0,0.03); z-index: 20; border-bottom-left-radius: 25px; border-bottom-right-radius: 25px; }
        .btn-breath { background: #eff6ff; color: var(--cog-color); border: none; width: 42px; height: 42px; border-radius: 50%; display: flex; align-items: center; justify-content: center; box-shadow: 0 2px 5px rgba(59, 130, 246, 0.1); transition: transform 0.2s; }
        .btn-breath:active { transform: scale(0.9); }

        /* CONTENU */
        .app-content { flex: 1; overflow-y: auto; padding: 1.5rem; padding-bottom: 120px; display: none; }
        .app-content.active { display: block; animation: slideUp 0.4s ease-out; }
        @keyframes slideUp { from { opacity: 0; transform: translateY(20px); } to { opacity: 1; transform: translateY(0); } }

        /* KPI CERCLES */
        .kpi-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin-bottom: 2rem; }
        .kpi-item { background: white; border-radius: 16px; padding: 15px 5px; text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.03); cursor: pointer; transition: transform 0.2s; position: relative; overflow: hidden; }
        .kpi-item:active { transform: scale(0.95); }
        .kpi-item::after { content: ''; position: absolute; bottom: 0; left: 0; width: 100%; height: 4px; }
        .chart-mini { position: relative; height: 60px; width: 60px; margin: 0 auto 8px auto; }
        .kpi-title { font-weight: 700; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.5px; }

        /* OBJECTIFS LISTE */
        .obj-card { background: white; border-radius: 16px; padding: 15px; margin-bottom: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.04); position: relative; overflow: hidden; display: flex; align-items: center; border-left: 5px solid var(--neu-color); transition: all 0.3s; }
        .obj-card.cog { border-left-color: var(--cog-color); }
        .obj-card.emo { border-left-color: var(--emo-color); }
        .obj-card.soc { border-left-color: var(--soc-color); }
        .obj-card.done { opacity: 0.6; background: #f1f5f9; border-left-color: #cbd5e1; }
        
        .obj-badge { font-size: 0.65rem; padding: 3px 8px; border-radius: 6px; font-weight: 700; text-transform: uppercase; margin-left: 8px; }
        .badge-scolaire { background: #e0f2fe; color: #0369a1; }
        .badge-stage { background: #fef3c7; color: #b45309; }
        .badge-recherche { background: #dcfce7; color: #15803d; }
        
        .countdown { font-size: 0.7rem; font-weight: 700; color: #64748b; margin-top: 4px; }
        .countdown.urgent { color: #ef4444; }

        /* METEO */
        .meteo-box { background: white; padding: 15px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); text-align: center; }

        /* NAV BAS */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid #f1f5f9; display: flex; justify-content: space-around; padding: 12px 0; z-index: 30; border-top-left-radius: 25px; border-top-right-radius: 25px; box-shadow: 0 -4px 20px rgba(0,0,0,0.02); }
        .nav-btn { background: none; border: none; color: #94a3b8; font-size: 0.75rem; display: flex; flex-direction: column; align-items: center; font-weight: 500; }
        .nav-btn.active { color: var(--primary); font-weight: 700; }
        .nav-btn i { font-size: 1.4rem; margin-bottom: 4px; }

        /* BOUTON ACTION FLOTTANT */
        .fab-main { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); background: linear-gradient(135deg, var(--primary), #8b5cf6); color: white; width: 60px; height: 60px; border-radius: 50%; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; box-shadow: 0 10px 25px rgba(79, 70, 229, 0.4); border: 4px solid white; z-index: 35; }

        /* OVERLAYS */
        .overlay-full { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: #f8fafc; z-index: 100; display: none; flex-direction: column; overflow-y: auto; }
        .overlay-header { padding: 1.5rem; background: white; border-bottom: 1px solid #f1f5f9; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 10; }
        .step-content { padding: 1.5rem; flex: 1; }

        /* BOUTONS LISTE */
        .list-btn { width: 100%; text-align: left; padding: 15px; margin-bottom: 10px; background: white; border: 1px solid #e2e8f0; border-radius: 12px; transition: all 0.2s; display: flex; align-items: center; }
        .list-btn:active { transform: scale(0.98); background: #f8fafc; border-color: var(--primary); }
        .list-dot { width: 12px; height: 12px; border-radius: 50%; margin-right: 15px; flex-shrink: 0; }

        /* RESPIRATION */
        .breath-circle { width: 200px; height: 200px; background: #e0e7ff; border-radius: 50%; margin: auto; display: flex; align-items: center; justify-content: center; color: var(--primary); font-size: 1.5rem; font-weight: bold; transition: all 5s ease-in-out; }
        .inhale { transform: scale(1.5); background-color: #c7d2fe; }
        .exhale { transform: scale(1.0); background-color: #e0e7ff; }

        #school-closed { display:none; height:100vh; align-items:center; justify-content:center; flex-direction:column; background: #1e293b; color: white; }
    </style>
</head>
<body>

<div id="loader" style="position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; display:flex; align-items:center; justify-content:center;">
    <div class="spinner-border text-primary" role="status"></div>
</div>

<header class="app-header">
    <div>
        <h5 class="mb-0 fw-bold">Bonjour <span id="display-code">...</span> üëã</h5>
        <small class="text-muted" id="mood-header-text">Comment √ßa va ?</small>
    </div>
    <button class="btn-breath" onclick="startBreathing()" title="Respiration">
        <i class="fas fa-wind"></i>
    </button>
</header>

<main class="app-content active" id="view-dashboard">
    
    <div class="kpi-grid">
        <div class="kpi-item" onclick="openCircleDetail('COG')">
            <div class="chart-mini"><canvas id="chartCog"></canvas></div>
            <div class="kpi-title" style="color:var(--cog-color)">Cognitif</div>
        </div>
        <div class="kpi-item" onclick="openCircleDetail('EMO')">
            <div class="chart-mini"><canvas id="chartEmo"></canvas></div>
            <div class="kpi-title" style="color:var(--emo-color)">√âmotionnel</div>
        </div>
        <div class="kpi-item" onclick="openCircleDetail('SOC')">
            <div class="chart-mini"><canvas id="chartSoc"></canvas></div>
            <div class="kpi-title" style="color:var(--soc-color)">Social</div>
        </div>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-3 px-1">
        <h6 class="fw-bold mb-0 text-dark">üéØ Objectifs √† atteindre</h6>
        <button class="btn btn-sm btn-outline-primary rounded-pill fw-bold" onclick="startGoalWizard()">+ Fixer un but</button>
    </div>
    
    <div id="active-goals-list"></div>

    <div class="mt-4">
        <div class="d-flex justify-content-between align-items-center p-2 rounded" style="background:#f1f5f9; cursor:pointer;" onclick="toggleHistory()">
            <span class="small fw-bold text-muted">üìÇ Historique des r√©ussites</span>
            <i class="fas fa-chevron-down text-muted" id="hist-icon"></i>
        </div>
        <div id="history-goals-list" style="display:none; margin-top:10px;"></div>
    </div>

</main>

<div class="bottom-nav">
    <button class="nav-btn active" onclick="switchView('dashboard')"><i class="fas fa-home"></i>Accueil</button>
    <div style="width: 60px;"></div> <button class="nav-btn" onclick="startMoodCheck()"><i class="fas fa-smile"></i>Humeur</button>
</div>

<button class="fab-main" onclick="startGoalWizard()">
    <i class="fas fa-plus"></i>
</button>

<div id="wizard-overlay" class="overlay-full">
    <div class="overlay-header">
        <h5 class="fw-bold mb-0">Nouveau But üéØ</h5>
        <button class="btn-close" onclick="closeWizard()"></button>
    </div>
    <div class="step-content" id="wizard-steps">
        </div>
</div>

<div id="circle-overlay" class="overlay-full">
    <div class="overlay-header">
        <h5 class="fw-bold mb-0" id="circle-title">--</h5>
        <button class="btn-close" onclick="closeCircle()"></button>
    </div>
    <div class="step-content">
        <div class="card p-3 mb-3 border-0 shadow-sm" style="background:#f8fafc;">
            <strong class="text-muted small">C'EST QUOI ?</strong>
            <p class="mb-0 mt-1" id="circle-def">--</p>
        </div>
        <h6 class="fw-bold mb-3">Mes r√©ussites dans ce domaine</h6>
        <div id="circle-history-list"></div>
    </div>
</div>

<div id="mood-overlay" class="overlay-full" style="justify-content:center; align-items:center; background:rgba(255,255,255,0.95);">
    <div class="text-center w-100 px-4">
        <h3 class="fw-bold mb-4">M√©t√©o du jour üå§Ô∏è</h3>
        <select id="mood-select" class="form-select form-select-lg mb-3 shadow-sm">
            <option value="">Comment te sens-tu ?</option>
        </select>
        <button class="btn btn-primary rounded-pill w-100 py-3 fw-bold" onclick="saveMood()">Valider</button>
        <button class="btn btn-link mt-3 text-muted" onclick="document.getElementById('mood-overlay').style.display='none'">Fermer</button>
    </div>
</div>

<div id="breath-overlay" class="overlay-full" style="justify-content:center; background:#eef2ff;">
    <div class="text-center">
        <div id="breath-circle" class="breath-circle">Pr√™t ?</div>
        <p class="mt-5 text-primary fw-bold" id="breath-text">Rel√¢che la pression...</p>
        <button class="btn btn-outline-dark rounded-pill mt-4 px-5" onclick="stopBreathing()">Fermer</button>
    </div>
</div>

<div id="school-closed"><i class="fas fa-moon mb-3" style="font-size:4rem; color:#fbbf24;"></i><h3 class="fw-bold">Pause</h3><p class="text-white-50 px-4 text-center">Disponible sur temps scolaire.</p></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<script src="js/firebase-config.js"></script>

<script>
    if (typeof firebaseConfig !== 'undefined') firebase.initializeApp(firebaseConfig);
    const userCode = new URLSearchParams(window.location.search).get("id");
    let CONFIG_ECOLE = { ouverture: 6, fermeture: 23, jours: [0,1,2,3,4,5,6], maintenance: false };
    
    // --- BIBLIOTH√àQUE COMPLETE (V18) ---
    const GOAL_LIBRARY = {
        "Scolaire": {
            "EMO": [
                "Identifier ses √©motions avant le cours", "Exprimer calmement un ressenti", "R√©guler son stress avant l'oral", 
                "Prendre confiance pour intervenir", "G√©rer la peur de se tromper", "Accepter une correction", 
                "Se recentrer apr√®s une frustration", "Maintenir une attitude calme", "Oser demander de l'aide", "Reconna√Ætre une r√©ussite"
            ],
            "COG": [
                "Se concentrer jusqu'au bout", "Comprendre une consigne avant d'agir", "Reformuler une consigne", 
                "Organiser son mat√©riel", "Planifier les √©tapes", "Appliquer une m√©thode", "V√©rifier son travail", 
                "Analyser une erreur", "M√©moriser une notion", "S'auto√©valuer"
            ],
            "SOC": [
                "Participer oralement", "Lever la main", "Parler de fa√ßon claire", "Adapter son vocabulaire", 
                "Regarder l'interlocuteur", "√âcouter sans interrompre", "Respecter les tours de parole", 
                "Adopter une posture attentive", "Contr√¥ler ses gestes", "Exprimer un d√©saccord calmement", "Collaborer en groupe"
            ]
        },
        "PFMP": {
            "EMO": [
                "G√©rer son stress t√¢che nouvelle", "Rester calme remarque pro", "Accepter correction", "Prendre confiance r√¥le",
                "G√©rer la fatigue", "Se recentrer apr√®s erreur", "Rester motiv√© malgr√© difficult√©", "Canaliser stress corporel"
            ],
            "COG": [
                "Comprendre consigne pro", "Reformuler consigne", "Observer avant d'agir", "Appliquer proc√©dure", 
                "Organiser poste de travail", "Anticiper √©tapes", "G√©rer temps de travail", "Respecter s√©curit√©"
            ],
            "SOC": [
                "Saluer en arrivant/partant", "Se pr√©senter clairement", "Parler poliment", "Adapter vocabulaire pro", 
                "Regarder interlocuteur", "Posture professionnelle", "Contr√¥ler gestes", "√âcouter consignes", "Collaborer √©quipe"
            ]
        },
        "Recherche": {
            "EMO": ["G√©rer stress recherche", "Oser contacter entreprise", "G√©rer peur du refus", "Pers√©v√©rer d√©marches"],
            "COG": ["Identifier entreprises", "Pr√©parer CV", "Adapter candidature", "Planifier actions", "Pr√©parer entretien"],
            "SOC": ["Se pr√©senter oral", "Parler pro t√©l√©phone", "Exprimer motivation", "Remercier interlocuteur", "Posture entretien"]
        }
    };

    const CONTEXT_FIELDS = {
        "Scolaire": { label: "MATI√àRE", type: "select", opts: ["Fran√ßais","Maths","Anglais","Espagnol","Hist-G√©o","Eco-Droit","Ens. Pro","PSE","Arts","EPS","Soutien","Autre"] },
        "PFMP": { label: "LIEU DE STAGE", type: "text" },
        "Recherche": { label: "LIEU / ACTION", type: "text" },
        "Autre": { label: "D√âTAIL", type: "text" }
    };

    const DEFINITIONS = {
        "COG": "C'est ta T√äTE üß†. Ta capacit√© √† r√©fl√©chir, t'organiser, te concentrer et apprendre.",
        "EMO": "C'est ton C≈íUR ‚ù§Ô∏è. Ta capacit√© √† comprendre ce que tu ressens et √† g√©rer ton stress.",
        "SOC": "C'est le LIEN ü§ù. Ta capacit√© √† communiquer, √©couter et travailler avec les autres."
    };

    // --- VARIABLES ---
    let userData = {};
    let draftGoal = {};
    let charts = {};
    let breathInterval;

    // --- INIT ---
    window.onload = function() {
        if (!userCode) return;
        document.getElementById('display-code').innerText = userCode;
        
        // Init M√©t√©o List
        const moodSel = document.getElementById('mood-select');
        ["Satisfait", "Joyeux", "Enthousiaste", "Calme", "Fatigu√©", "Stress√©", "Inquiet", "√ânerv√©", "Triste", "D√©motiv√©"].forEach(m => {
            moodSel.appendChild(new Option(m, m));
        });

        firebase.database().ref('accompagnement/config/horaires').on('value', (snap) => {
            if(snap.val()) CONFIG_ECOLE = snap.val(); checkAccess();
        });
    };

    function checkAccess() {
        const now = new Date(); const h = now.getHours(); const d = now.getDay();
        if (CONFIG_ECOLE.maintenance || !CONFIG_ECOLE.jours.includes(d) || h < CONFIG_ECOLE.ouverture || h >= CONFIG_ECOLE.fermeture) {
            document.getElementById('loader').style.display='none'; document.getElementById('school-closed').style.display='flex'; return;
        } else { document.getElementById('school-closed').style.display='none'; }

        firebase.database().ref(`accompagnement/autorisations/${userCode}`).on('value', (snap) => {
            const val = snap.val(); document.getElementById('loader').style.display='none';
            if(val && val.autorise) loadData();
        });
    }

    function loadData() {
        firebase.database().ref(`accompagnement/eleves/${userCode}`).on('value', (snap) => {
            userData = snap.val() || { objectifs: {}, meteo: {} };
            updateDashboard();
            checkMoodToday();
        });
    }

    // --- DASHBOARD ---
    function updateDashboard() {
        const activeList = document.getElementById('active-goals-list');
        const historyList = document.getElementById('history-goals-list');
        activeList.innerHTML = ''; historyList.innerHTML = '';
        
        let counts = { COG: 0, EMO: 0, SOC: 0 };
        const goals = userData.objectifs || {};
        const keys = Object.keys(goals).sort((a,b) => new Date(goals[a].date_cible) - new Date(goals[b].date_cible)); // Tri par date

        let hasActive = false;

        keys.forEach(key => {
            const g = goals[key];
            const typeClass = g.type === 'COG' ? 'cog' : (g.type === 'EMO' ? 'emo' : (g.type === 'SOC' ? 'soc' : 'neu'));
            
            // Calcul Compte √† rebours
            const target = new Date(g.date_cible);
            const today = new Date(); today.setHours(0,0,0,0); target.setHours(0,0,0,0);
            const diff = Math.ceil((target - today) / (1000 * 60 * 60 * 24));
            let timeStr = diff === 0 ? "Aujourd'hui" : (diff < 0 ? "En retard" : `J-${diff}`);
            if(g.done) timeStr = "Atteint le " + new Date(g.date_done).toLocaleDateString();

            // Badge Cadre
            let badgeClass = "badge-scolaire";
            if(g.context === 'PFMP') badgeClass = "badge-stage";
            if(g.context === 'Recherche') badgeClass = "badge-recherche";

            if(g.done) {
                // Historique et Stats
                if(g.type && counts[g.type] !== undefined) counts[g.type]++;
                historyList.innerHTML += `
                <div class="obj-card done ${typeClass}">
                    <i class="fas fa-check-circle text-success fs-4 me-3"></i>
                    <div>
                        <div class="fw-bold">${g.titre}</div>
                        <div class="small text-muted">${g.context} ‚Ä¢ ${g.detail || ''}</div>
                    </div>
                </div>`;
            } else {
                // Actif
                hasActive = true;
                activeList.innerHTML += `
                <div class="obj-card ${typeClass}">
                    <input type="checkbox" class="form-check-input me-3" style="width:25px;height:25px;border-color:#ccc;" onchange="validateGoal('${key}')">
                    <div class="w-100">
                        <div class="d-flex justify-content-between align-items-start">
                            <span class="fw-bold lh-sm">${g.titre}</span>
                            <span class="obj-badge ${badgeClass}">${g.context}</span>
                        </div>
                        <div class="d-flex justify-content-between mt-2">
                            <small class="text-muted">${g.detail || ''}</small>
                            <small class="countdown ${diff<0?'urgent':''}">${timeStr}</small>
                        </div>
                    </div>
                </div>`;
            }
        });

        if(!hasActive) activeList.innerHTML = `<div class="text-center py-4 text-muted fst-italic">Aucun objectif en cours.<br>Clique sur + pour d√©marrer !</div>`;

        // Update Charts
        renderDonut('chartCog', counts.COG, '#3b82f6');
        renderDonut('chartEmo', counts.EMO, '#ec4899');
        renderDonut('chartSoc', counts.SOC, '#8b5cf6');
    }

    function validateGoal(key) {
        if(confirm("Bravo ! Objectif atteint ? üèÜ")) {
            firebase.database().ref(`accompagnement/eleves/${userCode}/objectifs/${key}`).update({
                done: true,
                date_done: new Date().toISOString()
            });
        } else {
            updateDashboard(); // Reset checkbox
        }
    }

    // --- WIZARD CREATION OBJECTIF (Le C≈ìur V18) ---
    function startGoalWizard() {
        draftGoal = {};
        document.getElementById('wizard-overlay').style.display = 'flex';
        renderWizardStep(1);
    }

    function renderWizardStep(step) {
        const cont = document.getElementById('wizard-steps');
        cont.innerHTML = '';

        if(step === 1) { // CHOIX CADRE
            cont.innerHTML = `
                <h4 class="fw-bold mb-4">Dans quel cadre ?</h4>
                <button class="list-btn" onclick="draftGoal.context='Scolaire'; renderWizardStep(2)"><div class="list-dot bg-primary"></div>üè´ Scolaire</button>
                <button class="list-btn" onclick="draftGoal.context='PFMP'; renderWizardStep(2)"><div class="list-dot bg-warning"></div>üíº PFMP / Stage</button>
                <button class="list-btn" onclick="draftGoal.context='Recherche'; renderWizardStep(2)"><div class="list-dot bg-success"></div>üîé Recherche de Stage</button>
                <button class="list-btn" onclick="draftGoal.context='Autre'; renderWizardStep(4)"><div class="list-dot bg-secondary"></div>‚ú® Autre (Libre)</button>
            `;
        }
        else if(step === 2) { // CHOIX COMP√âTENCE
            cont.innerHTML = `
                <button class="btn btn-light btn-sm mb-3" onclick="renderWizardStep(1)">‚Üê Retour</button>
                <h4 class="fw-bold mb-4">Quel type de progr√®s ?</h4>
                <button class="list-btn" onclick="draftGoal.type='COG'; renderWizardStep(3)"><div class="list-dot" style="background:var(--cog-color)"></div>üß† Cognitif (T√™te)</button>
                <button class="list-btn" onclick="draftGoal.type='EMO'; renderWizardStep(3)"><div class="list-dot" style="background:var(--emo-color)"></div>‚ù§Ô∏è √âmotionnel (C≈ìur)</button>
                <button class="list-btn" onclick="draftGoal.type='SOC'; renderWizardStep(3)"><div class="list-dot" style="background:var(--soc-color)"></div>ü§ù Social (Lien)</button>
                <button class="list-btn" onclick="draftGoal.type='AUTRE'; renderWizardStep(4)"><div class="list-dot bg-secondary"></div>‚ö™ Autre</button>
            `;
        }
        else if(step === 3) { // LISTE D√âROULANTE
            const list = GOAL_LIBRARY[draftGoal.context]?.[draftGoal.type] || [];
            let html = `<button class="btn btn-light btn-sm mb-3" onclick="renderWizardStep(2)">‚Üê Retour</button><h4 class="fw-bold mb-3">Choisis ton but :</h4><div class="list-group">`;
            list.forEach(goal => {
                html += `<button class="list-group-item list-group-item-action py-3" onclick="draftGoal.titre='${goal}'; renderWizardStep(4)">${goal}</button>`;
            });
            html += `<button class="list-group-item list-group-item-action py-3 fst-italic text-muted" onclick="draftGoal.titre=prompt('Ton objectif :'); if(draftGoal.titre) renderWizardStep(4)">üñäÔ∏è Autre (√âcrire)...</button></div>`;
            cont.innerHTML = html;
        }
        else if(step === 4) { // D√âTAILS
            const fieldConfig = CONTEXT_FIELDS[draftGoal.context] || CONTEXT_FIELDS['Autre'];
            let detailInput = `<input type="text" id="wiz-detail" class="form-control mb-3" placeholder="...">`;
            
            if(fieldConfig.type === 'select') {
                let opts = fieldConfig.opts.map(o => `<option value="${o}">${o}</option>`).join('');
                detailInput = `<select id="wiz-detail" class="form-select mb-3">${opts}</select>`;
            }

            cont.innerHTML = `
                <button class="btn btn-light btn-sm mb-3" onclick="renderWizardStep(1)">‚Üê Recommencer</button>
                <h4 class="fw-bold mb-4">Concr√®tement üìÖ</h4>
                
                <label class="small fw-bold text-muted">POUR QUAND ?</label>
                <input type="date" id="wiz-date" class="form-control mb-4" value="${new Date().toISOString().split('T')[0]}">
                
                <label class="small fw-bold text-muted">${fieldConfig.label}</label>
                ${detailInput}

                <div class="card p-3 mb-4 bg-light border-0">
                    <strong>${draftGoal.titre || 'Objectif Libre'}</strong>
                </div>

                <button class="btn btn-primary w-100 rounded-pill py-3 fw-bold" onclick="saveWizardGoal()">‚úÖ VALIDER L'OBJECTIF</button>
            `;
        }
    }

    function saveWizardGoal() {
        const date = document.getElementById('wiz-date').value;
        const detail = document.getElementById('wiz-detail').value;
        if(!date) return alert("Date requise");

        firebase.database().ref(`accompagnement/eleves/${userCode}/objectifs`).push({
            context: draftGoal.context,
            type: draftGoal.type || 'AUTRE',
            titre: draftGoal.titre || "Objectif Libre",
            date_cible: date,
            detail: detail,
            done: false,
            created: new Date().toISOString()
        });
        closeWizard();
    }
    function closeWizard() { document.getElementById('wizard-overlay').style.display = 'none'; }

    // --- CERCLES D√âTAILS ---
    window.openCircleDetail = function(type) {
        const title = type === 'COG' ? 'Cognitif' : (type === 'EMO' ? '√âmotionnel' : 'Social');
        const color = type === 'COG' ? 'var(--cog-color)' : (type === 'EMO' ? 'var(--emo-color)' : 'var(--soc-color)');
        
        document.getElementById('circle-title').innerText = title;
        document.getElementById('circle-title').style.color = color;
        document.getElementById('circle-def').innerText = DEFINITIONS[type];
        
        const list = document.getElementById('circle-history-list'); list.innerHTML = '';
        const goals = userData.objectifs || {};
        
        let found = false;
        Object.values(goals).forEach(g => {
            if(g.type === type && g.done) {
                found = true;
                list.innerHTML += `<div class="p-2 mb-2 border-bottom"><i class="fas fa-check text-success me-2"></i>${g.titre}</div>`;
            }
        });
        if(!found) list.innerHTML = '<div class="text-muted fst-italic">Pas encore de r√©ussite valid√©e ici.</div>';

        document.getElementById('circle-overlay').style.display = 'flex';
    }
    function closeCircle() { document.getElementById('circle-overlay').style.display = 'none'; }

    // --- CHART UTILS ---
    function renderDonut(id, val, col) {
        const ctx = document.getElementById(id); if(!ctx) return;
        if(charts[id]) charts[id].destroy();
        charts[id] = new Chart(ctx.getContext('2d'), {
            type: 'doughnut',
            data: { datasets: [{ data: val>0?[val, 10]:[0,1], backgroundColor: val>0?[col, '#e2e8f0']:['transparent','#e2e8f0'], borderWidth:0 }] },
            options: { cutout: '75%', responsive:true, maintainAspectRatio:false, events:[], plugins:{tooltip:{enabled:false}} }
        });
    }

    // --- EXTRAS ---
    window.toggleHistory = function() { const h = document.getElementById('history-goals-list'); h.style.display = h.style.display==='none'?'block':'none'; }
    window.startMoodCheck = function() { document.getElementById('mood-overlay').style.display = 'flex'; }
    window.saveMood = function() {
        const m = document.getElementById('mood-select').value; if(!m) return;
        document.getElementById('mood-header-text').innerText = "Humeur : " + m;
        document.getElementById('mood-overlay').style.display = 'none';
    }
    function checkMoodToday() { /* Optionnel: check si d√©j√† rempli */ }

    window.startBreathing = function() {
        document.getElementById('breath-overlay').style.display = 'flex';
        const c = document.getElementById('breath-circle'); const t = document.getElementById('breath-text');
        breathInterval = setInterval(() => {
            c.innerText = "Inspirer"; c.className = "breath-circle inhale"; t.innerText = "Gonfle tes poumons...";
            setTimeout(() => { c.innerText = "Expirer"; c.className = "breath-circle exhale"; t.innerText = "Rel√¢che tout..."; }, 5000);
        }, 11000);
    }
    window.stopBreathing = function() { document.getElementById('breath-overlay').style.display='none'; clearInterval(breathInterval); }

</script>
</body>
</html>
