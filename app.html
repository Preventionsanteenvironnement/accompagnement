<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Mon Espace CPS</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <style>
        :root { --bg-app: #f8fafc; --surface: #ffffff; --text-main: #1e293b; --primary: #6366f1; --radius: 16px; }
        body { background-color: var(--bg-app); color: var(--text-main); font-family: 'Inter', sans-serif; height: 100vh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* HEADER */
        .app-header { background: var(--surface); padding: 1rem; display: flex; justify-content: space-between; align-items: center; box-shadow: 0 1px 3px rgba(0,0,0,0.05); z-index: 20; }
        .btn-breath { background: #e0e7ff; color: var(--primary); border: none; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; animation: pulse 3s infinite; }
        @keyframes pulse { 0% { transform: scale(1); } 50% { transform: scale(1.1); } 100% { transform: scale(1); } }

        /* CONTENT - Padding augment√© en bas pour le scroll */
        .app-content { flex: 1; overflow-y: auto; padding: 1rem; padding-bottom: 120px; display: none; }
        .app-content.active { display: block; animation: fadeEffect 0.3s; }
        @keyframes fadeEffect { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* CARDS */
        .card-box { background: var(--surface); border-radius: var(--radius); padding: 1.2rem; margin-bottom: 1rem; box-shadow: 0 2px 5px rgba(0,0,0,0.03); border: 1px solid #f1f5f9; }
        
        /* GRAPHIQUES */
        .kpi-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 8px; margin-bottom: 1rem; }
        .kpi-item { background: white; border-radius: 12px; padding: 10px 5px; text-align: center; box-shadow: 0 2px 4px rgba(0,0,0,0.02); display: flex; flex-direction: column; align-items: center; cursor: pointer; transition: transform 0.1s; }
        .kpi-item:active { transform: scale(0.95); }
        .chart-mini { position: relative; height: 55px; width: 55px; }

        /* OBJECTIFS */
        .obj-item { background: #fff; border-left: 4px solid #cbd5e1; padding: 10px; margin-bottom: 8px; border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.05); }
        .obj-item.active { border-left-color: #f59e0b; background: #fffbeb; }
        .obj-item.done { border-left-color: #10b981; opacity: 0.7; background: #f0fdf4; }

        /* NAV BAS */
        .bottom-nav { position: fixed; bottom: 0; left: 0; width: 100%; background: white; border-top: 1px solid #e2e8f0; display: flex; justify-content: space-around; padding: 10px 0; z-index: 30; }
        .nav-btn { background: none; border: none; color: #94a3b8; font-size: 0.75rem; display: flex; flex-direction: column; align-items: center; }
        .nav-btn.active { color: var(--primary); }
        .nav-btn i { font-size: 1.4rem; margin-bottom: 2px; }

        /* RESPIRATION ANIMATION */
        .overlay-full { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: white; z-index: 100; display: none; flex-direction: column; }
        .breath-circle { width: 180px; height: 180px; background: #a5b4fc; border-radius: 50%; margin: auto; display: flex; align-items: center; justify-content: center; color: white; font-size: 1.5rem; font-weight: bold; text-align: center; transition: all 5s ease-in-out; }
        /* Classes pilot√©es par JS pour timing pr√©cis */
        .inhale { transform: scale(1.8); background-color: #818cf8; transition: all 5s ease-in-out; }
        .exhale { transform: scale(1.0); background-color: #c7d2fe; transition: all 6s ease-in-out; }

        #school-closed { display:none; height:100vh; align-items:center; justify-content:center; flex-direction:column; background: #1e293b; color: white; }
    </style>
</head>
<body>

<div id="loader" style="position:fixed; top:0; left:0; width:100%; height:100%; background:white; z-index:9999; display:flex; align-items:center; justify-content:center;">
    <div class="spinner-border text-primary" role="status"></div>
</div>

<header class="app-header">
    <div>
        <h5 class="mb-0 fw-bold">Bonjour <span id="display-code">...</span> üëã</h5>
    </div>
    <button class="btn-breath" onclick="startBreathing()" title="Respirer">
        <i class="fas fa-wind"></i>
    </button>
</header>

<main class="app-content active" id="view-dashboard">
    
    <div class="card-box" id="mood-container">
        <div id="mood-form">
            <h6 class="fw-bold mb-3">Quelle √©motion ressens-tu ?</h6>
            <select id="mood-select-primary" class="form-select mb-3" onchange="updateMoodAdjectives()">
                <option value="">Choisis...</option>
                </select>
            <select id="mood-select-adj" class="form-select mb-3" style="display:none;">
                <option value="">Pr√©cise...</option>
            </select>
            <button class="btn btn-primary w-100 rounded-pill" onclick="saveMood()">Valider ma m√©t√©o</button>
        </div>
        
        <div id="mood-display" style="display:none; text-align:center;">
            <h6 class="text-muted small fw-bold uppercase mb-2">MA M√âT√âO DU JOUR</h6>
            <div class="d-flex justify-content-center align-items-center gap-2">
                <span style="font-size: 2rem;">üå§Ô∏è</span>
                <div class="text-start">
                    <h4 class="fw-bold mb-0 text-primary" id="mood-display-title">--</h4>
                    <small class="text-muted" id="mood-display-desc">--</small>
                </div>
            </div>
        </div>
    </div>

    <div class="d-flex justify-content-between align-items-end mb-2 px-1">
        <h6 class="fw-bold mb-0">Mes Comp√©tences</h6>
    </div>
    <div class="kpi-grid">
        <div class="kpi-item" onclick="switchView('library')">
            <div class="chart-mini"><canvas id="chartCog"></canvas></div>
            <small class="fw-bold text-dark mt-1" style="font-size:0.75rem">Cognitif</small>
        </div>
        <div class="kpi-item" onclick="switchView('library')">
            <div class="chart-mini"><canvas id="chartEmo"></canvas></div>
            <small class="fw-bold text-dark mt-1" style="font-size:0.75rem">√âmotionnel</small>
        </div>
        <div class="kpi-item" onclick="switchView('library')">
            <div class="chart-mini"><canvas id="chartSoc"></canvas></div>
            <small class="fw-bold text-dark mt-1" style="font-size:0.75rem">Social</small>
        </div>
    </div>

    <div class="card-box">
        <div class="d-flex justify-content-between align-items-center mb-3">
            <h6 class="fw-bold mb-0">üéØ Objectifs √† atteindre</h6>
            <button class="btn btn-sm btn-outline-primary rounded-pill fw-bold" onclick="openNewObjectiveModal()">+ Ajouter</button>
        </div>
        
        <div id="objectives-active-list"></div>
        
        <div class="mt-3 pt-2 border-top">
            <small class="text-muted fw-bold" onclick="toggleHistory()" style="cursor:pointer; display:block; padding:5px;">
                üìÇ Voir les objectifs atteints ‚ñº
            </small>
            <div id="objectives-history-list" style="display:none; margin-top:10px;"></div>
        </div>
    </div>

    <h6 class="ms-1 mb-2 small fw-bold text-muted mt-4">DERNI√àRES R√âUSSITES</h6>
    <div id="recent-list"></div>

</main>

<main class="app-content" id="view-library">
    <h4 class="fw-bold mb-3">üìö Comprendre</h4>
    <div id="library-list"></div>
</main>

<div class="fixed-bottom mb-4 pb-2 text-center" style="z-index: 35; pointer-events: none;">
    <button onclick="lancerRituel()" class="btn btn-primary rounded-pill shadow-lg py-3 px-4 fw-bold" 
            style="pointer-events: auto; background: linear-gradient(135deg, #6366f1, #8b5cf6); border:none;">
        ‚ú® Faire le point
    </button>
</div>

<nav class="bottom-nav">
    <button class="nav-btn active" onclick="switchView('dashboard')"><i class="fas fa-home"></i>Accueil</button>
    <div style="width: 60px;"></div> <button class="nav-btn" onclick="switchView('library')"><i class="fas fa-book-open"></i>Savoir</button>
</nav>

<div id="breathing-overlay" class="overlay-full" style="background:#eef2ff; justify-content:center;">
    <div class="text-center">
        <div id="breath-circle" class="breath-circle">Pr√™t ?</div>
        <button class="btn btn-outline-dark rounded-pill mt-5 px-5" onclick="stopBreathing()">Fermer</button>
    </div>
</div>

<div id="new-obj-overlay" class="overlay-full p-4" style="background:#f8fafc;">
    <div class="d-flex justify-content-between mb-4">
        <h4 class="fw-bold">üéØ Nouvel Objectif</h4>
        <button class="btn-close" onclick="closeNewObjectiveModal()"></button>
    </div>

    <label class="form-label small fw-bold text-muted">CADRE</label>
    <select id="new-obj-type" class="form-select mb-3 text-uppercase fw-bold" style="font-size:0.9rem;">
        <option value="Scolaire">üéì Scolaire</option>
        <option value="PFMP">üíº Stage / PFMP</option>
    </select>

    <label class="form-label small fw-bold text-muted">QUOI ? (Ton but)</label>
    <div class="input-group mb-3">
        <input type="text" id="new-obj-title" class="form-control" list="obj-suggestions" placeholder="Ex: Participer...">
        <datalist id="obj-suggestions">
            <option value="Participation orale">
            <option value="Demander de l'aide">
            <option value="Rester concentr√©">
            <option value="G√©rer mon mat√©riel">
            <option value="Arriver √† l'heure">
        </datalist>
    </div>
    
    <label class="form-label small fw-bold text-muted">POUR QUAND ?</label>
    <select id="new-obj-date" class="form-select mb-3">
        <option value="">-- Choisis un jour --</option>
        <option value="Lundi">Lundi</option>
        <option value="Mardi">Mardi</option>
        <option value="Mercredi">Mercredi</option>
        <option value="Jeudi">Jeudi</option>
        <option value="Vendredi">Vendredi</option>
        <option value="Semaine prochaine">Semaine prochaine</option>
    </select>
    
    <label class="form-label small fw-bold text-muted">MATI√àRE / LIEU</label>
    <div class="input-group mb-4">
        <select id="new-obj-context-select" class="form-select" onchange="checkOtherSubject(this)">
            <option value="Fran√ßais">Fran√ßais</option>
            <option value="Maths">Maths</option>
            <option value="Anglais">Anglais</option>
            <option value="Histoire-G√©o">Histoire-G√©o</option>
            <option value="Enseignement Pro">Ens. Pro</option>
            <option value="Atelier">Atelier</option>
            <option value="EPS">EPS</option>
            <option value="Autre">Autre (pr√©ciser)...</option>
        </select>
        <input type="text" id="new-obj-context-input" class="form-control" style="display:none;" placeholder="Pr√©cise...">
    </div>

    <button class="btn btn-primary w-100 rounded-pill py-3 fw-bold shadow-sm" onclick="saveNewObjective()">Valider mon objectif</button>
</div>

<div id="wizard-overlay" class="overlay-full"></div>
<div id="knowledge-overlay" class="overlay-full"></div>
<div id="school-closed"><i class="fas fa-moon mb-3" style="font-size:4rem; color:#fbbf24;"></i><h3 class="fw-bold">Pause</h3><p class="text-white-50 px-4 text-center">Disponible sur temps scolaire.</p></div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
<script src="js/firebase-config.js"></script>

<script>
    if (typeof firebaseConfig !== 'undefined') firebase.initializeApp(firebaseConfig);
    const userCode = new URLSearchParams(window.location.search).get("id");
    let CONFIG_ECOLE = { ouverture: 6, fermeture: 23, jours: [0,1,2,3,4,5,6], maintenance: false };
    
    // DONN√âES √âMOTIONS
    const EMOTIONS_DATA = {
        "Joie": ["Satisfait", "Content", "Joyeux", "Heureux", "Gai", "Enthousiaste"],
        "Amour": ["Passionn√©", "Fanatique"],
        "Peur": ["Inquiet", "Stress√©", "Angoiss√©", "Nerveux"],
        "Col√®re": ["√ânerv√©", "F√¢ch√©", "Irrit√©", "Furieux"],
        "Tristesse": ["Pein√©", "D√©prim√©", "Abattu"],
        "D√©go√ªt": ["√âc≈ìur√©", "Lass√©"],
        "Surprise": ["√âtonn√©", "√âpat√©"]
    };

    // STRUCTURE COMPL√àTE
    const REF_STRUCT = [
        { id: "C1.1", default:"Connaissance de soi", axe: "COG", color: "#3b82f6" },
        { id: "C1.2", default:"Pens√©e critique", axe: "COG", color: "#3b82f6" },
        { id: "C1.3", default:"Valeurs et besoins", axe: "COG", color: "#3b82f6" },
        { id: "C1.4", default:"D√©cisions constructives", axe: "COG", color: "#3b82f6" },
        { id: "C1.5", default:"Auto-√©valuation", axe: "COG", color: "#3b82f6" },
        { id: "C1.6", default:"Pleine attention", axe: "COG", color: "#3b82f6" },
        { id: "C2.1", default:"Atteindre ses buts", axe: "COG", color: "#3b82f6" },
        { id: "C2.2", default:"G√©rer impulsions", axe: "COG", color: "#3b82f6" },
        { id: "C2.3", default:"R√©soudre probl√®mes", axe: "COG", color: "#3b82f6" },
        { id: "C2.4", default:"Demander de l'aide", axe: "COG", color: "#3b82f6" },
        { id: "E1.1", default:"Comprendre √©motions", axe: "EMO", color: "#ef4444" },
        { id: "E1.2", default:"Identifier √©motions", axe: "EMO", color: "#ef4444" },
        { id: "E2.2", default:"Exprimer √©motions", axe: "EMO", color: "#ef4444" },
        { id: "E2.3", default:"G√©rer stress", axe: "EMO", color: "#ef4444" },
        { id: "S1.1", default:"Com. positive", axe: "SOC", color: "#10b981" },
        { id: "S1.2", default:"Empathie", axe: "SOC", color: "#10b981" },
        { id: "S1.3", default:"Liens prosociaux", axe: "SOC", color: "#10b981" },
        { id: "S2.1", default:"S'affirmer", axe: "SOC", color: "#10b981" },
        { id: "S2.2", default:"R√©soudre conflits", axe: "SOC", color: "#10b981" }
    ];

    let userData = {};
    let libraryData = {};
    let charts = {};
    let wizardData = {};
    let breathInterval = null;

    window.onload = function() {
        if (!userCode) return;
        document.getElementById('display-code').innerText = userCode;
        
        // Init M√©t√©o
        const moodSel = document.getElementById('mood-select-primary');
        Object.keys(EMOTIONS_DATA).forEach(em => {
            const opt = document.createElement('option'); opt.value=em; opt.innerText=em; moodSel.appendChild(opt);
        });

        // Auth & Data
        firebase.database().ref('accompagnement/config/horaires').on('value', (snap) => {
            if(snap.val()) CONFIG_ECOLE = snap.val(); checkAccess();
        });
        firebase.database().ref('accompagnement/contenu_pedagogique').on('value', (snap) => {
            libraryData = snap.val() || {}; renderLibraryList();
        });
    };

    function checkAccess() {
        const now = new Date(); const h = now.getHours(); const d = now.getDay();
        if (CONFIG_ECOLE.maintenance || !CONFIG_ECOLE.jours.includes(d) || h < CONFIG_ECOLE.ouverture || h >= CONFIG_ECOLE.fermeture) {
            document.getElementById('loader').style.display='none'; document.getElementById('school-closed').style.display='flex'; return;
        } else { document.getElementById('school-closed').style.display='none'; }

        firebase.database().ref(`accompagnement/autorisations/${userCode}`).on('value', (snap) => {
            const val = snap.val(); 
            document.getElementById('loader').style.display='none';
            // On laisse passer si pas de data pour √©viter blocage test, sinon if(val && val.autorise)
            loadData(); 
        });
    }

    function loadData() {
        firebase.database().ref(`accompagnement/eleves/${userCode}`).on('value', (snap) => {
            userData = snap.val() || { competences_validees: {}, objectifs: {}, meteo: {} };
            updateDashboard();
            renderObjectives(userData.objectifs);
            checkTodayMood();
        });
    }

    // --- DASHBOARD GRAPHS ---
    function updateDashboard() {
        let counts = { COG: 0, EMO: 0, SOC: 0 };
        let recent = [];
        Object.keys(userData.competences_validees || {}).forEach(key => {
            const item = userData.competences_validees[key];
            if(item.valide) {
                const refItem = REF_STRUCT.find(r => r.id === key.replace('_', '.'));
                if(refItem) counts[refItem.axe]++;
                recent.push({...item, text: refItem?refItem.default:"Comp√©tence", color: refItem?refItem.color:"#ccc"});
            }
        });

        renderDonut('chartCog', counts.COG, '#3b82f6');
        renderDonut('chartEmo', counts.EMO, '#ef4444');
        renderDonut('chartSoc', counts.SOC, '#10b981');

        const recContainer = document.getElementById('recent-list'); recContainer.innerHTML = '';
        recent.sort((a,b)=>new Date(b.date)-new Date(a.date)).slice(0,3).forEach(i => {
            recContainer.innerHTML += `<div class="card-box p-2 mb-2 d-flex align-items-center"><div style="width:10px; height:10px; border-radius:50%; background:${i.color}; margin-right:10px;"></div><div><div class="fw-bold small">${i.text}</div><div class="text-muted" style="font-size:0.7rem">${i.contexte || ''}</div></div></div>`;
        });
    }

    function renderDonut(id, val, col) {
        const cvs = document.getElementById(id);
        if(!cvs) return;
        if(charts[id]) charts[id].destroy();
        charts[id] = new Chart(cvs.getContext('2d'), {
            type: 'doughnut', 
            data: { datasets: [{ data: val>0?[val, 10-val]:[0,1], backgroundColor: val>0?[col, '#e2e8f0']:['transparent','#e2e8f0'], borderWidth: 0 }] },
            options: { cutout: '70%', responsive: true, maintainAspectRatio: false, events: [], plugins:{tooltip:{enabled:false}} }
        });
    }

    // --- RESPIRATION (5s / 6s) ---
    window.startBreathing = function() {
        document.getElementById('breathing-overlay').style.display = 'flex';
        const circle = document.getElementById('breath-circle');
        
        function cycle() {
            circle.innerText = "Inspirer";
            circle.className = "breath-circle inhale"; // 5s
            
            setTimeout(() => {
                circle.innerText = "Expirer";
                circle.className = "breath-circle exhale"; // 6s
            }, 5000); // Au bout de 5s, on expire
        }
        
        cycle(); // Premier cycle
        breathInterval = setInterval(cycle, 11000); // 5+6 = 11s total
    }
    window.stopBreathing = function() {
        document.getElementById('breathing-overlay').style.display = 'none';
        clearInterval(breathInterval);
        document.getElementById('breath-circle').className = "breath-circle";
    }

    // --- METEO ---
    window.updateMoodAdjectives = function() {
        const prim = document.getElementById('mood-select-primary').value;
        const adjSel = document.getElementById('mood-select-adj');
        adjSel.innerHTML = '<option value="">Pr√©cise...</option>';
        if(prim && EMOTIONS_DATA[prim]) {
            adjSel.style.display = 'block';
            EMOTIONS_DATA[prim].forEach(adj => {
                const opt = document.createElement('option'); opt.value=adj; opt.innerText=adj; adjSel.appendChild(opt);
            });
        } else { adjSel.style.display = 'none'; }
    }
    window.saveMood = function() {
        const p = document.getElementById('mood-select-primary').value;
        const a = document.getElementById('mood-select-adj').value;
        if(!p) return;
        const today = new Date().toISOString().split('T')[0];
        firebase.database().ref(`accompagnement/eleves/${userCode}/meteo/${today}`).set({emotion: p, detail: a || p});
    }
    function checkTodayMood() {
        const today = new Date().toISOString().split('T')[0];
        const m = (userData.meteo && userData.meteo[today]);
        if(m) {
            document.getElementById('mood-form').style.display = 'none';
            document.getElementById('mood-display').style.display = 'block';
            document.getElementById('mood-display-title').innerText = m.emotion;
            document.getElementById('mood-display-desc').innerText = m.detail;
        } else {
            document.getElementById('mood-form').style.display = 'block';
            document.getElementById('mood-display').style.display = 'none';
        }
    }

    // --- OBJECTIFS (Menus D√©roulants) ---
    function renderObjectives(objData) {
        const activeList = document.getElementById('objectives-active-list');
        const historyList = document.getElementById('objectives-history-list');
        activeList.innerHTML = ''; historyList.innerHTML = '';
        
        if(!objData) { activeList.innerHTML = '<div class="text-muted small fst-italic">Aucun objectif.</div>'; return; }
        
        const keys = Object.keys(objData);
        let hasActive = false;

        keys.forEach(key => {
            const obj = objData[key];
            const isPerso = obj.auteur === 'ELEVE';
            const badge = isPerso ? '<span class="badge bg-secondary ms-2" style="font-size:0.6rem">MOI</span>' : '<span class="badge bg-warning text-dark ms-2" style="font-size:0.6rem">COACH</span>';
            const contextStr = obj.matiere ? ` (${obj.matiere})` : '';
            const dayStr = obj.date_cible || '';

            const html = `
            <div class="obj-item ${obj.done ? 'done' : 'active'}">
                <div class="d-flex justify-content-between align-items-center">
                    <div>
                        <div class="fw-bold">${obj.titre} ${badge}</div>
                        <div class="small text-muted">${dayStr}${contextStr}</div>
                    </div>
                    ${!obj.done ? `<input type="checkbox" class="form-check-input" onchange="checkObj('${key}')" style="width:25px;height:25px;">` : '<span class="text-success fw-bold">OK</span>'}
                </div>
            </div>`;

            if(obj.done) historyList.innerHTML += html;
            else { activeList.innerHTML += html; hasActive = true; }
        });

        if(!hasActive) activeList.innerHTML = '<div class="text-muted small fst-italic">Aucun objectif actif.</div>';
    }

    window.openNewObjectiveModal = function() { document.getElementById('new-obj-overlay').style.display = 'flex'; }
    window.closeNewObjectiveModal = function() { document.getElementById('new-obj-overlay').style.display = 'none'; }
    window.checkOtherSubject = function(sel) {
        const inp = document.getElementById('new-obj-context-input');
        if(sel.value === 'Autre') { inp.style.display = 'block'; inp.focus(); } else { inp.style.display = 'none'; }
    }
    
    window.saveNewObjective = function() {
        const t = document.getElementById('new-obj-title').value;
        const d = document.getElementById('new-obj-date').value;
        let m = document.getElementById('new-obj-context-select').value;
        if(m === 'Autre') m = document.getElementById('new-obj-context-input').value;
        const type = document.getElementById('new-obj-type').value;

        if(!t) return;
        
        firebase.database().ref(`accompagnement/eleves/${userCode}/objectifs`).push({
            titre: t, date_cible: d, matiere: m, type: type, done: false, auteur: "ELEVE", created: new Date().toISOString()
        });
        closeNewObjectiveModal();
    }

    window.checkObj = function(key) {
        if(confirm("Objectif atteint ?")) {
            firebase.database().ref(`accompagnement/eleves/${userCode}/objectifs/${key}`).update({ done: true });
        }
    }
    window.toggleHistory = function() {
        const h = document.getElementById('objectives-history-list');
        h.style.display = h.style.display === 'none' ? 'block' : 'none';
    }

    // --- NAVIGATION ---
    window.switchView = function(viewName) {
        document.querySelectorAll('.app-content').forEach(el => el.classList.remove('active'));
        document.getElementById('view-' + viewName).classList.add('active');
        document.querySelectorAll('.nav-btn').forEach(el => el.classList.remove('active'));
        event.currentTarget.classList.add('active');
    }

    // --- LIBRARY & WIZARD (Code inchang√© V16 pour cette partie) ---
    function renderLibraryList() {
        const container = document.getElementById('library-list'); container.innerHTML = '';
        REF_STRUCT.forEach(ref => {
            const safeId = ref.id.replace('.', '_');
            const data = libraryData[safeId] || {};
            const title = data.titre_eleve || ref.default;
            container.innerHTML += `<div class="card-box p-3 mb-2" onclick="openKnowledge('${safeId}', '${ref.color}', '${ref.id}')" style="cursor:pointer; border-left:4px solid ${ref.color}"><h6 class="fw-bold mb-0">${title}</h6><small class="text-muted">${ref.axe}</small></div>`;
        });
    }
    window.openKnowledge = function(safeId, color, code) {
        const data = libraryData[safeId] || {};
        const title = data.titre_eleve || "Titre";
        const science = data.explication_scientifique || "Pas encore d'explication.";
        const pourquoi = data.pourquoi_scolaire || "";
        const lien = data.lien_externe || "";
        const overlay = document.getElementById('knowledge-overlay');
        let btnExo = lien ? `<a href="${lien}" target="_blank" class="btn btn-primary w-100 rounded-pill mt-3">üöÄ Faire l'exercice</a>` : '';
        overlay.innerHTML = `<div class="p-4"><div class="d-flex justify-content-between mb-4"><h3 class="fw-bold" style="color:${color}">${title}</h3><button class="btn btn-light rounded-circle" onclick="closeKnowledge()">‚úï</button></div><div class="mb-3"><strong>C'est quoi ?</strong><p>${science}</p></div><div class="mb-3"><strong>Pourquoi ?</strong><p>${pourquoi}</p></div>${btnExo}</div>`;
        overlay.style.display = 'flex';
    }
    window.closeKnowledge = function() { document.getElementById('knowledge-overlay').style.display = 'none'; }

    window.lancerRituel = function() { document.getElementById('wizard-overlay').style.display = 'flex'; showStep(1); }
    window.showStep = function(s) {
        const ov = document.getElementById('wizard-overlay'); ov.innerHTML = '';
        if(s===1) ov.innerHTML = `<div class="p-4 text-center"><h3 class="fw-bold mb-4">C'√©tait o√π ?</h3><button class="btn btn-light w-100 p-3 mb-2 text-start fw-bold" onclick="selCtx('COURS')">üìö En Cours</button><button class="btn btn-light w-100 p-3 mb-2 text-start fw-bold" onclick="selCtx('ATELIER')">üõ†Ô∏è En Atelier</button><button class="btn btn-light w-100 p-3 mb-2 text-start fw-bold" onclick="selCtx('STAGE')">üíº En Stage</button></div>`;
        else if(s===2) {
            let h = `<div class="p-4"><button class="btn btn-sm btn-light mb-3" onclick="showStep(1)">Retour</button><h4 class="fw-bold mb-3">Ta r√©ussite</h4>`;
            REF_STRUCT.forEach(r => h+=`<button class="btn btn-light w-100 p-3 mb-2 text-start" onclick="selComp('${r.id}')" style="border-left:4px solid ${r.color}"><b>${r.default}</b></button>`);
            ov.innerHTML = h + `</div>`;
        } else if(s===3) {
            ov.innerHTML = `<div class="p-4"><button class="btn btn-sm btn-light mb-3" onclick="showStep(2)">Retour</button><h4 class="fw-bold mb-3">D√©tails</h4><select id="w-lvl" class="form-select mb-3"><option value="1">‚≠ê D√©couverte</option><option value="2">‚≠ê‚≠ê Appliqu√©</option><option value="3">‚≠ê‚≠ê‚≠ê Ma√Ætris√©</option></select><textarea id="w-prv" class="form-control mb-3" placeholder="Preuve..."></textarea><button class="btn btn-primary w-100 rounded-pill py-3" onclick="saveRituel()">Valider</button></div>`;
        }
    }
    window.selCtx=function(c){wizardData.ctx=c;showStep(2)};
    window.selComp=function(i){wizardData.id=i;showStep(3)};
    window.saveRituel=function(){
        const p=document.getElementById('w-prv').value; const l=document.getElementById('w-lvl').value;
        if(p.length<2){alert('Preuve ?');return;}
        const sid = wizardData.id.replace('.','_');
        firebase.database().ref(`accompagnement/eleves/${userCode}/competences_validees/${sid}`).set({valide:true, niveau:l, preuve:p, contexte:wizardData.ctx, date:new Date().toISOString()}).then(()=>{document.getElementById('wizard-overlay').style.display='none';});
    }
    window.closeWizard = function(){document.getElementById('wizard-overlay').style.display='none';}

</script>
</body>
</html>
